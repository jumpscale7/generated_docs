<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>JumpScale.core.system.process &mdash; Jumpscale Doc 7.0 documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '7.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="top" title="Jumpscale Doc 7.0 documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="../../../../index.html">Jumpscale Doc 7.0 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for JumpScale.core.system.process</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">select</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">Popen</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">ujson</span> <span class="kn">as</span> <span class="nn">json</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">JumpScale</span> <span class="kn">import</span> <span class="n">j</span>

<span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">sig</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
<div class="viewcode-block" id="kill"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.kill">[docs]</a>    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Kill a process with a signal</span>
<span class="sd">    @param pid: pid of the process to kill</span>
<span class="sd">    @param sig: signal. If no signal is specified signal.SIGKILL is used</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">j</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#39;Killing process </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">pid</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">platformtype</span><span class="o">.</span><span class="n">isUnix</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sig</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">sig</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGKILL</span>

            <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">sig</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Could not kill process with id </span><span class="si">%s</span><span class="s">.</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pid</span><span class="p">,</span><span class="n">e</span><span class="p">))</span>
        
    <span class="k">elif</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">platformtype</span><span class="o">.</span><span class="n">isWindows</span><span class="p">():</span>
        <span class="kn">import</span> <span class="nn">win32api</span><span class="o">,</span> <span class="nn">win32process</span><span class="o">,</span> <span class="nn">win32con</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">handle</span> <span class="o">=</span> <span class="n">win32api</span><span class="o">.</span><span class="n">OpenProcess</span><span class="p">(</span><span class="n">win32con</span><span class="o">.</span><span class="n">PROCESS_TERMINATE</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
            <span class="n">win32process</span><span class="o">.</span><span class="n">TerminateProcess</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span>


<span class="c">#Fix subprocess.Popen EINTR issues</span>
<span class="c">#The _communicate method on Unix uses select(2) to monitor stdout/err pipes,</span>
<span class="c">#which can raise an exception (EINTR) whenever the parent process receives a</span>
<span class="c">#signal (or the system call is interrupted for some other reason), eg a</span>
<span class="c">#SIGCHLD when the actual subprocess stops.</span>
<span class="c">#This was partially fixed in Python 2.6.0, but not completely. This code</span>
<span class="c">#replaces the standard implementation with a patched one based on the code</span>
<span class="c">#in Python 2.6.0, a patch in Python bug #1068268</span>
<span class="c">#(http://bugs.python.org/issue1068268) and a patch applied to the Python2.5</span>
<span class="c">#package in Ubuntu Linux (http://patches.ubuntu.com/p/python2.5/extracted/</span>
<span class="c">#        subprocess-eintr-safety.dpatch)</span>
<span class="n">mswindows</span> <span class="o">=</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;win32&quot;</span><span class="p">)</span></div>
<span class="c">#Bump this version number as long as the upstream subprocess module is not</span>
<span class="c">#fixed. Testcases on Solaris tend to fail easily.</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">mswindows</span><span class="p">:</span>
    <span class="n">SafePopen</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">types</span>
    <span class="kn">import</span> <span class="nn">errno</span>
    <span class="kn">import</span> <span class="nn">gc</span>
    <span class="kn">import</span> <span class="nn">traceback</span>
    <span class="kn">import</span> <span class="nn">pickle</span>
    <span class="k">class</span> <span class="nc">SafePopen</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">):</span>
        <span class="c">#Make sure we wrap this for Unix/win32 splitup if ever we need some</span>
        <span class="c">#win32-specific fixes (see original subprocess.Popen)</span>
        <span class="k">def</span> <span class="nf">communicate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="c">#This is based on code in CPython 2.6.0, but including some extra</span>
            <span class="c">#checks to emulate 2.5 behaviour which didn&#39;t close stdout/err.</span>
            <span class="k">if</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">stdout</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">stderr</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">input</span><span class="p">:</span>
                        <span class="c">#MOD - 1068268</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_fo_write_no_intr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="nb">input</span><span class="p">)</span>
                        <span class="c">#END MOD</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
                    <span class="c">#MOD - 1068268</span>
                    <span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fo_read_no_intr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
                    <span class="c">#END MOD</span>
                    <span class="c">#MOD</span>
                    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="c">#END MOD</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">:</span>
                    <span class="c">#MOD - 1068268</span>
                    <span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fo_read_no_intr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                    <span class="c">#END MOD</span>
                    <span class="c">#MOD</span>
                    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="c">#END MOD</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_communicate</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">_communicate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
                <span class="c">#This is subprocess.Popen._communicate in the non-win32 case of</span>
                <span class="c">#Python 2.5.2, as found on</span>
                <span class="c">#http://svn.python.org/projects/python/tags/r252/Lib/subprocess.py</span>
                <span class="c">#2 modifications were made: a minor self-check, and an exception</span>
                <span class="c">#handling clause around select.select as found in the version of</span>
                <span class="c">#subprocess.Popen._communicate of Python 2.6.0</span>
                <span class="c">#The differences found in the patch of 1068268 are applied as</span>
                <span class="c">#well, similar to the 2.6.0 _communicate</span>

                <span class="c">#First we&#39;ll check whether &#39;self&#39; got all attributes used in this</span>
                <span class="c">#method, to catch issues with older versions of subprocess.Popen.</span>
                <span class="c">#MOD START</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;stdin&#39;</span><span class="p">,</span> <span class="s">&#39;stdout&#39;</span><span class="p">,</span> <span class="s">&#39;stderr&#39;</span><span class="p">,</span>
                        <span class="s">&#39;universal_newlines&#39;</span><span class="p">,</span> <span class="s">&#39;_translate_newlines&#39;</span><span class="p">,</span>
                        <span class="s">&#39;wait&#39;</span><span class="p">,</span> <span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
                        <span class="c">#This implementation can&#39;t be used, use the original</span>
                        <span class="k">return</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="o">.</span><span class="n">_communicate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">)</span>
                <span class="c">#MOD END</span>
                <span class="n">read_set</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">write_set</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">stdout</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># Return</span>
                <span class="n">stderr</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># Return</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="p">:</span>
                    <span class="c"># Flush stdio buffer.  This might block, if the user has</span>
                    <span class="c"># been writing to .stdin in an uncontrolled fashion.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">input</span><span class="p">:</span>
                        <span class="n">write_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
                    <span class="n">read_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
                    <span class="n">stdout</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">:</span>
                    <span class="n">read_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                    <span class="n">stderr</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="n">input_offset</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="n">read_set</span> <span class="ow">or</span> <span class="n">write_set</span><span class="p">:</span>
                    <span class="c">#MOD - 1068268</span>
                    <span class="c">#Handle EINTR in select(2)</span>
                    <span class="kn">import</span> <span class="nn">select</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">rlist</span><span class="p">,</span> <span class="n">wlist</span><span class="p">,</span> <span class="n">xlist</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">read_set</span><span class="p">,</span> <span class="n">write_set</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="k">except</span> <span class="n">select</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EINTR</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">raise</span>
                    <span class="c">#MOD END</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span> <span class="ow">in</span> <span class="n">wlist</span><span class="p">:</span>
                        <span class="c"># When select has indicated that the file is writable,</span>
                        <span class="c"># we can write up to PIPE_BUF bytes without risk</span>
                        <span class="c"># blocking.  POSIX defines PIPE_BUF &gt;= 512</span>
                        <span class="c">#MOD - 1068268</span>
                        <span class="n">bytes_written</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_no_intr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> \
                                <span class="nb">buffer</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">input_offset</span><span class="p">,</span> <span class="mi">512</span><span class="p">))</span>
                        <span class="c">#END MOD</span>
                        <span class="n">input_offset</span> <span class="o">+=</span> <span class="n">bytes_written</span>
                        <span class="k">if</span> <span class="n">input_offset</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                            <span class="n">write_set</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span> <span class="ow">in</span> <span class="n">rlist</span><span class="p">:</span>
                        <span class="c">#MOD - 1068268</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_no_intr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mi">1024</span><span class="p">)</span>
                        <span class="c">#END MOD</span>
                        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                            <span class="n">read_set</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
                        <span class="n">stdout</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span> <span class="ow">in</span> <span class="n">rlist</span><span class="p">:</span>
                        <span class="c">#MOD - 1068268</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_no_intr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mi">1024</span><span class="p">)</span>
                        <span class="c">#END MOD</span>
                        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                            <span class="n">read_set</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                        <span class="n">stderr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

                <span class="c"># All data exchanged.  Translate lists into strings.</span>
                <span class="k">if</span> <span class="n">stdout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">stdout</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">stderr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">stderr</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stderr</span><span class="p">)</span>

                <span class="c"># Translate newlines, if requested.  We cannot let the file</span>
                <span class="c"># object do the translation: It is based on stdio, which is</span>
                <span class="c"># impossible to combine with select (unless forcing no</span>
                <span class="c"># buffering).</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">universal_newlines</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="s">&#39;newlines&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">stdout</span><span class="p">:</span>
                        <span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_translate_newlines</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">stderr</span><span class="p">:</span>
                        <span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_translate_newlines</span><span class="p">(</span><span class="n">stderr</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>

        <span class="c"># sys.version_info &gt;= (2, 6)</span>
        <span class="c">#We only patch 2.6.0 though, bump this if necessary</span>
        <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">_communicate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
                <span class="c">#This is _communicate of Python 2.6.0 + partial application of</span>
                <span class="c">#patch in 1068268</span>
                <span class="n">read_set</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">write_set</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">stdout</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># Return</span>
                <span class="n">stderr</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># Return</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="p">:</span>
                    <span class="c"># Flush stdio buffer.  This might block, if the user has</span>
                    <span class="c"># been writing to .stdin in an uncontrolled fashion.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">input</span><span class="p">:</span>
                        <span class="n">write_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
                    <span class="n">read_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
                    <span class="n">stdout</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">:</span>
                    <span class="n">read_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                    <span class="n">stderr</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="n">input_offset</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="n">read_set</span> <span class="ow">or</span> <span class="n">write_set</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">rlist</span><span class="p">,</span> <span class="n">wlist</span><span class="p">,</span> <span class="n">xlist</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">read_set</span><span class="p">,</span> <span class="n">write_set</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="k">except</span> <span class="n">select</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EINTR</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">raise</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span> <span class="ow">in</span> <span class="n">wlist</span><span class="p">:</span>
                        <span class="c"># When select has indicated that the file is writable,</span>
                        <span class="c"># we can write up to PIPE_BUF bytes without risk</span>
                        <span class="c"># blocking.  POSIX defines PIPE_BUF &gt;= 512</span>
                        <span class="n">chunk</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="n">input_offset</span> <span class="p">:</span> <span class="n">input_offset</span> <span class="o">+</span> <span class="mi">512</span><span class="p">]</span>
                        <span class="c">#MOD - 1068268</span>
                        <span class="n">bytes_written</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_no_intr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span>
                                <span class="n">chunk</span><span class="p">)</span>
                        <span class="c">#END MOD</span>
                        <span class="n">input_offset</span> <span class="o">+=</span> <span class="n">bytes_written</span>
                        <span class="k">if</span> <span class="n">input_offset</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                            <span class="n">write_set</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdin</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span> <span class="ow">in</span> <span class="n">rlist</span><span class="p">:</span>
                        <span class="c">#MOD - 1068268</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_no_intr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mi">1024</span><span class="p">)</span>
                        <span class="c">#END MOD</span>
                        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                            <span class="n">read_set</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
                        <span class="n">stdout</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span> <span class="ow">in</span> <span class="n">rlist</span><span class="p">:</span>
                        <span class="c">#MOD - 1068268</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_no_intr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mi">1024</span><span class="p">)</span>
                        <span class="c">#END MOD</span>
                        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                            <span class="n">read_set</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                        <span class="n">stderr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

                <span class="c"># All data exchanged.  Translate lists into strings.</span>
                <span class="k">if</span> <span class="n">stdout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">stdout</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">stderr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">stderr</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stderr</span><span class="p">)</span>

                <span class="c"># Translate newlines, if requested.  We cannot let the file</span>
                <span class="c"># object do the translation: It is based on stdio, which is</span>
                <span class="c"># impossible to combine with select (unless forcing no</span>
                <span class="c"># buffering).</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">universal_newlines</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="s">&#39;newlines&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">stdout</span><span class="p">:</span>
                        <span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_translate_newlines</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">stderr</span><span class="p">:</span>
                        <span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_translate_newlines</span><span class="p">(</span><span class="n">stderr</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>



        <span class="k">def</span> <span class="nf">_execute_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">executable</span><span class="p">,</span> <span class="n">preexec_fn</span><span class="p">,</span> <span class="n">close_fds</span><span class="p">,</span>
                           <span class="n">cwd</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">universal_newlines</span><span class="p">,</span>
                           <span class="n">startupinfo</span><span class="p">,</span> <span class="n">creationflags</span><span class="p">,</span> <span class="n">shell</span><span class="p">,</span>
                           <span class="n">p2cread</span><span class="p">,</span> <span class="n">p2cwrite</span><span class="p">,</span>
                           <span class="n">c2pread</span><span class="p">,</span> <span class="n">c2pwrite</span><span class="p">,</span>
                           <span class="n">errread</span><span class="p">,</span> <span class="n">errwrite</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Execute program (POSIX version)&quot;&quot;&quot;</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">StringTypes</span><span class="p">):</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">shell</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;/bin/sh&quot;</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span>

            <span class="k">if</span> <span class="n">executable</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">executable</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c"># For transferring possible exec failure from child to parent</span>
            <span class="c"># The first char specifies the exception type: 0 means</span>
            <span class="c"># OSError, 1 means some other error.</span>
            <span class="n">errpipe_read</span><span class="p">,</span> <span class="n">errpipe_write</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pipe</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_cloexec_flag</span><span class="p">(</span><span class="n">errpipe_write</span><span class="p">)</span>

            <span class="n">gc_was_enabled</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">isenabled</span><span class="p">()</span>
            <span class="c"># Disable gc to avoid bug where gc -&gt; file_dealloc -&gt;</span>
            <span class="c"># write to stderr -&gt; hang.  http://bugs.python.org/issue1336</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">gc_was_enabled</span><span class="p">:</span>
                    <span class="n">gc</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>
                <span class="k">raise</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_child_created</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c"># Child</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c"># Close parent&#39;s pipe ends</span>
                    <span class="k">if</span> <span class="n">p2cwrite</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">p2cwrite</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">c2pread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">c2pread</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">errread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">errread</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">errpipe_read</span><span class="p">)</span>

                    <span class="c"># Dup fds for child</span>
                    <span class="k">if</span> <span class="n">p2cread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">p2cread</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">c2pwrite</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">c2pwrite</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">errwrite</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">errwrite</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

                    <span class="c"># Close pipe fds.  Make sure we don&#39;t close the same</span>
                    <span class="c"># fd more than once, or standard fds.</span>
                    <span class="k">if</span> <span class="n">p2cread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">p2cread</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">p2cread</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">c2pwrite</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">c2pwrite</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">p2cread</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">c2pwrite</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">errwrite</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">errwrite</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">p2cread</span><span class="p">,</span> <span class="n">c2pwrite</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">errwrite</span><span class="p">)</span>

                    <span class="c"># Close all other fds, if asked for</span>
                    <span class="k">if</span> <span class="n">close_fds</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_close_fds</span><span class="p">(</span><span class="n">but</span><span class="o">=</span><span class="n">errpipe_write</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">cwd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">preexec_fn</span><span class="p">:</span>
                        <span class="n">preexec_fn</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">execvp</span><span class="p">(</span><span class="n">executable</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">execvpe</span><span class="p">(</span><span class="n">executable</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>

                <span class="k">except</span><span class="p">:</span>
                    <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
                    <span class="c"># Save the traceback and attach it to the exception object</span>
                    <span class="n">exc_lines</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span>
                                                           <span class="n">exc_value</span><span class="p">,</span>
                                                           <span class="n">tb</span><span class="p">)</span>
                    <span class="n">exc_value</span><span class="o">.</span><span class="n">child_traceback</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exc_lines</span><span class="p">)</span>
                    <span class="c">#MOD - 1068268</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_write_no_intr</span><span class="p">(</span><span class="n">errpipe_write</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">exc_value</span><span class="p">))</span>
                    <span class="c">#END MOD</span>

                <span class="c"># This exitcode won&#39;t be reported to applications, so it</span>
                <span class="c"># really doesn&#39;t matter what we return.</span>
                <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>

            <span class="c"># Parent</span>
            <span class="k">if</span> <span class="n">gc_was_enabled</span><span class="p">:</span>
                <span class="n">gc</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">errpipe_write</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p2cread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">p2cwrite</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">p2cread</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c2pwrite</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">c2pread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">c2pwrite</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">errwrite</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">errread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">errwrite</span><span class="p">)</span>

            <span class="c"># Wait for exec to fail or succeed; possibly raising exception</span>
            <span class="c">#MOD - 1068268</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_no_intr</span><span class="p">(</span><span class="n">errpipe_read</span><span class="p">,</span> <span class="mi">1048576</span><span class="p">)</span> <span class="c"># Exceptions limited to 1 MB</span>
            <span class="c">#END MOD</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">errpipe_read</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
                <span class="c">#MOD - 1068268</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_waitpid_no_intr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="c">#END MOD</span>
                <span class="n">child_exception</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">child_exception</span>

        <span class="k">def</span> <span class="nf">_fixed_poll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_deadstate</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Check if child process has terminated.  Returns returncode</span>
<span class="sd">            attribute.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c">#MOD - 1068268</span>
                    <span class="n">pid</span><span class="p">,</span> <span class="n">sts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_waitpid_no_intr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">WNOHANG</span><span class="p">)</span>
                    <span class="c">#END MOD</span>
                    <span class="k">if</span> <span class="n">pid</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_handle_exitstatus</span><span class="p">(</span><span class="n">sts</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">os</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">_deadstate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="n">_deadstate</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span>

        <span class="c">#poll became _internal_poll in 2.6</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
            <span class="n">_internal_poll</span> <span class="o">=</span> <span class="n">_fixed_poll</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">poll</span> <span class="o">=</span> <span class="n">_fixed_poll</span>

        <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Wait for child process to terminate.  Returns returncode</span>
<span class="sd">            attribute.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c">#MOD - 1068268</span>
                <span class="n">pid</span><span class="p">,</span> <span class="n">sts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_waitpid_no_intr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="c">#END MOD</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_handle_exitstatus</span><span class="p">(</span><span class="n">sts</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span>

        <span class="k">def</span> <span class="nf">_read_no_intr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">buffersize</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Like os.read, but retries on EINTR&quot;&quot;&quot;</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buffersize</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EINTR</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span>


        <span class="k">def</span> <span class="nf">_write_no_intr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Like os.write, but retries on EINTR&quot;&quot;&quot;</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EINTR</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span>

        <span class="k">def</span> <span class="nf">_waitpid_no_intr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Like os.waitpid, but retries on EINTR&quot;&quot;&quot;</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">waitpid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EINTR</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span>

        <span class="k">def</span> <span class="nf">_fo_read_no_intr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Like obj.read(), but retries on EINTR&quot;&quot;&quot;</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">IOError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EINTR</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span>

        <span class="k">def</span> <span class="nf">_fo_write_no_intr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Like obj.write(), but retries on EINTR&quot;&quot;&quot;</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">IOError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EINTR</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
    <span class="c">#Add terminate() and kill() as introduced in Python2.6</span>
    <span class="kn">import</span> <span class="nn">signal</span>
    <span class="k">class</span> <span class="nc">SafePopen</span><span class="p">(</span><span class="n">SafePopen</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;win&#39;</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">send_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">):</span>
                <span class="sd">&#39;&#39;&#39;Send a signal to the process&#39;&#39;&#39;</span>
                <span class="k">if</span> <span class="n">sig</span> <span class="o">==</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Only SIGTERM is supported on Windows&#39;</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="sd">&#39;&#39;&#39;Terminate the process&#39;&#39;&#39;</span>
                <span class="kn">from</span> <span class="nn">_subprocess</span> <span class="kn">import</span> <span class="n">TerminateProcess</span>
                <span class="n">TerminateProcess</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">kill</span> <span class="o">=</span> <span class="n">terminate</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">send_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">):</span>
                <span class="sd">&#39;&#39;&#39;Send a signal to the process&#39;&#39;&#39;</span>
                <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">sig</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="sd">&#39;&#39;&#39;Terminate the process with SIGTERM&#39;&#39;&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="sd">&#39;&#39;&#39;Kill the process with SIGKILL&#39;&#39;&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGKILL</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_safe_subprocess</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Create a L{subprocess.Popen} object in a safe way</span>

<span class="sd">    This function will disable all threaded log targets before creating the</span>
<span class="sd">    subprocess (which forks, introducing lots of troubles in threaded</span>
<span class="sd">    application), and re-enable these log targets afterwards.</span>

<span class="sd">    The arguments provided to this method are copied verbatim to the</span>
<span class="sd">    L{subprocess.Popen} constructor.</span>

<span class="sd">    @see: L{subprocess.Popen}</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c">#Close all threaded log targets before creating a subprocess, which forks</span>
    <span class="c">##from JumpScale.core.log.LogTargets import ThreadedLogTarget</span>
    <span class="c">##ThreadedLogTarget.disable_all_instances(close=True)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c">#Make sure we re-enable logging, even when subprocess creation fails</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">SafePopen</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c">#Re-enable afterwards</span>
        <span class="c">##ThreadedLogTarget.enable_all_instances()</span>
        <span class="k">pass</span>

    <span class="k">return</span> <span class="n">process</span>


<span class="k">def</span> <span class="nf">_convert_uid_gid</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Convert a given user and/or group to the UID/GID</span>

<span class="sd">    This function calculates UID and GID of a given user and/or group name or</span>
<span class="sd">    ID, performing several sanity checks on the provided values and system</span>
<span class="sd">    environment.</span>

<span class="sd">    This function is used by runDaemon and executeAsUser. If it returns without</span>
<span class="sd">    exceptions, there&#39;s a rather big chance setuid/setgid will work fine.</span>

<span class="sd">    @param user: Username or UID of user to setuid() to</span>
<span class="sd">    @type user: string or number</span>
<span class="sd">    @param group: Groupname of GID of group to setgid() to</span>
<span class="sd">    @type group: string or number</span>

<span class="sd">    @returns: Calculated UID and GID</span>
<span class="sd">    @rtype: tuple&lt;number, number&gt;</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_convert</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">idname</span><span class="p">,</span> <span class="n">setfunc</span><span class="p">,</span> <span class="n">namfunc</span><span class="p">,</span> <span class="n">idfield</span><span class="p">,</span> <span class="n">idfunc</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Convert a given name of ID to a system ID, validating all input</span>

<span class="sd">        The returned value will be C{None} if user or group is not given.</span>

<span class="sd">        @param value: Name or ID of the user/group to lookup</span>
<span class="sd">        @type value: string or number</span>
<span class="sd">        @param name: Human-readable name of the object type to lookup, &#39;user&#39;</span>
<span class="sd">                     or &#39;group&#39;</span>
<span class="sd">        @type name: string</span>
<span class="sd">        @param idname: Human-readable name of the resulting ID, &#39;UID&#39; or &#39;GID&#39;</span>
<span class="sd">        @type idname: string</span>
<span class="sd">        @param setfunc: Name of the function (attribute of the &#39;os&#39; module)</span>
<span class="sd">                        used to switch to the desired system ID, &#39;setuid&#39; or</span>
<span class="sd">                        &#39;setgid&#39;</span>
<span class="sd">        @type setfunc: string</span>
<span class="sd">        @param namfunc: Function used to retrieve information of a system</span>
<span class="sd">                        object based on its name, pwd.getpwnam or grp.getgrnam</span>
<span class="sd">        @type namfunc: callable</span>
<span class="sd">        @param idfield: Name of the attribute of the value returned by</span>
<span class="sd">                        C{namfunc} containing the ID, &#39;pw_uid&#39; or &#39;gr_gid&#39;</span>
<span class="sd">        @type idfield: string</span>
<span class="sd">        @param idfunc: Function used to retrieve information of a system</span>
<span class="sd">                       object based on its name, pwd.getpwuid or grp.getgruid</span>
<span class="sd">        @type idfunc: callable</span>

<span class="sd">        @returns: ID of the given system object name</span>
<span class="sd">        @rtuple: number</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c"># Used in some exception strings</span>
        <span class="n">cname</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>

        <span class="c"># Validation: does os.set*id exist?</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">setfunc</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> provided but </span><span class="si">%s</span><span class="s">() not available on &#39;</span>
                               <span class="s">&#39;this platform&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cname</span><span class="p">,</span> <span class="n">setfunc</span><span class="p">))</span>

        <span class="c"># We want to make sure we&#39;re running as root. This requires os.getuid</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;getuid&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;No getuid() available on this platform&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> argument only supported when running &#39;</span>
                             <span class="s">&#39;as root&#39;</span> <span class="o">%</span> <span class="n">cname</span><span class="p">)</span>

        <span class="c"># If the given value is not a string, assume its a *ID</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">id_</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c"># Lookup object information</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">namfunc</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="c"># And retrieve the *ID field</span>
                <span class="n">id_</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">idfield</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="c"># Unless the object can&#39;t be found</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Unknown </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

        <span class="c"># Make sure we&#39;re really using an integer</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">id_</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Provided </span><span class="si">%s</span><span class="s"> should be a number&#39;</span> <span class="o">%</span> <span class="n">idname</span><span class="p">)</span>

        <span class="c"># Check whether there&#39;s a reverse mapping of the *ID to a system object</span>
        <span class="c"># We don&#39;t want people to use *IDs of unknown system objects</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">idfunc</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Invalid </span><span class="si">%s</span><span class="s"> </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">idname</span><span class="p">,</span> <span class="n">id_</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">id_</span>

    <span class="c"># Calculate UID</span>
    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">pwd</span>

        <span class="n">uid</span> <span class="o">=</span> <span class="n">_convert</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">,</span> <span class="s">&#39;UID&#39;</span><span class="p">,</span> <span class="s">&#39;setuid&#39;</span><span class="p">,</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwnam</span><span class="p">,</span> <span class="s">&#39;pw_uid&#39;</span><span class="p">,</span>
                        <span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">)</span>

    <span class="c"># Calculate GID</span>
    <span class="k">if</span> <span class="n">group</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">grp</span>

        <span class="n">gid</span> <span class="o">=</span> <span class="n">_convert</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="s">&#39;group&#39;</span><span class="p">,</span> <span class="s">&#39;GID&#39;</span><span class="p">,</span> <span class="s">&#39;setgid&#39;</span><span class="p">,</span> <span class="n">grp</span><span class="o">.</span><span class="n">getgrnam</span><span class="p">,</span> <span class="s">&#39;gr_gid&#39;</span><span class="p">,</span>
                        <span class="n">grp</span><span class="o">.</span><span class="n">getgrgid</span><span class="p">)</span>

    <span class="c"># Return them</span>
    <span class="k">return</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span>


<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">commandline</span><span class="p">,</span> <span class="n">showOutput</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">captureOutput</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">maxSeconds</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<div class="viewcode-block" id="run"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.run">[docs]</a>        <span class="n">stopOnError</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Execute a command and wait for its termination</span>

<span class="sd">    This function spawns a subprocess which executes the given command line in a</span>
<span class="sd">    subshell. The function waits for the spawned process to terminate, or until</span>
<span class="sd">    a time period of maxSeconds was exceeded.</span>

<span class="sd">    When showOutput is set to True, stdin, stderr and stdout handles of the</span>
<span class="sd">    subprocess are bound to the handles of the calling process. This can be used</span>
<span class="sd">    to run interactive commands.</span>

<span class="sd">    Both showOutput and captureOutput can&#39;t be True at the same time.</span>

<span class="sd">    Any extra keyword arguments are passed to L{subprocess.Popen}. These</span>
<span class="sd">    arguments can overwrite any argument set by this function, so setting any of</span>
<span class="sd">    the arguments used by this function (including C{stdin}, C{stdout},</span>
<span class="sd">    C{stderr}, C{env}, C{shell} and C{preexec_fn}) can change the behavior</span>
<span class="sd">    of this function. This could e.g. be used to set C{cwd}.</span>

<span class="sd">    The exit code contained in the returned tuple is the exit code of the</span>
<span class="sd">    spawned process if equal to or larger than 0. If the subprocess was killed</span>
<span class="sd">    while running, the exit code will be -1. If the process was stopped because</span>
<span class="sd">    maxSeconds was exceeded, an exit code equal to -2 will be returned.</span>

<span class="sd">    If user or group is defined (as name of number), the process will</span>
<span class="sd">    setuid/setgid to this user and group before executing the command line,</span>
<span class="sd">    effectively running the child process with the privileges of the provided</span>
<span class="sd">    user and group.</span>

<span class="sd">    Remarks:</span>
<span class="sd">     * Don&#39;t use the &#39;&amp;&#39; shell operator to run a process in the background, use</span>
<span class="sd">       the startDaemon function instead</span>
<span class="sd">     * Shell operators including pipes and redirects are allowed in the</span>
<span class="sd">       command line string</span>
<span class="sd">     * When spawning processes which generate large amounts of output, make sure</span>
<span class="sd">       you set captureOutput to False, otherwise too much data will be buffered</span>
<span class="sd">       in memory</span>
<span class="sd">     * If captureOutput is set to False, the values of stdout and stderr in the</span>
<span class="sd">       return value will be empty strings</span>
<span class="sd">     * If stopOnError is set to True, the calling process will exit with exit</span>
<span class="sd">       code 44 if the child process returned a non-zero exit code, or 45 if the</span>
<span class="sd">       child process exceeds maxSeconds</span>

<span class="sd">    @param commandline: Command line string to execute</span>
<span class="sd">    @type commandline: string</span>
<span class="sd">    @param showOutput: Bind stdin/stdout/stderr to parent process</span>
<span class="sd">    @type showOutput: bool</span>
<span class="sd">    @param captureOutput: Capture generated output</span>
<span class="sd">    @type captureOutput: bool</span>
<span class="sd">    @param maxSeconds: Maximum number of seconds the subprocess should be</span>
<span class="sd">                       allowed to run</span>
<span class="sd">    @type maxSeconds: number</span>
<span class="sd">    @param stopOnError: Quit the caller process when the subprocess fails</span>
<span class="sd">    @type stopOnError: bool</span>
<span class="sd">    @param user: Username or UID of user to setuid() to</span>
<span class="sd">    @type user: string or number</span>
<span class="sd">    @param group: Groupname of GID of group to setgid() to</span>
<span class="sd">    @type group: string or number</span>
<span class="sd">    @param kwargs: Extra arguments passed through to L{subprocess.Popen}</span>

<span class="sd">    @return: Tuple containing subprocess exitcode, stdout and stderr output</span>
<span class="sd">    @rtype: tuple(number, string, string)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">env</span> <span class="o">=</span>  <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;env&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c"># Calculate UID and GID t run as</span>
    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">group</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span> <span class="o">=</span> <span class="n">_convert_uid_gid</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>

        <span class="c"># Once we reached this point, we can be pretty sure the uid and gid</span>
        <span class="c"># variables can be passed to processhelper.py with only a slight</span>
        <span class="c"># chance of things going wrong in there</span>

        <span class="n">jumpscale_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">dirs</span><span class="o">.</span><span class="n">baseDir</span><span class="p">,</span> <span class="s">&#39;lib&#39;</span><span class="p">,</span> <span class="s">&#39;jumpscale&#39;</span><span class="p">,</span> <span class="s">&#39;core&#39;</span><span class="p">)</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">)</span>

        <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\&#39;</span><span class="s">from JumpScale.core.system.processhelper import main; main()</span><span class="se">\&#39;</span><span class="s">&#39;</span><span class="p">,</span> <span class="p">))</span>

        <span class="k">if</span> <span class="n">uid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="s">&#39;--uid&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">uid</span><span class="p">,</span> <span class="p">))</span>
        <span class="k">if</span> <span class="n">gid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="s">&#39;--gid&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">gid</span><span class="p">,</span> <span class="p">))</span>

        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">commandline</span><span class="p">)</span>

        <span class="n">commandline</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

        <span class="c"># TODO Do we want to cleanup the environment, eg HOME and USER?</span>
        <span class="c"># See Trac #165</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;PYTHONPATH&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">jumpscale_path</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">jumpscale_path</span>
        <span class="n">env</span><span class="p">[</span><span class="s">&#39;PYTHONPATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>

    <span class="k">return</span> <span class="n">_runWithEnv</span><span class="p">(</span><span class="n">commandline</span><span class="p">,</span> <span class="n">showOutput</span><span class="o">=</span><span class="n">showOutput</span><span class="p">,</span>
            <span class="n">captureOutput</span><span class="o">=</span><span class="n">captureOutput</span><span class="p">,</span> <span class="n">maxSeconds</span><span class="o">=</span><span class="n">maxSeconds</span><span class="p">,</span>
            <span class="n">stopOnError</span><span class="o">=</span><span class="n">stopOnError</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_runWithEnv</span><span class="p">(</span><span class="n">commandline</span><span class="p">,</span> <span class="n">showOutput</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">captureOutput</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">maxSeconds</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span></div>
        <span class="n">stopOnError</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Execute a command and wait for its termination</span>

<span class="sd">    This method provides the same functionality as L{run}, but also allows a</span>
<span class="sd">    caller to provide an environment dictionary. If this is L{None}, an empty</span>
<span class="sd">    environment will be used.</span>

<span class="sd">    @see: run</span>
<span class="sd">    @param env: Environment to run the subprocess in</span>
<span class="sd">    @type env: dict</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c">#This list will contain callables executed at the end to clean up everything</span>
    <span class="c">#where necessary, eg closing file descriptors</span>
    <span class="n">cleanup</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="c">#Did we have to kill the subprocess (because maxSeconds timed out?)</span>
    <span class="n">killed</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">if</span> <span class="n">captureOutput</span> <span class="ow">and</span> <span class="n">showOutput</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;captureOutput and showOutput are mutually exclusive&#39;</span><span class="p">)</span>

    <span class="n">j</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="s">&#39;system.process.start &quot;</span><span class="si">%s</span><span class="s">&quot; maxSeconds=</span><span class="si">%d</span><span class="s"> stopOnError=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> \
            <span class="p">(</span><span class="n">commandline</span><span class="p">,</span> <span class="n">maxSeconds</span><span class="p">,</span> <span class="n">stopOnError</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">captureOutput</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">showOutput</span><span class="p">:</span>
        <span class="n">stdin</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">stdout</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>
        <span class="n">stderr</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>
    <span class="k">elif</span> <span class="n">showOutput</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">captureOutput</span><span class="p">:</span>
        <span class="n">stdin</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span>
        <span class="n">stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="n">stderr</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">showOutput</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">captureOutput</span><span class="p">:</span>
        <span class="c">#There&#39;s no place like devnull</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;devnull&#39;</span><span class="p">,</span> \
                <span class="s">&#39;nul&#39;</span> <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">platformtype</span><span class="o">.</span><span class="n">isWindows</span><span class="p">()</span> <span class="k">else</span> <span class="s">&#39;/dev/null&#39;</span><span class="p">),</span>
                <span class="s">&#39;rw&#39;</span><span class="p">)</span>
        <span class="n">stdin</span> <span class="o">=</span> <span class="n">stdout</span> <span class="o">=</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">fd</span>

        <span class="k">def</span> <span class="nf">cleanup_fd</span><span class="p">():</span>
            <span class="n">fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">cleanup</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cleanup_fd</span><span class="p">)</span>

    <span class="c"># Set up the arguments we want...</span>
    <span class="n">subprocess_kwargs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;stdin&#39;</span><span class="p">:</span> <span class="n">stdin</span><span class="p">,</span>
        <span class="s">&#39;stdout&#39;</span><span class="p">:</span> <span class="n">stdout</span><span class="p">,</span>
        <span class="s">&#39;stderr&#39;</span><span class="p">:</span> <span class="n">stderr</span><span class="p">,</span>
        <span class="s">&#39;shell&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="s">&#39;env&#39;</span><span class="p">:</span> <span class="n">env</span><span class="p">,</span>
        <span class="s">&#39;close_fds&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">mswindows</span><span class="p">:</span>
        <span class="c"># Reset all signals before calling execlp but after forking. This</span>
        <span class="c"># fixes Python issue 1652 (http://bugs.python.org/issue1652) and</span>
        <span class="c"># jumpscale ticket 189</span>
        <span class="k">def</span> <span class="nf">reset_signals</span><span class="p">():</span>
            <span class="sd">&#39;&#39;&#39;Reset all signals to SIG_DFL&#39;&#39;&#39;</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">NSIG</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">signal</span><span class="o">.</span><span class="n">getsignal</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIG_DFL</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIG_DFL</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                        <span class="c"># Skip, can&#39;t set this signal</span>
                        <span class="k">pass</span>

        <span class="n">subprocess_kwargs</span><span class="p">[</span><span class="s">&#39;preexec_fn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reset_signals</span>

    <span class="c"># ... and overwrite with user-provided</span>
    <span class="n">subprocess_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">process</span> <span class="o">=</span> <span class="n">_safe_subprocess</span><span class="p">(</span><span class="n">commandline</span><span class="p">,</span> <span class="o">**</span><span class="n">subprocess_kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">maxSeconds</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">captureOutput</span><span class="p">:</span>
            <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">err</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

        <span class="n">code</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span> <span class="c">#maxSeconds set</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c">#Use maxSeconds - 1 to make sure the function actually waits only</span>
        <span class="c">#maxSeconds. If maxSeconds &lt;= 1, use maxSeconds.</span>
        <span class="n">timediff</span> <span class="o">=</span> <span class="n">maxSeconds</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">maxSeconds</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">maxSeconds</span>
        <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="n">timediff</span> <span class="ow">and</span> <span class="n">process</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c">#Wait 0.1 seconds between subprocess polling during the first 3</span>
            <span class="c">#seconds the process runs. Bump this polling interval to 1s when</span>
            <span class="c">#this threshold is reached.</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c">#Child is still running, kill it</span>
            <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">platformtype</span><span class="o">.</span><span class="n">isUnix</span><span class="p">():</span>
                <span class="c">#Soft and hard kill on Unix</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                    <span class="c">#Give the process some time to settle</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
                    <span class="n">process</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c">#Kill on anything else</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">poll</span><span class="p">():</span>
                    <span class="n">process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>

            <span class="n">killed</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">captureOutput</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">killed</span><span class="p">:</span>
            <span class="c">#Subprocess stopped in-time, let&#39;s read the output</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">captureOutput</span> <span class="ow">and</span> <span class="n">killed</span><span class="p">:</span>
            <span class="c">#Subprocess had to be killed. This causes funny situations if we&#39;d</span>
            <span class="c">#want to read the output streams now (blocking read hangs the</span>
            <span class="c">#application, whilst the intermediate shell goes into zombie mode,</span>
            <span class="c">#fun).</span>

            <span class="c">#Read out process streams, but don&#39;t block</span>
            <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">platformtype</span><span class="o">.</span><span class="n">isUnix</span><span class="p">():</span>
                <span class="k">def</span> <span class="nf">readout</span><span class="p">(</span><span class="n">stream</span><span class="p">):</span>
                    <span class="c">#Non-blocking, safe UNIX-style stream readout</span>
                    <span class="kn">import</span> <span class="nn">fcntl</span>
                    <span class="kn">import</span> <span class="nn">select</span>
                    <span class="c">#Store original flags</span>
                    <span class="n">flags</span> <span class="o">=</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">fcntl</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">F_GETFL</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">stream</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
                        <span class="c">#Set non-blocking</span>
                        <span class="n">fcntl</span><span class="o">.</span><span class="n">fcntl</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">F_SETFL</span><span class="p">,</span>
                                <span class="n">flags</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_NONBLOCK</span><span class="p">)</span>

                    <span class="c">#Store all intermediate data</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                            <span class="c">#Check whether more data is available</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">stream</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                                <span class="c">#If not, kthxbye</span>
                                <span class="k">break</span>

                            <span class="c">#Read out all available data</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                                <span class="k">break</span>

                            <span class="c">#Honour subprocess univeral_newlines</span>
                            <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">universal_newlines</span><span class="p">:</span>
                                <span class="n">line</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">_translate_newlines</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                            <span class="c">#Add data to cache</span>
                            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                    <span class="k">finally</span><span class="p">:</span>
                        <span class="c">#Don&#39;t forget to reset stream flags</span>
                        <span class="c">#Although normally the stream won&#39;t ever be used after</span>
                        <span class="c">#this</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">stream</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
                            <span class="n">fcntl</span><span class="o">.</span><span class="n">fcntl</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">F_SETFL</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>

                    <span class="c">#Fold cache and return</span>
                    <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c">#This is not UNIX, most likely Win32. read() seems to work</span>
                <span class="k">def</span> <span class="nf">readout</span><span class="p">(</span><span class="n">stream</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

            <span class="n">out</span> <span class="o">=</span> <span class="n">readout</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">readout</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">err</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

        <span class="n">code</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span>
        <span class="n">code</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="k">if</span> <span class="n">killed</span> <span class="k">else</span> <span class="n">code</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>

    <span class="c">#Run cleanup callables</span>
    <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">cleanup</span><span class="p">:</span>
        <span class="n">func</span><span class="p">()</span>

    <span class="n">j</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#39;system.process.run ended, exitcode was </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> \
            <span class="n">ret</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">j</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#39;system.process.run stdout:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">ret</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">7</span><span class="p">)</span>
    <span class="n">j</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#39;system.process.run stderr:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">ret</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">7</span><span class="p">)</span>

    <span class="c">#45 first, since -2 != 0</span>
    <span class="k">if</span> <span class="n">stopOnError</span> <span class="ow">and</span> <span class="n">killed</span><span class="p">:</span>
        <span class="n">j</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="s">&#39;system.process.start had to kill the subprocess&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">stopOnError</span> <span class="ow">and</span> <span class="n">ret</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">j</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#39;system.process.start subprocess failed&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">44</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">runScript</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="n">showOutput</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">captureOutput</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">maxSeconds</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<div class="viewcode-block" id="runScript"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.runScript">[docs]</a>        <span class="n">stopOnError</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Execute a Python script</span>

<span class="sd">    This function executes a Python script, making sure the script output will</span>
<span class="sd">    not be buffered.</span>

<span class="sd">    For an overview of the parameters and function behaviour, see the</span>
<span class="sd">    documentation of L{jumpscale.system.process.run}.</span>

<span class="sd">    @param script: Script to execute</span>
<span class="sd">    @type script: string</span>

<span class="sd">    @return: Tuple containing subprocess exitcode, stdout and stderr output</span>
<span class="sd">    @rtype: tuple(number, string, string)</span>

<span class="sd">    @raise ValueError: Script is not an existing file</span>

<span class="sd">    @see: jumpscale.system.process.run</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">isFile</span><span class="p">(</span><span class="n">script</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Unable to execute </span><span class="si">%s</span><span class="s">: not an existing file&#39;</span> <span class="o">%</span> <span class="n">script</span><span class="p">)</span>

    <span class="n">cmdline</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> -u &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="n">script</span><span class="p">)</span>
    <span class="n">j</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#39;Executing script: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">cmdline</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">run</span><span class="p">(</span><span class="n">cmdline</span><span class="p">,</span> <span class="n">showOutput</span><span class="o">=</span><span class="n">showOutput</span><span class="p">,</span> <span class="n">captureOutput</span><span class="o">=</span><span class="n">captureOutput</span><span class="p">,</span>
            <span class="n">maxSeconds</span><span class="o">=</span><span class="n">maxSeconds</span><span class="p">,</span> <span class="n">stopOnError</span><span class="o">=</span><span class="n">stopOnError</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">runDaemon</span><span class="p">(</span><span class="n">commandline</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span></div>
<div class="viewcode-block" id="runDaemon"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.runDaemon">[docs]</a>              <span class="n">env</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Run an application as a background process</span>

<span class="sd">    This function will execute the given commandline decoupled from the host</span>
<span class="sd">    process by forking first. The stdout and stderr streams of the spawned</span>
<span class="sd">    application can be redirected to files.</span>

<span class="sd">    This can be compared to using</span>

<span class="sd">        nohup myapplication -u -b 1 &amp;</span>

<span class="sd">    in a Bash shell.</span>

<span class="sd">    If no stdout or stderr paths are provided, those streams are ignored.</span>

<span class="sd">    If user or group is defined (as name of number), the daemon process will</span>
<span class="sd">    setuid/setgid to this user and group before executing the child process,</span>
<span class="sd">    effectively running the daemon process with the privileges of the provided</span>
<span class="sd">    user and group.</span>

<span class="sd">    If C{env} is provided, it will be used as environment in which the daemon</span>
<span class="sd">    process will be executed. If it is not set, C{os.environ} will be used. Do</span>
<span class="sd">    note C{PYTHONUNBUFFERED} and C{PYTHONPATH} will be slightly altered (in a</span>
<span class="sd">    copy of the provided dictionary) by this function before spawning the</span>
<span class="sd">    daemon process.</span>

<span class="sd">    @param commandline: Command line string to execute</span>
<span class="sd">    @type commandline: string</span>
<span class="sd">    @param stdout: Path to file to redirect stdout</span>
<span class="sd">    @type stdout: string</span>
<span class="sd">    @param stderr: Path to file to redirect stderr</span>
<span class="sd">    @type stderr: string</span>
<span class="sd">    @param user: Username or UID of user to setuid() to</span>
<span class="sd">    @type user: string or number</span>
<span class="sd">    @param group: Groupname of GID of group to setgid() to</span>
<span class="sd">    @type group: string or number</span>
<span class="sd">    @param env: Environment settings for the daemon</span>
<span class="sd">    @type env: dict</span>

<span class="sd">    @return: PID of the daemonized process</span>
<span class="sd">    @rtype: number</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">logmessage</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">logmessage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;Running command </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> as daemon process&#39;</span> <span class="o">%</span> <span class="n">commandline</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">stdout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">logmessage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;redirecting stdout to </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">stdout</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">stderr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">logmessage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;redirecting stderr to </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">stderr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">logmessage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;setuid to user </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">group</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">logmessage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;setgid to group </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">group</span><span class="p">))</span>
    <span class="n">logmessage</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logmessage</span><span class="p">)</span>
    <span class="n">j</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">logmessage</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

    <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span> <span class="o">=</span> <span class="n">_convert_uid_gid</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>

    <span class="c"># Once we reached this point, we can be pretty sure the uid and gid</span>
    <span class="c"># variables can be passed to processhelper.py with only a slight chance of</span>
    <span class="c"># things going wrong in there</span>

    <span class="n">jumpscale_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">dirs</span><span class="o">.</span><span class="n">baseDir</span><span class="p">,</span> <span class="s">&#39;lib&#39;</span><span class="p">,</span> <span class="s">&#39;jumpscale&#39;</span><span class="p">,</span> <span class="s">&#39;core&#39;</span><span class="p">)</span>

    <span class="n">cmd</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">)</span>

    <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\&#39;</span><span class="s">from JumpScale.core.system.processhelper import main; main()</span><span class="se">\&#39;</span><span class="s">&#39;</span><span class="p">,</span> <span class="p">))</span>

    <span class="k">if</span> <span class="n">stdout</span><span class="p">:</span>
        <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">createDir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">stdout</span><span class="p">))</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="s">&#39;--stdout&#39;</span><span class="p">,</span> <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">stdout</span><span class="p">,</span> <span class="p">))</span>
    <span class="k">if</span> <span class="n">stderr</span><span class="p">:</span>
        <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">createDir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">stderr</span><span class="p">))</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="s">&#39;--stderr&#39;</span><span class="p">,</span> <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">stderr</span><span class="p">,</span> <span class="p">))</span>

    <span class="k">if</span> <span class="n">uid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="s">&#39;--uid&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">uid</span><span class="p">,</span> <span class="p">))</span>
    <span class="k">if</span> <span class="n">gid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="s">&#39;--gid&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">gid</span><span class="p">,</span> <span class="p">))</span>

    <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;--daemonize&#39;</span><span class="p">)</span>

    <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;--&#39;</span><span class="p">)</span>
    <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">commandline</span><span class="p">)</span>

    <span class="n">cmd</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

    <span class="n">env</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">env</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">env</span><span class="p">[</span><span class="s">&#39;PYTHONUNBUFFERED&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;1&#39;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;PYTHONPATH&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">jumpscale_path</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">jumpscale_path</span>
    <span class="n">env</span><span class="p">[</span><span class="s">&#39;PYTHONPATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>

    <span class="n">code</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">_runWithEnv</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>

    <span class="n">processdata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>

    <span class="n">childpid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">processdata</span><span class="p">[</span><span class="s">&#39;CHILDPID&#39;</span><span class="p">])</span>

    <span class="n">logmessage</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">logmessage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;Started daemon process </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">commandline</span><span class="p">)</span>
    <span class="n">logmessage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;PID is </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">childpid</span><span class="p">)</span>
    <span class="k">if</span> <span class="s">&#39;UID&#39;</span> <span class="ow">in</span> <span class="n">processdata</span><span class="p">:</span>
        <span class="n">logmessage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;UID is </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">processdata</span><span class="p">[</span><span class="s">&#39;UID&#39;</span><span class="p">]))</span>
    <span class="k">if</span> <span class="s">&#39;GID&#39;</span> <span class="ow">in</span> <span class="n">processdata</span><span class="p">:</span>
        <span class="n">logmessage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;GID is </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">processdata</span><span class="p">[</span><span class="s">&#39;GID&#39;</span><span class="p">]))</span>
    <span class="n">logmessage</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logmessage</span><span class="p">)</span>
    <span class="n">j</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">logmessage</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">childpid</span>


<span class="k">class</span> <span class="nc">_Unset</span><span class="p">:</span></div>
    <span class="sd">&#39;&#39;&#39;Value used in L{calculateEnvironment} to remove an item from the output&#39;&#39;&#39;</span>

<span class="n">UNSET</span> <span class="o">=</span> <span class="n">_Unset</span><span class="p">()</span>
<span class="k">del</span> <span class="n">_Unset</span>

<span class="k">def</span> <span class="nf">calculateEnvironment</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
<div class="viewcode-block" id="calculateEnvironment"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.calculateEnvironment">[docs]</a>    <span class="sd">&#39;&#39;&#39;Merge new keys in an environment dict</span>

<span class="sd">    All key/value pairs in the C{values} dict will be merged into the C{source}</span>
<span class="sd">    dict, which defaults to the current environment values, C{os.environ}.</span>

<span class="sd">    If L{UNSET} is used as a value in C{values}, the value will be removed from</span>
<span class="sd">    the result.</span>

<span class="sd">    Sample usage:</span>

<span class="sd">        &gt;&gt;&gt; os_environ = {</span>
<span class="sd">        ...     &#39;PATH&#39;: &#39;/bin:/usr/bin&#39;,</span>
<span class="sd">        ...     &#39;USER&#39;: &#39;root&#39;,</span>
<span class="sd">        ...     &#39;PWD&#39;: &#39;/root&#39;,</span>
<span class="sd">        ... }</span>
<span class="sd">        &gt;&gt;&gt; myenv = {</span>
<span class="sd">        ...     &#39;USER&#39;: UNSET,</span>
<span class="sd">        ...     &#39;PWD&#39;: &#39;/tmp&#39;,</span>
<span class="sd">        ... }</span>
<span class="sd">        &gt;&gt;&gt; result = calculateEnvironment(myenv, os_environ)</span>
<span class="sd">        &gt;&gt;&gt; print result[&#39;PATH&#39;]</span>
<span class="sd">        /bin:/usr/bin</span>
<span class="sd">        &gt;&gt;&gt; print result[&#39;PWD&#39;]</span>
<span class="sd">        /tmp</span>
<span class="sd">        &gt;&gt;&gt; print &#39;USER&#39; in result</span>
<span class="sd">        False</span>

<span class="sd">    @param values: Values to merge into the environment</span>
<span class="sd">    @type values: dict</span>
<span class="sd">    @param source: Source environment, defaults to os.environ</span>
<span class="sd">    @type source: dict</span>

<span class="sd">    @return: Merged environment</span>
<span class="sd">    @rtype: dict</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">source</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">UNSET</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>


<span class="k">class</span> <span class="nc">SystemProcess</span><span class="p">:</span></div>
<div class="viewcode-block" id="SystemProcess"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.SystemProcess">[docs]</a>
    <span class="k">def</span> <span class="nf">executeWithoutPipe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">dieOnNonZeroExitCode</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">printCommandToStdout</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">outputToStdout</span> <span class="o">=</span> <span class="s">&quot;deprecatedArgument&quot;</span><span class="p">):</span>
<div class="viewcode-block" id="SystemProcess.executeWithoutPipe"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.SystemProcess.executeWithoutPipe">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        DEPRECATED, use system.process.executeAsync() instead, and call the wait() method of the returned object.</span>

<span class="sd">        Execute command without opening pipes, returns only the exitcode</span>
<span class="sd">        This is platform independent</span>
<span class="sd">        @param command: command to execute</span>
<span class="sd">        @param dieOnNonZeroExitCode: boolean to die if got non zero exitcode</span>
<span class="sd">        @param printCommandToStdout: boolean to show/hide output to stdout</span>
<span class="sd">        @param outputToStdout: Deprecated. Use &#39;printCommandToStdout&#39; instead.</span>
<span class="sd">        @rtype: integer represents the exitcode</span>
<span class="sd">        if exitcode is not zero then the executed command returned with errors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">j</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Using DEPRECATED method system.process.executeWithoutPipe(). Please use system.process.executeAsync() instead, and call the wait() method of the returned object.&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">outputToStdout</span> <span class="o">==</span> <span class="s">&quot;deprecatedArgument&quot;</span><span class="p">):</span>
            <span class="n">j</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;system.process.executeWithoutPipe called with deprecated argument &#39;outputToStdout&#39;. This paramater is deprecated because it is confusing: printing the output to StdOut is impossible when executing a command without piping. The argument indicates if the command itself should be written on screen and is therefore renamed to &#39;printCommandToStdout&#39;. Use this argument instead.&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">printCommandToStdout</span> <span class="o">=</span> <span class="n">outputToStdout</span>

        <span class="k">if</span> <span class="n">printCommandToStdout</span><span class="p">:</span>
            <span class="n">j</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;system.process.executeWithoutPipe [</span><span class="si">%s</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="n">command</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">j</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;system.process.executeWithoutPipe [</span><span class="si">%s</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="n">command</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">exitcode</span> <span class="o">!=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">dieOnNonZeroExitCode</span><span class="p">:</span>
            <span class="n">j</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;command: [</span><span class="si">%s</span><span class="s">]</span><span class="se">\n</span><span class="s">exitcode:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">exitcode</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Error during execution!</span><span class="se">\n</span><span class="s">Command: </span><span class="si">%s</span><span class="se">\n</span><span class="s">Exitcode: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">exitcode</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">exitcode</span>

    <span class="k">def</span> <span class="nf">executeAsync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">printCommandToStdout</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">redirectStreams</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">argsInCommand</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">useShell</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">outputToStdout</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span></div>
<div class="viewcode-block" id="SystemProcess.executeAsync"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.SystemProcess.executeAsync">[docs]</a>        <span class="sd">&quot;&quot;&quot; Execute command asynchronous. By default, the input, output and error streams of the command will be piped to the returned Popen object. Be sure to call commands that don&#39;t expect user input, or send input to the stdin parameter of the returning Popen object.</span>
<span class="sd">        @param command: Command to execute. (string)</span>
<span class="sd">        @param args: [Optional, [] by default] Arguments to be passed to the command. (Array of string)</span>
<span class="sd">        @param printCommandToStdOut: [Optional, False by default] Indicates if the command to be executed needs to be printed to screen. (boolean)</span>
<span class="sd">        @param redirectStreams: [Optional, True by default] Indicates if the input, output and error streams should be captured by the returned Popen object. If not, the output and input will be mixed with the streams of the calling process. (boolean)</span>
<span class="sd">        @param argsInCommand: [Optional, False by default] Indicates if the command-parameter contains command-line arguments.  If argsInCommand is False and args is not empty, the contents of args will be added to the command when executing.</span>
<span class="sd">        @param useShell: [Optional, False by default on Windows, True by default on Linux] Indicates if the command should be executed throug the shell.</span>
<span class="sd">        @return: If redirectStreams is true, this function returns a subprocess.Popen object representing the started process. Otherwise, it will return the pid-number of the started process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">useShell</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> <span class="c"># The default value depends on which platform we&#39;re using.</span>
            <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">platformtype</span><span class="o">.</span><span class="n">isUnix</span><span class="p">():</span>
                <span class="n">useShell</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">platformtype</span><span class="o">.</span><span class="n">isWindows</span><span class="p">():</span>
                <span class="n">useShell</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Platform not supported&quot;</span><span class="p">)</span>

        <span class="n">j</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;system.process.executeAsync [</span><span class="si">%s</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="n">command</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">printCommandToStdout</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;system.process.executeAsync [</span><span class="si">%s</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="n">command</span>

        <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">platformtype</span><span class="o">.</span><span class="n">isWindows</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">argsInCommand</span><span class="p">:</span>                
                <span class="n">cmd</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">list2cmdline</span><span class="p">([</span><span class="n">command</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="n">command</span>
                

            <span class="k">if</span> <span class="n">redirectStreams</span><span class="p">:</span> <span class="c"># Process will be started and the Popen object will be returned. The calling function can use this object to read or write to its pipes or to wait for completion.</span>
                <span class="n">retVal</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stdin</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">,</span> <span class="n">shell</span> <span class="o">=</span> <span class="n">useShell</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># Process will be started without inheriting handles. Subprocess doesn&#39;t offer functionality to accomplish this, so we implement it ourselves using the lowlevel win32.CreateProcess method.</span>
                <span class="c"># Example use-case: Image a vapp that contains a deamon that can be started using a control script, and we want to start this deamon after installation.</span>
                <span class="c">#                   In this case, we want to call the control script from the install script using system.process.execute to be able to capture the output of the control script.</span>
                <span class="c">#                   The control script in turn will start the daemon in an asynchronous way and is not interested in the output of the daemon.</span>
                <span class="c">#                   If we would use the subprocess.Popen object to start the daemon in the control script, the stdout pipe of the control script will be inherited by the daemon,</span>
                <span class="c">#                   it will not be closed before the control script AND the daemon have ended both, so the install script will stay listening on the stdout pipe as long as it exists and the system.process.execute() method will not return until the daemon ends.</span>
                <span class="kn">from</span> <span class="nn">win32process</span> <span class="kn">import</span> <span class="n">CreateProcess</span><span class="p">,</span> <span class="n">STARTUPINFO</span><span class="p">,</span> <span class="n">STARTF_USESHOWWINDOW</span>
                <span class="kn">from</span> <span class="nn">win32con</span> <span class="kn">import</span> <span class="n">SW_HIDE</span>
                <span class="n">sui</span> <span class="o">=</span> <span class="n">STARTUPINFO</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">useShell</span><span class="p">:</span> <span class="c"># 4 lines below are copied from subprocess.Popen._execute_child().  (Code for Win9x is omitted as we only support WinXP and higher.)</span>
                    <span class="n">sui</span><span class="o">.</span><span class="n">dwFlags</span> <span class="o">|=</span> <span class="n">STARTF_USESHOWWINDOW</span>
                    <span class="n">sui</span><span class="o">.</span><span class="n">wShowWindow</span> <span class="o">=</span> <span class="n">SW_HIDE</span>
                    <span class="n">comspec</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;COMSPEC&quot;</span><span class="p">,</span> <span class="s">&quot;cmd.exe&quot;</span><span class="p">)</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="n">comspec</span> <span class="o">+</span> <span class="s">&quot; /c &quot;</span> <span class="o">+</span> <span class="n">cmd</span>
                <span class="c"># Returns a handle for the created process, a handle for the main thread, the identifier of the process (PID) and the identifier of the main thread.</span>
                <span class="n">hp</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">CreateProcess</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span>        <span class="c"># Executable</span>
                                                 <span class="n">cmd</span><span class="p">,</span>         <span class="c"># Command Line</span>
                                                 <span class="bp">None</span><span class="p">,</span>        <span class="c"># Security Attributes for Process</span>
                                                 <span class="bp">None</span><span class="p">,</span>        <span class="c"># Securtiy Attributes for Thread</span>
                                                 <span class="mi">0</span><span class="p">,</span>           <span class="c"># Inherithandles = False(0)</span>
                                                 <span class="mi">0</span><span class="p">,</span>           <span class="c"># Creation Flags</span>
                                                 <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">,</span>  <span class="c"># Environment Settings (use the same as calling process)</span>
                                                 <span class="bp">None</span><span class="p">,</span>        <span class="c"># CurrentDir (Don&#39;t change)</span>
                                                 <span class="n">sui</span><span class="p">)</span>         <span class="c"># Startup Information</span>
                <span class="n">retVal</span> <span class="o">=</span> <span class="n">pid</span>

        <span class="k">elif</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">platformtype</span><span class="o">.</span><span class="n">isUnix</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">useShell</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">argsInCommand</span><span class="p">:</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="n">command</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">list2cmdline</span><span class="p">([</span><span class="n">command</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">redirectStreams</span><span class="p">:</span>
                    <span class="n">retVal</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">stdin</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">outputToStdout</span><span class="p">:</span>
                        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">devnull</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;/dev/null&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
                        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">devnull</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">devnull</span><span class="p">)</span>
                        <span class="n">devnull</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">retVal</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">pid</span> <span class="c"># Returning the pid, analogous to the windows implementation where we don&#39;t have a Popen object to return.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">argsInCommand</span><span class="p">:</span> <span class="c"># Not possible, only the shell is able to parse command line arguments form a space-separated string.</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;On Unix, either use the shell to execute a command, or split your command in an argument list&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">redirectStreams</span><span class="p">:</span>
                    <span class="n">retVal</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">command</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">stdin</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">outputToStdout</span><span class="p">:</span>
                        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">command</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">devnull</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;/dev/null&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
                        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">command</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">devnull</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">devnull</span><span class="p">)</span>
                        <span class="n">devnull</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">retVal</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">pid</span> <span class="c"># Returning the pid, analogous to the windows implementation where we don&#39;t have a Popen object to return.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Platform not supported&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">retVal</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span> <span class="p">,</span> <span class="n">dieOnNonZeroExitCode</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">outputToStdout</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">useShell</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">ignoreErrorOutput</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span></div>
<div class="viewcode-block" id="SystemProcess.execute"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.SystemProcess.execute">[docs]</a>        <span class="sd">&quot;&quot;&quot;Executes a command, returns the exitcode and the output</span>
<span class="sd">        @param command: command to execute</span>
<span class="sd">        @param dieOnNonZeroExitCode: boolean to die if got non zero exitcode</span>
<span class="sd">        @param outputToStdout: boolean to show/hide output to stdout</span>
<span class="sd">        @param ignoreErrorOutput standard stderror is added to stdout in out result, if you want to make sure this does not happen put on True</span>
<span class="sd">        @rtype: integer represents the exitcode plus the output of the executed command</span>
<span class="sd">        if exitcode is not zero then the executed command returned with errors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Since python has no non-blocking readline() call, we implement it ourselves</span>
        <span class="c"># using the following private methods.</span>
        <span class="c">#</span>
        <span class="c"># We choose for line buffering, i.e. whenever we receive a full line of output (terminated by \n)</span>
        <span class="c"># on stdout or stdin of the child process, we log it</span>
        <span class="c">#</span>
        <span class="c"># When the process terminates, we log the final lines (and add a \n to them)</span>
        <span class="n">j</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;exec:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">command</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">_logentry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span><span class="n">loglevel</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">outputToStdout</span><span class="p">:</span>
                <span class="n">j</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">loglevel</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">j</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span><span class="n">loglevel</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_splitdata</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Split data in pieces separated by \n &quot;&quot;&quot;</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">lines</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">_logoutput</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">OUT_LINE</span><span class="p">,</span> <span class="n">ERR_LINE</span><span class="p">):</span>
            <span class="p">[</span><span class="n">lines</span><span class="p">,</span> <span class="n">partialline</span><span class="p">]</span> <span class="o">=</span> <span class="n">_splitdata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">OUT_LINE</span> <span class="o">+</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">partialline</span> <span class="o">=</span> <span class="n">OUT_LINE</span> <span class="o">+</span> <span class="n">partialline</span>
            <span class="n">OUT_LINE</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">partialline</span><span class="p">:</span>
                <span class="n">OUT_LINE</span> <span class="o">=</span> <span class="n">partialline</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">_logentry</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">OUT_LINE</span><span class="p">,</span> <span class="n">ERR_LINE</span>

        <span class="k">def</span> <span class="nf">_logerror</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">OUT_LINE</span><span class="p">,</span> <span class="n">ERR_LINE</span><span class="p">):</span>
            <span class="p">[</span><span class="n">lines</span><span class="p">,</span> <span class="n">partialline</span><span class="p">]</span> <span class="o">=</span> <span class="n">_splitdata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ERR_LINE</span> <span class="o">+</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">partialline</span> <span class="o">=</span> <span class="n">ERR_LINE</span> <span class="o">+</span> <span class="n">partialline</span>
            <span class="n">ERR_LINE</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">partialline</span><span class="p">:</span>
                <span class="n">ERR_LINE</span> <span class="o">=</span> <span class="n">partialline</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">_logentry</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">OUT_LINE</span><span class="p">,</span> <span class="n">ERR_LINE</span>

        <span class="k">def</span> <span class="nf">_flushlogs</span><span class="p">(</span><span class="n">OUT_LINE</span><span class="p">,</span> <span class="n">ERR_LINE</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Called when the child process closes. We need to get the last</span>
<span class="sd">                non-\n terminated pieces of the stdout and stderr streams</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">OUT_LINE</span><span class="p">:</span>
                <span class="n">_logentry</span><span class="p">(</span><span class="n">OUT_LINE</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ERR_LINE</span><span class="p">:</span>
                <span class="n">_logentry</span><span class="p">(</span><span class="n">ERR_LINE</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">command</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Error, cannot execute command not specified&#39;</span><span class="p">)</span>
        <span class="n">j</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;system.process.execute [</span><span class="si">%s</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="n">command</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">errno</span>
            <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">platformtype</span><span class="o">.</span><span class="n">isUnix</span><span class="p">():</span>
                <span class="kn">import</span> <span class="nn">subprocess</span>
                <span class="kn">import</span> <span class="nn">signal</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGCHLD</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIG_DFL</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="n">j</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#39;failed to set child signal, error </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">ex</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">childprocess</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">close_fds</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
                <span class="p">(</span><span class="n">output</span><span class="p">,</span><span class="n">error</span><span class="p">)</span> <span class="o">=</span> <span class="n">childprocess</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
                <span class="n">exitcode</span> <span class="o">=</span> <span class="n">childprocess</span><span class="o">.</span><span class="n">returncode</span>
                
            <span class="k">elif</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">platformtype</span><span class="o">.</span><span class="n">isWindows</span><span class="p">():</span>
                <span class="kn">import</span> <span class="nn">subprocess</span><span class="o">,</span> <span class="nn">win32pipe</span><span class="o">,</span> <span class="nn">msvcrt</span><span class="o">,</span> <span class="nn">pywintypes</span>

                <span class="c"># For some awkward reason you need to include the stdin pipe, or you get an error deep inside</span>
                <span class="c"># the subprocess module if you use QRedirectStdOut in the calling script</span>
                <span class="c"># We do not use the stdin.</span>
                <span class="n">childprocess</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span> <span class="n">close_fds</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="n">useShell</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
                <span class="n">output</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span> <span class="n">OUT_LINE</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span> <span class="n">ERR_LINE</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
                <span class="n">childRunning</span> <span class="o">=</span> <span class="bp">True</span>

                <span class="k">while</span> <span class="n">childRunning</span><span class="p">:</span>
                    <span class="n">stdoutData</span> <span class="o">=</span> <span class="n">childprocess</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span> <span class="c"># The readline method will block until data is received on stdout, or the stdout pipe has been destroyed. (Will return empty string)</span>
                                                                <span class="c"># Only call processes that release their stdout pipe when exiting, otherwise the method will not return when the process completed.</span>
                                                                <span class="c"># When the called process starts another process and marks its handle of the stdout pipe as inheritable, the pipe will not be destroyed before both processes end.</span>
                    <span class="k">if</span> <span class="n">stdoutData</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span> <span class="o">+</span> <span class="n">stdoutData</span>
                        <span class="p">(</span><span class="n">OUT_LINE</span><span class="p">,</span> <span class="n">ERR_LINE</span><span class="p">)</span> <span class="o">=</span> <span class="n">_logoutput</span><span class="p">(</span><span class="n">stdoutData</span><span class="p">,</span> <span class="n">OUT_LINE</span><span class="p">,</span> <span class="n">ERR_LINE</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span> <span class="c"># Did not read any data on channel</span>
                        <span class="k">if</span> <span class="n">childprocess</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span> <span class="c"># Will return a number if the process has ended, or None if it&#39;s running.</span>
                            <span class="n">childRunning</span> <span class="o">=</span> <span class="bp">False</span>

                <span class="n">exitcode</span> <span class="o">=</span> <span class="n">childprocess</span><span class="o">.</span><span class="n">returncode</span>
                <span class="n">error</span> <span class="o">=</span> <span class="s">&quot;Error output redirected to stdout.&quot;</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Non supported OS for system.process.execute()&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span>

        <span class="k">if</span> <span class="n">exitcode</span><span class="o">&lt;&gt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">error</span><span class="o">&lt;&gt;</span><span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="n">j</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot; Exitcode:</span><span class="si">%s</span><span class="se">\n</span><span class="s">Output:</span><span class="si">%s</span><span class="se">\n</span><span class="s">Error:</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">exitcode</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">error</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ignoreErrorOutput</span><span class="o">&lt;&gt;</span><span class="bp">True</span><span class="p">:</span>
                <span class="n">output</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s">***ERROR***</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">output</span><span class="p">,</span><span class="n">error</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">exitcode</span> <span class="o">!=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">dieOnNonZeroExitCode</span><span class="p">:</span>
            <span class="n">j</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;command: [</span><span class="si">%s</span><span class="s">]</span><span class="se">\n</span><span class="s">exitcode:</span><span class="si">%s</span><span class="se">\n</span><span class="s">output:</span><span class="si">%s</span><span class="se">\n</span><span class="s">error:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">exitcode</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">error</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Error during execution! (system.process.execute())</span><span class="se">\n\n</span><span class="s">Command: [</span><span class="si">%s</span><span class="s">]</span><span class="se">\n\n</span><span class="s">Exitcode: </span><span class="si">%s</span><span class="se">\n\n</span><span class="s">Program output:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n\n</span><span class="s">Errormessage:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">exitcode</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">error</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">exitcode</span><span class="p">,</span> <span class="n">output</span>

    <span class="k">def</span> <span class="nf">executeIndependant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cmd</span><span class="p">):</span></div>
<div class="viewcode-block" id="SystemProcess.executeIndependant"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.SystemProcess.executeIndependant">[docs]</a>        <span class="c"># devnull = open(os.devnull, &#39;wb&#39;) # use this in python &lt; 3.3</span>
        <span class="c"># Popen([&#39;nohup&#39;, cmd+&quot; &amp;&quot;], stdout=devnull, stderr=devnull)</span>
        <span class="n">cmd2</span><span class="o">=</span><span class="s">&quot;nohup </span><span class="si">%s</span><span class="s"> &gt; /dev/null 2&gt;&amp;1 &amp;&quot;</span><span class="o">%</span><span class="n">cmd</span>
        <span class="n">cmd2</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">dirs</span><span class="o">.</span><span class="n">replaceTxtDirVars</span><span class="p">(</span><span class="n">cmd2</span><span class="p">)</span>
        <span class="k">print</span> <span class="n">cmd2</span>
        <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">executeWithoutPipe</span><span class="p">(</span><span class="n">cmd2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">executeScript</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scriptName</span><span class="p">):</span></div>
<div class="viewcode-block" id="SystemProcess.executeScript"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.SystemProcess.executeScript">[docs]</a>        <span class="sd">&quot;&quot;&quot;execute python script from shell/Interactive Window&quot;&quot;&quot;</span>
        <span class="n">j</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#39;Excecuting script with name: </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">scriptName</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scriptName</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Error, Script name in empty in system.process.executeScript&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">execfile</span><span class="p">(</span><span class="n">scriptName</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Failed to execute the specified script: </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scriptName</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">executeInSandbox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span></div>
<div class="viewcode-block" id="SystemProcess.executeInSandbox"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.SystemProcess.executeInSandbox">[docs]</a>        <span class="sd">&quot;&quot;&quot;Executes a command</span>
<span class="sd">        @param command: string (command to be executed)</span>
<span class="sd">        @param timeout: 0 means to ever, expressed in seconds</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">j</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#39;Executing command </span><span class="si">%s</span><span class="s"> in sandbox&#39;</span><span class="o">%</span><span class="n">command</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">command</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Error, cannot execute command not specified&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">exitcode</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="ow">or</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">exitcode</span> <span class="o">!=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">timeout</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Error durring execution!</span><span class="se">\n</span><span class="s">Command: </span><span class="si">%s</span><span class="se">\n</span><span class="s">Errormessage: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">command</span><span class="p">,</span><span class="n">output</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">exitcode</span><span class="p">,</span> <span class="n">output</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Failed to execute the specified command: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">command</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">executeCode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">code</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></div>
<div class="viewcode-block" id="SystemProcess.executeCode"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.SystemProcess.executeCode">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        execute a method (python code with def)</span>
<span class="sd">        use params=j.core.params.get() as input</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
            <span class="n">params</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">codeLines</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>        
        <span class="k">if</span> <span class="s">&quot;def &quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">codeLines</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;code to execute needs to start with def&quot;</span><span class="p">)</span>
        <span class="n">def_indent</span> <span class="o">=</span> <span class="n">codeLines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;def &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">def_indent</span><span class="p">:</span>
            <span class="c">#means we need to lower identation with 4</span>
            <span class="k">def</span> <span class="nf">unindent</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">def_indent</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">line</span><span class="p">[</span><span class="n">def_indent</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">line</span>

            <span class="n">out</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">unindent</span><span class="p">,</span> <span class="n">codeLines</span><span class="p">))</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">out</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">codetools</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">findAll</span><span class="p">(</span><span class="s">&quot;^def&quot;</span><span class="p">,</span><span class="n">code</span><span class="p">))</span><span class="o">&lt;&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">server</span><span class="o">.</span><span class="n">raiseError</span><span class="p">(</span><span class="s">&quot;Cannot find 1 def method in code to execute, code submitted was </span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">code</span><span class="p">)</span>

        <span class="n">code2</span><span class="o">=</span><span class="s">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">code</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;def&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">line</span><span class="o">=</span><span class="s">&quot;def main(&quot;</span><span class="o">+</span><span class="s">&quot;(&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;(&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">code2</span><span class="o">+=</span><span class="s">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">line</span>

        <span class="c">#try to load the code</span>
        <span class="n">execContext</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">exec</span> <span class="n">code2</span> <span class="ow">in</span> <span class="n">execContext</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Could not import code, code submitted was </span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">code</span><span class="p">)</span>

        <span class="n">main</span> <span class="o">=</span> <span class="n">execContext</span><span class="p">[</span><span class="s">&#39;main&#39;</span><span class="p">]</span>
        
        <span class="c">#try to execute the code</span>
        <span class="n">result</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span><span class="o">=</span><span class="n">main</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>            
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Error </span><span class="si">%s</span><span class="s">.</span><span class="se">\n</span><span class="s">code submitted was </span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="n">code</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span>
        

    <span class="k">def</span> <span class="nf">isPidAlive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span></div>
<div class="viewcode-block" id="SystemProcess.isPidAlive"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.SystemProcess.isPidAlive">[docs]</a>        <span class="sd">&quot;&quot;&quot;Checks whether this pid is alive.</span>
<span class="sd">           For unix, a signal is sent to check that the process is alive.</span>
<span class="sd">           For windows, the process information is retrieved and it is double checked that the process is python.exe</span>
<span class="sd">           or pythonw.exe</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">j</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#39;Checking whether process with PID </span><span class="si">%d</span><span class="s"> is alive&#39;</span> <span class="o">%</span> <span class="n">pid</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">platformtype</span><span class="o">.</span><span class="n">isUnix</span><span class="p">():</span>
            <span class="c"># Unix strategy: send signal SIGCONT to process pid</span>
            <span class="c"># Achilles heal: another process which happens to have the same pid could be running</span>
            <span class="c"># and incorrectly considered as this process</span>
            <span class="kn">import</span> <span class="nn">signal</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="k">return</span> <span class="bp">True</span>

        <span class="k">elif</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">platformtype</span><span class="o">.</span><span class="n">isWindows</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">windows</span><span class="o">.</span><span class="n">isPidAlive</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>

    <span class="n">kill</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">kill</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">getPidsByFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filterstr</span><span class="p">):</span>
<div class="viewcode-block" id="SystemProcess.getPidsByFilter"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.SystemProcess.getPidsByFilter">[docs]</a>        <span class="n">cmd</span><span class="o">=</span><span class="s">&quot;ps ax | grep &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span><span class="o">%</span><span class="n">filterstr</span>
        <span class="n">rcode</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="c"># print out</span>
        <span class="n">found</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;grep&quot;</span><span class="p">)</span><span class="o">&lt;&gt;-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">==</span><span class="s">&quot;&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">&lt;&gt;</span><span class="s">&quot;&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">filterstr</span><span class="p">)</span><span class="o">&lt;&gt;-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="c"># print &quot;found pidline:%s&quot;%line</span>
                    <span class="n">found</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>   
        <span class="k">return</span> <span class="n">found</span>

    <span class="k">def</span> <span class="nf">checkstart</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cmd</span><span class="p">,</span><span class="n">filterstr</span><span class="p">,</span><span class="n">nrtimes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">retry</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span></div>
<div class="viewcode-block" id="SystemProcess.checkstart"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.SystemProcess.checkstart">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        @param cmd is which command to execute to start e.g. a daemon</span>
<span class="sd">        @param filterstr is what to check on if its running</span>
<span class="sd">        @param nrtimes is how many processes need to run</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">found</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getPidsByFilter</span><span class="p">(</span><span class="n">filterstr</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">retry</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">found</span><span class="p">)</span><span class="o">==</span><span class="n">nrtimes</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="c"># print &quot;START:%s&quot;%cmd</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">found</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getPidsByFilter</span><span class="p">(</span><span class="n">filterstr</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">found</span><span class="p">)</span><span class="o">&lt;&gt;</span><span class="n">nrtimes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;could not start </span><span class="si">%s</span><span class="s">, found </span><span class="si">%s</span><span class="s"> nr of instances. Needed </span><span class="si">%s</span><span class="s">.&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">found</span><span class="p">),</span><span class="n">nrtimes</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">checkstop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cmd</span><span class="p">,</span><span class="n">filterstr</span><span class="p">,</span><span class="n">retry</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nrinstances</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span></div>
<div class="viewcode-block" id="SystemProcess.checkstop"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.SystemProcess.checkstop">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        @param cmd is which command to execute to start e.g. a daemon</span>
<span class="sd">        @param filterstr is what to check on if its running</span>
<span class="sd">        @param nrtimes is how many processes need to run</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">found</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getPidsByFilter</span><span class="p">(</span><span class="n">filterstr</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">retry</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">found</span><span class="p">)</span><span class="o">==</span><span class="n">nrinstances</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="c"># print &quot;START:%s&quot;%cmd</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span><span class="n">dieOnNonZeroExitCode</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">found</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getPidsByFilter</span><span class="p">(</span><span class="n">filterstr</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">found</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">),</span><span class="mi">9</span><span class="p">)</span>
            <span class="n">found</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getPidsByFilter</span><span class="p">(</span><span class="n">filterstr</span><span class="p">)</span>
                
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">found</span><span class="p">)</span><span class="o">&lt;&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;could not stop </span><span class="si">%s</span><span class="s">, found </span><span class="si">%s</span><span class="s"> nr of instances.&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">found</span><span class="p">)))</span>


    <span class="k">def</span> <span class="nf">getProcessPid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process</span><span class="p">):</span></div>
<div class="viewcode-block" id="SystemProcess.getProcessPid"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.SystemProcess.getProcessPid">[docs]</a>        <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">platformtype</span><span class="o">.</span><span class="n">isUnix</span><span class="p">():</span>
            <span class="c"># Need to set $COLUMNS such that we can grep full commandline</span>
            <span class="c"># Note: apparently this does not work on solaris</span>
            <span class="n">command</span> <span class="o">=</span> <span class="s">&quot;env COLUMNS=300 ps -ef&quot;</span>
            <span class="p">(</span><span class="n">exitcode</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">dieOnNonZeroExitCode</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">outputToStdout</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">pids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">co</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;\s*(?P&lt;uid&gt;[a-z]+)\s+(?P&lt;pid&gt;[0-9]+)\s+(?P&lt;ppid&gt;[0-9]+)\s+(?P&lt;cpu&gt;[0-9]+)\s+(?P&lt;stime&gt;\S+)\s+(?P&lt;tty&gt;\S+)\s+(?P&lt;time&gt;\S+)\s+(?P&lt;cmd&gt;.+)&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">co</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">gd</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>                
                <span class="c"># print line</span>
                <span class="c"># print gd[&quot;cmd&quot;]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">gd</span><span class="p">[</span><span class="s">&#39;pid&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">process</span><span class="p">:</span>
                    <span class="n">pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gd</span><span class="p">[</span><span class="s">&#39;pid&#39;</span><span class="p">])</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="nb">unicode</span><span class="p">))</span> <span class="ow">and</span>  <span class="n">process</span> <span class="ow">in</span> <span class="n">gd</span><span class="p">[</span><span class="s">&#39;cmd&#39;</span><span class="p">]:</span>
                    <span class="n">pids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gd</span><span class="p">[</span><span class="s">&#39;pid&#39;</span><span class="p">])</span>
            <span class="n">pids</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">pids</span>
        <span class="k">else</span><span class="p">:</span>
             <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;getProcessPid is only implemented for unix&quot;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">getMyProcessObject</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="SystemProcess.getMyProcessObject"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.SystemProcess.getMyProcessObject">[docs]</a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getProcessObject</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">getProcessObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pid</span><span class="p">):</span></div>
<div class="viewcode-block" id="SystemProcess.getProcessObject"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.SystemProcess.getProcessObject">[docs]</a>        <span class="kn">import</span> <span class="nn">psutil</span>
        <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">psutil</span><span class="o">.</span><span class="n">get_process_list</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">pid</span><span class="o">==</span><span class="n">pid</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">process</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Could not find process with pid:</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">pid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getProcessPidsFromUser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">user</span><span class="p">):</span></div>
<div class="viewcode-block" id="SystemProcess.getProcessPidsFromUser"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.SystemProcess.getProcessPidsFromUser">[docs]</a>        <span class="kn">import</span> <span class="nn">psutil</span>
        <span class="n">result</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">psutil</span><span class="o">.</span><span class="n">get_process_list</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">username</span><span class="o">==</span><span class="n">user</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>            
        <span class="k">return</span> <span class="n">result</span>


    <span class="k">def</span> <span class="nf">killUserProcesses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">user</span><span class="p">):</span></div>
<div class="viewcode-block" id="SystemProcess.killUserProcesses"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.SystemProcess.killUserProcesses">[docs]</a>        <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getProcessPidsFromUser</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getSimularProcesses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="SystemProcess.getSimularProcesses"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.SystemProcess.getSimularProcesses">[docs]</a>        <span class="kn">import</span> <span class="nn">psutil</span>
        <span class="n">myprocess</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getMyProcessObject</span><span class="p">()</span>
        <span class="n">result</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">psutil</span><span class="o">.</span><span class="n">get_process_list</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">cmdline</span><span class="o">==</span><span class="n">myprocess</span><span class="o">.</span><span class="n">cmdline</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">psutil</span><span class="o">.</span><span class="n">NoSuchProcess</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">result</span>


    <span class="k">def</span> <span class="nf">checkProcess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span></div>
<div class="viewcode-block" id="SystemProcess.checkProcess"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.SystemProcess.checkProcess">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if a certain process is running on the system.</span>
<span class="sd">        you can specify minimal running processes needed.</span>
<span class="sd">        @param process: String with the name of the process we</span>
<span class="sd">            are trying to check</span>
<span class="sd">        @param min: (int) minimal threads that should run.</span>
<span class="sd">        @return status: (int) when ok, 1 when not ok.</span>

<span class="sd">        @TODO: The process matching on strings is incorrect, it will match a partial match (e.g.: apache will match a process using apache2)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">j</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#39;Checking whether at least </span><span class="si">%d</span><span class="s"> processes </span><span class="si">%s</span><span class="s"> are running&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">min</span><span class="p">,</span> <span class="n">process</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">platformtype</span><span class="o">.</span><span class="n">isUnix</span><span class="p">():</span>
            <span class="n">pids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getProcessPid</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pids</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">min</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="mi">1</span>

        <span class="c"># Windows platform</span>
        <span class="k">elif</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">platformtype</span><span class="o">.</span><span class="n">isWindows</span><span class="p">():</span>

            <span class="k">return</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">windows</span><span class="o">.</span><span class="n">checkProcess</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="nb">min</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">checkProcessForPid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">process</span><span class="p">):</span></div>
<div class="viewcode-block" id="SystemProcess.checkProcessForPid"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.SystemProcess.checkProcessForPid">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether a given pid actually does belong to a given process name.</span>
<span class="sd">        @param pid: (int) the pid to check</span>
<span class="sd">        @param process: (str) the process that should have the pid</span>
<span class="sd">        @return status: (int) 0 when ok, 1 when not ok.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">j</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#39;Checking whether process with PID </span><span class="si">%d</span><span class="s"> is actually </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">process</span><span class="p">),</span> <span class="mi">7</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">platformtype</span><span class="o">.</span><span class="n">isUnix</span><span class="p">():</span>
            <span class="n">command</span> <span class="o">=</span> <span class="s">&quot;ps -p </span><span class="si">%i</span><span class="s">&quot;</span><span class="o">%</span><span class="n">pid</span>
            <span class="p">(</span><span class="n">exitcode</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">dieOnNonZeroExitCode</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">outputToStdout</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">platformtype</span><span class="o">.</span><span class="n">isLinux</span><span class="p">()</span> <span class="ow">or</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">platformtype</span><span class="o">.</span><span class="n">isESX</span><span class="p">():</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;.{23}.*(\s|\/)</span><span class="si">%s</span><span class="s">(\s|$).*&quot;</span> <span class="o">%</span> <span class="n">process</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">platformtype</span><span class="o">.</span><span class="n">isSolaris</span><span class="p">():</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;.{22}.*(\s|\/)</span><span class="si">%s</span><span class="s">(\s|$).*&quot;</span> <span class="o">%</span> <span class="n">process</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span> <span class="p">:</span>
                    <span class="n">i</span><span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="mi">1</span>

        <span class="k">elif</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">platformtype</span><span class="o">.</span><span class="n">isWindows</span><span class="p">():</span>

            <span class="k">return</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">windows</span><span class="o">.</span><span class="n">checkProcessForPid</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setEnvironmentVariable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varnames</span><span class="p">,</span> <span class="n">varvalues</span><span class="p">):</span></div>
<div class="viewcode-block" id="SystemProcess.setEnvironmentVariable"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.SystemProcess.setEnvironmentVariable">[docs]</a>        <span class="sd">&quot;&quot;&quot;Set the value of the environment variables C{varnames}. Existing variable are overwritten</span>

<span class="sd">        @param varnames: A list of the names of all the environment variables to set</span>
<span class="sd">        @type varnames: list&lt;string&gt;</span>
<span class="sd">        @param varvalues: A list of all values for the environment variables</span>
<span class="sd">        @type varvalues: list&lt;string&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">varnames</span><span class="p">)):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">varnames</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">varvalues</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getPidsByPort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span></div>
<div class="viewcode-block" id="SystemProcess.getPidsByPort"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.SystemProcess.getPidsByPort">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns pid of the process that is listening on the given port</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getProcessByPort</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
        <span class="n">pids</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">getProcessPid</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pids</span>

    <span class="k">def</span> <span class="nf">killProcessByName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span></div>
<div class="viewcode-block" id="SystemProcess.killProcessByName"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.SystemProcess.killProcessByName">[docs]</a>        <span class="n">pids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getProcessPid</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
            <span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">killProcessByPort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">port</span><span class="p">):</span></div>
<div class="viewcode-block" id="SystemProcess.killProcessByPort"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.SystemProcess.killProcessByPort">[docs]</a>        <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPidsByPort</span><span class="p">(</span><span class="n">port</span><span class="p">):</span>
            <span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">getProcessByPort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span></div>
<div class="viewcode-block" id="SystemProcess.getProcessByPort"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.SystemProcess.getProcessByPort">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the full name of the process that is listening on the given port</span>

<span class="sd">        @param port: the port for which to find the command</span>
<span class="sd">        @type port: int</span>
<span class="sd">        @return: full process name</span>
<span class="sd">        @rtype: string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">port</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">platformtype</span><span class="o">.</span><span class="n">isLinux</span><span class="p">()</span> <span class="ow">or</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">platformtype</span><span class="o">.</span><span class="n">isESX</span><span class="p">():</span>
            <span class="n">command</span> <span class="o">=</span> <span class="s">&quot;netstat -ntulp | grep &#39;:</span><span class="si">%s</span><span class="s"> &#39;&quot;</span> <span class="o">%</span> <span class="n">port</span>
            <span class="p">(</span><span class="n">exitcode</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">dieOnNonZeroExitCode</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">outputToStdout</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

            <span class="c"># Not found if grep&#39;s exitcode  &gt; 0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exitcode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>

            <span class="c"># Note: we can have multiline output. For example:</span>
            <span class="c">#   tcp        0      0 0.0.0.0:5432            0.0.0.0:*               LISTEN      28419/postgres</span>
            <span class="c">#   tcp6       0      0 :::5432                 :::*                    LISTEN      28419/postgres</span>

            <span class="n">regex</span> <span class="o">=</span> <span class="s">&quot;^.+\s(\d+)/.+\s*$&quot;</span>
            <span class="n">pid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Unexpected output from netstat -tanup: [</span><span class="si">%s</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="n">line</span><span class="p">)</span>
                <span class="n">pid_of_line</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">pid</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">pid</span> <span class="o">=</span> <span class="n">pid_of_line</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pid</span> <span class="o">!=</span> <span class="n">pid_of_line</span><span class="p">:</span>

                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Found multiple pids listening to port [</span><span class="si">%s</span><span class="s">]. Error.&quot;</span> <span class="o">%</span> <span class="n">port</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pid</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c"># No process found listening on this port</span>
                <span class="k">return</span> <span class="bp">None</span>

            <span class="c"># Need to set $COLUMNS such that we can grep full commandline</span>
            <span class="c"># Note: apparently this does not work on solaris</span>
            <span class="n">command</span> <span class="o">=</span> <span class="s">&quot;env COLUMNS=300 ps -ef&quot;</span>
            <span class="p">(</span><span class="n">exitcode</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">dieOnNonZeroExitCode</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">outputToStdout</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">co</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;\s*(?P&lt;uid&gt;[a-z]+)\s+(?P&lt;pid&gt;[0-9]+)\s+(?P&lt;ppid&gt;[0-9]+)\s+(?P&lt;cpu&gt;[0-9]+)\s+(?P&lt;stime&gt;\S+)\s+(?P&lt;tty&gt;\S+)\s+(?P&lt;time&gt;\S+)\s+(?P&lt;cmd&gt;.+)&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">co</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">gd</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">gd</span><span class="p">[</span><span class="s">&#39;pid&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pid</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">gd</span><span class="p">[</span><span class="s">&#39;cmd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;This platform is not supported in j.system.process.getProcessByPort()&quot;</span><span class="p">)</span>

    <span class="n">run</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">run</span><span class="p">)</span></div>
    <span class="n">runScript</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">runScript</span><span class="p">)</span>
    <span class="n">runDaemon</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">runDaemon</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">appCheckActive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">appname</span><span class="p">):</span>
<div class="viewcode-block" id="SystemProcess.appCheckActive"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.SystemProcess.appCheckActive">[docs]</a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">appNrInstances</span><span class="p">(</span><span class="n">appname</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span>

    <span class="k">def</span> <span class="nf">appNrInstances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">appname</span><span class="p">):</span></div>
<div class="viewcode-block" id="SystemProcess.appNrInstances"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.SystemProcess.appNrInstances">[docs]</a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">appGetPids</span><span class="p">(</span><span class="n">appname</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">appNrInstancesActive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">appname</span><span class="p">):</span></div>
<div class="viewcode-block" id="SystemProcess.appNrInstancesActive"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.SystemProcess.appNrInstancesActive">[docs]</a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">appGetPidsActive</span><span class="p">(</span><span class="n">appname</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">getEnviron</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span></div>
<div class="viewcode-block" id="SystemProcess.getEnviron"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.SystemProcess.getEnviron">[docs]</a>        <span class="n">environ</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">fileGetContents</span><span class="p">(</span><span class="s">&#39;/proc/</span><span class="si">%s</span><span class="s">/environ&#39;</span> <span class="o">%</span> <span class="n">pid</span><span class="p">)</span>
        <span class="n">env</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">environ</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\0</span><span class="s">&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="s">&#39;=&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">env</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">env</span>

    <span class="k">def</span> <span class="nf">appGetPids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">appname</span><span class="p">):</span></div>
<div class="viewcode-block" id="SystemProcess.appGetPids"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.SystemProcess.appGetPids">[docs]</a>        <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">redis</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Redis was not running when applications started, cannot get pid&#39;s&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">j</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">hexists</span><span class="p">(</span><span class="s">&quot;application&quot;</span><span class="p">,</span><span class="n">appname</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pids</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="s">&quot;application&quot;</span><span class="p">,</span><span class="n">appname</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">pids</span>

    <span class="k">def</span> <span class="nf">appsGetNames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="SystemProcess.appsGetNames"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.SystemProcess.appsGetNames">[docs]</a>        <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">redis</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Make sure redis is running for port 7766&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">j</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">hkeys</span><span class="p">(</span><span class="s">&quot;application&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getDefunctProcesses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="SystemProcess.getDefunctProcesses"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.SystemProcess.getDefunctProcesses">[docs]</a>        <span class="n">rc</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;ps ax&quot;</span><span class="p">)</span>
        <span class="n">llist</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">==</span><span class="s">&quot;&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;&lt;defunct&gt;&quot;</span><span class="p">)</span><span class="o">&lt;&gt;-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c"># print &quot;defunct:%s&quot;%line</span>
                <span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">pid</span><span class="o">=</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">pid</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">pid</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="n">llist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">llist</span>

    <span class="k">def</span> <span class="nf">appsGet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="SystemProcess.appsGet"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.SystemProcess.appsGet">[docs]</a>
        <span class="n">defunctlist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getDefunctProcesses</span><span class="p">()</span>
        <span class="n">result</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">appsGetNames</span><span class="p">():</span>
            <span class="n">pids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">appGetPidsActive</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="n">pids</span><span class="o">=</span><span class="p">[</span><span class="n">pid</span> <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">pids</span> <span class="k">if</span> <span class="n">pid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">defunctlist</span><span class="p">]</span>
                
            <span class="k">if</span> <span class="n">pids</span><span class="o">==</span><span class="p">[]:</span>
                <span class="n">j</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">hdelete</span><span class="p">(</span><span class="s">&quot;application&quot;</span><span class="p">,</span><span class="n">item</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">=</span><span class="n">pids</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">appGetPidsActive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">appname</span><span class="p">):</span></div>
<div class="viewcode-block" id="SystemProcess.appGetPidsActive"><a class="viewcode-back" href="../../../../API/JumpScale.core.system.html#JumpScale.core.system.process.SystemProcess.appGetPidsActive">[docs]</a>        <span class="n">pids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">appGetPids</span><span class="p">(</span><span class="n">appname</span><span class="p">)</span>
        <span class="n">todelete</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isPidAlive</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
                <span class="n">todelete</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>        
            <span class="k">else</span><span class="p">:</span>
                <span class="n">environ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getEnviron</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;JSPROCNAME&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">appname</span><span class="p">:</span>
                    <span class="n">todelete</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">todelete</span><span class="p">:</span>
            <span class="n">pids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="n">j</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s">&quot;application&quot;</span><span class="p">,</span><span class="n">appname</span><span class="p">,</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">pids</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">pids</span>
</pre></div></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li><a href="../../../../index.html">Jumpscale Doc 7.0 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
    </div>
  </body>
</html>