<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>JumpScale.baselib.jpackages.JPackageObject &mdash; Jumpscale Doc 7.0 documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '7.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="top" title="Jumpscale Doc 7.0 documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="../../../../index.html">Jumpscale Doc 7.0 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for JumpScale.baselib.jpackages.JPackageObject</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">inspect</span>

<span class="kn">from</span> <span class="nn">JumpScale</span> <span class="kn">import</span> <span class="n">j</span>

<span class="kn">from</span> <span class="nn">JPackageStateObject</span> <span class="kn">import</span> <span class="n">JPackageStateObject</span>
<span class="c">#from JumpScale.core.sync.Sync import SyncLocal</span>
<span class="kn">from</span> <span class="nn">ActionManager</span> <span class="kn">import</span> <span class="n">ActionManager</span>

<span class="kn">from</span> <span class="nn">CodeManagementRecipe</span> <span class="kn">import</span> <span class="n">CodeManagementRecipe</span>
<span class="kn">from</span> <span class="nn">JumpScale.core.system.fs</span> <span class="kn">import</span> <span class="n">FileLock</span>

<div class="viewcode-block" id="JPLock"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPLock">[docs]</a><span class="k">def</span> <span class="nf">JPLock</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">lockname</span> <span class="o">=</span> <span class="s">&quot;jp_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">FileLock</span><span class="p">(</span><span class="n">lockname</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span>
</div>
<div class="viewcode-block" id="JPackageObject"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject">[docs]</a><span class="k">class</span> <span class="nc">JPackageObject</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Data representation of a JPackage, should contain all information contained in the jpackages.cfg</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span><span class="n">instance</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialization of the JPackage</span>

<span class="sd">        @param domain:  The domain that the JPackage belongs to, can be a string or the DomainObject4</span>
<span class="sd">        @param name:    The name of the JPackage</span>
<span class="sd">        @param version: The version of the JPackage</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">supportedPlatforms</span><span class="o">=</span><span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="o">=</span><span class="n">domain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="o">=</span><span class="n">version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">=</span><span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">supportedPlatforms</span><span class="o">=</span><span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="o">=</span><span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="o">=</span><span class="s">&quot;&quot;</span>


        <span class="c">#checks on correctness of the parameters</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">domain</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;The domain parameter cannot be empty or None&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;The name parameter cannot be empty or None&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">version</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;The version parameter cannot be empty or None&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">buildNr</span><span class="o">=-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskletsChecksum</span><span class="o">=</span><span class="s">&quot;&quot;</span>    
        
        <span class="bp">self</span><span class="o">.</span><span class="n">configchanged</span><span class="o">=</span><span class="bp">False</span>
              
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">=</span><span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[]</span> <span class="c">#key = domain_packagename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependenciesNames</span><span class="o">=</span><span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">=</span><span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hrd_instance</span><span class="o">=</span><span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">=</span><span class="bp">None</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">_clean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init</span><span class="p">()</span>

        <span class="c">########</span>
        <span class="c">#create defaults for new jpackages</span>
        <span class="n">hrdpath</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathMetadata</span><span class="p">(),</span><span class="s">&quot;hrd&quot;</span><span class="p">,</span><span class="s">&quot;main.hrd&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">hrdpath</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

        <span class="c">########</span>
        <span class="c">#LOAD INFO FROM REPO       </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">getHRD</span><span class="p">(</span><span class="n">hrdpath</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buildNr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">getInt</span><span class="p">(</span><span class="s">&quot;jp.buildNr&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&quot;jp.process.tcpports&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s">&quot;jp.process.tcpports&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&quot;jp.process.startuptime&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s">&quot;jp.process.startuptime&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">export</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span><span class="s">&quot;jp.export&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autobuild</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span><span class="s">&quot;jp.autobuild&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskletsChecksum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;jp.taskletschecksum&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">descrChecksum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;jp.descrchecksum&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">hrd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">getHrd</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getHRD</span><span class="p">(</span><span class="s">&quot;jp.name&quot;</span><span class="p">)</span>
            <span class="n">hrd</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;jp.descrchecksum&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">descrChecksum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;jp.descrchecksum&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hrdChecksum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;jp.hrdchecksum&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">hrd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">getHrd</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getHRD</span><span class="p">(</span><span class="s">&quot;jp.name&quot;</span><span class="p">)</span>
            <span class="n">hrd</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;jp.hrdchecksum&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hrdChecksum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;jp.hrdchecksum&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">supportedPlatforms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">getList</span><span class="p">(</span><span class="s">&quot;jp.supportedplatforms&quot;</span><span class="p">)</span>

        <span class="n">j</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">getDomainObject</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">blobstorRemote</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blobstorLocal</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_getState</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">debugMode</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="o">==</span><span class="bp">False</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&quot;jp.debug&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;jp.debug&quot;</span><span class="p">))</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="o">=</span><span class="mi">1</span>
            <span class="c">#DO NOT SET 0, 0 means we don&#39;t count the stat from the hrd</span>
      
        <span class="n">key</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_activeblobfolder</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">dirs</span><span class="o">.</span><span class="n">cfgDir</span><span class="p">,</span> <span class="s">&quot;jpackages&quot;</span><span class="p">,</span> <span class="s">&quot;state&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_blobfolder</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathMetadata</span><span class="p">(),</span><span class="s">&quot;files&quot;</span><span class="p">)</span>


        <span class="c"># print &quot;**JP:%s&quot;%self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loaded</span><span class="o">=</span><span class="bp">False</span>

<div class="viewcode-block" id="JPackageObject.log"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.log">[docs]</a>    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msg</span><span class="p">,</span><span class="n">category</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">level</span><span class="o">&lt;</span><span class="n">j</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">loglevel</span><span class="o">+</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">j</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">logenable</span><span class="p">:</span>
            <span class="n">j</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msg</span><span class="p">),</span><span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">)</span>        

    <span class="c"># @JPLock</span></div>
    <span class="k">def</span> <span class="nf">_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c">#create defaults for new jpackages</span>
        <span class="n">hrddir</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathMetadata</span><span class="p">(),</span><span class="s">&quot;hrd&quot;</span><span class="p">)</span>

        <span class="c">#define templates path</span>
        <span class="n">extpath</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__init__</span><span class="p">)</span>
        <span class="n">extpath</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">getDirName</span><span class="p">(</span><span class="n">extpath</span><span class="p">)</span>
        <span class="n">src</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">extpath</span><span class="p">,</span><span class="s">&quot;templates&quot;</span><span class="p">)</span>        

        <span class="c">#this is to check if metadata in jpackage dir (on repo) is complete</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">hrddir</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
                <span class="n">content</span><span class="o">=</span><span class="s">&quot;jp.domain=</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span>
                <span class="n">content</span><span class="o">+=</span><span class="s">&quot;jp.name=</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span>
                <span class="n">content</span><span class="o">+=</span><span class="s">&quot;jp.version=</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">getHRD</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">)</span>

            <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">copyDirTree</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathMetadata</span><span class="p">(),</span> <span class="n">overwriteFiles</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="c">#do never put this on true</span>

        <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">copyDirTree</span><span class="p">(</span><span class="n">src</span><span class="o">+</span><span class="s">&quot;/actions/&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathMetadata</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;/actions/&quot;</span><span class="p">,</span> <span class="n">overwriteFiles</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="c">#for easy development, overwrite specific implementations</span>
        <span class="c">#j.system.fs.copyFile(src+&quot;/actions/process.depcheck.py&quot;,self.getPathMetadata()+&quot;/actions/process.depcheck.py&quot;)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">getHRD</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">hrddir</span><span class="p">,</span><span class="s">&quot;main.hrd&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;jp.domain&quot;</span><span class="p">,</span><span class="n">checkExists</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">&lt;&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;jp.domain&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;WARNING: domain in jpackage is not same as name of directory.&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;jp.name&quot;</span><span class="p">,</span><span class="n">checkExists</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">&lt;&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;jp.name&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;WARNING: name in jpackage is not same as name of directory.&quot;</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;jp.version&quot;</span><span class="p">,</span><span class="n">checkExists</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">&lt;&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">:</span>                
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;jp.version&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;WARNING: version in jpackage is not same as name of directory.&quot;</span>

        <span class="n">descr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;jp.description&quot;</span><span class="p">,</span><span class="n">checkExists</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">descr</span><span class="o">&lt;&gt;</span><span class="bp">False</span> <span class="ow">and</span> <span class="n">descr</span><span class="o">&lt;&gt;</span><span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="o">=</span><span class="n">descr</span>
        <span class="k">if</span> <span class="n">descr</span><span class="o">&lt;&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">:</span>                
            <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;jp.description&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>                      

        <span class="bp">self</span><span class="o">.</span><span class="n">supportedPlatforms</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">getList</span><span class="p">(</span><span class="s">&quot;jp.supportedplatforms&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">supportedPlatforms</span><span class="o">==</span><span class="p">[]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raiseError</span><span class="p">(</span><span class="s">&quot;supported platforms cannot be empty&quot;</span><span class="p">)</span>

        <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">createDir</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathMetadata</span><span class="p">(),</span><span class="s">&quot;uploadhistory&quot;</span><span class="p">))</span>
        <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">createDir</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathMetadata</span><span class="p">(),</span><span class="s">&quot;files&quot;</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">platform</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">supportedPlatforms</span><span class="p">:</span>
            <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">createDir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathFilesPlatform</span><span class="p">(</span><span class="n">platform</span><span class="p">))</span>
  
    <span class="k">def</span> <span class="nf">_clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;.quarantine&quot;</span><span class="p">,</span><span class="s">&quot;.tmb&quot;</span><span class="p">]:</span>
        <span class="c"># for item in [&quot;.quarantine&quot;,&quot;.tmb&quot;,&#39;actions/code.getRecipe&#39;]:</span>
            <span class="n">path</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathMetadata</span><span class="p">(),</span><span class="n">item</span><span class="p">)</span>
            <span class="c"># print &quot;remove:%s&quot;%path</span>
            <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">removeDirTree</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;.quarantine&quot;</span><span class="p">,</span><span class="s">&quot;.tmb&quot;</span><span class="p">]:</span>
            <span class="n">path</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathFiles</span><span class="p">(),</span><span class="n">item</span><span class="p">)</span>
            <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">removeDirTree</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="c"># print &quot;remove:%s&quot;%path</span>

        <span class="c"># j.system.fs.remove(&quot;%s/actions/install.download.py&quot;%self.getPathMetadata())</span>

    <span class="c"># @JPLock</span>
<div class="viewcode-block" id="JPackageObject.load"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">instance</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">hrddata</span><span class="o">=</span><span class="p">{},</span><span class="n">findDefaultInstance</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaded</span> <span class="ow">and</span> <span class="n">force</span><span class="o">==</span><span class="bp">False</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c">#TRY AND FIND INSTANCE</span>
        <span class="k">if</span> <span class="n">instance</span><span class="o">==</span><span class="bp">None</span> <span class="ow">and</span> <span class="n">findDefaultInstance</span><span class="p">:</span>
            <span class="n">root</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">dirs</span><span class="o">.</span><span class="n">packageDir</span><span class="p">,</span> <span class="s">&quot;instance&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">root</span><span class="p">):</span>
                <span class="n">instanceNames</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">listDirsInDir</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="bp">False</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instanceNames</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">=</span><span class="n">instanceNames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">instance</span><span class="o">&lt;&gt;</span><span class="bp">None</span><span class="p">:</span>
                <span class="n">root</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">dirs</span><span class="o">.</span><span class="n">packageDir</span><span class="p">,</span> <span class="s">&quot;instance&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">instance</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">root</span><span class="p">):</span>
                    <span class="n">j</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">inputerror_critical</span><span class="p">(</span><span class="s">&quot;Could not find instance &#39;</span><span class="si">%s</span><span class="s">&#39; for jpackage </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span><span class="bp">self</span><span class="p">),</span><span class="s">&quot;jpackage.init&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">=</span><span class="n">instance</span>

        <span class="k">if</span> <span class="n">hrddata</span><span class="o">&lt;&gt;</span><span class="p">{}:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_installActiveHrd</span><span class="p">(</span><span class="n">hrddata</span><span class="o">=</span><span class="n">hrddata</span><span class="p">)</span>

        <span class="n">hrdinstancepath</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathInstance</span><span class="p">(),</span><span class="s">&quot;hrdinstance&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">hrdinstancepath</span><span class="p">):</span>
            <span class="c"># j.events.inputerror_critical(&quot;Cannot load jpackage:%s could not find an instance&quot;%self)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hrd_instance</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">getHRD</span><span class="p">(</span><span class="n">hrdinstancepath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span> <span class="o">=</span> <span class="n">ActionManager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c">#WHY WOULD THIS BE NEEDED?</span>
        <span class="c">#j.application.loadConfig()</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">loadBlobStores</span><span class="p">()</span>

        <span class="c"># print &quot;loadactionsdone:%s&quot;%self</span>

        <span class="c"># ######CHECK IF JP ALREADY INSTALLED </span>
        <span class="c"># if self.state.lastinstalledbuildnr&gt;=0:</span>
        <span class="c">#     #means jp is installed on system</span>
        <span class="c">#     #because was already installed make sure we create active instance if we can&#39;t find the active path yet</span>

        <span class="c">#     #get rid of past</span>
        <span class="c">#     oldpath=j.system.fs.joinPaths(j.dirs.packageDir, &quot;instance&quot;, self.domain,self.name,self.version)</span>
        <span class="c">#     if j.system.fs.exists(path=oldpath):</span>
        <span class="c">#         j.system.fs.removeDirTree(oldpath)</span>

        <span class="c">#     root=j.system.fs.joinPaths(j.dirs.packageDir, &quot;instance&quot;, self.domain,self.name)</span>
        <span class="c">#     if not j.system.fs.exists(path=root) or len(j.system.fs.listDirsInDir(root,False,True))==0:</span>
                
        <span class="c">#         #this is to allow system to keep on running when upgrading from old situation</span>
        <span class="c">#         self.instance=0</span>
        <span class="c">#         hrdinstancepath=j.system.fs.joinPaths(self.getPathInstance(),&quot;hrdinstance&quot;)  </span>
        <span class="c">#         j.system.fs.createDir(hrdinstancepath)</span>
        <span class="c">#         self.copyMetadataToActive()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_loaded</span><span class="o">=</span><span class="bp">True</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="c"># @JPLock</span></div>
<div class="viewcode-block" id="JPackageObject.getCodeMgmtRecipe"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.getCodeMgmtRecipe">[docs]</a>    <span class="k">def</span> <span class="nf">getCodeMgmtRecipe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init</span><span class="p">()</span>

        <span class="n">hrdpath</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathMetadata</span><span class="p">(),</span><span class="s">&quot;hrd&quot;</span><span class="p">,</span><span class="s">&quot;code.hrd&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">hrdpath</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
        <span class="n">recipepath</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathMetadata</span><span class="p">(),</span><span class="s">&quot;coderecipe.cfg&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">recipepath</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">CodeManagementRecipe</span><span class="p">(</span><span class="n">hrdpath</span><span class="p">,</span><span class="n">recipepath</span><span class="p">,</span><span class="n">jp</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_installActiveHrd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">hrddata</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        match hrd templates with active ones, add entries where needed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#THE ACTIVATE ONES</span>
        <span class="n">hrdtemplatesPath</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathMetadata</span><span class="p">(),</span><span class="s">&quot;hrdactive&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">listFilesInDir</span><span class="p">(</span><span class="n">hrdtemplatesPath</span><span class="p">):</span>
            <span class="n">base</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">getBaseName</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">base</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;&gt;</span><span class="s">&quot;_&quot;</span><span class="p">:</span>
                <span class="n">templ</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">fileGetContents</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>                
                <span class="n">actbasepath</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">dirs</span><span class="o">.</span><span class="n">hrdDir</span><span class="p">,</span><span class="n">base</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">actbasepath</span><span class="p">):</span>
                    <span class="c">#means there is no hrd, put empty file</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;did not find active hrd for </span><span class="si">%s</span><span class="s">, will now put there&quot;</span><span class="o">%</span><span class="n">actbasepath</span><span class="p">,</span><span class="n">category</span><span class="o">=</span><span class="s">&quot;init&quot;</span><span class="p">)</span>
                    <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">writeFile</span><span class="p">(</span><span class="n">actbasepath</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
                <span class="n">hrd</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">getHRD</span><span class="p">(</span><span class="n">actbasepath</span><span class="p">)</span>
                <span class="n">hrd</span><span class="o">.</span><span class="n">checkValidity</span><span class="p">(</span><span class="n">templ</span><span class="p">,</span><span class="n">hrddata</span><span class="o">=</span><span class="n">hrddata</span><span class="p">)</span>

        <span class="c">#########</span>
        <span class="c">#now load the ones which are specific per instance</span>
        <span class="n">hrdinstancepath</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathInstance</span><span class="p">(),</span><span class="s">&quot;hrdinstance&quot;</span><span class="p">)</span>  
        <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">createDir</span><span class="p">(</span><span class="n">hrdinstancepath</span><span class="p">)</span>        
        <span class="n">hrdtemplatesPath</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathMetadata</span><span class="p">(),</span><span class="s">&quot;hrdinstance&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">hrdtemplatesPath</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">listFilesInDir</span><span class="p">(</span><span class="n">hrdtemplatesPath</span><span class="p">):</span>
                <span class="n">base</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">getBaseName</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">base</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;&gt;</span><span class="s">&quot;_&quot;</span><span class="p">:</span>
                    <span class="n">templ</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">fileGetContents</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>                
                    <span class="n">actbasepath</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathInstance</span><span class="p">(),</span><span class="s">&quot;hrdinstance&quot;</span><span class="p">,</span><span class="n">base</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">actbasepath</span><span class="p">):</span>
                        <span class="c">#means there is no hrd, put empty file</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;did not find instance hrd for </span><span class="si">%s</span><span class="s">, will now put there&quot;</span><span class="o">%</span><span class="n">actbasepath</span><span class="p">,</span><span class="n">category</span><span class="o">=</span><span class="s">&quot;init&quot;</span><span class="p">)</span>
                        <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">writeFile</span><span class="p">(</span><span class="n">actbasepath</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
                    <span class="n">hrd</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">getHRD</span><span class="p">(</span><span class="n">actbasepath</span><span class="p">)</span>
                    <span class="n">hrd</span><span class="o">.</span><span class="n">checkValidity</span><span class="p">(</span><span class="n">templ</span><span class="p">,</span><span class="n">hrddata</span><span class="o">=</span><span class="n">hrddata</span><span class="p">)</span>

        <span class="n">j</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">loadConfig</span><span class="p">()</span> <span class="c">#makes sure hrd gets reloaded to application.config object</span>

    <span class="c"># @JPLock</span>
    <span class="k">def</span> <span class="nf">_copyMetadataToActive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">hrddata</span><span class="o">=</span><span class="p">{}):</span>
        
        <span class="n">instancepathactions</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathInstance</span><span class="p">(),</span><span class="s">&quot;actions&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">isDir</span><span class="p">(</span><span class="n">instancepathactions</span><span class="p">):</span>
            <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">removeDirTree</span><span class="p">(</span><span class="n">instancepathactions</span><span class="p">)</span>
        <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">createDir</span><span class="p">(</span><span class="n">instancepathactions</span><span class="p">)</span>
        
        <span class="n">sourcepath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathMetadata</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">actionname</span> <span class="ow">in</span> <span class="n">j</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">getActionNamesInstance</span><span class="p">():</span>
            <span class="n">srcpath</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">sourcepath</span><span class="p">,</span><span class="s">&quot;actions&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">.py&quot;</span><span class="o">%</span><span class="n">actionname</span><span class="p">)</span>
            <span class="n">destpath</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">instancepathactions</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">.py&quot;</span><span class="o">%</span><span class="n">actionname</span><span class="p">)</span>
            <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">copyFile</span><span class="p">(</span><span class="n">srcpath</span><span class="p">,</span><span class="n">destpath</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_installActiveHrd</span><span class="p">(</span><span class="n">hrddata</span><span class="o">=</span><span class="n">hrddata</span><span class="p">)</span>
        <span class="n">hrdinstancepath</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathInstance</span><span class="p">(),</span><span class="s">&quot;hrdinstance&quot;</span><span class="p">)</span> 

        <span class="bp">self</span><span class="o">.</span><span class="n">hrd_instance</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">getHRD</span><span class="p">(</span><span class="n">hrdinstancepath</span><span class="p">)</span>

        <span class="n">dir2apply</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathInstance</span><span class="p">()</span>

        <span class="c">#apply apackage hrd data on actions active</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hrd_instance</span><span class="o">.</span><span class="n">applyOnDir</span><span class="p">(</span><span class="n">dir2apply</span><span class="p">)</span> 
        <span class="c">#make sure params are filled in in actions dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">applyOnDir</span><span class="p">(</span><span class="n">dir2apply</span><span class="p">)</span> 
        <span class="c">#apply hrd config from system on actions active</span>
        <span class="n">j</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">applyOnDir</span><span class="p">(</span><span class="n">dir2apply</span><span class="p">)</span>

        <span class="n">additionalArgs</span><span class="o">=</span><span class="p">{}</span>
        <span class="n">additionalArgs</span><span class="p">[</span><span class="s">&quot;jp_instance&quot;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span>
        <span class="n">additionalArgs</span><span class="p">[</span><span class="s">&quot;jp_name&quot;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">additionalArgs</span><span class="p">[</span><span class="s">&quot;jp_domain&quot;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span>
        <span class="n">additionalArgs</span><span class="p">[</span><span class="s">&quot;jp_version&quot;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span>

        <span class="n">j</span><span class="o">.</span><span class="n">dirs</span><span class="o">.</span><span class="n">replaceFilesDirVars</span><span class="p">(</span><span class="n">dir2apply</span><span class="p">,</span><span class="n">additionalArgs</span><span class="o">=</span><span class="n">additionalArgs</span><span class="p">)</span>

<div class="viewcode-block" id="JPackageObject.loadBlobStores"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.loadBlobStores">[docs]</a>    <span class="k">def</span> <span class="nf">loadBlobStores</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init</span><span class="p">()</span>
        <span class="n">do</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">getDomainObject</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">do</span><span class="o">.</span><span class="n">blobstorremote</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">&lt;&gt;</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blobstorRemote</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">blobstor</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">do</span><span class="o">.</span><span class="n">blobstorremote</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">do</span><span class="o">.</span><span class="n">blobstorlocal</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">&lt;&gt;</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blobstorLocal</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">blobstor</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">do</span><span class="o">.</span><span class="n">blobstorlocal</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">blobstorRemote</span> <span class="o">==</span><span class="bp">None</span> <span class="ow">or</span>   <span class="bp">self</span><span class="o">.</span><span class="n">blobstorLocal</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raiseError</span><span class="p">(</span><span class="s">&quot;DEBUG NOW blobstorremote or blobstorlocal needs to be available&quot;</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="JPackageObject.getDebugMode"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.getDebugMode">[docs]</a>    <span class="k">def</span> <span class="nf">getDebugMode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">debugMode</span>
</div>
<div class="viewcode-block" id="JPackageObject.getDebugModeInJpackage"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.getDebugModeInJpackage">[docs]</a>    <span class="k">def</span> <span class="nf">getDebugModeInJpackage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&quot;jp.debug&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;jp.debug&quot;</span><span class="p">))</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="JPackageObject.setDebugMode"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.setDebugMode">[docs]</a>    <span class="k">def</span> <span class="nf">setDebugMode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dependencies</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDependencies</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="n">dep</span><span class="o">.</span><span class="n">setDebugMode</span><span class="p">(</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">setDebugMode</span><span class="p">()</span>
        <span class="n">recipe</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getCodeMgmtRecipe</span><span class="p">()</span>
        <span class="n">recipe</span><span class="o">.</span><span class="n">addToProtectedDirs</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">findDefaultInstance</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;set debug mode&quot;</span><span class="p">,</span><span class="n">category</span><span class="o">=</span><span class="s">&quot;init&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="JPackageObject.setDebugModeInJpackage"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.setDebugModeInJpackage">[docs]</a>    <span class="k">def</span> <span class="nf">setDebugModeInJpackage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span> 
        <span class="k">if</span> <span class="n">dependencies</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDependencies</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="n">dep</span><span class="o">.</span><span class="n">setDebugModeInJpackage</span><span class="p">(</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;jp.debug&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">findDefaultInstance</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;set debug mode in jpackage&quot;</span><span class="p">,</span><span class="n">category</span><span class="o">=</span><span class="s">&quot;init&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="JPackageObject.removeDebugModeInJpackage"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.removeDebugModeInJpackage">[docs]</a>    <span class="k">def</span> <span class="nf">removeDebugModeInJpackage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dependencies</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDependencies</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="n">dep</span><span class="o">.</span><span class="n">removeDebugModeInJpackage</span><span class="p">(</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&quot;jp.debug&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;jp.debug&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">findDefaultInstance</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;remove debug mode in jpackage&quot;</span><span class="p">,</span><span class="n">category</span><span class="o">=</span><span class="s">&quot;init&quot;</span><span class="p">)</span>        
</div>
<div class="viewcode-block" id="JPackageObject.removeDebugMode"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.removeDebugMode">[docs]</a>    <span class="k">def</span> <span class="nf">removeDebugMode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">dependencies</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDependencies</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="n">dep</span><span class="o">.</span><span class="n">removeDebugMode</span><span class="p">(</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">recipe</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getCodeMgmtRecipe</span><span class="p">()</span>
        <span class="n">recipe</span><span class="o">.</span><span class="n">removeFromProtectedDirs</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">setDebugMode</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;remove debug mode&quot;</span><span class="p">,</span><span class="n">category</span><span class="o">=</span><span class="s">&quot;init&quot;</span><span class="p">)</span>


<span class="c">###############################################################</span>
<span class="c">############  MAIN OBJECT METHODS (DELETE, ...)  ##############</span>
<span class="c">###############################################################</span>
</div>
    <span class="nd">@JPLock</span>
<div class="viewcode-block" id="JPackageObject.delete"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete all metadata, files of the jpackages</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># self._init()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadActions</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">shellconfig</span><span class="o">.</span><span class="n">interactive</span><span class="p">:</span>
            <span class="n">do</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">dialog</span><span class="o">.</span><span class="n">askYesNo</span><span class="p">(</span><span class="s">&quot;Are you sure you want to remove </span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">, all metadata &amp; files will be removed&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">do</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">do</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">getDataPath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
            <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">removeDirTree</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">getMetadataPath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
            <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">removeDirTree</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPathActions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
            <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">removeDirTree</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="c">#@todo over ftp try to delete the targz file (less urgent), check with other quality levels to make sure we don&#39;t delete files we should not delete</span>
</div>
    <span class="nd">@JPLock</span>
<div class="viewcode-block" id="JPackageObject.save"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a new config file and saves the most important jpackages params in it</span>

<span class="sd">        @param new: True if we are saving a new Q-Package, used to ensure backwards compatibility</span>
<span class="sd">        @type new: boolean</span>
<span class="sd">        &quot;&quot;&quot;</span>      
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#39;saving jpackages data to &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPathMetadata</span><span class="p">(),</span><span class="n">category</span><span class="o">=</span><span class="s">&quot;save&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buildNr</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raiseError</span><span class="p">(</span><span class="s">&quot;buildNr cannot be empty&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;jp.buildNr&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">buildNr</span><span class="p">)</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;jp.export&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">export</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;jp.autobuild&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">autobuild</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;jp.taskletschecksum&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">taskletsChecksum</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;jp.hrdchecksum&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">hrdChecksum</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;jp.descrchecksum&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">descrChecksum</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;jp.supportedplatforms&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">supportedPlatforms</span><span class="p">)</span>

        <span class="c"># for idx, dependency in enumerate(self.dependencies):</span>
        <span class="c">#     self._addDependencyToHRD(idx, dependency.domain, dependency.name,minversion=dependency.minversion,maxversion=dependency.maxversion)</span>
</div>
    <span class="nd">@JPLock</span>
    <span class="k">def</span> <span class="nf">_addDependencyToHRD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">minversion</span><span class="p">,</span> <span class="n">maxversion</span><span class="p">):</span>
        <span class="n">hrd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span>
        <span class="n">basekey</span> <span class="o">=</span> <span class="s">&#39;jp.dependency.</span><span class="si">%s</span><span class="s">.</span><span class="si">%%</span><span class="s">s&#39;</span> <span class="o">%</span> <span class="n">idx</span>
        <span class="k">def</span> <span class="nf">setValue</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="n">hrd</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">basekey</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="n">setValue</span><span class="p">(</span><span class="s">&#39;domain&#39;</span><span class="p">,</span> <span class="n">domain</span><span class="p">)</span>
        <span class="n">setValue</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">setValue</span><span class="p">(</span><span class="s">&#39;minversion&#39;</span><span class="p">,</span> <span class="n">minversion</span><span class="p">)</span>
        <span class="n">setValue</span><span class="p">(</span><span class="s">&#39;maxversion&#39;</span><span class="p">,</span> <span class="n">maxversion</span><span class="p">)</span>

<span class="c">##################################################################################################</span>
<span class="c">###################################  DEPENDENCY HANDLING  #######################################</span>
<span class="c">##################################################################################################</span>


<div class="viewcode-block" id="JPackageObject.loadDependencies"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.loadDependencies">[docs]</a>    <span class="k">def</span> <span class="nf">loadDependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">errorIfNotFound</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">==</span><span class="p">[]:</span>

            <span class="n">ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">prefix</span><span class="p">(</span><span class="s">&#39;jp.dependency&#39;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_raiseError</span><span class="p">(</span><span class="s">&quot;Error in jpackage hrd:</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="p">)</span>

            <span class="n">ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
            <span class="n">ids</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="c">#walk over found id&#39;s</span>
            <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
                <span class="n">key</span><span class="o">=</span><span class="s">&quot;jp.dependency.</span><span class="si">%s</span><span class="s">.</span><span class="si">%%</span><span class="s">s&quot;</span><span class="o">%</span><span class="nb">id</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">key</span> <span class="o">%</span> <span class="s">&#39;minversion&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">key</span> <span class="o">%</span> <span class="s">&#39;minversion&#39;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">key</span> <span class="o">%</span> <span class="s">&#39;maxversion&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">key</span> <span class="o">%</span> <span class="s">&#39;maxversion&#39;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
                   
                <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span> <span class="o">%</span> <span class="s">&#39;name&#39;</span><span class="p">)</span>
                <span class="n">domain</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span> <span class="o">%</span> <span class="s">&#39;domain&#39;</span><span class="p">)</span>
                <span class="n">minversion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span> <span class="o">%</span> <span class="s">&#39;minversion&#39;</span><span class="p">)</span>
                <span class="n">maxversion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span> <span class="o">%</span> <span class="s">&#39;maxversion&#39;</span><span class="p">)</span>

                <span class="n">deppack</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">findNewest</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span><span class="n">name</span><span class="p">,</span>\
                    <span class="n">minversion</span><span class="o">=</span><span class="n">minversion</span><span class="p">,</span><span class="n">maxversion</span><span class="o">=</span><span class="n">maxversion</span><span class="p">,</span><span class="n">returnNoneIfNotFound</span><span class="o">=</span><span class="ow">not</span><span class="p">(</span><span class="n">errorIfNotFound</span><span class="p">))</span> <span class="c">#,platform=j.system.platformtype.myplatformdeppack.loadDependencies()</span>

                <span class="k">if</span> <span class="n">errorIfNotFound</span> <span class="o">==</span> <span class="bp">False</span> <span class="ow">and</span> <span class="n">deppack</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">deppackKey</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">__</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">deppack</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">deppack</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dependenciesNames</span><span class="p">[</span><span class="n">deppackKey</span><span class="p">]</span><span class="o">=</span><span class="n">deppack</span>

                <span class="c">#now deps of deps</span>
                <span class="n">deppack</span><span class="o">.</span><span class="n">loadDependencies</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deppack</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">deppack2</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">deppack</span><span class="o">.</span><span class="n">dependencies</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">deppack2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">deppack2</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deppack2</span><span class="p">)</span>
                    <span class="n">deppackKey2</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">__</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">deppack2</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">deppack2</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dependenciesNames</span><span class="p">[</span><span class="n">deppackKey2</span><span class="p">]</span><span class="o">=</span><span class="n">deppack2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="JPackageObject.addDependency"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.addDependency">[docs]</a>    <span class="k">def</span> <span class="nf">addDependency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">supportedplatforms</span><span class="p">,</span> <span class="n">minversion</span><span class="p">,</span> <span class="n">maxversion</span><span class="p">,</span> <span class="n">dependencytype</span><span class="p">):</span>
        <span class="n">dep</span> <span class="o">=</span> <span class="n">DependencyDef4</span><span class="p">()</span>
        <span class="n">dep</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">dep</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span>
        <span class="n">dep</span><span class="o">.</span><span class="n">minversion</span> <span class="o">=</span> <span class="n">minversion</span>
        <span class="n">dep</span><span class="o">.</span><span class="n">maxversion</span> <span class="o">=</span> <span class="n">maxversion</span>
        <span class="c"># dep.supportedPlatforms = supportedplatforms</span>
        <span class="c"># dep.dependencytype = j.enumerators.DependencyType4.getByName(dependencytype)</span>
        <span class="c"># self.dependencyDefs.append(dep)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">=</span><span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadDependencies</span><span class="p">()</span>
        

<span class="c">#############################################################################</span>
<span class="c">####################################  GETS  #################################</span>
<span class="c">#############################################################################</span>
</div>
<div class="viewcode-block" id="JPackageObject.getIsPreparedForUpdatingFiles"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.getIsPreparedForUpdatingFiles">[docs]</a>    <span class="k">def</span> <span class="nf">getIsPreparedForUpdatingFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return true if package has been prepared</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prepared</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">prepared</span>
        <span class="k">if</span> <span class="n">prepared</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="JPackageObject.getKey"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.getKey">[docs]</a>    <span class="k">def</span> <span class="nf">getKey</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">|</span><span class="si">%s</span><span class="s">|</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="JPackageObject.getDependingInstalledPackages"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.getDependingInstalledPackages">[docs]</a>    <span class="k">def</span> <span class="nf">getDependingInstalledPackages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">errorIfNotFound</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the packages that are dependent on this packages and installed on this machine</span>
<span class="sd">        This is a heavy operation and might take some time</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">##self.assertAccessable()</span>
        <span class="k">if</span> <span class="n">errorIfNotFound</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDependingPackages</span><span class="p">(</span><span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">,</span> <span class="n">errorIfNotFound</span><span class="o">=</span><span class="n">errorIfNotFound</span><span class="p">)</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raiseError</span><span class="p">(</span><span class="s">&quot;No depending packages present&quot;</span><span class="p">)</span>
        <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDependingPackages</span><span class="p">(</span><span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">,</span> <span class="n">errorIfNotFound</span><span class="o">=</span><span class="n">errorIfNotFound</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isInstalled</span><span class="p">()]</span>
</div>
<div class="viewcode-block" id="JPackageObject.getDependingPackages"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.getDependingPackages">[docs]</a>    <span class="k">def</span> <span class="nf">getDependingPackages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">errorIfNotFound</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the packages that are dependent on this package</span>
<span class="sd">        This is a heavy operation and might take some time</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">j</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">getJPackageObjects</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">getDependencies</span><span class="p">(</span><span class="n">errorIfNotFound</span><span class="p">)]</span>
</div>
    <span class="k">def</span> <span class="nf">_getState</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c">##self.assertAccessable()</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        from dir get [qbase]/cfg/jpackages/state/$jpackagesdomain_$jpackagesname_$jpackagesversion.state</span>
<span class="sd">        is a inifile with following variables</span>
<span class="sd">        * lastinstalledbuildnr</span>
<span class="sd">        * lastaction</span>
<span class="sd">        * lasttag</span>
<span class="sd">        * lastactiontime  epoch of last time an action was done</span>
<span class="sd">        * currentaction  (&quot;&quot; if no action current)</span>
<span class="sd">        * currenttag (&quot;&quot; if no action current)</span>
<span class="sd">        * lastexpandedbuildNr  (means expanded from tgz into jpackages dir)</span>
<span class="sd">        @return a JpackageStateObject</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">=</span><span class="n">JPackageStateObject</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="JPackageObject.getVersionAsInt"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.getVersionAsInt">[docs]</a>    <span class="k">def</span> <span class="nf">getVersionAsInt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Translate string version representation to a number</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">##self.assertAccessable()</span>
        <span class="c">#@todo</span>
        <span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="JPackageObject.getPathInstance"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.getPathInstance">[docs]</a>    <span class="k">def</span> <span class="nf">getPathInstance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return absolute pathname of the package&#39;s metadatapath</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">j</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">getJPActiveInstancePath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="JPackageObject.getPathMetadata"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.getPathMetadata">[docs]</a>    <span class="k">def</span> <span class="nf">getPathMetadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return absolute pathname of the package&#39;s metadatapath active instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">j</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">getMetadataPath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="JPackageObject.getPathFiles"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.getPathFiles">[docs]</a>    <span class="k">def</span> <span class="nf">getPathFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return absolute pathname of the jpackages&#39;s filespath</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">##self.assertAccessable()</span>
        <span class="k">return</span> <span class="n">j</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">getDataPath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="JPackageObject.getPathFilesPlatform"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.getPathFilesPlatform">[docs]</a>    <span class="k">def</span> <span class="nf">getPathFilesPlatform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">platform</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return absolute pathname of the jpackages&#39;s filespath</span>
<span class="sd">        if not given then will be: j.system.platformtype</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">##self.assertAccessable()</span>
        <span class="k">if</span> <span class="n">platform</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
            <span class="n">platform</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">platformtype</span><span class="o">.</span><span class="n">myplatform</span>
        <span class="n">platform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getPackageInteractive</span><span class="p">(</span><span class="n">platform</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span>  <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathFiles</span><span class="p">(),</span> <span class="nb">str</span><span class="p">(</span><span class="n">platform</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">path</span>
</div>
<div class="viewcode-block" id="JPackageObject.getPathFilesPlatformForSubDir"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.getPathFilesPlatformForSubDir">[docs]</a>    <span class="k">def</span> <span class="nf">getPathFilesPlatformForSubDir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return absolute pathnames of the jpackages&#39;s filespath for platform or parent of platform if it does not exist in lowest level</span>
<span class="sd">        if platform not given then will be: j.system.platformtype</span>
<span class="sd">        the subdir will be used to check upon if found in one of the dirs, if never found will raise error</span>
<span class="sd">        all matching results are returned</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">possibleplatform</span> <span class="ow">in</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">platformtype</span><span class="o">.</span><span class="n">getMyRelevantPlatforms</span><span class="p">():</span>
            <span class="c"># print platform</span>
            <span class="n">path</span> <span class="o">=</span>  <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathFiles</span><span class="p">(),</span> <span class="n">possibleplatform</span><span class="p">,</span><span class="n">subdir</span><span class="p">)</span>
            <span class="c">#print path</span>
            <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raiseError</span><span class="p">(</span><span class="s">&quot;Could not find subdir </span><span class="si">%s</span><span class="s"> in files dirs for &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="JPackageObject.getPathSourceCode"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.getPathSourceCode">[docs]</a>    <span class="k">def</span> <span class="nf">getPathSourceCode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return absolute path to where this package&#39;s source can be extracted to</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
        <span class="c">#return j.system.fs.joinPaths(j.dirs.varDir, &#39;src&#39;, self.name, self.version)</span>
</div>
<div class="viewcode-block" id="JPackageObject.getHighestInstalledBuildNr"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.getHighestInstalledBuildNr">[docs]</a>    <span class="k">def</span> <span class="nf">getHighestInstalledBuildNr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the latetst installed buildnumber</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">##self.assertAccessable()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">lastinstalledbuildnr</span>
</div>
<div class="viewcode-block" id="JPackageObject.buildNrIncrement"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.buildNrIncrement">[docs]</a>    <span class="k">def</span> <span class="nf">buildNrIncrement</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">buildNr</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">ql</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getQualityLevels</span><span class="p">():</span>
            <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getMetadataPathQualityLevel</span><span class="p">(</span><span class="n">ql</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">path</span><span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s">&quot;hrd&quot;</span><span class="p">,</span><span class="s">&quot;main.hrd&quot;</span><span class="p">)</span>
                <span class="n">buildNr2</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">getHRD</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">getInt</span><span class="p">(</span><span class="s">&quot;jp.buildNr&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">buildNr2</span><span class="o">&gt;</span><span class="n">buildNr</span><span class="p">:</span>
                    <span class="n">buildNr</span><span class="o">=</span><span class="n">buildNr2</span>
        
        <span class="n">buildNr</span><span class="o">+=</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buildNr</span><span class="o">=</span><span class="n">buildNr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">buildNr</span>
            </div>
<div class="viewcode-block" id="JPackageObject.getMetadataPathQualityLevel"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.getMetadataPathQualityLevel">[docs]</a>    <span class="k">def</span> <span class="nf">getMetadataPathQualityLevel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ql</span><span class="p">):</span>
        <span class="n">path</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">dirs</span><span class="o">.</span><span class="n">packageDirMD</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">isLink</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raiseError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> needs to be link&quot;</span><span class="o">%</span><span class="n">path</span><span class="p">)</span>
        <span class="n">jpackagesdir</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">getParent</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="n">path</span><span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">jpackagesdir</span><span class="p">,</span><span class="n">ql</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">path</span>
</div>
<div class="viewcode-block" id="JPackageObject.getQualityLevels"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.getQualityLevels">[docs]</a>    <span class="k">def</span> <span class="nf">getQualityLevels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">path</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">dirs</span><span class="o">.</span><span class="n">packageDirMD</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">isLink</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raiseError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> needs to be link&quot;</span><span class="o">%</span><span class="n">path</span><span class="p">)</span>
        <span class="n">jpackageconfig</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getConfig</span><span class="p">(</span><span class="s">&#39;sources&#39;</span><span class="p">,</span> <span class="s">&#39;jpackages&#39;</span><span class="p">)</span>
        <span class="n">ql</span> <span class="o">=</span> <span class="n">jpackageconfig</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;qualitylevel&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">ql</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ql</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">ql</span>
</div>
<div class="viewcode-block" id="JPackageObject.getBrokenDependencies"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.getBrokenDependencies">[docs]</a>    <span class="k">def</span> <span class="nf">getBrokenDependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">platform</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list of dependencies that cannot be resolved</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">platform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getPackageInteractive</span><span class="p">(</span><span class="n">platform</span><span class="p">)</span>
        <span class="n">broken</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span>   <span class="c"># go over my dependencies</span>
                                        <span class="c"># Do this without try catch</span>
                                        <span class="c"># pass boolean to findnewest that it should return None instead of fail</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">j</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">findNewest</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="n">dep</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">dep</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">minversion</span><span class="o">=</span><span class="n">dep</span><span class="o">.</span><span class="n">minversion</span><span class="p">,</span> <span class="n">maxversion</span><span class="o">=</span><span class="n">dep</span><span class="o">.</span><span class="n">maxversion</span><span class="p">,</span> <span class="n">platform</span><span class="o">=</span><span class="n">platform</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">print</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">broken</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">broken</span>
</div>
<div class="viewcode-block" id="JPackageObject.getDependencies"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.getDependencies">[docs]</a>    <span class="k">def</span> <span class="nf">getDependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">errorIfNotFound</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the dependencies for the JPackage</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadDependencies</span><span class="p">(</span><span class="n">errorIfNotFound</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span>
</div>
<div class="viewcode-block" id="JPackageObject.getInstanceNames"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.getInstanceNames">[docs]</a>    <span class="k">def</span> <span class="nf">getInstanceNames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">root</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">dirs</span><span class="o">.</span><span class="n">packageDir</span><span class="p">,</span> <span class="s">&quot;instance&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">listDirsInDir</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="bp">False</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_getPackageInteractive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">platform</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">platform</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">supportedPlatforms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">platform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">supportedPlatforms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">platform</span><span class="o">==</span><span class="bp">None</span> <span class="ow">and</span> <span class="n">j</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">shellconfig</span><span class="o">.</span><span class="n">interactive</span><span class="p">:</span>
            <span class="n">platform</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">dialog</span><span class="o">.</span><span class="n">askChoice</span><span class="p">(</span><span class="s">&quot;Select platform.&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">supportedPlatforms</span> <span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="bp">None</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">platform</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
            <span class="n">platform</span><span class="o">=</span><span class="bp">None</span>
        <span class="k">return</span> <span class="n">platform</span>

    <span class="k">def</span> <span class="nf">_copyBlobInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">copyDirTree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_blobfolder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_activeblobfolder</span><span class="p">)</span>

<div class="viewcode-block" id="JPackageObject.getBlobInfo"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.getBlobInfo">[docs]</a>    <span class="k">def</span> <span class="nf">getBlobInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">platform</span><span class="p">,</span><span class="n">ttype</span><span class="p">,</span><span class="n">active</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        @return blobkey,[[md5,path],...]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">blobfolder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blobfolder</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">active</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_activeblobfolder</span>
        <span class="n">path</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">blobfolder</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">___</span><span class="si">%s</span><span class="s">.info&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span><span class="n">ttype</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">content</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">fileGetContents</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">splitted</span><span class="o">=</span><span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">key</span><span class="o">=</span><span class="n">splitted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">result</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">splitted</span><span class="o">=</span><span class="n">splitted</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">splitted</span><span class="p">:</span>
                <span class="n">item</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">==</span><span class="s">&quot;&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;|&quot;</span><span class="p">)])</span>
            <span class="k">return</span> <span class="n">key</span><span class="p">,</span><span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span><span class="p">,[]</span>
</div>
<div class="viewcode-block" id="JPackageObject.getBlobItemPaths"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.getBlobItemPaths">[docs]</a>    <span class="k">def</span> <span class="nf">getBlobItemPaths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">platform</span><span class="p">,</span><span class="n">ttype</span><span class="p">,</span><span class="n">blobitempath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        translates the item as shown in the blobinfo to the corresponding paths (jpackageFilesPath,destpathOnSystem)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">platform</span><span class="o">=</span><span class="n">platform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">ttype</span><span class="o">=</span><span class="n">ttype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">ptype</span> <span class="o">=</span> <span class="n">ttype</span>
        <span class="k">if</span> <span class="n">ptype</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;cr_&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">ptype</span><span class="o">=</span><span class="n">ttype</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>

        <span class="n">filespath</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathFiles</span><span class="p">(),</span><span class="n">platform</span><span class="p">,</span><span class="n">ttype</span><span class="p">,</span><span class="n">blobitempath</span><span class="p">)</span>
        <span class="n">systemdest</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">getTypePath</span><span class="p">(</span><span class="n">ptype</span><span class="p">,</span> <span class="n">blobitempath</span><span class="p">,</span><span class="n">jp</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">filespath</span><span class="p">,</span><span class="n">systemdest</span><span class="p">)</span>
</div>
    <span class="nd">@JPLock</span>
<div class="viewcode-block" id="JPackageObject.getBlobPlatformTypes"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.getBlobPlatformTypes">[docs]</a>    <span class="k">def</span> <span class="nf">getBlobPlatformTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        @return [[platform,ttype],...]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blobfolder</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">active</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_activeblobfolder</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">active</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">result</span>
        <span class="n">infofiles</span><span class="o">=</span><span class="p">[</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">getBaseName</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">listFilesInDir</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span> <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;___&quot;</span><span class="p">)</span><span class="o">&lt;&gt;-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">infofiles</span><span class="p">:</span>
            <span class="n">platform</span><span class="p">,</span><span class="n">ttype</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;___&quot;</span><span class="p">)</span>
            <span class="n">ttype</span><span class="o">=</span><span class="n">ttype</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;.info&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ttype</span><span class="o">&lt;&gt;</span><span class="s">&quot;&quot;</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">platform</span><span class="p">,</span><span class="n">ttype</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="JPackageObject.getCodeLocationsFromRecipe"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.getCodeLocationsFromRecipe">[docs]</a>    <span class="k">def</span> <span class="nf">getCodeLocationsFromRecipe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">items</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCodeMgmtRecipe</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
            <span class="n">item</span><span class="o">.</span><span class="n">systemdest</span>
            <span class="n">path</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">getSource</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">isFile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">path</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">getDirName</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            
        <span class="n">items</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">result</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">previtem</span><span class="o">=</span><span class="s">&quot;willnotfindthis&quot;</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)):</span>                
            <span class="n">item</span><span class="o">=</span><span class="n">items</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
            <span class="c"># print &quot;previtem:%s now:%s&quot;%(previtem,item)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">previtem</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">previtem</span><span class="o">=</span><span class="n">item</span>
                <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                    <span class="c"># print &quot;append&quot;</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> 
        
        <span class="k">return</span> <span class="n">result</span>
</div>
    <span class="k">def</span> <span class="nf">_getPlatformDirsToCopy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list of platform related directories to be copied in sandbox</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">platformDirs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">platform</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">platformtype</span>

        <span class="n">_jpackagesDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPathFiles</span><span class="p">()</span>

        <span class="n">platformSpecificDir</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">_jpackagesDir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">platform</span><span class="p">),</span> <span class="s">&#39;&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">isDir</span><span class="p">(</span><span class="n">platformSpecificDir</span><span class="p">):</span>
            <span class="n">platformDirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">platformSpecificDir</span><span class="p">)</span>

        <span class="n">genericDir</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">_jpackagesDir</span><span class="p">,</span> <span class="s">&#39;generic&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">isDir</span><span class="p">(</span><span class="n">genericDir</span><span class="p">):</span>
            <span class="n">platformDirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">genericDir</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">isUnix</span><span class="p">():</span>
            <span class="n">unixDir</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">_jpackagesDir</span><span class="p">,</span> <span class="s">&#39;unix&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">isDir</span><span class="p">(</span><span class="n">unixDir</span><span class="p">):</span>
                <span class="n">platformDirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unixDir</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">isSolaris</span><span class="p">():</span>
                <span class="n">sourceDir</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">_jpackagesDir</span><span class="p">,</span> <span class="s">&#39;solaris&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">platform</span><span class="o">.</span><span class="n">isLinux</span><span class="p">():</span>
                <span class="n">sourceDir</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">_jpackagesDir</span><span class="p">,</span> <span class="s">&#39;linux&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">platform</span><span class="o">.</span><span class="n">isDarwin</span><span class="p">():</span>
                <span class="n">sourceDir</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">_jpackagesDir</span><span class="p">,</span> <span class="s">&#39;darwin&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">platform</span><span class="o">.</span><span class="n">isWindows</span><span class="p">():</span>
            <span class="n">sourceDir</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">_jpackagesDir</span><span class="p">,</span> <span class="s">&#39;win&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">isDir</span><span class="p">(</span><span class="n">sourceDir</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">(</span><span class="n">sourceDir</span><span class="p">)</span> <span class="ow">in</span> <span class="n">platformDirs</span><span class="p">:</span>
                <span class="n">platformDirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sourceDir</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">platformDirs</span>

<span class="c">#############################################################################</span>
<span class="c">################################  CHECKS  ###################################</span>
<span class="c">#############################################################################</span>

<div class="viewcode-block" id="JPackageObject.hasModifiedFiles"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.hasModifiedFiles">[docs]</a>    <span class="k">def</span> <span class="nf">hasModifiedFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if files are modified in the JPackage files</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">##self.assertAccessable()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">prepared</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="JPackageObject.hasModifiedMetaData"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.hasModifiedMetaData">[docs]</a>    <span class="k">def</span> <span class="nf">hasModifiedMetaData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if files are modified in the JPackage metadata</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">##self.assertAccessable()</span>
        <span class="k">return</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">j</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">getDomainObject</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">)</span><span class="o">.</span><span class="n">getJPackageTuplesWithModifiedMetadata</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="JPackageObject.isInstalled"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.isInstalled">[docs]</a>    <span class="k">def</span> <span class="nf">isInstalled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">checkAndDie</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">hrdcheck</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the JPackage is installed</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">installed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">lastinstalledbuildnr</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">if</span> <span class="n">hrdcheck</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">instance</span><span class="o">&lt;&gt;</span><span class="bp">None</span><span class="p">:</span>
                <span class="n">hrdinstancepath</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">getJPActiveInstancePath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">instance</span><span class="p">),</span><span class="s">&quot;hrdinstance&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hrdinstancepath</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathInstance</span><span class="p">(),</span><span class="s">&quot;hrdinstance&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">hrdinstancepath</span><span class="p">):</span>
                <span class="n">installed</span><span class="o">=</span><span class="bp">False</span>

        <span class="k">if</span> <span class="n">checkAndDie</span> <span class="ow">and</span> <span class="n">installed</span><span class="o">==</span><span class="bp">False</span><span class="p">:</span>
            <span class="n">j</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">opserror_critical</span><span class="p">(</span><span class="s">&quot;Jpackage </span><span class="si">%s</span><span class="s"> is not installed, cannot continue.&quot;</span><span class="o">%</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">installed</span>
</div>
<div class="viewcode-block" id="JPackageObject.supportsPlatform"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.supportsPlatform">[docs]</a>    <span class="k">def</span> <span class="nf">supportsPlatform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">platform</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if a JPackage can be installed on a platform</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">platform</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
            <span class="n">relevant</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">platformtype</span><span class="o">.</span><span class="n">getMyRelevantPlatforms</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">relevant</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">platformtype</span><span class="o">.</span><span class="n">getParents</span><span class="p">(</span><span class="n">platform</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">supportedPlatform</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">supportedPlatforms</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">supportedPlatform</span> <span class="ow">in</span> <span class="n">relevant</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
    <span class="k">def</span> <span class="nf">_isHostPlatformSupported</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">platform</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Checks if a given platform is supported, the checks takes the</span>
<span class="sd">        supported platform their parents in account.</span>

<span class="sd">        @param platform: platform to check</span>
<span class="sd">        @type platform: j.system.platformtype</span>

<span class="sd">        @return: flag that indicates if the given platform is supported</span>
<span class="sd">        @rtype: Boolean</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c">#@todo P1 no longer working use new j.system.platformtype</span>

        <span class="n">supportedPlatformPool</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">platform</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">supportedPlatforms</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">platform</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">supportedPlatformPool</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">platform</span><span class="p">)</span>
                <span class="n">platform</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">parent</span>

        <span class="k">if</span> <span class="n">platform</span> <span class="ow">in</span> <span class="n">supportedPlatformPool</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

<span class="c">#############################################################################</span>
<span class="c">#################################  ACTIONS  ################################</span>
<span class="c">#############################################################################</span>

    <span class="nd">@JPLock</span>
<div class="viewcode-block" id="JPackageObject.start"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start the JPackage, run the start tasklet(s)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isInstalled</span><span class="p">(</span><span class="n">checkAndDie</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">dependencies</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDependencies</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="n">dep</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">process_start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#39;start&#39;</span><span class="p">)</span>
</div>
    <span class="nd">@JPLock</span>
<div class="viewcode-block" id="JPackageObject.stop"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">walkinstances</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop the JPackage, run the stop tasklet(s)</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="k">if</span> <span class="n">dependencies</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDependencies</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="n">dep</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">walkinstances</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">iname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInstanceNames</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">iname</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">walkinstances</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isInstalled</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>        
                <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">process_stop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#39;stop&#39;</span><span class="p">)</span>
</div>
    <span class="nd">@JPLock</span>
<div class="viewcode-block" id="JPackageObject.kill"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.kill">[docs]</a>    <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop the JPackage, run the stop tasklet(s)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isInstalled</span><span class="p">(</span><span class="n">checkAndDie</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dependencies</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDependencies</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="n">dep</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">process_kill</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#39;stop&#39;</span><span class="p">)</span>
</div>
    <span class="nd">@JPLock</span>
<div class="viewcode-block" id="JPackageObject.monitor"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.monitor">[docs]</a>    <span class="k">def</span> <span class="nf">monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">result</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop the JPackage, run the stop tasklet(s)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dependencies</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDependencies</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="n">result</span><span class="o">=</span><span class="n">result</span> <span class="o">&amp;</span> <span class="n">dep</span><span class="o">.</span><span class="n">monitor</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span><span class="n">result</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>        
        <span class="k">print</span> <span class="s">&quot;monitor for: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="bp">self</span>
        <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="o">&amp;</span><span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">monitor_up_local</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
    <span class="nd">@JPLock</span>
<div class="viewcode-block" id="JPackageObject.monitor_net"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.monitor_net">[docs]</a>    <span class="k">def</span> <span class="nf">monitor_net</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ipaddr</span><span class="o">=</span><span class="s">&quot;localhost&quot;</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">result</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop the JPackage, run the stop tasklet(s)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dependencies</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDependencies</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="n">result</span><span class="o">=</span><span class="n">result</span> <span class="o">&amp;</span> <span class="n">dep</span><span class="o">.</span><span class="n">monitor</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span><span class="n">result</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>        
        <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="o">&amp;</span><span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">monitor_up_net</span><span class="p">(</span><span class="n">ipaddr</span><span class="o">=</span><span class="n">ipaddr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
    <span class="nd">@JPLock</span>
<div class="viewcode-block" id="JPackageObject.restart"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.restart">[docs]</a>    <span class="k">def</span> <span class="nf">restart</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Restart the JPackage</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="k">if</span> <span class="n">dependencies</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDependencies</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="n">dep</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">process_stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">process_start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#39;stop&#39;</span><span class="p">)</span>


        <span class="c"># if dependencies:</span>
        <span class="c">#     deps = self.getDependencies()</span>
        <span class="c">#     for dep in deps:</span>
        <span class="c">#         dep.restart(False)</span>
        <span class="c"># self.loadActions()</span>
        <span class="c"># self.stop()</span>
        <span class="c"># self.start()</span>
</div>
<div class="viewcode-block" id="JPackageObject.isrunning"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.isrunning">[docs]</a>    <span class="k">def</span> <span class="nf">isrunning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">ipaddr</span><span class="o">=</span><span class="s">&quot;localhost&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if application installed is running for jpackages</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="p">(</span><span class="n">dependencies</span><span class="o">=</span><span class="n">dependencies</span><span class="p">)</span>
        <span class="c"># self.monitor_up_net(dependencies=dependencies,ipaddr=ipaddr)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#39;isrunning&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="JPackageObject.reinstall"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.reinstall">[docs]</a>    <span class="k">def</span> <span class="nf">reinstall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reinstall the JPackage by running its install tasklet, best not to use dependancies reinstall </span>
<span class="sd">        &quot;&quot;&quot;</span>                
        <span class="bp">self</span><span class="o">.</span><span class="n">install</span><span class="p">(</span><span class="n">dependencies</span><span class="o">=</span><span class="n">dependencies</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="n">download</span><span class="p">,</span> <span class="n">reinstall</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
    <span class="nd">@JPLock</span>
<div class="viewcode-block" id="JPackageObject.prepare"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.prepare">[docs]</a>    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dependencies</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dependencies</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDependencies</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="n">dep</span><span class="o">.</span><span class="n">install</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="n">download</span><span class="p">,</span> <span class="n">reinstall</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">install_prepare</span><span class="p">()</span>
</div>
    <span class="nd">@JPLock</span>
<div class="viewcode-block" id="JPackageObject.copyfiles"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.copyfiles">[docs]</a>    <span class="k">def</span> <span class="nf">copyfiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dependencies</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dependencies</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDependencies</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="n">dep</span><span class="o">.</span><span class="n">copyfiles</span><span class="p">(</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="n">download</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">==</span><span class="bp">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_copyfiles</span><span class="p">(</span><span class="n">doCodeRecipe</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">codeLink</span><span class="p">(</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">install_copy</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="JPackageObject.installDebs"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.installDebs">[docs]</a>    <span class="k">def</span> <span class="nf">installDebs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">platform</span> <span class="ow">in</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">listDirsInDir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathFiles</span><span class="p">(),</span><span class="n">dirNameOnly</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">platform</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">platformtype</span><span class="o">.</span><span class="n">getMyRelevantPlatforms</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="n">pathplatform</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathFiles</span><span class="p">(),</span><span class="n">platform</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ttype</span> <span class="ow">in</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">listDirsInDir</span><span class="p">(</span><span class="n">pathplatform</span><span class="p">,</span><span class="n">dirNameOnly</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">ttype</span> <span class="o">==</span> <span class="s">&#39;debs&#39;</span><span class="p">:</span>
                    <span class="n">fullpath</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">pathplatform</span><span class="p">,</span> <span class="n">ttype</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">file_</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">listFilesInDir</span><span class="p">(</span><span class="n">fullpath</span><span class="p">)):</span>
                        <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">ubuntu</span><span class="o">.</span><span class="n">installDebFile</span><span class="p">(</span><span class="n">file_</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_copyfiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">doCodeRecipe</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cleanupfiles</span><span class="p">(</span><span class="n">doCodeRecipe</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">platform</span> <span class="ow">in</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">listDirsInDir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathFiles</span><span class="p">(),</span><span class="n">dirNameOnly</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">platform</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">platformtype</span><span class="o">.</span><span class="n">getMyRelevantPlatforms</span><span class="p">():</span>
                <span class="k">continue</span>
            
            <span class="c">#first do the debs otherwise the other dirs cannot overwrite what debs do</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">installDebs</span><span class="p">()</span>

            <span class="n">pathplatform</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathFiles</span><span class="p">(),</span><span class="n">platform</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ttype</span> <span class="ow">in</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">listDirsInDir</span><span class="p">(</span><span class="n">pathplatform</span><span class="p">,</span><span class="n">dirNameOnly</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
                <span class="c"># print &quot;type:%s,%s&quot;%(ttype,ttype.find(&quot;cr_&quot;))</span>
                <span class="k">if</span> <span class="n">doCodeRecipe</span><span class="o">==</span><span class="bp">False</span> <span class="ow">and</span> <span class="n">ttype</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;cr_&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;DO NOT COPY, because debug &quot;</span>
                    <span class="k">continue</span> <span class="c">#skip the coderecipe folders</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pathttype</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">pathplatform</span><span class="p">,</span><span class="n">ttype</span><span class="p">)</span>
                    <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">removeIrrelevantFiles</span><span class="p">(</span><span class="n">pathttype</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">ttype</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;etc&quot;</span><span class="p">,</span><span class="s">&quot;cfg&quot;</span><span class="p">]:</span>
                        <span class="n">applyhrd</span><span class="o">=</span><span class="bp">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">applyhrd</span><span class="o">=</span><span class="bp">False</span>
                    <span class="k">if</span> <span class="n">ttype</span> <span class="o">==</span> <span class="s">&#39;debs&#39;</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">tmp</span><span class="p">,</span><span class="n">destination</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getBlobItemPaths</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span><span class="n">ttype</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;copy files from:</span><span class="si">%s</span><span class="s"> to:</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">pathttype</span><span class="p">,</span><span class="n">destination</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__copyFiles</span><span class="p">(</span><span class="n">pathttype</span><span class="p">,</span><span class="n">destination</span><span class="p">,</span><span class="n">applyhrd</span><span class="o">=</span><span class="n">applyhrd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_copyBlobInfo</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_cleanupfiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doCodeRecipe</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">platform</span><span class="p">,</span> <span class="n">ttype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBlobPlatformTypes</span><span class="p">(</span><span class="bp">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">doCodeRecipe</span> <span class="ow">and</span> <span class="n">ttype</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;cr_&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">blobkey</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBlobInfo</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span> <span class="n">ttype</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">md5</span><span class="p">,</span> <span class="n">relativefile</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                    <span class="n">blobpath</span><span class="p">,</span> <span class="n">localpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBlobItemPaths</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span> <span class="n">ttype</span><span class="p">,</span> <span class="n">relativefile</span><span class="p">)</span>
                    <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">localpath</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__copyFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span><span class="n">destination</span><span class="p">,</span><span class="n">applyhrd</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copy the files from package dirs to their proper location in the sandbox.</span>

<span class="sd">        @param destination: destination of the files</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">destination</span><span class="o">==</span><span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raiseError</span><span class="p">(</span><span class="s">&quot;A destination needs to be specified.&quot;</span><span class="p">)</span> <span class="c">#done for safety, jpackage action scripts have to be adjusted</span>

        <span class="k">print</span> <span class="s">&quot;pathplatform:</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">path</span>
        <span class="c">#    self.log(&quot;Copy files from %s to %s&quot;%(path,destination),category=&quot;copy&quot;)</span>
        <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">createDir</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span><span class="n">skipProtectedDirs</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">applyhrd</span><span class="p">:</span>
            <span class="n">tmpdir</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">getTmpDirPath</span><span class="p">()</span>
            <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">copyDirTree</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">tmpdir</span><span class="p">)</span>
            <span class="n">j</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">applyOnDir</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
            <span class="n">j</span><span class="o">.</span><span class="n">dirs</span><span class="o">.</span><span class="n">replaceFilesDirVars</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
            <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">copyDirTree</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span><span class="n">skipProtectedDirs</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">removeDirTree</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">copyDirTree</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span><span class="n">keepsymlinks</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">skipProtectedDirs</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="nd">@JPLock</span>
<div class="viewcode-block" id="JPackageObject.install"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.install">[docs]</a>    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dependencies</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">reinstall</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">reinstalldeps</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">update</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">instance</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">hrddata</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Install the JPackage</span>

<span class="sd">        @param dependencies: if True, all dependencies will be installed too</span>
<span class="sd">        @param download:     if True, bundles of package will be downloaded too</span>
<span class="sd">        @param reinstall:    if True, package will be reinstalled</span>

<span class="sd">        when dependencies the reinstall will not be asked for there</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">supportsPlatform</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raiseError</span><span class="p">(</span><span class="s">&quot;Only those platforms are supported by this package </span><span class="si">%s</span><span class="s"> your system supports the following platforms: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">supportedPlatforms</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">platformtype</span><span class="o">.</span><span class="n">getMyRelevantPlatforms</span><span class="p">())))</span>

        <span class="n">key</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">j</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">inInstall</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;are already in install of jpackage&quot;</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">dependencies</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDependencies</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;**</span><span class="si">%s</span><span class="s"> asks for dependency:</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dep</span><span class="p">)</span>
                <span class="n">dep</span><span class="o">.</span><span class="n">install</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="n">download</span><span class="p">,</span> <span class="n">reinstall</span><span class="o">=</span><span class="n">reinstalldeps</span><span class="p">,</span><span class="n">hrddata</span><span class="o">=</span><span class="n">hrddata</span><span class="p">)</span>

        <span class="c"># If I am already installed assume my dependencies are also installed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buildNr</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">buildNr</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">lastinstalledbuildnr</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">reinstall</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">isInstalled</span><span class="p">(</span><span class="n">instance</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#39;already installed&#39;</span><span class="p">)</span>            
            <span class="c"># if str(instance) in self.getInstanceNames():</span>
            <span class="c">#     self.configure(dependencies=dependencies,instance=instance,hrddata=hrddata)</span>
            <span class="k">return</span> <span class="c"># Nothing to do</span>

        <span class="n">j</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">inInstall</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">=</span><span class="n">instance</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_copyMetadataToActive</span><span class="p">(</span><span class="n">hrddata</span><span class="o">=</span><span class="n">hrddata</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">)</span> <span class="c">#reload actions to make sure new hrdactive are applied</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">download</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">reinstall</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">buildNr</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">lastinstalledbuildnr</span><span class="p">:</span>
            <span class="c">#print &#39;really installing &#39; + str(self)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#39;installing&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">checkNoCurrentAction</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raiseError</span><span class="p">(</span><span class="s">&quot;jpackages is in inconsistent state, ...&quot;</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>            

            <span class="bp">self</span><span class="o">.</span><span class="n">copyfiles</span><span class="p">(</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">install_post</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buildNr</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buildNr</span><span class="o">=</span><span class="mi">0</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#39;install for debug (link)&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">codeLink</span><span class="p">(</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">update</span><span class="p">:</span>
            <span class="c"># if self.buildNr==-1 or self.configchanged or reinstall or self.buildNr &gt; self.state.lastinstalledbuildnr:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buildNr</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buildNr</span><span class="o">=</span><span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">setLastInstalledBuildNr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buildNr</span><span class="p">)</span>

        <span class="n">j</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">inInstall</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="JPackageObject.isNew"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.isNew">[docs]</a>    <span class="k">def</span> <span class="nf">isNew</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buildNr</span><span class="o">==-</span><span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">buildNr</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">lastinstalledbuildnr</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
    <span class="nd">@JPLock</span>
<div class="viewcode-block" id="JPackageObject.uninstall"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.uninstall">[docs]</a>    <span class="k">def</span> <span class="nf">uninstall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unInstallDependingFirst</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove the JPackage from the sandbox. In case dependent JPackages are installed, the JPackage is not removed.</span>

<span class="sd">        @param unInstallDependingFirst: remove first dependent JPackages</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Make sure there are no longer installed packages that depend on me</span>
        <span class="c">##self.assertAccessable()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">loadActions</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">unInstallDependingFirst</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDependingInstalledPackages</span><span class="p">(</span><span class="n">errorIfNotFound</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                <span class="n">p</span><span class="o">.</span><span class="n">uninstall</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDependingInstalledPackages</span><span class="p">(</span><span class="n">recursive</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">errorIfNotFound</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raiseError</span><span class="p">(</span><span class="s">&#39;Other package on the system dependend on this one, uninstall them first!&#39;</span><span class="p">)</span>
        <span class="n">j</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">startupmanager</span><span class="o">.</span><span class="n">remove4JPackage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="s">&quot;install&quot;</span>
        <span class="n">action</span> <span class="o">=</span> <span class="s">&quot;uninstall&quot;</span>
        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span>
        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">checkNoCurrentAction</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raiseError</span><span class="p">(</span><span class="s">&quot;jpackages is in inconsistent state, ...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#39;uninstalling&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">uninstall</span><span class="p">()</span>
        <span class="n">state</span><span class="o">.</span><span class="n">setLastInstalledBuildNr</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="JPackageObject.prepareForUpdatingFiles"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.prepareForUpdatingFiles">[docs]</a>    <span class="k">def</span> <span class="nf">prepareForUpdatingFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">suppressErrors</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        After this command the operator can change the files of the jpackages.</span>
<span class="sd">        Files do not aways come from code repo, they can also come from jpackages repo only</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">createDir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathFiles</span><span class="p">())</span>
        <span class="k">if</span>  <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">prepared</span> <span class="o">&lt;&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isNew</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">suppressErrors</span><span class="o">=</span><span class="n">suppressErrors</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_expand</span><span class="p">(</span><span class="n">suppressErrors</span><span class="o">=</span><span class="n">suppressErrors</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">setPrepared</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</div>
    <span class="nd">@JPLock</span>
<div class="viewcode-block" id="JPackageObject.configure"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.configure">[docs]</a>    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">instance</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">hrddata</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure the JPackage after installation, via the configure tasklet(s)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#39;configure&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">dependencies</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDependencies</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="n">dep</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">instance</span><span class="o">==</span><span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">instanceName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInstanceNames</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">=</span><span class="n">instanceName</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">instance</span><span class="o">=</span><span class="n">instanceName</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_copyMetadataToActive</span><span class="p">(</span><span class="n">hrddata</span><span class="o">=</span><span class="n">hrddata</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">install_configure</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">process_configure</span><span class="p">()</span>
        <span class="c"># self.state.setIsPendingReconfiguration(False)</span>
        <span class="n">j</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">loadConfig</span><span class="p">()</span> <span class="c">#makes sure hrd gets reloaded to application.config object</span>
</div>
    <span class="nd">@JPLock</span>
<div class="viewcode-block" id="JPackageObject.codeExport"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.codeExport">[docs]</a>    <span class="k">def</span> <span class="nf">codeExport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Export code to right locations in sandbox or on system</span>
<span class="sd">        code recipe is being used</span>
<span class="sd">        only the sections in the recipe which are relevant to you will be used</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#39;CodeExport&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dependencies</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">j</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">dialog</span><span class="o">.</span><span class="n">askYesNo</span><span class="p">(</span><span class="s">&quot; Do you want to link the dependencies?&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">update</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">j</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">dialog</span><span class="o">.</span><span class="n">askYesNo</span><span class="p">(</span><span class="s">&quot; Do you want to update your code before exporting?&quot;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">codeUpdate</span><span class="p">(</span><span class="n">dependencies</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dependencies</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDependencies</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="n">dep</span><span class="o">.</span><span class="n">codeExport</span><span class="p">(</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">update</span><span class="o">=</span><span class="n">update</span><span class="p">)</span>
</div>
    <span class="nd">@JPLock</span>
<div class="viewcode-block" id="JPackageObject.codeUpdate"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.codeUpdate">[docs]</a>    <span class="k">def</span> <span class="nf">codeUpdate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update code from code repo (get newest code)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#39;CodeUpdate&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">findDefaultInstance</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="c"># j.clients.mercurial.statusClearAll()</span>
        <span class="k">if</span> <span class="n">dependencies</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDependencies</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="n">dep</span><span class="o">.</span><span class="n">codeUpdate</span><span class="p">(</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">code_update</span><span class="p">()</span>
</div>
    <span class="nd">@JPLock</span>
<div class="viewcode-block" id="JPackageObject.codeCommit"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.codeCommit">[docs]</a>    <span class="k">def</span> <span class="nf">codeCommit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">push</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        update code from code repo (get newest code)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">findDefaultInstance</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#39;CodeCommit&#39;</span><span class="p">)</span>
        <span class="n">j</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">mercurial</span><span class="o">.</span><span class="n">statusClearAll</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dependencies</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDependencies</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="n">dep</span><span class="o">.</span><span class="n">codeCommit</span><span class="p">(</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">push</span><span class="o">=</span><span class="n">push</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">code_commit</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">push</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">codePush</span><span class="p">(</span><span class="n">dependencies</span><span class="p">)</span>

    <span class="c"># @JPLock</span>
    <span class="c"># def codePush(self, dependencies=False, merge=True):</span>
    <span class="c">#     &quot;&quot;&quot;</span>
    <span class="c">#     Push code to repo (be careful this can brake code of other people)</span>
    <span class="c">#     &quot;&quot;&quot;        </span>
    <span class="c">#     self.load()</span>
    <span class="c">#     j.log(&quot;CodePush&quot;)</span>
    <span class="c">#     j.clients.mercurial.statusClearAll()</span>
    <span class="c">#     if dependencies:</span>
    <span class="c">#         deps = self.getDependencies()</span>
    <span class="c">#         for dep in deps:</span>
    <span class="c">#             dep.codePush(merge=merge)</span>
    <span class="c">#     self.actions.code_push(merge=merge)</span>
</div>
    <span class="nd">@JPLock</span>
<div class="viewcode-block" id="JPackageObject.codeLink"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.codeLink">[docs]</a>    <span class="k">def</span> <span class="nf">codeLink</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Link code from local repo to right locations in sandbox</span>

<span class="sd">        @param force: if True, do an update which removes the changes (when using as install method should be True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span> 

        <span class="c"># j.clients.mercurial.statusClearAll()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;CodeLink&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dependencies</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">shellconfig</span><span class="o">.</span><span class="n">interactive</span><span class="p">:</span>
                <span class="n">dependencies</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">dialog</span><span class="o">.</span><span class="n">askYesNo</span><span class="p">(</span><span class="s">&quot;Do you want to link the dependencies?&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raiseError</span><span class="p">(</span><span class="s">&quot;Need to specify arg &#39;depencies&#39; (true or false) when non interactive&quot;</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">update</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">shellconfig</span><span class="o">.</span><span class="n">interactive</span><span class="p">:</span>
                <span class="n">update</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">dialog</span><span class="o">.</span><span class="n">askYesNo</span><span class="p">(</span><span class="s">&quot;Do you want to update your code before linking?&quot;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raiseError</span><span class="p">(</span><span class="s">&quot;Need to specify arg &#39;update&#39; (true or false) when non interactive&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">codeUpdate</span><span class="p">(</span><span class="n">dependencies</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dependencies</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDependencies</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="n">dep</span><span class="o">.</span><span class="n">codeLink</span><span class="p">(</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="n">update</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>            

        <span class="n">hrdpath</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathMetadata</span><span class="p">(),</span><span class="s">&quot;hrd&quot;</span><span class="p">,</span><span class="s">&quot;code.hrd&quot;</span><span class="p">)</span>
        <span class="n">codehrd</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">hrd</span><span class="o">.</span><span class="n">getHRD</span><span class="p">(</span><span class="n">hrdpath</span><span class="p">)</span>
        <span class="n">account</span><span class="o">=</span><span class="n">codehrd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;jp.code.account&quot;</span><span class="p">)</span>
        <span class="n">repo</span><span class="o">=</span><span class="n">codehrd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;jp.code.repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">account</span><span class="o">==</span><span class="s">&quot;&quot;</span> <span class="ow">or</span> <span class="n">repo</span><span class="o">==</span><span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">code_link</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>
      </div>
    <span class="nd">@JPLock</span>
<div class="viewcode-block" id="JPackageObject.package"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.package">[docs]</a>    <span class="k">def</span> <span class="nf">package</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">update</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        copy files from code recipe&#39;s and also manually copied files in the files sections</span>

<span class="sd">        @param dependencies: whether or not to package the dependencies</span>
<span class="sd">        @type dependencies: boolean</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">findDefaultInstance</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#39;Package&#39;</span><span class="p">)</span>
        <span class="c"># Disable action caching:</span>
        <span class="c"># If a user packages for 2 different platforms in the same jshell</span>
        <span class="c"># instance, the second call is just ignored, which is not desired</span>
        <span class="c"># behaviour.</span>
        <span class="c"># Also, when a user packages once, then sees a need to update his/her</span>
        <span class="c"># code, and then packages again in the same jshell, again the second</span>
        <span class="c"># time would be a non-op, which is again not desired. So we disable the</span>
        <span class="c"># action caching for this action.</span>
        <span class="k">if</span> <span class="n">dependencies</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDependencies</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="n">dep</span><span class="o">.</span><span class="n">package</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">code_update</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">code_package</span><span class="p">()</span>

        <span class="n">newbuildNr</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="n">newblobinfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculateBlobInfo</span><span class="p">()</span>

        <span class="n">actionsdir</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathMetadata</span><span class="p">(),</span> <span class="s">&quot;actions&quot;</span><span class="p">)</span>
        <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">removeIrrelevantFiles</span><span class="p">(</span><span class="n">actionsdir</span><span class="p">)</span>
        <span class="n">taskletsChecksum</span><span class="p">,</span> <span class="n">descr2</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">hash</span><span class="o">.</span><span class="n">hashDir</span><span class="p">(</span><span class="n">actionsdir</span><span class="p">)</span>
        <span class="n">hrddir</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathMetadata</span><span class="p">(),</span> <span class="s">&quot;hrdactive&quot;</span><span class="p">)</span>
        <span class="n">hrdChecksum</span><span class="p">,</span> <span class="n">descr2</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">hash</span><span class="o">.</span><span class="n">hashDir</span><span class="p">(</span><span class="n">hrddir</span><span class="p">)</span>
        <span class="n">descrdir</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathMetadata</span><span class="p">(),</span> <span class="s">&quot;documentation&quot;</span><span class="p">)</span>
        <span class="n">descrChecksum</span><span class="p">,</span> <span class="n">descr2</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">hash</span><span class="o">.</span><span class="n">hashDir</span><span class="p">(</span><span class="n">descrdir</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">descrChecksum</span> <span class="o">&lt;&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">descrChecksum</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Descr change.&quot;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">category</span><span class="o">=</span><span class="s">&quot;buildNr&quot;</span><span class="p">)</span>
            <span class="c">#buildNr needs to go up</span>
            <span class="n">newbuildNr</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">descrChecksum</span> <span class="o">=</span> <span class="n">descrChecksum</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Descr did not change.&quot;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span><span class="n">category</span><span class="o">=</span><span class="s">&quot;buildNr&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">taskletsChecksum</span> <span class="o">&lt;&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">taskletsChecksum</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Actions change.&quot;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">category</span><span class="o">=</span><span class="s">&quot;buildNr&quot;</span><span class="p">)</span>
            <span class="c">#buildNr needs to go up</span>
            <span class="n">newbuildNr</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">taskletsChecksum</span> <span class="o">=</span> <span class="n">taskletsChecksum</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Actions did not change.&quot;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span><span class="n">category</span><span class="o">=</span><span class="s">&quot;buildNr&quot;</span><span class="p">)</span>            

        <span class="k">if</span> <span class="n">hrdChecksum</span> <span class="o">&lt;&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">hrdChecksum</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Active HRD change.&quot;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">category</span><span class="o">=</span><span class="s">&quot;buildNr&quot;</span><span class="p">)</span>
            <span class="c">#buildNr needs to go up</span>
            <span class="n">newbuildNr</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hrdChecksum</span> <span class="o">=</span> <span class="n">hrdChecksum</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Active HRD did not change.&quot;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span><span class="n">category</span><span class="o">=</span><span class="s">&quot;buildNr&quot;</span><span class="p">)</span>        

        <span class="k">if</span> <span class="n">newbuildNr</span> <span class="ow">or</span> <span class="n">newblobinfo</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">newbuildNr</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buildNrIncrement</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;new buildNr is:</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">buildNr</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">_calculateBlobInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">filesdir</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathMetadata</span><span class="p">(),</span><span class="s">&quot;files&quot;</span><span class="p">)</span>

        <span class="n">pathfiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPathFiles</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pathfiles</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">for</span> <span class="n">platform</span> <span class="ow">in</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">listDirsInDir</span><span class="p">(</span><span class="n">pathfiles</span><span class="p">,</span><span class="n">dirNameOnly</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="n">pathplatform</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathFiles</span><span class="p">(),</span><span class="n">platform</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ttype</span> <span class="ow">in</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">listDirsInDir</span><span class="p">(</span><span class="n">pathplatform</span><span class="p">,</span><span class="n">dirNameOnly</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
                <span class="n">pathttype</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">pathplatform</span><span class="p">,</span><span class="n">ttype</span><span class="p">)</span>
                <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">removeIrrelevantFiles</span><span class="p">(</span><span class="n">pathttype</span><span class="p">)</span>
                <span class="n">md5</span><span class="p">,</span><span class="n">llist</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">hash</span><span class="o">.</span><span class="n">hashDir</span><span class="p">(</span><span class="n">pathttype</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">llist</span><span class="o">==</span><span class="s">&quot;&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">out</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">%</span><span class="n">md5</span>
                <span class="n">out</span><span class="o">+=</span><span class="n">llist</span>

                <span class="n">oldkey</span><span class="p">,</span><span class="n">olditems</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getBlobInfo</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span><span class="n">ttype</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">oldkey</span><span class="o">&lt;&gt;</span><span class="n">md5</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">buildNrIncrement</span><span class="p">()</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">True</span>

                    <span class="n">dest</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathMetadata</span><span class="p">(),</span><span class="s">&quot;files&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">___</span><span class="si">%s</span><span class="s">.info&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span><span class="n">ttype</span><span class="p">))</span>
                    <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">createDir</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">getDirName</span><span class="p">(</span><span class="n">dest</span><span class="p">))</span>
                    <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">writeFile</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span><span class="n">out</span><span class="p">)</span>

                    <span class="n">dest</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathMetadata</span><span class="p">(),</span><span class="s">&quot;uploadhistory&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">___</span><span class="si">%s</span><span class="s">.info&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span><span class="n">ttype</span><span class="p">))</span>
                    <span class="n">out</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> | </span><span class="si">%s</span><span class="s"> | </span><span class="si">%s</span><span class="s"> | </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">getLocalTimeHR</span><span class="p">(),</span><span class="n">j</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">getTimeEpoch</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">buildNr</span><span class="p">,</span><span class="n">md5</span><span class="p">)</span>
                    <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">writeFile</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Uploaded changed for platform:</span><span class="si">%s</span><span class="s"> type:</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span><span class="n">ttype</span><span class="p">),</span><span class="n">level</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">category</span><span class="o">=</span><span class="s">&quot;upload&quot;</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;No file change for platform:</span><span class="si">%s</span><span class="s"> type:</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span><span class="n">ttype</span><span class="p">),</span><span class="n">level</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">category</span><span class="o">=</span><span class="s">&quot;upload&quot;</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@JPLock</span>
<div class="viewcode-block" id="JPackageObject.compile"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.compile">[docs]</a>    <span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">params</span><span class="o">.</span><span class="n">jpackages</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#39;Compile&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dependencies</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDependencies</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="n">dep</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</div>
    <span class="nd">@JPLock</span>
<div class="viewcode-block" id="JPackageObject.download"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.download">[docs]</a>    <span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">destination</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">suppressErrors</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">allplatforms</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">expand</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">nocode</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">instance</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download the jpackages &amp; expand</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span><span class="n">findDefaultInstance</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="n">nocode</span><span class="o">=</span><span class="bp">True</span>

        <span class="k">if</span> <span class="n">dependencies</span><span class="o">==</span><span class="bp">None</span> <span class="ow">and</span> <span class="n">j</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">shellconfig</span><span class="o">.</span><span class="n">interactive</span><span class="p">:</span>
            <span class="n">dependencies</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">askYesNo</span><span class="p">(</span><span class="s">&quot;Do you want all depending packages to be downloaded too?&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dependencies</span><span class="o">=</span><span class="n">dependencies</span>
        
        <span class="k">if</span> <span class="n">instance</span><span class="o">&lt;&gt;</span><span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">=</span><span class="n">instance</span>
        

        <span class="k">if</span> <span class="n">dependencies</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDependencies</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="n">dep</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">destination</span><span class="o">=</span><span class="n">destination</span><span class="p">,</span><span class="n">allplatforms</span><span class="o">=</span><span class="n">allplatforms</span><span class="p">,</span><span class="n">expand</span><span class="o">=</span><span class="n">expand</span><span class="p">,</span><span class="n">nocode</span><span class="o">=</span><span class="n">nocode</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">install_download</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="n">expand</span><span class="p">,</span><span class="n">nocode</span><span class="o">=</span><span class="n">nocode</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">destination</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">expand</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">nocode</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        
        <span class="n">j</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">getDomainObject</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#39;Downloading.&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">platform</span><span class="p">,</span><span class="n">ttype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBlobPlatformTypes</span><span class="p">():</span>
            
            <span class="k">if</span> <span class="n">ttype</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;cr_&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">nocode</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;no need to download (option nocode):</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ttype</span><span class="p">)</span>
                    <span class="k">continue</span>
                
            <span class="k">if</span> <span class="n">destination</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
                <span class="n">downloaddestination</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathFiles</span><span class="p">(),</span><span class="n">platform</span><span class="p">,</span><span class="n">ttype</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">downloaddestination</span> <span class="o">=</span> <span class="n">destination</span>

            
            <span class="n">checksum</span><span class="p">,</span><span class="n">files</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getBlobInfo</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span><span class="n">ttype</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;key found:</span><span class="si">%s</span><span class="s"> for platform:</span><span class="si">%s</span><span class="s"> type:</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">checksum</span><span class="p">,</span><span class="n">platform</span><span class="p">,</span><span class="n">ttype</span><span class="p">),</span><span class="n">category</span><span class="o">=</span><span class="s">&quot;download&quot;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
            
            <span class="n">key</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span><span class="n">ttype</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">blobstorLocal</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">checksum</span><span class="p">):</span>
                <span class="k">print</span> <span class="s">&quot;try to find remote&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">blobstorRemote</span><span class="o">.</span><span class="n">copyToOtherBlobStor</span><span class="p">(</span><span class="n">checksum</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">blobstorLocal</span><span class="p">)</span>

            <span class="n">force</span><span class="o">=</span><span class="bp">True</span>

            <span class="k">if</span> <span class="n">force</span><span class="o">==</span><span class="bp">False</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">downloadedBlobStorKeys</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">downloadedBlobStorKeys</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">checksum</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;No need to download/expand for platform_type:&#39;</span><span class="si">%s</span><span class="s">&#39;, already there.&quot;</span><span class="o">%</span><span class="n">key</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;expand platform_type:</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">key</span><span class="p">,</span><span class="n">category</span><span class="o">=</span><span class="s">&quot;download&quot;</span><span class="p">)</span>
            <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">removeDirTree</span><span class="p">(</span><span class="n">downloaddestination</span><span class="p">)</span>
            <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">createDir</span><span class="p">(</span><span class="n">downloaddestination</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blobstorLocal</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">checksum</span><span class="p">,</span> <span class="n">downloaddestination</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">downloadedBlobStorKeys</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">checksum</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">True</span>

    <span class="nd">@JPLock</span>
<div class="viewcode-block" id="JPackageObject.backup"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.backup">[docs]</a>    <span class="k">def</span> <span class="nf">backup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">url</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make a backup for this package by running its backup tasklet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">url</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">askString</span><span class="p">(</span><span class="s">&quot;Url to backup to?&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raiseError</span><span class="p">(</span><span class="s">&quot;url needs to be specified&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">params</span><span class="o">.</span><span class="n">jpackages</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">params</span><span class="o">.</span><span class="n">url</span><span class="o">=</span><span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#39;Backup&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dependencies</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDependencies</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="n">dep</span><span class="o">.</span><span class="n">backup</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">backup</span><span class="p">()</span>
</div>
    <span class="nd">@JPLock</span>
<div class="viewcode-block" id="JPackageObject.restore"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.restore">[docs]</a>    <span class="k">def</span> <span class="nf">restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">url</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make a restore for this package by running its restore tasklet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">url</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">askString</span><span class="p">(</span><span class="s">&quot;Url to restore to?&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raiseError</span><span class="p">(</span><span class="s">&quot;url needs to be specified&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#39;restore&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">params</span><span class="o">.</span><span class="n">jpackages</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">params</span><span class="o">.</span><span class="n">url</span><span class="o">=</span><span class="n">url</span>
        <span class="k">if</span> <span class="n">dependencies</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDependencies</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="n">dep</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>        
</div>
<div class="viewcode-block" id="JPackageObject.upload"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.upload">[docs]</a>    <span class="k">def</span> <span class="nf">upload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remote</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">local</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">onlycode</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">dependencies</span><span class="o">==</span><span class="bp">None</span> <span class="ow">and</span> <span class="n">j</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">shellconfig</span><span class="o">.</span><span class="n">interactive</span><span class="p">:</span>
            <span class="n">dependencies</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">askYesNo</span><span class="p">(</span><span class="s">&quot;Do you want all depending packages to be downloaded too?&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dependencies</span><span class="o">=</span><span class="n">dependencies</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">findDefaultInstance</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dependencies</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDependencies</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="n">dep</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span><span class="n">remote</span><span class="o">=</span><span class="n">remote</span><span class="p">,</span> <span class="n">local</span><span class="o">=</span><span class="n">local</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">onlycode</span><span class="o">=</span><span class="n">onlycode</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span><span class="n">onlycode</span><span class="o">=</span><span class="n">onlycode</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="JPackageObject.getBlobKeysActive"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.getBlobKeysActive">[docs]</a>    <span class="k">def</span> <span class="nf">getBlobKeysActive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">keys</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">platform</span><span class="p">,</span><span class="n">ttype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBlobPlatformTypes</span><span class="p">():</span>
            <span class="n">key0</span><span class="p">,</span><span class="n">blobitems</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getBlobInfo</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span><span class="n">ttype</span><span class="p">)</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">keys</span>
</div>
<div class="viewcode-block" id="JPackageObject.uploadExistingBlobs"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.uploadExistingBlobs">[docs]</a>    <span class="k">def</span> <span class="nf">uploadExistingBlobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">blobserver</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        @return the non found keys</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadBlobStores</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dependencies</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDependencies</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="n">dep</span><span class="o">.</span><span class="n">uploadExistingBlobs</span><span class="p">(</span><span class="n">blobserver</span><span class="o">=</span><span class="n">blobserver</span><span class="p">)</span>

        <span class="n">keys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getBlobKeysActive</span><span class="p">()</span>
        <span class="n">bservernew</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">blobstor</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blobserver</span><span class="p">)</span>
        <span class="n">notfound</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="k">print</span> <span class="bp">self</span><span class="p">,</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">bservernew</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                <span class="c">#does not exist on remote bserver yet</span>
                <span class="k">print</span> <span class="s">&quot;blob </span><span class="si">%s</span><span class="s"> not on dest.&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">key</span><span class="p">),</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">blobstorLocal</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                    <span class="k">print</span> <span class="s">&quot;upload from local.&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">blobstorLocal</span><span class="o">.</span><span class="n">copyToOtherBlobStor</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">bservernew</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">blobstorRemote</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                    <span class="k">print</span> <span class="s">&quot;upload from remote.&quot;</span>
                    
                    <span class="bp">self</span><span class="o">.</span><span class="n">blobstorRemote</span><span class="o">.</span><span class="n">copyToOtherBlobStor</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">bservernew</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;blob </span><span class="si">%s</span><span class="s"> not on sources.&quot;</span><span class="o">%</span><span class="n">key</span>
                    <span class="n">notfound</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">notfound</span>
</div>
<div class="viewcode-block" id="JPackageObject.uploadExistingBlobsFromHistory"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.uploadExistingBlobsFromHistory">[docs]</a>    <span class="k">def</span> <span class="nf">uploadExistingBlobsFromHistory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">blobserver</span><span class="o">=</span><span class="s">&quot;jpackages_remote&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        @return the non found keys</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadBlobStores</span><span class="p">()</span>
        <span class="n">bservernew</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">blobstor</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blobserver</span><span class="p">)</span>
        <span class="n">hist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getBlobHistory</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ttype</span> <span class="ow">in</span> <span class="n">hist</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">epochs</span><span class="o">=</span><span class="n">hist</span><span class="p">[</span><span class="n">ttype</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="c">#[int(item) for item in hist[ttype].keys()]</span>
            <span class="n">epochs</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">epochs</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">epochs</span><span class="p">:</span>
                <span class="n">key</span><span class="o">=</span><span class="n">hist</span><span class="p">[</span><span class="n">ttype</span><span class="p">][</span><span class="n">epoch</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">ttype</span><span class="p">,</span><span class="n">hist</span><span class="p">[</span><span class="n">ttype</span><span class="p">][</span><span class="n">epoch</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">bservernew</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                    <span class="k">print</span> <span class="s">&quot;found&quot;</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c">#does not exist on remote bserver yet</span>
                    <span class="k">print</span> <span class="s">&quot;blob </span><span class="si">%s</span><span class="s"> not on dest.&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">key</span><span class="p">),</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">blobstorLocal</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                        <span class="k">print</span> <span class="s">&quot;upload from local.&quot;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">blobstorLocal</span><span class="o">.</span><span class="n">copyToOtherBlobStor</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">bservernew</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">blobstorRemote</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                        <span class="k">print</span> <span class="s">&quot;upload from remote.&quot;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">blobstorRemote</span><span class="o">.</span><span class="n">copyToOtherBlobStor</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">bservernew</span><span class="p">)</span>
                        <span class="k">break</span>
</div>
<div class="viewcode-block" id="JPackageObject.checkExistingBlobs"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.checkExistingBlobs">[docs]</a>    <span class="k">def</span> <span class="nf">checkExistingBlobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">blobserver</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        @return the non found keys</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadBlobStores</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dependencies</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDependencies</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="n">dep</span><span class="o">.</span><span class="n">uploadExistingBlobs</span><span class="p">(</span><span class="n">blobserver</span><span class="o">=</span><span class="n">blobserver</span><span class="p">)</span>

        <span class="n">keys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getBlobKeysActive</span><span class="p">()</span>
        <span class="n">bservernew</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">blobstor</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blobserver</span><span class="p">)</span>
        <span class="n">notfound</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="k">print</span> <span class="bp">self</span><span class="p">,</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">bservernew</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                <span class="n">notfound</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">notfound</span>
</div>
<div class="viewcode-block" id="JPackageObject.getBlobHistory"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.getBlobHistory">[docs]</a>    <span class="k">def</span> <span class="nf">getBlobHistory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">blobtypes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getBlobPlatformTypes</span><span class="p">()</span>
        <span class="n">result</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">btype</span> <span class="ow">in</span> <span class="n">blobtypes</span><span class="p">:</span>            
            <span class="n">btype2</span><span class="o">=</span><span class="s">&quot;___&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">btype</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="n">btype2</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
            <span class="n">path</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/uploadhistory/</span><span class="si">%s</span><span class="s">.info&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathMetadata</span><span class="p">(),</span><span class="n">btype2</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">print</span> <span class="s">&quot;ERROR: COULD NOT FIND </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">path</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">C</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">fileGetContents</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">C</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">&lt;&gt;</span><span class="s">&quot;&quot;</span><span class="p">:</span>

                        <span class="n">hrtime</span><span class="p">,</span><span class="n">ttime</span><span class="p">,</span><span class="n">nr</span><span class="p">,</span><span class="n">md5</span><span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;|&quot;</span><span class="p">)</span>
                        <span class="n">md5</span><span class="o">=</span><span class="n">md5</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="n">result</span><span class="p">[</span><span class="n">btype2</span><span class="p">][</span><span class="n">ttime</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">hrtime</span><span class="p">,</span><span class="n">md5</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>        


</div>
    <span class="nd">@JPLock</span>
    <span class="k">def</span> <span class="nf">_upload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remote</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">local</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">onlycode</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Upload jpackages to Blobstor, default remote and local</span>
<span class="sd">        Does always a jp.package() first</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">findDefaultInstance</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_calculateBlobInfo</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">platform</span><span class="p">,</span><span class="n">ttype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBlobPlatformTypes</span><span class="p">():</span>

            <span class="n">key0</span><span class="p">,</span><span class="n">blobitems</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getBlobInfo</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span><span class="n">ttype</span><span class="p">)</span>

            <span class="n">pathttype</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPathFiles</span><span class="p">(),</span><span class="n">platform</span><span class="p">,</span><span class="n">ttype</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ttype</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">&lt;&gt;</span><span class="s">&quot;cr_&quot;</span> <span class="ow">and</span> <span class="n">onlycode</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;no need to upload (onlycode option):</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">platform</span><span class="p">,</span><span class="n">ttype</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pathttype</span><span class="p">):</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_raiseError</span><span class="p">(</span><span class="s">&quot;Could not find files section:</span><span class="si">%s</span><span class="s">, check the files directory in your jpackages metadata dir, maybe there is a .info file which is wrong &amp; does not exist here.&quot;</span><span class="o">%</span><span class="n">pathttype</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Upload platform:&#39;</span><span class="si">%s</span><span class="s">&#39;, type:&#39;</span><span class="si">%s</span><span class="s">&#39; files:&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span><span class="n">ttype</span><span class="p">,</span><span class="n">pathttype</span><span class="p">),</span><span class="n">category</span><span class="o">=</span><span class="s">&quot;upload&quot;</span><span class="p">)</span>
        
            <span class="k">if</span> <span class="n">local</span> <span class="ow">and</span> <span class="n">remote</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">blobstorRemote</span> <span class="o">&lt;&gt;</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">blobstorLocal</span> <span class="o">&lt;&gt;</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">descr</span><span class="p">,</span><span class="n">uploadedAnything</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blobstorLocal</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">pathttype</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">blobstorLocal</span><span class="o">.</span><span class="n">copyToOtherBlobStor</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">blobstorRemote</span><span class="p">)</span>
                <span class="c"># key, descr,uploadedAnything  = self.blobstorRemote.put(pathttype)</span>
            <span class="k">elif</span> <span class="n">local</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">blobstorLocal</span> <span class="o">&lt;&gt;</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">descr</span><span class="p">,</span> <span class="n">uploadedAnything</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blobstorLocal</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">pathttype</span><span class="p">,</span> <span class="n">blobstors</span><span class="o">=</span><span class="p">[])</span>
            <span class="k">elif</span> <span class="n">remote</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">blobstorRemote</span> <span class="o">&lt;&gt;</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">descr</span><span class="p">,</span> <span class="n">uploadedAnything</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blobstorRemote</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">pathttype</span><span class="p">,</span> <span class="n">blobstors</span><span class="o">=</span><span class="p">[])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raiseError</span><span class="p">(</span><span class="s">&quot;need to upload to local or remote&quot;</span><span class="p">)</span>


            <span class="c"># if uploadedAnything:</span>
            <span class="c">#     self.log(&quot;Uploaded blob for %s:%s:%s to blobstor.&quot;%(self,platform,ttype))</span>
            <span class="c"># else:</span>
            <span class="c">#     self.log(&quot;Blob for %s:%s:%s was already on blobstor, no need to upload.&quot;%(self,platform,ttype))</span>

            <span class="k">if</span> <span class="n">key0</span><span class="o">&lt;&gt;</span><span class="n">key</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raiseError</span><span class="p">(</span><span class="s">&quot;Corruption in upload for </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@JPLock</span>
<div class="viewcode-block" id="JPackageObject.waitUp"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.waitUp">[docs]</a>    <span class="k">def</span> <span class="nf">waitUp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dependencies</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDependencies</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">deps</span><span class="o">=</span><span class="p">[]</span>

        <span class="n">start</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">getTimeEpoch</span><span class="p">()</span>
        <span class="n">now</span><span class="o">=</span><span class="n">start</span>
        <span class="k">while</span> <span class="n">now</span><span class="o">&lt;</span><span class="n">start</span><span class="o">+</span><span class="n">timeout</span><span class="p">:</span>
            <span class="n">result</span><span class="o">=</span><span class="bp">True</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="c"># result=result &amp; dep.actions.monitor_up_net()</span>
                <span class="n">result</span> <span class="o">&amp;=</span> <span class="n">dep</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">monitor_up_local</span><span class="p">()</span>
            <span class="c"># result=result &amp; self.actions.monitor_up_net()</span>
            <span class="n">result</span> <span class="o">&amp;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">monitor_up_local</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;waitup:</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="bp">self</span>
            <span class="n">now</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">getTimeEpoch</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raiseErrorOps</span><span class="p">(</span><span class="s">&quot;Timeout on waitup for jp:</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="p">)</span>
</div>
    <span class="nd">@JPLock</span>
<div class="viewcode-block" id="JPackageObject.waitDown"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.waitDown">[docs]</a>    <span class="k">def</span> <span class="nf">waitDown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;waitdown: not implemented&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dependencies</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDependencies</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">deps</span><span class="o">=</span><span class="p">[]</span>

        <span class="n">start</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">getTimeEpoch</span><span class="p">()</span>
        <span class="n">now</span><span class="o">=</span><span class="n">start</span>
        <span class="k">while</span> <span class="n">now</span><span class="o">&lt;</span><span class="n">start</span><span class="o">+</span><span class="n">timeout</span><span class="p">:</span>
            <span class="n">result</span><span class="o">=</span><span class="bp">True</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">&amp;=</span> <span class="ow">not</span><span class="p">(</span><span class="n">dep</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">monitor_up_net</span><span class="p">())</span>
            <span class="n">result</span> <span class="o">&amp;=</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">monitor_up_net</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>

            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;waitdown:</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="bp">self</span>
            <span class="n">now</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">getTimeEpoch</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_raiseErrorOps</span><span class="p">(</span><span class="s">&quot;Timeout on waitdown for jp:</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="p">)</span>

</div>
    <span class="nd">@JPLock</span>
<div class="viewcode-block" id="JPackageObject.processDepCheck"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.processDepCheck">[docs]</a>    <span class="k">def</span> <span class="nf">processDepCheck</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="c">#check for dependencies for process to start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dependencies</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDependencies</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">deps</span><span class="o">=</span><span class="p">[]</span>            
            
        <span class="n">start</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">getTimeEpoch</span><span class="p">()</span>
        <span class="n">now</span><span class="o">=</span><span class="n">start</span>

        <span class="k">while</span> <span class="n">now</span><span class="o">&lt;</span><span class="n">start</span><span class="o">+</span><span class="n">timeout</span><span class="p">:</span>
            <span class="n">result</span><span class="o">=</span><span class="bp">True</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="n">r</span><span class="o">=</span><span class="n">dep</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">process_depcheck</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">r</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">process_depcheck</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="bp">False</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;processdepcheck:</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="bp">self</span>
            <span class="n">now</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">getTimeEpoch</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raiseErrorOps</span><span class="p">(</span><span class="s">&quot;Timeout on check process dependencies for jp:</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="p">)</span>


<span class="c">########################################################################</span>
<span class="c">#########################  RECONFIGURE  ################################</span>
<span class="c">########################################################################</span>
</div>
<div class="viewcode-block" id="JPackageObject.signalConfigurationNeeded"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.signalConfigurationNeeded">[docs]</a>    <span class="k">def</span> <span class="nf">signalConfigurationNeeded</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set in the corresponding jpackages&#39;s state file if reconfiguration is needed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">setIsPendingReconfiguration</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">j</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">_setHasPackagesPendingConfiguration</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="JPackageObject.isPendingReconfiguration"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.isPendingReconfiguration">[docs]</a>    <span class="k">def</span> <span class="nf">isPendingReconfiguration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the JPackage needs reconfiguration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">getIsPendingReconfiguration</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>


<span class="c">#########################################################################</span>
<span class="c">####################### SHOW ############################################</span>
</div>
<div class="viewcode-block" id="JPackageObject.showDependencies"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.showDependencies">[docs]</a>    <span class="k">def</span> <span class="nf">showDependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return all dependencies of the JPackage.</span>
<span class="sd">        See also: addDependency and removeDependency</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">_printList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getDependencies</span><span class="p">())</span>
            </div>
<div class="viewcode-block" id="JPackageObject.showDependingInstalledPackages"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.showDependingInstalledPackages">[docs]</a>    <span class="k">def</span> <span class="nf">showDependingInstalledPackages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show which jpackages have this jpackages as dependency.</span>
<span class="sd">        Do this only for the installed jpackages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_printList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getDependingInstalledPackages</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="JPackageObject.showDependingPackages"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.showDependingPackages">[docs]</a>    <span class="k">def</span> <span class="nf">showDependingPackages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show which jpackages have this jpackages as dependency.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_printList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getDependingPackages</span><span class="p">())</span>
</div>
    <span class="k">def</span> <span class="nf">_printList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">arr</span><span class="p">:</span>
            <span class="n">j</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>        

<span class="c">#########################################################################</span>
<span class="c">#######################  SUPPORTING FUNCTIONS  ##########################</span>

    <span class="k">def</span> <span class="nf">_getDomainObject</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the domain object for this Q-Package</span>

<span class="sd">        @return: domain object for this Q-Package</span>
<span class="sd">        @rtype: Domain.Domain</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">j</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">getDomainObject</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_raiseError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">message</span><span class="p">,</span><span class="n">category</span><span class="o">=</span><span class="s">&quot;jpackage&quot;</span><span class="p">):</span>
        <span class="c">##self.assertAccessable()</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;INPUTERROR: </span><span class="si">%s</span><span class="s"> for jpackage </span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
        <span class="n">j</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">inputerror_critical</span><span class="p">(</span><span class="n">message</span><span class="p">,</span><span class="n">category</span><span class="p">)</span> 

    <span class="k">def</span> <span class="nf">_raiseErrorOps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">message</span><span class="p">,</span><span class="n">category</span><span class="o">=</span><span class="s">&quot;jpackage&quot;</span><span class="p">):</span>
        <span class="c">##self.assertAccessable()</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;OPSERROR: </span><span class="si">%s</span><span class="s"> for jpackage </span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
        <span class="n">j</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">opserror_critical</span><span class="p">(</span><span class="n">message</span><span class="p">,</span><span class="n">category</span><span class="p">)</span> 

    <span class="k">def</span> <span class="nf">_clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c">##self.assertAccessable()</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clear all properties except domain, name, and version</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">supportedPlatforms</span><span class="o">=</span><span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buildNr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependenciesNames</span> <span class="o">=</span> <span class="p">{}</span>


    <span class="k">def</span> <span class="nf">__cmp__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">other</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">other</span><span class="o">==</span><span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">domain</span><span class="p">)</span> <span class="ow">and</span> <span class="n">j</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">_getVersionAsInt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span> <span class="o">==</span> <span class="n">j</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">_getVersionAsInt</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__str__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_resetPreparedForUpdatingFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">setPrepared</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;JPackage </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">) &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

<div class="viewcode-block" id="JPackageObject.reportNumbers"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.jpackages.html#JumpScale.baselib.jpackages.JPackageObject.JPackageObject.reportNumbers">[docs]</a>    <span class="k">def</span> <span class="nf">reportNumbers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39; buildNr:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buildNr</span><span class="p">)</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li><a href="../../../../index.html">Jumpscale Doc 7.0 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
    </div>
  </body>
</html>