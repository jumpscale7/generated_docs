<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>JumpScale.portal.portal.PortalServer &mdash; Jumpscale Doc 7.0 documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '7.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="top" title="Jumpscale Doc 7.0 documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">Jumpscale Doc 7.0 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for JumpScale.portal.portal.PortalServer</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">urlparse</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">redis</span>

<span class="kn">from</span> <span class="nn">beaker.middleware</span> <span class="kn">import</span> <span class="n">SessionMiddleware</span>
<span class="kn">from</span> <span class="nn">MacroExecutor</span> <span class="kn">import</span> <span class="n">MacroExecutorPage</span><span class="p">,</span> <span class="n">MacroExecutorWiki</span><span class="p">,</span> <span class="n">MacroExecutorPreprocess</span>
<span class="kn">from</span> <span class="nn">PortalAuthenticatorOSIS</span> <span class="kn">import</span> <span class="n">PortalAuthenticatorOSIS</span>
<span class="kn">from</span> <span class="nn">RequestContext</span> <span class="kn">import</span> <span class="n">RequestContext</span>
<span class="kn">from</span> <span class="nn">PortalRest</span> <span class="kn">import</span> <span class="n">PortalRest</span>
<span class="kn">from</span> <span class="nn">.OsisBeaker</span> <span class="kn">import</span> <span class="n">OsisBeaker</span>

<span class="kn">from</span> <span class="nn">JumpScale</span> <span class="kn">import</span> <span class="n">j</span>
<span class="kn">from</span> <span class="nn">gevent.pywsgi</span> <span class="kn">import</span> <span class="n">WSGIServer</span>
<span class="kn">import</span> <span class="nn">gevent</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">mimeparse</span>
<span class="kn">import</span> <span class="nn">mimetypes</span>
<span class="kn">import</span> <span class="nn">JumpScale.grid.agentcontroller</span>

<span class="n">BLOCK_SIZE</span> <span class="o">=</span> <span class="mi">4096</span>

<span class="n">CONTENT_TYPE_JSON</span> <span class="o">=</span> <span class="s">&#39;application/json&#39;</span>
<span class="n">CONTENT_TYPE_JS</span> <span class="o">=</span> <span class="s">&#39;application/javascript&#39;</span>
<span class="n">CONTENT_TYPE_YAML</span> <span class="o">=</span> <span class="s">&#39;application/yaml&#39;</span>
<span class="n">CONTENT_TYPE_PLAIN</span> <span class="o">=</span> <span class="s">&#39;text/plain&#39;</span>
<span class="n">CONTENT_TYPE_HTML</span> <span class="o">=</span> <span class="s">&#39;text/html&#39;</span>
<span class="n">CONTENT_TYPE_PNG</span> <span class="o">=</span> <span class="s">&#39;image/png&#39;</span>


<div class="viewcode-block" id="PortalServer"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer">[docs]</a><span class="k">class</span> <span class="nc">PortalServer</span><span class="p">:</span>

<span class="c">##################### INIT</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hrd</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">instanceconfig</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">contentdirs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">libpath</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">getHtmllibDir</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">started</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cfgdir</span><span class="o">=</span><span class="s">&quot;cfg&quot;</span>

        <span class="n">j</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">portal</span><span class="o">.</span><span class="n">active</span><span class="o">=</span><span class="bp">self</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">osis</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">osis</span><span class="o">.</span><span class="n">getClientByInstance</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pageKey2doc</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routes</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loadConfig</span><span class="p">()</span>        

        <span class="n">macroPathsPreprocessor</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;macros/preprocess&quot;</span><span class="p">]</span>
        <span class="n">macroPathsWiki</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;macros/wiki&quot;</span><span class="p">]</span>
        <span class="n">macroPathsPage</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;macros/page&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">macroexecutorPreprocessor</span> <span class="o">=</span> <span class="n">MacroExecutorPreprocess</span><span class="p">(</span><span class="n">macroPathsPreprocessor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macroexecutorPage</span> <span class="o">=</span> <span class="n">MacroExecutorPage</span><span class="p">(</span><span class="n">macroPathsPage</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macroexecutorWiki</span> <span class="o">=</span> <span class="n">MacroExecutorWiki</span><span class="p">(</span><span class="n">macroPathsWiki</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bootstrap</span><span class="p">()</span>

        <span class="n">session_opts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;session.cookie_expires&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="s">&#39;session.type&#39;</span><span class="p">:</span> <span class="s">&#39;OsisBeaker&#39;</span><span class="p">,</span>
            <span class="s">&#39;session.namespace_class&#39;</span><span class="p">:</span> <span class="n">OsisBeaker</span><span class="p">,</span>
            <span class="s">&#39;session.namespace_args&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;client&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">osis</span><span class="p">},</span>
            <span class="s">&#39;session.data_dir&#39;</span><span class="p">:</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">dirs</span><span class="o">.</span><span class="n">varDir</span><span class="p">,</span> <span class="s">&quot;beakercache&quot;</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_router</span> <span class="o">=</span> <span class="n">SessionMiddleware</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">router</span><span class="p">,</span> <span class="n">session_opts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_webserver</span> <span class="o">=</span> <span class="n">WSGIServer</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">listenip</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_router</span><span class="p">)</span>

        <span class="c"># wwwroot = wwwroot.replace(&quot;\\&quot;, &quot;/&quot;)</span>
        <span class="c"># while len(wwwroot) &gt; 0 and wwwroot[-1] == &quot;/&quot;:</span>
        <span class="c">#     wwwroot = wwwroot[:-1]</span>
        <span class="c"># self.wwwroot = wwwroot</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">confluence2htmlconvertor</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">docgenerator</span><span class="o">.</span><span class="n">getConfluence2htmlConvertor</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activejobs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobids2greenlets</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">schedule1min</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule15min</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule60min</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rediscache</span><span class="o">=</span><span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">7767</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redisprod</span><span class="o">=</span><span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">7768</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">jslibroot</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">dirs</span><span class="o">.</span><span class="n">baseDir</span><span class="p">,</span><span class="s">&quot;apps&quot;</span><span class="p">,</span><span class="s">&quot;portals&quot;</span><span class="p">,</span><span class="s">&quot;jslib&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">=</span><span class="n">PortalAuthenticatorOSIS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">osis</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loadSpaces</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="o">=</span><span class="n">PortalRest</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="PortalServer.loadConfig"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.loadConfig">[docs]</a>    <span class="k">def</span> <span class="nf">loadConfig</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">replaceVar</span><span class="p">(</span><span class="n">txt</span><span class="p">):</span>
            <span class="c"># txt = txt.replace(&quot;$base&quot;, j.dirs.baseDir).replace(&quot;\\&quot;, &quot;/&quot;)</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;$appdir&quot;</span><span class="p">,</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;$vardir&quot;</span><span class="p">,</span> <span class="n">j</span><span class="o">.</span><span class="n">dirs</span><span class="o">.</span><span class="n">varDir</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;$htmllibdir&quot;</span><span class="p">,</span> <span class="n">j</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">getHtmllibDir</span><span class="p">())</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;/&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">txt</span>


        <span class="c">######INIT FILE</span>

        <span class="n">ini</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">inifile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfgdir</span> <span class="o">+</span> <span class="s">&quot;/portal.cfg&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ini</span><span class="o">.</span><span class="n">checkParam</span><span class="p">(</span><span class="s">&quot;main&quot;</span><span class="p">,</span> <span class="s">&quot;appdir&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">appdir</span> <span class="o">=</span> <span class="n">replaceVar</span><span class="p">(</span><span class="n">ini</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="s">&quot;main&quot;</span><span class="p">,</span> <span class="s">&quot;appdir&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">appdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">appdir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;$base&quot;</span><span class="p">,</span><span class="n">j</span><span class="o">.</span><span class="n">dirs</span><span class="o">.</span><span class="n">baseDir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">appdir</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">getContentDirs</span><span class="p">()</span> <span class="c">#contentdirs need to be loaded before we go to other dir of base server</span>
        <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">changeDir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">appdir</span><span class="p">)</span>            

        <span class="c"># dbtype = ini.getValue(&quot;main&quot;, &quot;dbtype&quot;).lower().strip()</span>
        <span class="c"># if dbtype == &quot;fs&quot;:</span>
        <span class="c">#     self.dbtype = j.enumerators.KeyValueStoreType.FILE_SYSTEM</span>
        <span class="c"># elif dbtype == &quot;mem&quot;:</span>
        <span class="c">#     self.dbtype = j.enumerators.KeyValueStoreType.MEMORY</span>
        <span class="c"># elif dbtype == &quot;redis&quot;:</span>
        <span class="c">#     self.dbtype = j.enumerators.KeyValueStoreType.REDIS</span>
        <span class="c"># elif dbtype == &quot;arakoon&quot;:</span>
        <span class="c">#     self.dbtype = j.enumerators.KeyValueStoreType.ARAKOON</span>
        <span class="c"># else:</span>
        <span class="c">#     raise RuntimeError(&quot;could not find appropriate core db, supported are: fs,mem,redis,arakoon, used here&#39;%s&#39;&quot;%dbtype)</span>

        <span class="c"># self.systemdb=j.db.keyvaluestore.getFileSystemStore(&quot;appserversystem&quot;,baseDir=replaceVar(ini.getValue(&quot;systemdb&quot;,&quot;dbdpath&quot;)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">listenip</span> <span class="o">=</span> <span class="s">&#39;0.0.0.0&#39;</span>
        <span class="k">if</span> <span class="n">ini</span><span class="o">.</span><span class="n">checkSection</span><span class="p">(</span><span class="s">&#39;main&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ini</span><span class="o">.</span><span class="n">checkParam</span><span class="p">(</span><span class="s">&#39;main&#39;</span><span class="p">,</span> <span class="s">&#39;listenip&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">listenip</span> <span class="o">=</span> <span class="n">ini</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="s">&#39;main&#39;</span><span class="p">,</span> <span class="s">&#39;listenip&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ini</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="s">&quot;main&quot;</span><span class="p">,</span> <span class="s">&quot;webserverport&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">ini</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="s">&quot;main&quot;</span><span class="p">,</span> <span class="s">&quot;pubipaddr&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logdir</span><span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">dirs</span><span class="o">.</span><span class="n">logDir</span><span class="p">,</span><span class="s">&quot;portal&quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
        <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">createDir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logdir</span><span class="p">)</span>



        <span class="c"># self.secret = ini.getValue(&quot;main&quot;, &quot;secret&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">admingroups</span> <span class="o">=</span> <span class="n">ini</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="s">&quot;main&quot;</span><span class="p">,</span> <span class="s">&quot;admingroups&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filesroot</span> <span class="o">=</span> <span class="n">replaceVar</span><span class="p">(</span><span class="n">ini</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="s">&quot;main&quot;</span><span class="p">,</span> <span class="s">&quot;filesroot&quot;</span><span class="p">))</span>

        <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">createDir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filesroot</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">getContentDirs</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="PortalServer.reset"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routes</span><span class="o">=</span><span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadConfig</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bootstrap</span><span class="p">()</span>        
        <span class="n">j</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">codegenerator</span><span class="o">.</span><span class="n">resetMemNonSystem</span><span class="p">()</span>
        <span class="n">j</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">specparser</span><span class="o">.</span><span class="n">resetMemNonSystem</span><span class="p">()</span>
        <span class="c"># self.actorsloader.scan(path=self.contentdirs,reset=True) #do we need to load them all</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bucketsloader</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">portalloader</span><span class="o">.</span><span class="n">getBucketsLoader</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spacesloader</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">portalloader</span><span class="o">.</span><span class="n">getSpacesLoader</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadSpaces</span><span class="p">()</span>
        </div>
<div class="viewcode-block" id="PortalServer.bootstrap"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.bootstrap">[docs]</a>    <span class="k">def</span> <span class="nf">bootstrap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actors</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c"># key is the applicationName_actorname (lowercase)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actorsloader</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">portalloader</span><span class="o">.</span><span class="n">getActorsLoader</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app_actor_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskletengines</span> <span class="o">=</span> <span class="p">{}</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">actorsloader</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="c"># self.actorsloader._generateLoadActor(&quot;system&quot;, &quot;contentmanager&quot;, actorpath=&quot;%s/apps/portalbase/system/system__contentmanager/&quot;%j.dirs.baseDir)</span>
        <span class="c"># self.actorsloader._generateLoadActor(&quot;system&quot;, &quot;master&quot;, actorpath=&quot;system/system__master/&quot;)</span>
        <span class="c"># self.actorsloader._generateLoadActor(&quot;system&quot;, &quot;usermanager&quot;, actorpath=&quot;system/system__usermanager/&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actorsloader</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contentdirs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actorsloader</span><span class="o">.</span><span class="n">getActor</span><span class="p">(</span><span class="s">&quot;system&quot;</span><span class="p">,</span> <span class="s">&quot;contentmanager&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actorsloader</span><span class="o">.</span><span class="n">getActor</span><span class="p">(</span><span class="s">&quot;system&quot;</span><span class="p">,</span> <span class="s">&quot;usermanager&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PortalServer.loadSpaces"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.loadSpaces">[docs]</a>    <span class="k">def</span> <span class="nf">loadSpaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bucketsloader</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">portalloader</span><span class="o">.</span><span class="n">getBucketsLoader</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spacesloader</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">portalloader</span><span class="o">.</span><span class="n">getSpacesLoader</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bucketsloader</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contentdirs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">spacesloader</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contentdirs</span><span class="p">)</span>

        <span class="k">if</span> <span class="s">&quot;system&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacesloader</span><span class="o">.</span><span class="n">spaces</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;could not find system space&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">spacesloader</span><span class="o">.</span><span class="n">spaces</span><span class="p">[</span><span class="s">&quot;system&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loadDocProcessor</span><span class="p">()</span> <span class="c">#need to make sure we have content for the systemspace</span>
</div>
<div class="viewcode-block" id="PortalServer.getContentDirs"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.getContentDirs">[docs]</a>    <span class="k">def</span> <span class="nf">getContentDirs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        walk over known content dirs &amp; execute loader on it</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cfgpath</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfgdir</span><span class="p">,</span> <span class="s">&quot;contentdirs.cfg&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">path</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">pathNormalize</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">contentdirs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">contentdirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cfgpath</span><span class="p">):</span>
            <span class="n">wikicfg</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">fileGetContents</span><span class="p">(</span><span class="n">cfgpath</span><span class="p">)</span>

            <span class="n">paths</span> <span class="o">=</span> <span class="n">wikicfg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">path</span><span class="o">==</span><span class="s">&quot;&quot;</span> <span class="ow">or</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;#&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;/&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;/&quot;</span> <span class="ow">and</span> <span class="n">path</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">getParent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfgdir</span><span class="p">),</span> <span class="n">path</span><span class="p">)</span>
                <span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="c">#add own base path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">getParent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfgdir</span><span class="p">),</span> <span class="s">&quot;base&quot;</span><span class="p">)</span>
        <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">createDir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span><span class="p">)</span>
        <span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basepath</span><span class="p">)</span>

        <span class="c">#add base path of parent portal</span>
        <span class="n">appdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">appdir</span>
        <span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">appdir</span><span class="p">,</span> <span class="s">&quot;wiki&quot;</span><span class="p">))</span>
        <span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">appdir</span><span class="p">,</span> <span class="s">&quot;system&quot;</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="PortalServer.unloadActorFromRoutes"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.unloadActorFromRoutes">[docs]</a>    <span class="k">def</span> <span class="nf">unloadActorFromRoutes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">appname</span><span class="p">,</span> <span class="n">actorname</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">appn</span><span class="p">,</span> <span class="n">actorn</span><span class="p">,</span> <span class="n">remaining</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;_&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="c"># print appn+&quot; &quot;+appname+&quot; &quot;+actorn+&quot; &quot;+actorname</span>
            <span class="k">if</span> <span class="n">appn</span> <span class="o">==</span> <span class="n">appname</span> <span class="ow">and</span> <span class="n">actorn</span> <span class="o">==</span> <span class="n">actorname</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
 
<span class="c">##################### USER RIGHTS</span>
</div>
<div class="viewcode-block" id="PortalServer.getUserRight"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.getUserRight">[docs]</a>    <span class="k">def</span> <span class="nf">getUserRight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">space</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">space</span> <span class="o">==</span> <span class="s">&quot;&quot;</span> <span class="ow">or</span> <span class="n">space</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacesloader</span><span class="o">.</span><span class="n">spaces</span><span class="p">:</span>
            <span class="n">space</span> <span class="o">=</span> <span class="s">&quot;system&quot;</span>
        <span class="n">spaceobject</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacesloader</span><span class="o">.</span><span class="n">spaces</span><span class="p">[</span><span class="n">space</span><span class="p">]</span>
        <span class="c"># print &quot;spaceobject&quot;</span>
        <span class="c"># print spaceobject.model</span>
        <span class="k">if</span> <span class="s">&quot;user&quot;</span> <span class="ow">in</span> <span class="n">ctx</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s">&#39;beaker.session&#39;</span><span class="p">]:</span>
            <span class="n">username</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s">&#39;beaker.session&#39;</span><span class="p">][</span><span class="s">&quot;user&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">username</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">username</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="n">right</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="n">username</span><span class="o">==</span><span class="s">&quot;guest&quot;</span><span class="p">:</span>
                <span class="n">groupsusers</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;guest&quot;</span><span class="p">,</span><span class="s">&quot;guests&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">groupsusers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">getGroups</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

            <span class="n">right</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="k">if</span> <span class="s">&quot;admin&quot;</span> <span class="ow">in</span> <span class="n">groupsusers</span><span class="p">:</span>
                <span class="n">right</span> <span class="o">=</span> <span class="s">&quot;*&quot;</span>
            <span class="c"># print &quot;groupsusers:%s&quot;%groupsusers</span>
            <span class="k">if</span> <span class="n">right</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">groupuser</span> <span class="ow">in</span> <span class="n">groupsusers</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">groupuser</span> <span class="ow">in</span> <span class="n">spaceobject</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">acl</span><span class="p">:</span>
                        <span class="c"># found match</span>
                        <span class="n">right</span> <span class="o">=</span> <span class="n">spaceobject</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">acl</span><span class="p">[</span><span class="n">groupuser</span><span class="p">]</span>
                        <span class="k">break</span>

            <span class="c"># if right == &quot;&quot;:</span>
            <span class="c">#     #check bitbucket</span>
            <span class="c">#     for key,acl in spaceobject.model.acl.iteritems():</span>
            <span class="c">#         if key.find(&quot;bitbucket&quot;)==0:</span>
            <span class="c">#             from IPython import embed</span>
            <span class="c">#             print &quot;DEBUG NOW ooooooo&quot;</span>
            <span class="c">#             embed()</span>
                        
        <span class="k">if</span> <span class="n">right</span> <span class="o">==</span> <span class="s">&quot;*&quot;</span><span class="p">:</span>
            <span class="n">right</span> <span class="o">=</span> <span class="s">&quot;rwa&quot;</span>
        <span class="c"># print &quot;right:%s&quot; % right</span>
        <span class="k">return</span> <span class="n">username</span><span class="p">,</span> <span class="n">right</span>
</div>
<div class="viewcode-block" id="PortalServer.getUserFromCTX"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.getUserFromCTX">[docs]</a>    <span class="k">def</span> <span class="nf">getUserFromCTX</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ctx</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s">&quot;beaker.session&quot;</span><span class="p">][</span><span class="s">&quot;user&quot;</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="PortalServer.getGroupsFromCTX"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.getGroupsFromCTX">[docs]</a>    <span class="k">def</span> <span class="nf">getGroupsFromCTX</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ctx</span><span class="p">):</span>
        <span class="n">groups</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">getGroups</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s">&quot;beaker.session&quot;</span><span class="p">][</span><span class="s">&quot;user&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="PortalServer.isAdminFromCTX"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.isAdminFromCTX">[docs]</a>    <span class="k">def</span> <span class="nf">isAdminFromCTX</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ctx</span><span class="p">):</span>
        <span class="n">groups</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getGroupsFromCTX</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">gr</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">gr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">admingroups</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>     
</div>
<div class="viewcode-block" id="PortalServer.isLoggedInFromCTX"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.isLoggedInFromCTX">[docs]</a>    <span class="k">def</span> <span class="nf">isLoggedInFromCTX</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ctx</span><span class="p">):</span>
        <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getUserFromCTX</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span><span class="o">&lt;&gt;</span><span class="s">&quot;&quot;</span> <span class="ow">and</span> <span class="n">user</span><span class="o">&lt;&gt;</span><span class="s">&quot;guest&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="c">##################### process pages, get docs</span></div>
<div class="viewcode-block" id="PortalServer.getpage"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.getpage">[docs]</a>    <span class="k">def</span> <span class="nf">getpage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">docgenerator</span><span class="o">.</span><span class="n">pageNewHTML</span><span class="p">(</span><span class="s">&quot;index.html&quot;</span><span class="p">,</span> <span class="n">htmllibPath</span><span class="o">=</span><span class="s">&quot;/jslib&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">page</span>
</div>
<div class="viewcode-block" id="PortalServer.sendpage"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.sendpage">[docs]</a>    <span class="k">def</span> <span class="nf">sendpage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="n">contenttype</span> <span class="o">=</span> <span class="s">&quot;text/html&quot;</span>
        <span class="n">start_response</span><span class="p">(</span><span class="s">&#39;200 OK&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="n">contenttype</span><span class="p">),</span> <span class="p">])</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">page</span><span class="o">.</span><span class="n">getContent</span><span class="p">()]</span>
</div>
<div class="viewcode-block" id="PortalServer.getDoc"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.getDoc">[docs]</a>    <span class="k">def</span> <span class="nf">getDoc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">space</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{}):</span>
        <span class="k">print</span> <span class="s">&quot;GETDOC:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">space</span>
        <span class="n">space</span> <span class="o">=</span> <span class="n">space</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="n">username</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getUserRight</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">space</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;login&quot;</span><span class="p">,</span> <span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="s">&quot;accessdenied&quot;</span><span class="p">,</span> <span class="s">&quot;pagenotfound&quot;</span><span class="p">]:</span>
            <span class="n">right</span> <span class="o">=</span> <span class="s">&quot;r&quot;</span>

        <span class="k">print</span> <span class="s">&quot;# space:</span><span class="si">%s</span><span class="s"> name:</span><span class="si">%s</span><span class="s"> user:</span><span class="si">%s</span><span class="s"> right:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">space</span> <span class="o">==</span> <span class="s">&quot;&quot;</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="n">space</span> <span class="o">=</span> <span class="s">&quot;system&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s">&quot;r&quot;</span> <span class="ow">in</span> <span class="n">right</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;accessdenied&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;spaces&quot;</span>

        <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s">&quot;accessdenied&quot;</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">!=</span> <span class="s">&quot;pagenotfound&quot;</span><span class="p">:</span>
            <span class="c"># check security</span>
            <span class="k">if</span> <span class="n">right</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="s">&quot;space&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">space</span>
                <span class="n">params</span><span class="p">[</span><span class="s">&quot;page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
                <span class="n">doc</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDoc</span><span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="s">&quot;accessdenied&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">doc</span><span class="p">,</span> <span class="n">params</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">right</span> <span class="o">=</span> <span class="s">&quot;r&quot;</span>

        <span class="c"># print &quot;find space:%s page:%s&quot; % (space,name)</span>
        <span class="k">if</span> <span class="n">space</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="n">doc</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDoc</span><span class="p">(</span><span class="s">&quot;system&quot;</span><span class="p">,</span> <span class="s">&quot;spaces&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="c"># ctx.params[&quot;error&quot;]=&quot;Could not find space, space was empty, please specify space.\n&quot;</span>
        <span class="k">elif</span> <span class="n">space</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacesloader</span><span class="o">.</span><span class="n">spaces</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">space</span> <span class="o">==</span> <span class="s">&quot;system&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;wiki has not loaded system space, cannot continue&quot;</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;could not find space </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">space</span>
            <span class="n">doc</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDoc</span><span class="p">(</span><span class="s">&quot;system&quot;</span><span class="p">,</span> <span class="s">&quot;pagenotfound&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&quot;space&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="s">&quot;space&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">space</span>
            <span class="k">if</span> <span class="s">&quot;page&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="s">&quot;page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
            <span class="k">print</span> <span class="s">&quot;could not find space </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">space</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Could not find space </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">space</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spaceObject</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacesloader</span><span class="o">.</span><span class="n">getLoaderFromId</span><span class="p">(</span><span class="n">space</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">spaceObject</span><span class="o">.</span><span class="n">docprocessor</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">spaceObject</span><span class="o">.</span><span class="n">loadDocProcessor</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  <span class="c"># dynamic load of space</span>

            <span class="n">spacedocgen</span> <span class="o">=</span> <span class="n">spaceObject</span><span class="o">.</span><span class="n">docprocessor</span>

            <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">spacedocgen</span><span class="o">.</span><span class="n">name2doc</span><span class="p">:</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="n">spacedocgen</span><span class="o">.</span><span class="n">name2doc</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&quot;accessdenied&quot;</span><span class="p">:</span>
                    <span class="c"># means the accessdenied page does not exist</span>
                    <span class="n">doc</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDoc</span><span class="p">(</span><span class="s">&quot;system&quot;</span><span class="p">,</span> <span class="s">&quot;accessdenied&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">doc</span><span class="p">,</span> <span class="n">params</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&quot;pagenotfound&quot;</span><span class="p">:</span>
                    <span class="c"># means the nofound page does not exist</span>
                    <span class="n">doc</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDoc</span><span class="p">(</span><span class="s">&quot;system&quot;</span><span class="p">,</span> <span class="s">&quot;pagenotfound&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="n">start_response</span><span class="p">(</span><span class="s">&quot;404 Not found&quot;</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="k">return</span> <span class="n">doc</span><span class="p">,</span> <span class="n">params</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">space</span> <span class="ow">in</span> <span class="n">spacedocgen</span><span class="o">.</span><span class="n">name2doc</span><span class="p">:</span>
                        <span class="n">doc</span> <span class="o">=</span> <span class="n">spacedocgen</span><span class="o">.</span><span class="n">name2doc</span><span class="p">[</span><span class="n">space</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="s">&quot;home&quot;</span> <span class="ow">in</span> <span class="n">spacedocgen</span><span class="o">.</span><span class="n">name2doc</span><span class="p">:</span>
                        <span class="n">doc</span> <span class="o">=</span> <span class="n">spacedocgen</span><span class="o">.</span><span class="n">name2doc</span><span class="p">[</span><span class="s">&quot;home&quot;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ctx</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&quot;path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;space:</span><span class="si">%s</span><span class="s"> pagename:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                        <span class="c"># print ctx.params[&quot;path&quot;]</span>
                        <span class="k">if</span> <span class="s">&quot;space&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                            <span class="n">params</span><span class="p">[</span><span class="s">&quot;space&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">space</span>
                        <span class="k">if</span> <span class="s">&quot;page&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                            <span class="n">params</span><span class="p">[</span><span class="s">&quot;page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
                        <span class="n">doc</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDoc</span><span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="s">&quot;pagenotfound&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&quot;path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;space:</span><span class="si">%s</span><span class="s"> pagename:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="n">doc</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDoc</span><span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="s">&quot;pagenotfound&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

        <span class="n">ctx</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&quot;rights&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">right</span>
        <span class="n">doc</span><span class="o">.</span><span class="n">loadFromDisk</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&quot;pagenotfound&quot;</span><span class="p">:</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">start_response</span><span class="p">(</span><span class="s">&quot;404 Not found&quot;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="k">return</span> <span class="n">doc</span><span class="p">,</span> <span class="n">params</span>
</div>
<div class="viewcode-block" id="PortalServer.returnDoc"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.returnDoc">[docs]</a>    <span class="k">def</span> <span class="nf">returnDoc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">start_response</span><span class="p">,</span> <span class="n">space</span><span class="p">,</span> <span class="n">docname</span><span class="p">,</span> <span class="n">extraParams</span><span class="o">=</span><span class="p">{}):</span>
        <span class="n">doc</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDoc</span><span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="n">docname</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">doc</span><span class="o">.</span><span class="n">dirty</span> <span class="ow">or</span> <span class="s">&quot;reload&quot;</span> <span class="ow">in</span> <span class="n">ctx</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
            <span class="n">doc</span><span class="o">.</span><span class="n">loadFromDisk</span><span class="p">()</span>
            <span class="n">doc</span><span class="o">.</span><span class="n">preprocess</span><span class="p">()</span>

        <span class="n">ctx</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extraParams</span><span class="p">)</span>

        <span class="c"># doc.applyParams(ctx.params)</span>
        <span class="n">content</span><span class="p">,</span><span class="n">doc</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">executeMacrosDynamicWiki</span><span class="p">(</span><span class="n">paramsExtra</span><span class="o">=</span><span class="n">extraParams</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ctx</span><span class="p">)</span>

        <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">confluence2htmlconvertor</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="n">doc</span><span class="p">,</span> <span class="n">requestContext</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getpage</span><span class="p">(),</span> <span class="n">paramsExtra</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;postprocess&#39;</span> <span class="ow">in</span> <span class="n">page</span><span class="o">.</span><span class="n">processparameters</span> <span class="ow">or</span> <span class="n">page</span><span class="o">.</span><span class="n">processparameters</span><span class="p">[</span><span class="s">&#39;postprocess&#39;</span><span class="p">]:</span>
            <span class="n">page</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;$$space&quot;</span><span class="p">,</span> <span class="n">space</span><span class="p">)</span>
            <span class="n">page</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;$$page&quot;</span><span class="p">,</span> <span class="n">doc</span><span class="o">.</span><span class="n">original_name</span><span class="p">)</span>
            <span class="n">page</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;$$path&quot;</span><span class="p">,</span> <span class="n">doc</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="n">page</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;$$querystr&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s">&#39;QUERY_STRING&#39;</span><span class="p">])</span>

        <span class="n">page</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;$$$menuright&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s">&quot;todestruct&quot;</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">__dict__</span><span class="p">:</span>
            <span class="n">doc</span><span class="o">.</span><span class="n">destructed</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="n">ctx</span><span class="o">.</span><span class="n">start_response</span><span class="p">(</span><span class="s">&#39;200 OK&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s">&quot;text/html&quot;</span><span class="p">),</span> <span class="p">])</span>
        <span class="k">return</span> <span class="n">page</span>
</div>
<div class="viewcode-block" id="PortalServer.processor_page"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.processor_page">[docs]</a>    <span class="k">def</span> <span class="nf">processor_page</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">,</span> <span class="n">wwwroot</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">webprefix</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">indexignore</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;pyc&quot;</span><span class="p">,</span> <span class="s">&quot;pyo&quot;</span><span class="p">,</span> <span class="s">&quot;bak&quot;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;_&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;.&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">def</span> <span class="nf">formatContent</span><span class="p">(</span><span class="n">contenttype</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">fileGetContents</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getpage</span><span class="p">()</span>
            <span class="n">page</span><span class="o">.</span><span class="n">addCodeBlock</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">edit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">start_response</span><span class="p">(</span><span class="s">&#39;200 OK&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="n">contenttype</span><span class="p">),</span> <span class="p">])</span>
            <span class="k">return</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">page</span><span class="p">)]</span>

        <span class="k">def</span> <span class="nf">removePrefixes</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;//&quot;</span><span class="p">,</span> <span class="s">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;//&quot;</span><span class="p">,</span> <span class="s">&quot;/&quot;</span><span class="p">)</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;/&quot;</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">while</span> <span class="n">path</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">webprefix</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">webprefix</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
            <span class="k">while</span> <span class="n">path</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
            <span class="k">return</span> <span class="n">path</span>

        <span class="k">def</span> <span class="nf">send_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
            <span class="c"># print &quot;sendfile:%s&quot; % path</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span>
            <span class="n">block</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">BLOCK_SIZE</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
            <span class="n">BLOCK_SIZE2</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c"># print &quot;%s %s&quot; % (file_path,size)</span>
            <span class="k">while</span> <span class="n">BLOCK_SIZE2</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">:</span>
                <span class="n">BLOCK_SIZE2</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
                <span class="c"># print BLOCK_SIZE2</span>
                <span class="c"># print len(block)</span>
                <span class="k">yield</span> <span class="n">block</span>
                <span class="n">block</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">BLOCK_SIZE</span><span class="p">)</span>
            <span class="c"># print &quot;endfile&quot;</span>

        <span class="n">wwwroot</span> <span class="o">=</span> <span class="n">wwwroot</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;/&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">removePrefixes</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="c"># print &quot;wwwroot:%s&quot; % wwwroot</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">wwwroot</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="n">pathfull</span> <span class="o">=</span> <span class="n">wwwroot</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">path</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">pathfull</span> <span class="o">=</span> <span class="n">path</span>

        <span class="n">contenttype</span> <span class="o">=</span> <span class="s">&quot;text/html&quot;</span>
        <span class="n">content</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">contenttype</span> <span class="o">=</span> <span class="n">mimetypes</span><span class="o">.</span><span class="n">guess_type</span><span class="p">(</span><span class="n">pathfull</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="s">&quot;favicon.ico&quot;</span><span class="p">:</span>
            <span class="n">pathfull</span> <span class="o">=</span> <span class="s">&quot;wiki/System/favicon.ico&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pathfull</span><span class="p">)</span> <span class="ow">and</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pathfull</span> <span class="o">+</span> <span class="s">&#39;.gz&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s">&#39;gzip&#39;</span> <span class="ow">in</span> <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;HTTP_ACCEPT_ENCODING&#39;</span><span class="p">):</span>
            <span class="n">pathfull</span> <span class="o">+=</span> <span class="s">&quot;.gz&quot;</span>
            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;Vary&#39;</span><span class="p">,</span> <span class="s">&#39;Accept-Encoding&#39;</span><span class="p">))</span>
            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;Content-Encoding&#39;</span><span class="p">,</span> <span class="s">&#39;gzip&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pathfull</span><span class="p">):</span>
            <span class="k">print</span> <span class="s">&quot;error&quot;</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="n">contenttype</span><span class="p">),</span> <span class="p">]</span>
            <span class="n">start_response</span><span class="p">(</span><span class="s">&quot;404 Not found&quot;</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="s">&quot;path </span><span class="si">%s</span><span class="s"> not found&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">]</span>

        <span class="n">size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">pathfull</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s">&quot;wiki&quot;</span><span class="p">:</span>
            <span class="n">contenttype</span> <span class="o">=</span> <span class="s">&quot;text/html&quot;</span>
            <span class="c"># return formatWikiContent(pathfull,start_response)</span>
            <span class="k">return</span> <span class="n">formatContent</span><span class="p">(</span><span class="n">contenttype</span><span class="p">,</span> <span class="n">pathfull</span><span class="p">,</span> <span class="s">&quot;python&quot;</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s">&quot;py&quot;</span><span class="p">:</span>
            <span class="n">contenttype</span> <span class="o">=</span> <span class="s">&quot;text/html&quot;</span>
            <span class="k">return</span> <span class="n">formatContent</span><span class="p">(</span><span class="n">contenttype</span><span class="p">,</span> <span class="n">pathfull</span><span class="p">,</span> <span class="s">&quot;python&quot;</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s">&quot;spec&quot;</span><span class="p">:</span>
            <span class="n">contenttype</span> <span class="o">=</span> <span class="s">&quot;text/html&quot;</span>
            <span class="k">return</span> <span class="n">formatContent</span><span class="p">(</span><span class="n">contenttype</span><span class="p">,</span> <span class="n">pathfull</span><span class="p">,</span> <span class="s">&quot;python&quot;</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>

        <span class="c"># print contenttype</span>

        <span class="n">status</span> <span class="o">=</span> <span class="s">&#39;200 OK&#39;</span>

        <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="n">contenttype</span><span class="p">))</span>
        <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&quot;Content-length&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">)))</span>
        <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&quot;Cache-Control&quot;</span><span class="p">,</span> <span class="s">&#39;public,max-age=3600&#39;</span><span class="p">))</span>

        <span class="n">start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">content</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">content</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">send_file</span><span class="p">(</span><span class="n">pathfull</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PortalServer.process_elfinder"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.process_elfinder">[docs]</a>    <span class="k">def</span> <span class="nf">process_elfinder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">JumpScale.portal.html</span> <span class="kn">import</span> <span class="n">elFinder</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">keyvaluestore</span><span class="o">.</span><span class="n">getMemoryStore</span><span class="p">(</span><span class="s">&#39;elfinder&#39;</span><span class="p">)</span>
        <span class="n">rootpath</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cacheGet</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;root&#39;</span><span class="p">:</span> <span class="n">rootpath</span><span class="p">,</span> <span class="s">&#39;dotFiles&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">elFinder</span><span class="o">.</span><span class="n">connector</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="s">&#39;rawdata&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">JumpScale.portal.html</span> <span class="kn">import</span> <span class="n">multipart</span>
            <span class="kn">from</span> <span class="nn">cStringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;wsgi.input&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">stream</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;rawdata&#39;</span><span class="p">))</span>
            <span class="n">forms</span><span class="p">,</span> <span class="n">files</span> <span class="o">=</span> <span class="n">multipart</span><span class="o">.</span><span class="n">parse_form_data</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">forms</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">files</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;upload[]&#39;</span><span class="p">:</span>
                    <span class="n">params</span><span class="p">[</span><span class="s">&#39;upload[]&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="n">params</span><span class="p">[</span><span class="s">&#39;upload[]&#39;</span><span class="p">][</span><span class="n">value</span><span class="o">.</span><span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">file</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;init&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;1&#39;</span><span class="p">:</span>
            <span class="n">params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;target&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">status</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">status</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span> <span class="p">]</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;download&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">serializers</span><span class="o">.</span><span class="n">getSerializerType</span><span class="p">(</span><span class="s">&#39;j&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;content&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">response</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="PortalServer.path2spacePagename"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.path2spacePagename">[docs]</a>    <span class="k">def</span> <span class="nf">path2spacePagename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>

        <span class="n">pagename</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;?&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;?&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;/&quot;</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">space</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">splitted</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">space</span> <span class="o">=</span> <span class="n">splitted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">pagename</span> <span class="o">=</span> <span class="n">splitted</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">space</span><span class="p">,</span> <span class="n">pagename</span>

<span class="c">##################### FORMATTING + logs/raiseerror</span></div>
<div class="viewcode-block" id="PortalServer.log"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.log">[docs]</a>    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">space</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">pagename</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="n">path2</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logdir</span><span class="p">,</span> <span class="s">&quot;user_</span><span class="si">%s</span><span class="s">.log&quot;</span> <span class="o">%</span> <span class="n">user</span><span class="p">)</span>

        <span class="n">epoch</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">getTimeEpoch</span><span class="p">()</span> <span class="o">+</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">6</span>
        <span class="n">hrtime</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">epoch2HRDateTime</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">False</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoIP</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>  <span class="c"># @todo fix geoip, also make sure nginx forwards the right info</span>
            <span class="n">ee</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoIP</span><span class="o">.</span><span class="n">record_by_addr</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s">&quot;REMOTE_ADDR&quot;</span><span class="p">])</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ee</span><span class="p">[</span><span class="s">&quot;area_code&quot;</span><span class="p">],</span> <span class="n">ee</span><span class="p">[</span><span class="s">&quot;city&quot;</span><span class="p">],</span> <span class="n">ee</span><span class="p">[</span><span class="s">&quot;region_name&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">|</span><span class="si">%s</span><span class="s">|</span><span class="si">%s</span><span class="s">|</span><span class="si">%s</span><span class="s">|</span><span class="si">%s</span><span class="s">|</span><span class="si">%s</span><span class="s">|</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hrtime</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s">&quot;REMOTE_ADDR&quot;</span><span class="p">],</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">space</span><span class="p">,</span> <span class="n">pagename</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>
        <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">writeFile</span><span class="p">(</span><span class="n">path2</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">space</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">|</span><span class="si">%s</span><span class="s">|</span><span class="si">%s</span><span class="s">|</span><span class="si">%s</span><span class="s">|</span><span class="si">%s</span><span class="s">|</span><span class="si">%s</span><span class="s">|</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hrtime</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s">&quot;REMOTE_ADDR&quot;</span><span class="p">],</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">pagename</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>
            <span class="n">pathSpace</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logdir</span><span class="p">,</span> <span class="s">&quot;space_</span><span class="si">%s</span><span class="s">.log&quot;</span> <span class="o">%</span> <span class="n">space</span><span class="p">)</span>
            <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">writeFile</span><span class="p">(</span><span class="n">pathSpace</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PortalServer.raiseError"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.raiseError">[docs]</a>    <span class="k">def</span> <span class="nf">raiseError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">msginfo</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">errorObject</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">httpcode</span><span class="o">=</span><span class="s">&quot;500 Internal Server Error&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ctx</span><span class="o">.</span><span class="n">checkFormat</span><span class="p">():</span>
            <span class="c"># error in format</span>
            <span class="n">eco</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">errorconditionhandler</span><span class="o">.</span><span class="n">getErrorConditionObject</span><span class="p">()</span>
            <span class="n">eco</span><span class="o">.</span><span class="n">errormessage</span> <span class="o">=</span> <span class="s">&quot;only format supported = human or json, format is put with param &amp;format=...&quot;</span>
            <span class="n">eco</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">enumerators</span><span class="o">.</span><span class="n">ErrorConditionType</span><span class="o">.</span><span class="n">INPUT</span>
            <span class="k">print</span> <span class="s">&quot;WRONG FORMAT&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">errorObject</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">eco</span> <span class="o">=</span> <span class="n">errorObject</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">eco</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">errorconditionhandler</span><span class="o">.</span><span class="n">getErrorConditionObject</span><span class="p">()</span>

        <span class="n">method</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s">&quot;PATH_INFO&quot;</span><span class="p">]</span>
        <span class="n">remoteAddress</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s">&quot;REMOTE_ADDR&quot;</span><span class="p">]</span>
        <span class="n">queryString</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s">&quot;QUERY_STRING&quot;</span><span class="p">]</span>

        <span class="n">eco</span><span class="o">.</span><span class="n">caller</span> <span class="o">=</span> <span class="n">remoteAddress</span>
        <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="n">eco</span><span class="o">.</span><span class="n">errormessage</span> <span class="o">=</span> <span class="n">msg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">eco</span><span class="o">.</span><span class="n">errormessage</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">msginfo</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="n">eco</span><span class="o">.</span><span class="n">errormessage</span> <span class="o">+=</span> <span class="s">&quot;\msginfo was:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">msginfo</span>
        <span class="k">if</span> <span class="n">queryString</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="n">eco</span><span class="o">.</span><span class="n">errormessage</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">querystr was:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">queryString</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="n">eco</span><span class="o">.</span><span class="n">errormessage</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">method was:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">method</span>

        <span class="n">j</span><span class="o">.</span><span class="n">errorconditionhandler</span><span class="o">.</span><span class="n">processErrorConditionObject</span><span class="p">(</span><span class="n">eco</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">fformat</span> <span class="o">==</span> <span class="s">&quot;human&quot;</span> <span class="ow">or</span> <span class="n">ctx</span><span class="o">.</span><span class="n">fformat</span> <span class="o">==</span> <span class="s">&quot;text&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">msginfo</span> <span class="o">!=</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">msginfo</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&lt;br&gt;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">msginfo</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">eco</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text2html</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c"># is json</span>
            <span class="c"># result=[]</span>
            <span class="c"># result[&quot;error&quot;]=eco.obj2dict()</span>
            <span class="k">def</span> <span class="nf">todict</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">todict</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">return</span> <span class="n">data</span>
            <span class="n">eco</span><span class="o">.</span><span class="n">tb</span><span class="o">=</span><span class="s">&quot;&quot;</span>
            <span class="n">eco</span><span class="o">.</span><span class="n">frames</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">serializers</span><span class="o">.</span><span class="n">getSerializerType</span><span class="p">(</span><span class="s">&#39;j&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">todict</span><span class="p">(</span><span class="n">eco</span><span class="p">))</span>

        <span class="n">ctx</span><span class="o">.</span><span class="n">start_response</span><span class="p">(</span><span class="n">httpcode</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s">&#39;text/html&#39;</span><span class="p">)])</span>

        <span class="n">j</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s">&quot;***ERROR***:</span><span class="si">%s</span><span class="s"> : method </span><span class="si">%s</span><span class="s"> from ip </span><span class="si">%s</span><span class="s"> with params </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">eco</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">remoteAddress</span><span class="p">,</span> <span class="n">queryString</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">msg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;An unexpected error has occurred, please try again later.&quot;</span>
</div>
    <span class="k">def</span> <span class="nf">_text2html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;&lt;br&gt;&quot;</span><span class="p">)</span>
        <span class="c"># text=text.replace(&quot; &quot;,&quot;&amp;nbsp; &quot;)</span>
        <span class="k">return</span> <span class="n">text</span>

    <span class="k">def</span> <span class="nf">_text2htmlSerializer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text2html</span><span class="p">(</span><span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_resultjsonSerializer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">j</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">serializers</span><span class="o">.</span><span class="n">getSerializerType</span><span class="p">(</span><span class="s">&#39;j&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">&quot;result&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">_resultyamlSerializer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">j</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">object2yaml</span><span class="p">({</span><span class="s">&quot;result&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">})</span>

<div class="viewcode-block" id="PortalServer.getMimeType"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.getMimeType">[docs]</a>    <span class="k">def</span> <span class="nf">getMimeType</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">contenttype</span><span class="p">,</span> <span class="n">format_types</span><span class="p">):</span>
        <span class="n">supported_types</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;text/plain&quot;</span><span class="p">,</span> <span class="s">&quot;text/html&quot;</span><span class="p">,</span> <span class="s">&quot;application/yaml&quot;</span><span class="p">,</span> <span class="s">&quot;application/json&quot;</span><span class="p">]</span>
        <span class="n">CONTENT_TYPES</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&quot;text/plain&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s">&quot;text/html&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text2htmlSerializer</span><span class="p">,</span>
            <span class="s">&quot;application/yaml&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resultyamlSerializer</span><span class="p">,</span>
            <span class="s">&quot;application/json&quot;</span><span class="p">:</span> <span class="n">j</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">serializers</span><span class="o">.</span><span class="n">getSerializerType</span><span class="p">(</span><span class="s">&#39;j&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dumps</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">contenttype</span><span class="p">:</span>
            <span class="n">serializer</span> <span class="o">=</span> <span class="n">format_types</span><span class="p">[</span><span class="s">&quot;text&quot;</span><span class="p">][</span><span class="s">&quot;serializer&quot;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">CONTENT_TYPE_HTML</span><span class="p">,</span> <span class="n">serializer</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mimeType</span> <span class="o">=</span> <span class="n">mimeparse</span><span class="o">.</span><span class="n">best_match</span><span class="p">(</span><span class="n">supported_types</span><span class="p">,</span> <span class="n">contenttype</span><span class="p">)</span>
            <span class="n">serializer</span> <span class="o">=</span> <span class="n">CONTENT_TYPES</span><span class="p">[</span><span class="n">mimeType</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">mimeType</span><span class="p">,</span> <span class="n">serializer</span>
</div>
<div class="viewcode-block" id="PortalServer.reformatOutput"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.reformatOutput">[docs]</a>    <span class="k">def</span> <span class="nf">reformatOutput</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">restreturn</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">FFORMAT_TYPES</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&quot;text&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;content_type&quot;</span><span class="p">:</span> <span class="n">CONTENT_TYPE_HTML</span><span class="p">,</span> <span class="s">&quot;serializer&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text2htmlSerializer</span><span class="p">},</span>
            <span class="s">&quot;html&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;content_type&quot;</span><span class="p">:</span> <span class="n">CONTENT_TYPE_HTML</span><span class="p">,</span> <span class="s">&quot;serializer&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text2htmlSerializer</span><span class="p">},</span>
            <span class="s">&quot;raw&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;content_type&quot;</span><span class="p">:</span> <span class="n">CONTENT_TYPE_PLAIN</span><span class="p">,</span> <span class="s">&quot;serializer&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">},</span>
            <span class="s">&quot;jsonraw&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;content_type&quot;</span><span class="p">:</span> <span class="n">CONTENT_TYPE_JSON</span><span class="p">,</span> <span class="s">&quot;serializer&quot;</span><span class="p">:</span> <span class="n">j</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">serializers</span><span class="o">.</span><span class="n">getSerializerType</span><span class="p">(</span><span class="s">&#39;j&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dumps</span><span class="p">},</span>
            <span class="s">&quot;json&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;content_type&quot;</span><span class="p">:</span> <span class="n">CONTENT_TYPE_JSON</span><span class="p">,</span> <span class="s">&quot;serializer&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resultjsonSerializer</span><span class="p">},</span>
            <span class="s">&quot;yaml&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;content_type&quot;</span><span class="p">:</span> <span class="n">CONTENT_TYPE_YAML</span><span class="p">,</span> <span class="s">&quot;serializer&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resultyamlSerializer</span><span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="s">&#39;_jsonp&#39;</span> <span class="ow">in</span> <span class="n">ctx</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
           <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;httpStatus&#39;</span><span class="p">:</span> <span class="n">ctx</span><span class="o">.</span><span class="n">httpStatus</span><span class="p">,</span> <span class="s">&#39;httpMessage&#39;</span><span class="p">:</span> <span class="n">ctx</span><span class="o">.</span><span class="n">httpMessage</span><span class="p">,</span> <span class="s">&#39;body&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">}</span>
           <span class="k">return</span> <span class="n">CONTENT_TYPE_JS</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">(</span><span class="si">%s</span><span class="s">);&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;_jsonp&#39;</span><span class="p">],</span> <span class="n">j</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">serializers</span><span class="o">.</span><span class="n">getSerializerType</span><span class="p">(</span><span class="s">&#39;j&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>



        <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">_response_started</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span>

        <span class="n">fformat</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">fformat</span>


        <span class="k">if</span> <span class="s">&#39;_png&#39;</span> <span class="ow">in</span> <span class="n">ctx</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CONTENT_TYPE_PNG</span><span class="p">,</span> <span class="n">result</span>


        <span class="k">if</span> <span class="s">&quot;CONTENT_TYPE&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ctx</span><span class="o">.</span><span class="n">env</span><span class="p">:</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s">&#39;CONTENT_TYPE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CONTENT_TYPE_PLAIN</span>

        <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s">&#39;CONTENT_TYPE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;form-&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s">&#39;CONTENT_TYPE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CONTENT_TYPE_PLAIN</span>
        <span class="c"># normally HTTP_ACCEPT defines the return type we should rewrite this</span>
        <span class="k">if</span> <span class="n">fformat</span><span class="p">:</span>
            <span class="c"># extra format paramter overrides http_accept header</span>
            <span class="k">return</span> <span class="n">FFORMAT_TYPES</span><span class="p">[</span><span class="n">fformat</span><span class="p">][</span><span class="s">&#39;content_type&#39;</span><span class="p">],</span> <span class="n">FFORMAT_TYPES</span><span class="p">[</span><span class="n">fformat</span><span class="p">][</span><span class="s">&#39;serializer&#39;</span><span class="p">](</span><span class="n">result</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;HTTP_ACCEPT&#39;</span> <span class="ow">in</span> <span class="n">ctx</span><span class="o">.</span><span class="n">env</span><span class="p">:</span>
                <span class="n">returntype</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s">&#39;HTTP_ACCEPT&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">returntype</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s">&#39;CONTENT_TYPE&#39;</span><span class="p">]</span>
            <span class="n">content_type</span><span class="p">,</span> <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMimeType</span><span class="p">(</span><span class="n">returntype</span><span class="p">,</span> <span class="n">FFORMAT_TYPES</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">serializer</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="c">##################### router</span>
</div>
<div class="viewcode-block" id="PortalServer.startSession"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.startSession">[docs]</a>    <span class="k">def</span> <span class="nf">startSession</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s">&#39;beaker.session&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s">&quot;authkey&quot;</span> <span class="ow">in</span> <span class="n">ctx</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
            <span class="c"># user is authenticated by a special key</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&quot;authkey&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">existsKey</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                <span class="n">username</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">getUserFromKey</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">session</span><span class="p">[</span><span class="s">&#39;user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">username</span>
                <span class="n">session</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">secret</span><span class="p">:</span>
                <span class="n">session</span><span class="p">[</span><span class="s">&#39;user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;admin&#39;</span>
                <span class="n">session</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># check if authkey is a session</span>
                <span class="n">newsession</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">newsession</span><span class="p">:</span>
                    <span class="n">session</span> <span class="o">=</span> <span class="n">newsession</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s">&#39;beaker.session&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="n">start_response</span><span class="p">(</span><span class="s">&#39;419 Authentication Timeout&#39;</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returnDoc</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">start_response</span><span class="p">,</span> <span class="s">&quot;system&quot;</span><span class="p">,</span> <span class="s">&quot;accessdenied&quot;</span><span class="p">,</span> <span class="n">extraParams</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;path&quot;</span><span class="p">:</span> <span class="n">path</span><span class="p">}))]</span>

        <span class="k">if</span> <span class="s">&quot;user_logoff_&quot;</span> <span class="ow">in</span> <span class="n">ctx</span><span class="o">.</span><span class="n">params</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s">&quot;user_login_&quot;</span> <span class="ow">in</span> <span class="n">ctx</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returnDoc</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">start_response</span><span class="p">,</span> <span class="s">&quot;system&quot;</span><span class="p">,</span> <span class="s">&quot;login&quot;</span><span class="p">,</span> <span class="n">extraParams</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;path&quot;</span><span class="p">:</span> <span class="n">path</span><span class="p">}))]</span>

        <span class="k">if</span> <span class="s">&quot;user_login_&quot;</span> <span class="ow">in</span> <span class="n">ctx</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
            <span class="c"># user has filled in his login details, this is response on posted info</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;user_login_&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ctx</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;passwd&#39;</span><span class="p">):</span>
                <span class="n">secret</span><span class="o">=</span><span class="s">&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">secret</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;passwd&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">secret</span><span class="p">):</span>
                <span class="n">session</span><span class="p">[</span><span class="s">&#39;user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
                <span class="k">if</span> <span class="s">&quot;querystr&quot;</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s">&#39;QUERY_STRING&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;querystr&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s">&#39;QUERY_STRING&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
                <span class="n">session</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="c"># user is loging in from login page redirect him to home</span>
                <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;system/login&#39;</span><span class="p">):</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="s">&#39;302&#39;</span>
                    <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="p">(</span><span class="s">&#39;Location&#39;</span><span class="p">,</span> <span class="s">&quot;/&quot;</span><span class="p">),</span>
                    <span class="p">]</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="n">start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">session</span><span class="p">[</span><span class="s">&#39;user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
                <span class="n">session</span><span class="p">[</span><span class="s">&quot;querystr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
                <span class="n">session</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returnDoc</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">start_response</span><span class="p">,</span> <span class="s">&quot;system&quot;</span><span class="p">,</span> <span class="s">&quot;accessdenied&quot;</span><span class="p">,</span> <span class="n">extraParams</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;path&quot;</span><span class="p">:</span> <span class="n">path</span><span class="p">}))]</span>

        <span class="k">if</span> <span class="s">&quot;user&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">session</span> <span class="ow">or</span> <span class="n">session</span><span class="p">[</span><span class="s">&quot;user&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="n">session</span><span class="p">[</span><span class="s">&#39;user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;guest&quot;</span>
            <span class="n">session</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">if</span> <span class="s">&quot;querystr&quot;</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">session</span><span class="p">[</span><span class="s">&quot;querystr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="n">session</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="n">session</span>
</div>
    <span class="k">def</span> <span class="nf">_getParamsFromEnv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">parse_qs</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s">&quot;QUERY_STRING&quot;</span><span class="p">])</span>

        <span class="c"># HTTP parameters can be repeated multiple times, i.e. in case of using &lt;select multiple&gt;</span>
        <span class="c"># Example: a=1&amp;b=2&amp;a=3</span>
        <span class="c">#</span>
        <span class="c"># urlparse.parse_qs returns a dictionary of names &amp; list of values. Then it&#39;s simplified</span>
        <span class="c"># for lists with only a single element, e.g.</span>
        <span class="c">#</span>
        <span class="c">#   {&#39;a&#39;: [&#39;1&#39;, &#39;3&#39;], &#39;b&#39;: [&#39;2&#39;]}</span>
        <span class="c">#</span>
        <span class="c"># simplified to be</span>
        <span class="c">#</span>
        <span class="c">#   {&#39;a&#39;: [&#39;1&#39;, &#39;3&#39;], &#39;b&#39;: &#39;2&#39;}</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">env</span><span class="p">[</span><span class="s">&quot;REQUEST_METHOD&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;POST&quot;</span><span class="p">,</span> <span class="s">&quot;PUT&quot;</span><span class="p">):</span>
            <span class="n">postData</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s">&quot;wsgi.input&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">postData</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">params</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;postdata cannot be empty&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">raiseError</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">env</span><span class="p">[</span><span class="s">&#39;CONTENT_TYPE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;application/json&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">postParams</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">serializers</span><span class="o">.</span><span class="n">getSerializerType</span><span class="p">(</span><span class="s">&#39;j&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">postData</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">postParams</span><span class="p">:</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">postParams</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">params</span>
            <span class="k">elif</span> <span class="n">env</span><span class="p">[</span><span class="s">&#39;CONTENT_TYPE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;www-form-urlencoded&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">urlparse</span><span class="o">.</span><span class="n">parse_qsl</span><span class="p">(</span><span class="n">postData</span><span class="p">)))</span>
                <span class="k">return</span> <span class="n">params</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="s">&#39;rawdata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">postData</span>
        <span class="k">return</span> <span class="n">params</span>

<div class="viewcode-block" id="PortalServer.router"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.router">[docs]</a>    <span class="k">def</span> <span class="nf">router</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">environ</span><span class="p">[</span><span class="s">&quot;PATH_INFO&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;path:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">path</span>
        <span class="n">pathparts</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pathparts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;wiki&#39;</span><span class="p">:</span>
            <span class="n">pathparts</span> <span class="o">=</span> <span class="n">pathparts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;favicon.ico&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor_page</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filesroot</span><span class="p">,</span> <span class="s">&quot;favicon.ico&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>

        <span class="n">ctx</span> <span class="o">=</span> <span class="n">RequestContext</span><span class="p">(</span><span class="n">application</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">actor</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">environ</span><span class="p">,</span>
                             <span class="n">start_response</span><span class="o">=</span><span class="n">start_response</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getParamsFromEnv</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;jslib/&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span>
            <span class="n">user</span> <span class="o">=</span> <span class="s">&quot;None&quot;</span>
            <span class="c"># self.log(ctx, user, path)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor_page</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jslibroot</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;jslib/&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;images/&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">space</span><span class="p">,</span> <span class="n">image</span> <span class="o">=</span> <span class="n">pathparts</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">spaceObject</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSpace</span><span class="p">(</span><span class="n">space</span><span class="p">)</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">spaceObject</span><span class="o">.</span><span class="n">docprocessor</span><span class="o">.</span><span class="n">images</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">spaceObject</span><span class="o">.</span><span class="n">docprocessor</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">image</span><span class="p">]</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor_page</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">,</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">getDirName</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">getBaseName</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;images&quot;</span><span class="p">)</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">start_response</span><span class="p">(</span><span class="s">&#39;404&#39;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;files/specs/&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span>
            <span class="n">user</span> <span class="o">=</span> <span class="s">&quot;None&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor_page</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filesroot</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;files/&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;.files&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="s">&quot;None&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="n">space</span> <span class="o">=</span> <span class="n">pathparts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">path</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pathparts</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
            <span class="n">sploader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacesloader</span><span class="o">.</span><span class="n">getSpaceFromId</span><span class="p">(</span><span class="n">space</span><span class="p">)</span>
            <span class="n">filesroot</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">sploader</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot;.files&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor_page</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">,</span> <span class="n">filesroot</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>

        <span class="c"># user is logged in now</span>
        <span class="n">is_session</span><span class="p">,</span> <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startSession</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_session</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">session</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s">&#39;user&#39;</span><span class="p">]</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">pathparts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pathparts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pathparts</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="k">if</span> <span class="n">match</span> <span class="o">==</span> <span class="s">&quot;restmachine&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">processor_rest</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">human</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ctx</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">match</span> <span class="o">==</span> <span class="s">&quot;elfinder&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_elfinder</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">match</span> <span class="o">==</span> <span class="s">&quot;restextmachine&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">processor_restext</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">human</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ctx</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">match</span> <span class="o">==</span> <span class="s">&quot;rest&quot;</span><span class="p">:</span>
            <span class="n">space</span><span class="p">,</span> <span class="n">pagename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path2spacePagename</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">space</span><span class="p">,</span> <span class="n">pagename</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">processor_rest</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ctx</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">match</span> <span class="o">==</span> <span class="s">&quot;restext&quot;</span><span class="p">:</span>
            <span class="n">space</span><span class="p">,</span> <span class="n">pagename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path2spacePagename</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">space</span><span class="p">,</span> <span class="n">pagename</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">processor_restext</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span>
                                          <span class="n">ctx</span><span class="o">=</span><span class="n">ctx</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">match</span> <span class="o">==</span> <span class="s">&quot;ping&quot;</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s">&#39;200 OK&#39;</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s">&quot;text/html&quot;</span><span class="p">),</span>
            <span class="p">]</span>
            <span class="n">start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="s">&quot;pong&quot;</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">match</span> <span class="o">==</span> <span class="s">&quot;files&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor_page</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filesroot</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;files&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">match</span> <span class="o">==</span> <span class="s">&quot;specs&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor_page</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">,</span> <span class="s">&quot;specs&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;specs&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">match</span> <span class="o">==</span> <span class="s">&quot;appservercode&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor_page</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">,</span> <span class="s">&quot;code&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;code&quot;</span><span class="p">,</span> <span class="n">webprefix</span><span class="o">=</span><span class="s">&quot;appservercode&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">match</span> <span class="o">==</span> <span class="s">&quot;lib&quot;</span><span class="p">:</span>
            <span class="c"># print self.libpath</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor_page</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">libpath</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;lib&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="s">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pathparts</span><span class="p">)</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&quot;path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pathparts</span><span class="p">)</span>
            <span class="n">space</span><span class="p">,</span> <span class="n">pagename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path2spacePagename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">space</span><span class="p">,</span> <span class="n">pagename</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returnDoc</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">start_response</span><span class="p">,</span> <span class="n">space</span><span class="p">,</span> <span class="n">pagename</span><span class="p">,</span> <span class="p">{}))]</span>
    </div>
<div class="viewcode-block" id="PortalServer.addRoute"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.addRoute">[docs]</a>    <span class="k">def</span> <span class="nf">addRoute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">appname</span><span class="p">,</span> <span class="n">actor</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">paramvalidation</span><span class="o">=</span><span class="p">{},</span> <span class="n">paramdescription</span><span class="o">=</span><span class="p">{},</span> \
        <span class="n">paramoptional</span><span class="o">=</span><span class="p">{},</span> <span class="n">description</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">returnformat</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        @param function is the function which will be called as follows: function(webserver,path,params):</span>
<span class="sd">            function can also be a string, then only the string will be returned</span>
<span class="sd">            if str==&#39;taskletengine&#39; will directly call the taskletengine e.g. for std method calls from actors</span>
<span class="sd">        @appname e.g. system is 1e part of url which is routed http://localhost/appname/actor/method/</span>
<span class="sd">        @actor e.g. system is 2nd part of url which is routed http://localhost/appname/actor/method/</span>
<span class="sd">        @method e.g. &quot;test&quot; is part of url which is routed e.g. http://localhost/appname/actor/method/</span>
<span class="sd">        @paramvalidation e.g. {&quot;name&quot;:&quot;\w+&quot;,&quot;color&quot;:&quot;&quot;}   the values are regexes</span>
<span class="sd">        @paramdescription is optional e.g. {&quot;name&quot;:&quot;this is the description for name&quot;}</span>
<span class="sd">        @auth is for authentication if false then there will be no auth key checked</span>

<span class="sd">        example function called</span>

<span class="sd">            def test(self,webserver,path,params):</span>
<span class="sd">                return &#39;hello world!!&#39;</span>

<span class="sd">            or without the self in the functioncall (when no class method)</span>

<span class="sd">            what you return is being send to the browser</span>

<span class="sd">        example call: http://localhost:9999/test?key=1234&amp;color=dd&amp;name=dd</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">appname</span> <span class="o">=</span> <span class="n">appname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;_&quot;</span><span class="p">,</span> <span class="s">&quot;.&quot;</span><span class="p">)</span>
        <span class="n">actor</span> <span class="o">=</span> <span class="n">actor</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;_&quot;</span><span class="p">,</span> <span class="s">&quot;.&quot;</span><span class="p">)</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;_&quot;</span><span class="p">,</span> <span class="s">&quot;.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app_actor_dict</span><span class="p">[</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">appname</span><span class="p">,</span> <span class="n">actor</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">methoddict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;get&#39;</span><span class="p">:</span> <span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;set&#39;</span><span class="p">:</span> <span class="s">&#39;PUT&#39;</span><span class="p">,</span> <span class="s">&#39;new&#39;</span><span class="p">:</span> <span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;delete&#39;</span><span class="p">:</span> <span class="s">&#39;DELETE&#39;</span><span class="p">,</span>
                      <span class="s">&#39;find&#39;</span><span class="p">:</span> <span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;list&#39;</span><span class="p">:</span> <span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;datatables&#39;</span><span class="p">:</span> <span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;create&#39;</span><span class="p">:</span> <span class="s">&#39;POST&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routes</span><span class="p">[</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="n">appname</span><span class="p">,</span> <span class="n">actor</span><span class="p">,</span> <span class="n">method</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="n">function</span><span class="p">,</span> <span class="n">paramvalidation</span><span class="p">,</span> <span class="n">paramdescription</span><span class="p">,</span> <span class="n">paramoptional</span><span class="p">,</span> \
                                                                        <span class="n">description</span><span class="p">,</span> <span class="n">auth</span><span class="p">,</span> <span class="n">returnformat</span><span class="p">]</span>

<span class="c">##################### SCHEDULING</span>
</div>
    <span class="k">def</span> <span class="nf">_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        will remember time every 0.5 sec</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lfmid</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">lfmid</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">-</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">lfmid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fiveMinuteId</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">get5MinuteId</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hourId</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">getHourId</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dayId</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">getDayId</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span>
            <span class="n">gevent</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_minRepeat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">gevent</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule1min</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">item</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule1min</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="n">item</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_15minRepeat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">gevent</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">15</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule15min</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">item</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule15min</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="n">item</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_60minRepeat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">gevent</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule60min</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">item</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule60min</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="n">item</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="PortalServer.getNow"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.getNow">[docs]</a>    <span class="k">def</span> <span class="nf">getNow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span>
</div>
<div class="viewcode-block" id="PortalServer.addSchedule1MinPeriod"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.addSchedule1MinPeriod">[docs]</a>    <span class="k">def</span> <span class="nf">addSchedule1MinPeriod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule1min</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PortalServer.addSchedule15MinPeriod"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.addSchedule15MinPeriod">[docs]</a>    <span class="k">def</span> <span class="nf">addSchedule15MinPeriod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule15min</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PortalServer.addSchedule60MinPeriod"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.addSchedule60MinPeriod">[docs]</a>    <span class="k">def</span> <span class="nf">addSchedule60MinPeriod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule60min</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

<span class="c">##################### START-STOP / get spaces/actors/buckets / addgreenlet</span>
</div>
<div class="viewcode-block" id="PortalServer.start"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start the web server, serving the `routes`. When no `routes` dict is passed, serve a single &#39;test&#39; route.</span>

<span class="sd">        This method will block until an exception stops the server.</span>

<span class="sd">        @param routes: routes to serve, will be merged with the already added routes</span>
<span class="sd">        @type routes: dict(string, list(callable, dict(string, string), dict(string, string)))</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">TIMER</span> <span class="o">=</span> <span class="n">gevent</span><span class="o">.</span><span class="n">greenlet</span><span class="o">.</span><span class="n">Greenlet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_timer</span><span class="p">)</span>
        <span class="n">TIMER</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="n">S1</span> <span class="o">=</span> <span class="n">gevent</span><span class="o">.</span><span class="n">greenlet</span><span class="o">.</span><span class="n">Greenlet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_minRepeat</span><span class="p">)</span>
        <span class="n">S1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="n">S2</span> <span class="o">=</span> <span class="n">gevent</span><span class="o">.</span><span class="n">greenlet</span><span class="o">.</span><span class="n">Greenlet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_15minRepeat</span><span class="p">)</span>
        <span class="n">S2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="n">S3</span> <span class="o">=</span> <span class="n">gevent</span><span class="o">.</span><span class="n">greenlet</span><span class="o">.</span><span class="n">Greenlet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_60minRepeat</span><span class="p">)</span>
        <span class="n">S3</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="n">j</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s">&quot;webserver started on port </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_webserver</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="PortalServer.stop"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_webserver</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="PortalServer.getSpaces"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.getSpaces">[docs]</a>    <span class="k">def</span> <span class="nf">getSpaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacesloader</span><span class="o">.</span><span class="n">id2object</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="PortalServer.getBuckets"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.getBuckets">[docs]</a>    <span class="k">def</span> <span class="nf">getBuckets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucketsloader</span><span class="o">.</span><span class="n">id2object</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="PortalServer.getActors"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.getActors">[docs]</a>    <span class="k">def</span> <span class="nf">getActors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">actorsloader</span><span class="o">.</span><span class="n">id2object</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="PortalServer.getSpace"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.getSpace">[docs]</a>    <span class="k">def</span> <span class="nf">getSpace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ignore_doc_processor</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacesloader</span><span class="o">.</span><span class="n">spaces</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Could not find space </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacesloader</span><span class="o">.</span><span class="n">spaces</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">space</span><span class="o">.</span><span class="n">docprocessor</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ignore_doc_processor</span><span class="p">:</span>
            <span class="n">space</span><span class="o">.</span><span class="n">loadDocProcessor</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">space</span>
</div>
<div class="viewcode-block" id="PortalServer.loadSpace"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.loadSpace">[docs]</a>    <span class="k">def</span> <span class="nf">loadSpace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSpace</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">space</span><span class="o">.</span><span class="n">loadDocProcessor</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">space</span>
</div>
<div class="viewcode-block" id="PortalServer.getBucket"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.getBucket">[docs]</a>    <span class="k">def</span> <span class="nf">getBucket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucketsloader</span><span class="o">.</span><span class="n">buckets</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Could not find bucket </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucketsloader</span><span class="o">.</span><span class="n">buckets</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bucket</span>

</div>
<div class="viewcode-block" id="PortalServer.addGreenlet"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.addGreenlet">[docs]</a>    <span class="k">def</span> <span class="nf">addGreenlet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">appName</span><span class="p">,</span> <span class="n">greenlet</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">greenletObject</span> <span class="o">=</span> <span class="n">greenlet</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">greenletObject</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;greenlet class needs to have a method&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">greenletObject</span><span class="o">.</span><span class="n">actor</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;greenlet class needs to have a actor&quot;</span><span class="p">)</span>

        <span class="n">greenletObject</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addRoute</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="n">greenletObject</span><span class="o">.</span><span class="n">wscall</span><span class="p">,</span>
                                <span class="n">appname</span><span class="o">=</span><span class="n">appName</span><span class="p">,</span>
                                <span class="n">actor</span><span class="o">=</span><span class="n">greenletObject</span><span class="o">.</span><span class="n">actor</span><span class="p">,</span>
                                <span class="n">method</span><span class="o">=</span><span class="n">greenletObject</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                                <span class="n">paramvalidation</span><span class="o">=</span><span class="n">greenletObject</span><span class="o">.</span><span class="n">paramvalidation</span><span class="p">,</span>
                                <span class="n">paramdescription</span><span class="o">=</span><span class="n">greenletObject</span><span class="o">.</span><span class="n">paramdescription</span><span class="p">,</span>
                                <span class="n">paramoptional</span><span class="o">=</span><span class="n">greenletObject</span><span class="o">.</span><span class="n">paramoptional</span><span class="p">,</span>
                                <span class="n">description</span><span class="o">=</span><span class="n">greenletObject</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">greenletObject</span><span class="o">.</span><span class="n">auth</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PortalServer.restartInProcess"><a class="viewcode-back" href="../../../../API/JumpScale.portal.portal.html#JumpScale.portal.portal.PortalServer.PortalServer.restartInProcess">[docs]</a>    <span class="k">def</span> <span class="nf">restartInProcess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">fcntl</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[:]</span>
        <span class="n">args</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">)</span>
        <span class="n">apppath</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">dirs</span><span class="o">.</span><span class="n">appDir</span><span class="p">,</span> <span class="n">app</span><span class="p">)</span>
        <span class="n">max_fd</span> <span class="o">=</span> <span class="mi">1024</span>
        <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">max_fd</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">flags</span> <span class="o">=</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">F_GETFD</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">fcntl</span><span class="o">.</span><span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">F_SETFD</span><span class="p">,</span> <span class="n">flags</span> <span class="o">|</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">FD_CLOEXEC</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">apppath</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">execv</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">out</span><span class="o">=</span><span class="s">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;&gt;</span><span class="s">&quot;_&quot;</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;routes&quot;</span><span class="p">]:</span>
                <span class="n">out</span><span class="o">+=</span><span class="s">&quot;</span><span class="si">%-35s</span><span class="s"> :  </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>
        <span class="n">routes</span><span class="o">=</span><span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">out</span><span class="o">+=</span><span class="s">&quot;</span><span class="si">%-35s</span><span class="s"> :  </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="s">&quot;routes&quot;</span><span class="p">,</span><span class="n">routes</span><span class="p">)</span>
        <span class="n">items</span><span class="o">=</span><span class="n">out</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">items</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">out</span><span class="o">=</span><span class="s">&quot;portalserver:&quot;</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="n">__repr__</span> <span class="o">=</span> <span class="n">__str__</span>
</pre></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">Jumpscale Doc 7.0 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
    </div>
  </body>
</html>