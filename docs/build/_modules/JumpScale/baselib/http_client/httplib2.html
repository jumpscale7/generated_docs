<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>JumpScale.baselib.http_client.httplib2 &mdash; Jumpscale Doc 7.0 documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '7.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="top" title="Jumpscale Doc 7.0 documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">Jumpscale Doc 7.0 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for JumpScale.baselib.http_client.httplib2</h1><div class="highlight"><pre>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">generators</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">httplib2</span>

<span class="sd">A caching http interface that supports ETags and gzip</span>
<span class="sd">to conserve bandwidth.</span>

<span class="sd">Requires Python 2.3 or later</span>

<span class="sd">Changelog:</span>
<span class="sd">2007-08-18, Rick: Modified so it&#39;s able to use a socks proxy if needed.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s">&quot;Joe Gregorio (joe@bitworking.org)&quot;</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s">&quot;Copyright 2006, Joe Gregorio&quot;</span>
<span class="n">__contributors__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;Thomas Broyer (t.broyer@ltgt.net)&quot;</span><span class="p">,</span>
    <span class="s">&quot;James Antill&quot;</span><span class="p">,</span>
    <span class="s">&quot;Xavier Verges Farrero&quot;</span><span class="p">,</span>
    <span class="s">&quot;Jonathan Feinberg&quot;</span><span class="p">,</span>
    <span class="s">&quot;Blair Zajac&quot;</span><span class="p">,</span>
    <span class="s">&quot;Sam Ruby&quot;</span><span class="p">,</span>
    <span class="s">&quot;Louis Nyffenegger&quot;</span><span class="p">]</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s">&quot;MIT&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s">&quot;0.7.2&quot;</span>

<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">email</span>
<span class="kn">import</span> <span class="nn">email.Utils</span>
<span class="kn">import</span> <span class="nn">email.Message</span>
<span class="kn">import</span> <span class="nn">email.FeedParser</span>
<span class="kn">import</span> <span class="nn">StringIO</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">zlib</span>
<span class="kn">import</span> <span class="nn">httplib</span>
<span class="kn">import</span> <span class="nn">urlparse</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">calendar</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="c"># remove depracated warning in python2.6</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha1</span> <span class="k">as</span> <span class="n">_sha</span><span class="p">,</span> <span class="n">md5</span> <span class="k">as</span> <span class="n">_md5</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">sha</span>
    <span class="kn">import</span> <span class="nn">md5</span>
    <span class="n">_sha</span> <span class="o">=</span> <span class="n">sha</span><span class="o">.</span><span class="n">new</span>
    <span class="n">_md5</span> <span class="o">=</span> <span class="n">md5</span><span class="o">.</span><span class="n">new</span>
<span class="kn">import</span> <span class="nn">hmac</span>
<span class="kn">from</span> <span class="nn">gettext</span> <span class="kn">import</span> <span class="n">gettext</span> <span class="k">as</span> <span class="n">_</span>
<span class="kn">import</span> <span class="nn">socket</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">httplib2</span> <span class="kn">import</span> <span class="n">socks</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">socks</span> <span class="o">=</span> <span class="bp">None</span>

<span class="c"># Build the appropriate socket wrapper for ssl</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">ssl</span> <span class="c"># python 2.6</span>
    <span class="n">ssl_SSLError</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span>
    <span class="k">def</span> <span class="nf">_ssl_wrap_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">key_file</span><span class="p">,</span> <span class="n">cert_file</span><span class="p">,</span>
                         <span class="n">disable_validation</span><span class="p">,</span> <span class="n">ca_certs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">disable_validation</span><span class="p">:</span>
            <span class="n">cert_reqs</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cert_reqs</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span>
        <span class="c"># We should be specifying SSL version 3 or TLS v1, but the ssl module</span>
        <span class="c"># doesn&#39;t expose the necessary knobs. So we need to go with the default</span>
        <span class="c"># of SSLv23.</span>
        <span class="k">return</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">keyfile</span><span class="o">=</span><span class="n">key_file</span><span class="p">,</span> <span class="n">certfile</span><span class="o">=</span><span class="n">cert_file</span><span class="p">,</span>
                               <span class="n">cert_reqs</span><span class="o">=</span><span class="n">cert_reqs</span><span class="p">,</span> <span class="n">ca_certs</span><span class="o">=</span><span class="n">ca_certs</span><span class="p">)</span>
<span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ImportError</span><span class="p">):</span>
    <span class="n">ssl_SSLError</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">def</span> <span class="nf">_ssl_wrap_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">key_file</span><span class="p">,</span> <span class="n">cert_file</span><span class="p">,</span>
                         <span class="n">disable_validation</span><span class="p">,</span> <span class="n">ca_certs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">disable_validation</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CertificateValidationUnsupported</span><span class="p">(</span>
                    <span class="s">&quot;SSL certificate validation is not supported without &quot;</span>
                    <span class="s">&quot;the ssl module installed. To avoid this error, install &quot;</span>
                    <span class="s">&quot;the ssl module, or explicity disable validation.&quot;</span><span class="p">)</span>
        <span class="n">ssl_sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">ssl</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">key_file</span><span class="p">,</span> <span class="n">cert_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">httplib</span><span class="o">.</span><span class="n">FakeSocket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">ssl_sock</span><span class="p">)</span>


<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">iri2uri</span> <span class="kn">import</span> <span class="n">iri2uri</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">iri2uri</span><span class="p">(</span><span class="n">uri</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">uri</span>

<span class="k">def</span> <span class="nf">has_timeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">):</span> <span class="c"># python 2.6</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&#39;_GLOBAL_DEFAULT_TIMEOUT&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">socket</span><span class="o">.</span><span class="n">_GLOBAL_DEFAULT_TIMEOUT</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Http&#39;</span><span class="p">,</span> <span class="s">&#39;Response&#39;</span><span class="p">,</span> <span class="s">&#39;ProxyInfo&#39;</span><span class="p">,</span> <span class="s">&#39;HttpLib2Error&#39;</span><span class="p">,</span>
  <span class="s">&#39;RedirectMissingLocation&#39;</span><span class="p">,</span> <span class="s">&#39;RedirectLimit&#39;</span><span class="p">,</span> <span class="s">&#39;FailedToDecompressContent&#39;</span><span class="p">,</span>
  <span class="s">&#39;UnimplementedDigestAuthOptionError&#39;</span><span class="p">,</span> <span class="s">&#39;UnimplementedHmacDigestAuthOptionError&#39;</span><span class="p">,</span>
  <span class="s">&#39;debuglevel&#39;</span><span class="p">,</span> <span class="s">&#39;ProxiesUnavailableError&#39;</span><span class="p">]</span>


<span class="c"># The httplib debug level, set to a non-zero value to get debug output</span>
<span class="n">debuglevel</span> <span class="o">=</span> <span class="mi">0</span>


<span class="c"># Python 2.3 support</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">seq</span><span class="p">):</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">seq</span>

<span class="c"># Python 2.3 support</span>
<span class="k">def</span> <span class="nf">HTTPResponse__getheaders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return list of (header, value) tuples.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">httplib</span><span class="o">.</span><span class="n">ResponseNotReady</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>

<span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">httplib</span><span class="o">.</span><span class="n">HTTPResponse</span><span class="p">,</span> <span class="s">&#39;getheaders&#39;</span><span class="p">):</span>
    <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPResponse</span><span class="o">.</span><span class="n">getheaders</span> <span class="o">=</span> <span class="n">HTTPResponse__getheaders</span>

<span class="c"># All exceptions raised here derive from HttpLib2Error</span>
<div class="viewcode-block" id="HttpLib2Error"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.http_client.httplib2.html#JumpScale.baselib.http_client.httplib2.HttpLib2Error">[docs]</a><span class="k">class</span> <span class="nc">HttpLib2Error</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span>

<span class="c"># Some exceptions can be caught and optionally</span>
<span class="c"># be turned back into responses.</span></div>
<span class="k">class</span> <span class="nc">HttpLib2ErrorWithResponse</span><span class="p">(</span><span class="n">HttpLib2Error</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">response</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">content</span>
        <span class="n">HttpLib2Error</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">desc</span><span class="p">)</span>

<div class="viewcode-block" id="RedirectMissingLocation"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.http_client.httplib2.html#JumpScale.baselib.http_client.httplib2.RedirectMissingLocation">[docs]</a><span class="k">class</span> <span class="nc">RedirectMissingLocation</span><span class="p">(</span><span class="n">HttpLib2ErrorWithResponse</span><span class="p">):</span> <span class="k">pass</span></div>
<div class="viewcode-block" id="RedirectLimit"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.http_client.httplib2.html#JumpScale.baselib.http_client.httplib2.RedirectLimit">[docs]</a><span class="k">class</span> <span class="nc">RedirectLimit</span><span class="p">(</span><span class="n">HttpLib2ErrorWithResponse</span><span class="p">):</span> <span class="k">pass</span></div>
<div class="viewcode-block" id="FailedToDecompressContent"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.http_client.httplib2.html#JumpScale.baselib.http_client.httplib2.FailedToDecompressContent">[docs]</a><span class="k">class</span> <span class="nc">FailedToDecompressContent</span><span class="p">(</span><span class="n">HttpLib2ErrorWithResponse</span><span class="p">):</span> <span class="k">pass</span></div>
<div class="viewcode-block" id="UnimplementedDigestAuthOptionError"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.http_client.httplib2.html#JumpScale.baselib.http_client.httplib2.UnimplementedDigestAuthOptionError">[docs]</a><span class="k">class</span> <span class="nc">UnimplementedDigestAuthOptionError</span><span class="p">(</span><span class="n">HttpLib2ErrorWithResponse</span><span class="p">):</span> <span class="k">pass</span></div>
<div class="viewcode-block" id="UnimplementedHmacDigestAuthOptionError"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.http_client.httplib2.html#JumpScale.baselib.http_client.httplib2.UnimplementedHmacDigestAuthOptionError">[docs]</a><span class="k">class</span> <span class="nc">UnimplementedHmacDigestAuthOptionError</span><span class="p">(</span><span class="n">HttpLib2ErrorWithResponse</span><span class="p">):</span> <span class="k">pass</span>
</div>
<span class="k">class</span> <span class="nc">MalformedHeader</span><span class="p">(</span><span class="n">HttpLib2Error</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">RelativeURIError</span><span class="p">(</span><span class="n">HttpLib2Error</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">ServerNotFoundError</span><span class="p">(</span><span class="n">HttpLib2Error</span><span class="p">):</span> <span class="k">pass</span>
<div class="viewcode-block" id="ProxiesUnavailableError"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.http_client.httplib2.html#JumpScale.baselib.http_client.httplib2.ProxiesUnavailableError">[docs]</a><span class="k">class</span> <span class="nc">ProxiesUnavailableError</span><span class="p">(</span><span class="n">HttpLib2Error</span><span class="p">):</span> <span class="k">pass</span></div>
<span class="k">class</span> <span class="nc">CertificateValidationUnsupported</span><span class="p">(</span><span class="n">HttpLib2Error</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">SSLHandshakeError</span><span class="p">(</span><span class="n">HttpLib2Error</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">NotSupportedOnThisPlatform</span><span class="p">(</span><span class="n">HttpLib2Error</span><span class="p">):</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">CertificateHostnameMismatch</span><span class="p">(</span><span class="n">SSLHandshakeError</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">cert</span><span class="p">):</span>
    <span class="n">HttpLib2Error</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">desc</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cert</span> <span class="o">=</span> <span class="n">cert</span>

<span class="c"># Open Items:</span>
<span class="c"># -----------</span>
<span class="c"># Proxy support</span>

<span class="c"># Are we removing the cached content too soon on PUT (only delete on 200 Maybe?)</span>

<span class="c"># Pluggable cache storage (supports storing the cache in</span>
<span class="c">#   flat files by default. We need a plug-in architecture</span>
<span class="c">#   that can support Berkeley DB and Squid)</span>

<span class="c"># == Known Issues ==</span>
<span class="c"># Does not handle a resource that uses conneg and Last-Modified but no ETag as a cache validator.</span>
<span class="c"># Does not handle Cache-Control: max-stale</span>
<span class="c"># Does not use Age: headers when calculating cache freshness.</span>


<span class="c"># The number of redirections to follow before giving up.</span>
<span class="c"># Note that only GET redirects are automatically followed.</span>
<span class="c"># Will also honor 301 requests by saving that info and never</span>
<span class="c"># requesting that URI again.</span>
<span class="n">DEFAULT_MAX_REDIRECTS</span> <span class="o">=</span> <span class="mi">5</span>

<span class="c"># Default CA certificates file bundled with httplib2.</span>
<span class="n">CA_CERTS</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span> <span class="p">)),</span> <span class="s">&quot;cacerts.txt&quot;</span><span class="p">)</span>

<span class="c"># Which headers are hop-by-hop headers by default</span>
<span class="n">HOP_BY_HOP</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;connection&#39;</span><span class="p">,</span> <span class="s">&#39;keep-alive&#39;</span><span class="p">,</span> <span class="s">&#39;proxy-authenticate&#39;</span><span class="p">,</span> <span class="s">&#39;proxy-authorization&#39;</span><span class="p">,</span> <span class="s">&#39;te&#39;</span><span class="p">,</span> <span class="s">&#39;trailers&#39;</span><span class="p">,</span> <span class="s">&#39;transfer-encoding&#39;</span><span class="p">,</span> <span class="s">&#39;upgrade&#39;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">_get_end2end_headers</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
    <span class="n">hopbyhop</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">HOP_BY_HOP</span><span class="p">)</span>
    <span class="n">hopbyhop</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;connection&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)])</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">header</span> <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">header</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hopbyhop</span><span class="p">]</span>

<span class="n">URI</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_uri</span><span class="p">(</span><span class="n">uri</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parses a URI using the regex given in Appendix B of RFC 3986.</span>

<span class="sd">        (scheme, authority, path, query, fragment) = parse_uri(uri)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">URI</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">groups</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">groups</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">groups</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">groups</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">groups</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">urlnorm</span><span class="p">(</span><span class="n">uri</span><span class="p">):</span>
    <span class="p">(</span><span class="n">scheme</span><span class="p">,</span> <span class="n">authority</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">fragment</span><span class="p">)</span> <span class="o">=</span> <span class="n">parse_uri</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">scheme</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">authority</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">RelativeURIError</span><span class="p">(</span><span class="s">&quot;Only absolute URIs are allowed. uri = </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">uri</span><span class="p">)</span>
    <span class="n">authority</span> <span class="o">=</span> <span class="n">authority</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">scheme</span> <span class="o">=</span> <span class="n">scheme</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span>
    <span class="c"># Could do syntax based normalization of the URI before</span>
    <span class="c"># computing the digest. See Section 6.2.2 of Std 66.</span>
    <span class="n">request_uri</span> <span class="o">=</span> <span class="n">query</span> <span class="ow">and</span> <span class="s">&quot;?&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">path</span><span class="p">,</span> <span class="n">query</span><span class="p">])</span> <span class="ow">or</span> <span class="n">path</span>
    <span class="n">scheme</span> <span class="o">=</span> <span class="n">scheme</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">defrag_uri</span> <span class="o">=</span> <span class="n">scheme</span> <span class="o">+</span> <span class="s">&quot;://&quot;</span> <span class="o">+</span> <span class="n">authority</span> <span class="o">+</span> <span class="n">request_uri</span>
    <span class="k">return</span> <span class="n">scheme</span><span class="p">,</span> <span class="n">authority</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">defrag_uri</span>


<span class="c"># Cache filename construction (original borrowed from Venus http://intertwingly.net/code/venus/)</span>
<span class="n">re_url_scheme</span>    <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;^\w+://&#39;</span><span class="p">)</span>
<span class="n">re_slash</span>         <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;[?/:|]+&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">safename</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a filename suitable for the cache.</span>

<span class="sd">    Strips dangerous and common characters to create a filename we</span>
<span class="sd">    can use to store the cache in.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">re_url_scheme</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;idna&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;idna&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">UnicodeError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="nb">unicode</span><span class="p">):</span>
        <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="n">filemd5</span> <span class="o">=</span> <span class="n">_md5</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">re_url_scheme</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">re_slash</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

    <span class="c"># limit length of filename</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">200</span><span class="p">:</span>
        <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span>
    <span class="k">return</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">filename</span><span class="p">,</span> <span class="n">filemd5</span><span class="p">))</span>

<span class="n">NORMALIZE_SPACE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;(?:\r\n)?[ \t]+&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_normalize_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">([</span> <span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">NORMALIZE_SPACE</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>  <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">headers</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()])</span>

<span class="k">def</span> <span class="nf">_parse_cache_control</span><span class="p">(</span><span class="n">headers</span><span class="p">):</span>
    <span class="n">retval</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">headers</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;cache-control&#39;</span><span class="p">):</span>
        <span class="n">parts</span> <span class="o">=</span>  <span class="n">headers</span><span class="p">[</span><span class="s">&#39;cache-control&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">parts_with_args</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">part</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span> <span class="k">if</span> <span class="o">-</span><span class="mi">1</span> <span class="o">!=</span> <span class="n">part</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;=&quot;</span><span class="p">)]</span>
        <span class="n">parts_wo_args</span> <span class="o">=</span> <span class="p">[(</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">parts</span> <span class="k">if</span> <span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;=&quot;</span><span class="p">)]</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">parts_with_args</span> <span class="o">+</span> <span class="n">parts_wo_args</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">retval</span>

<span class="c"># Whether to use a strict mode to parse WWW-Authenticate headers</span>
<span class="c"># Might lead to bad results in case of ill-formed header value,</span>
<span class="c"># so disabled by default, falling back to relaxed parsing.</span>
<span class="c"># Set to true to turn on, usefull for testing servers.</span>
<span class="n">USE_WWW_AUTH_STRICT_PARSING</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c"># In regex below:</span>
<span class="c">#    [^\0-\x1f\x7f-\xff()&lt;&gt;@,;:\\\&quot;/[\]?={} \t]+             matches a &quot;token&quot; as defined by HTTP</span>
<span class="c">#    &quot;(?:[^\0-\x08\x0A-\x1f\x7f-\xff\\\&quot;]|\\[\0-\x7f])*?&quot;    matches a &quot;quoted-string&quot; as defined by HTTP, when LWS have already been replaced by a single space</span>
<span class="c"># Actually, as an auth-param value can be either a token or a quoted-string, they are combined in a single pattern which matches both:</span>
<span class="c">#    \&quot;?((?&lt;=\&quot;)(?:[^\0-\x1f\x7f-\xff\\\&quot;]|\\[\0-\x7f])*?(?=\&quot;)|(?&lt;!\&quot;)[^\0-\x08\x0A-\x1f\x7f-\xff()&lt;&gt;@,;:\\\&quot;/[\]?={} \t]+(?!\&quot;))\&quot;?</span>
<span class="n">WWW_AUTH_STRICT</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;^(?:\s*(?:,\s*)?([^\0-\x1f\x7f-\xff()&lt;&gt;@,;:</span><span class="se">\\\&quot;</span><span class="s">/[\]?={} \t]+)\s*=\s*</span><span class="se">\&quot;</span><span class="s">?((?&lt;=</span><span class="se">\&quot;</span><span class="s">)(?:[^\0-\x08\x0A-\x1f\x7f-\xff</span><span class="se">\\\&quot;</span><span class="s">]|</span><span class="se">\\</span><span class="s">[\0-\x7f])*?(?=</span><span class="se">\&quot;</span><span class="s">)|(?&lt;!</span><span class="se">\&quot;</span><span class="s">)[^\0-\x1f\x7f-\xff()&lt;&gt;@,;:</span><span class="se">\\\&quot;</span><span class="s">/[\]?={} \t]+(?!</span><span class="se">\&quot;</span><span class="s">))</span><span class="se">\&quot;</span><span class="s">?)(.*)$&quot;</span><span class="p">)</span>
<span class="n">WWW_AUTH_RELAXED</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;^(?:\s*(?:,\s*)?([^ \t\r\n=]+)\s*=\s*</span><span class="se">\&quot;</span><span class="s">?((?&lt;=</span><span class="se">\&quot;</span><span class="s">)(?:[^</span><span class="se">\\\&quot;</span><span class="s">]|</span><span class="se">\\</span><span class="s">.)*?(?=</span><span class="se">\&quot;</span><span class="s">)|(?&lt;!</span><span class="se">\&quot;</span><span class="s">)[^ \t\r\n,]+(?!</span><span class="se">\&quot;</span><span class="s">))</span><span class="se">\&quot;</span><span class="s">?)(.*)$&quot;</span><span class="p">)</span>
<span class="n">UNQUOTE_PAIRS</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;</span><span class="se">\\</span><span class="s">(.)&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_parse_www_authenticate</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="n">headername</span><span class="o">=</span><span class="s">&#39;www-authenticate&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a dictionary of dictionaries, one dict</span>
<span class="sd">    per auth_scheme.&quot;&quot;&quot;</span>
    <span class="n">retval</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">headers</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">headername</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">authenticate</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="n">headername</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
          <span class="n">www_auth</span> <span class="o">=</span> <span class="n">USE_WWW_AUTH_STRICT_PARSING</span> <span class="ow">and</span> <span class="n">WWW_AUTH_STRICT</span> <span class="ow">or</span> <span class="n">WWW_AUTH_RELAXED</span>
          <span class="k">while</span> <span class="n">authenticate</span><span class="p">:</span>
              <span class="c"># Break off the scheme at the beginning of the line</span>
              <span class="k">if</span> <span class="n">headername</span> <span class="o">==</span> <span class="s">&#39;authentication-info&#39;</span><span class="p">:</span>
                  <span class="p">(</span><span class="n">auth_scheme</span><span class="p">,</span> <span class="n">the_rest</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;digest&#39;</span><span class="p">,</span> <span class="n">authenticate</span><span class="p">)</span>
              <span class="k">else</span><span class="p">:</span>
                  <span class="p">(</span><span class="n">auth_scheme</span><span class="p">,</span> <span class="n">the_rest</span><span class="p">)</span> <span class="o">=</span> <span class="n">authenticate</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
              <span class="c"># Now loop over all the key value pairs that come after the scheme,</span>
              <span class="c"># being careful not to roll into the next scheme</span>
              <span class="n">match</span> <span class="o">=</span> <span class="n">www_auth</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">the_rest</span><span class="p">)</span>
              <span class="n">auth_params</span> <span class="o">=</span> <span class="p">{}</span>
              <span class="k">while</span> <span class="n">match</span><span class="p">:</span>
                  <span class="k">if</span> <span class="n">match</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">())</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                      <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">the_rest</span><span class="p">)</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
                      <span class="n">auth_params</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">UNQUOTE_PAIRS</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&#39;\1&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="c"># &#39;\\&#39;.join([x.replace(&#39;\\&#39;, &#39;&#39;) for x in value.split(&#39;\\\\&#39;)])</span>
                  <span class="n">match</span> <span class="o">=</span> <span class="n">www_auth</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">the_rest</span><span class="p">)</span>
              <span class="n">retval</span><span class="p">[</span><span class="n">auth_scheme</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">auth_params</span>
              <span class="n">authenticate</span> <span class="o">=</span> <span class="n">the_rest</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
          <span class="k">raise</span> <span class="n">MalformedHeader</span><span class="p">(</span><span class="s">&quot;WWW-Authenticate&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">retval</span>


<span class="k">def</span> <span class="nf">_entry_disposition</span><span class="p">(</span><span class="n">response_headers</span><span class="p">,</span> <span class="n">request_headers</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Determine freshness from the Date, Expires and Cache-Control headers.</span>

<span class="sd">    We don&#39;t handle the following:</span>

<span class="sd">    1. Cache-Control: max-stale</span>
<span class="sd">    2. Age: headers are not used in the calculations.</span>

<span class="sd">    Not that this algorithm is simpler than you might think</span>
<span class="sd">    because we are operating as a private (non-shared) cache.</span>
<span class="sd">    This lets us ignore &#39;s-maxage&#39;. We can also ignore</span>
<span class="sd">    &#39;proxy-invalidate&#39; since we aren&#39;t a proxy.</span>
<span class="sd">    We will never return a stale document as</span>
<span class="sd">    fresh as a design decision, and thus the non-implementation</span>
<span class="sd">    of &#39;max-stale&#39;. This also lets us safely ignore &#39;must-revalidate&#39;</span>
<span class="sd">    since we operate as if every server has sent &#39;must-revalidate&#39;.</span>
<span class="sd">    Since we are private we get to ignore both &#39;public&#39; and</span>
<span class="sd">    &#39;private&#39; parameters. We also ignore &#39;no-transform&#39; since</span>
<span class="sd">    we don&#39;t do any transformations.</span>
<span class="sd">    The &#39;no-store&#39; parameter is handled at a higher level.</span>
<span class="sd">    So the only Cache-Control parameters we look at are:</span>

<span class="sd">    no-cache</span>
<span class="sd">    only-if-cached</span>
<span class="sd">    max-age</span>
<span class="sd">    min-fresh</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">retval</span> <span class="o">=</span> <span class="s">&quot;STALE&quot;</span>
    <span class="n">cc</span> <span class="o">=</span> <span class="n">_parse_cache_control</span><span class="p">(</span><span class="n">request_headers</span><span class="p">)</span>
    <span class="n">cc_response</span> <span class="o">=</span> <span class="n">_parse_cache_control</span><span class="p">(</span><span class="n">response_headers</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request_headers</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;pragma&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">request_headers</span><span class="p">[</span><span class="s">&#39;pragma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;no-cache&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="s">&quot;TRANSPARENT&quot;</span>
        <span class="k">if</span> <span class="s">&#39;cache-control&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request_headers</span><span class="p">:</span>
            <span class="n">request_headers</span><span class="p">[</span><span class="s">&#39;cache-control&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;no-cache&#39;</span>
    <span class="k">elif</span> <span class="n">cc</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;no-cache&#39;</span><span class="p">):</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="s">&quot;TRANSPARENT&quot;</span>
    <span class="k">elif</span> <span class="n">cc_response</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;no-cache&#39;</span><span class="p">):</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="s">&quot;STALE&quot;</span>
    <span class="k">elif</span> <span class="n">cc</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;only-if-cached&#39;</span><span class="p">):</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="s">&quot;FRESH&quot;</span>
    <span class="k">elif</span> <span class="n">response_headers</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;date&#39;</span><span class="p">):</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">timegm</span><span class="p">(</span><span class="n">email</span><span class="o">.</span><span class="n">Utils</span><span class="o">.</span><span class="n">parsedate_tz</span><span class="p">(</span><span class="n">response_headers</span><span class="p">[</span><span class="s">&#39;date&#39;</span><span class="p">]))</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">current_age</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">now</span> <span class="o">-</span> <span class="n">date</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cc_response</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;max-age&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">freshness_lifetime</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cc_response</span><span class="p">[</span><span class="s">&#39;max-age&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">freshness_lifetime</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">response_headers</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;expires&#39;</span><span class="p">):</span>
            <span class="n">expires</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">Utils</span><span class="o">.</span><span class="n">parsedate_tz</span><span class="p">(</span><span class="n">response_headers</span><span class="p">[</span><span class="s">&#39;expires&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">None</span> <span class="o">==</span> <span class="n">expires</span><span class="p">:</span>
                <span class="n">freshness_lifetime</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">freshness_lifetime</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">calendar</span><span class="o">.</span><span class="n">timegm</span><span class="p">(</span><span class="n">expires</span><span class="p">)</span> <span class="o">-</span> <span class="n">date</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">freshness_lifetime</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">cc</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;max-age&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">freshness_lifetime</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cc</span><span class="p">[</span><span class="s">&#39;max-age&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">freshness_lifetime</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">cc</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;min-fresh&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">min_fresh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cc</span><span class="p">[</span><span class="s">&#39;min-fresh&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">min_fresh</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">current_age</span> <span class="o">+=</span> <span class="n">min_fresh</span>
        <span class="k">if</span> <span class="n">freshness_lifetime</span> <span class="o">&gt;</span> <span class="n">current_age</span><span class="p">:</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="s">&quot;FRESH&quot;</span>
    <span class="k">return</span> <span class="n">retval</span>

<span class="k">def</span> <span class="nf">_decompressContent</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">new_content</span><span class="p">):</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">new_content</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">encoding</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;content-encoding&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">encoding</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;gzip&#39;</span><span class="p">,</span> <span class="s">&#39;deflate&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">encoding</span> <span class="o">==</span> <span class="s">&#39;gzip&#39;</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">fileobj</span><span class="o">=</span><span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">new_content</span><span class="p">))</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">encoding</span> <span class="o">==</span> <span class="s">&#39;deflate&#39;</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="n">response</span><span class="p">[</span><span class="s">&#39;content-length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>
            <span class="c"># Record the historical presence of the encoding in a way the won&#39;t interfere.</span>
            <span class="n">response</span><span class="p">[</span><span class="s">&#39;-content-encoding&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;content-encoding&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;content-encoding&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">FailedToDecompressContent</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Content purported to be compressed with </span><span class="si">%s</span><span class="s"> but failed to decompress.&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;content-encoding&#39;</span><span class="p">),</span> <span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">content</span>

<span class="k">def</span> <span class="nf">_updateCache</span><span class="p">(</span><span class="n">request_headers</span><span class="p">,</span> <span class="n">response_headers</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">cachekey</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">cachekey</span><span class="p">:</span>
        <span class="n">cc</span> <span class="o">=</span> <span class="n">_parse_cache_control</span><span class="p">(</span><span class="n">request_headers</span><span class="p">)</span>
        <span class="n">cc_response</span> <span class="o">=</span> <span class="n">_parse_cache_control</span><span class="p">(</span><span class="n">response_headers</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cc</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;no-store&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">cc_response</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;no-store&#39;</span><span class="p">):</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">cachekey</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">Message</span><span class="o">.</span><span class="n">Message</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">response_headers</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">,</span><span class="s">&#39;content-encoding&#39;</span><span class="p">,</span><span class="s">&#39;transfer-encoding&#39;</span><span class="p">]:</span>
                    <span class="n">info</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="c"># Add annotations to the cache to indicate what headers</span>
            <span class="c"># are variant for this request.</span>
            <span class="n">vary</span> <span class="o">=</span> <span class="n">response_headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;vary&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">vary</span><span class="p">:</span>
                <span class="n">vary_headers</span> <span class="o">=</span> <span class="n">vary</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">vary_headers</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;-varied-</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">header</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">info</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">request_headers</span><span class="p">[</span><span class="n">header</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">pass</span>

            <span class="n">status</span> <span class="o">=</span> <span class="n">response_headers</span><span class="o">.</span><span class="n">status</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">304</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mi">200</span>

            <span class="n">status_header</span> <span class="o">=</span> <span class="s">&#39;status: </span><span class="si">%d</span><span class="se">\r\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">status</span>

            <span class="n">header_str</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">as_string</span><span class="p">()</span>

            <span class="n">header_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r</span><span class="s">(?!</span><span class="se">\n</span><span class="s">)|(?&lt;!</span><span class="se">\r</span><span class="s">)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">header_str</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">status_header</span><span class="p">,</span> <span class="n">header_str</span><span class="p">,</span> <span class="n">content</span><span class="p">])</span>

            <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cachekey</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_cnonce</span><span class="p">():</span>
    <span class="n">dig</span> <span class="o">=</span> <span class="n">_md5</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">(),</span> <span class="p">[</span><span class="s">&quot;0123456789&quot;</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)]))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">dig</span><span class="p">[:</span><span class="mi">16</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">_wsse_username_token</span><span class="p">(</span><span class="n">cnonce</span><span class="p">,</span> <span class="n">iso_now</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">_sha</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s%s%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cnonce</span><span class="p">,</span> <span class="n">iso_now</span><span class="p">,</span> <span class="n">password</span><span class="p">))</span><span class="o">.</span><span class="n">digest</span><span class="p">())</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>


<span class="c"># For credentials we need two things, first</span>
<span class="c"># a pool of credential to try (not necesarily tied to BAsic, Digest, etc.)</span>
<span class="c"># Then we also need a list of URIs that have already demanded authentication</span>
<span class="c"># That list is tricky since sub-URIs can take the same auth, or the</span>
<span class="c"># auth scheme may change as you descend the tree.</span>
<span class="c"># So we also need each Auth instance to be able to tell us</span>
<span class="c"># how close to the &#39;top&#39; it is.</span>

<span class="k">class</span> <span class="nc">Authentication</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">credentials</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">http</span><span class="p">):</span>
        <span class="p">(</span><span class="n">scheme</span><span class="p">,</span> <span class="n">authority</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">fragment</span><span class="p">)</span> <span class="o">=</span> <span class="n">parse_uri</span><span class="p">(</span><span class="n">request_uri</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">credentials</span> <span class="o">=</span> <span class="n">credentials</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">http</span> <span class="o">=</span> <span class="n">http</span>

    <span class="k">def</span> <span class="nf">depth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">):</span>
        <span class="p">(</span><span class="n">scheme</span><span class="p">,</span> <span class="n">authority</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">fragment</span><span class="p">)</span> <span class="o">=</span> <span class="n">parse_uri</span><span class="p">(</span><span class="n">request_uri</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">request_uri</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">):]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">inscope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">):</span>
        <span class="c"># XXX Should we normalize the request_uri?</span>
        <span class="p">(</span><span class="n">scheme</span><span class="p">,</span> <span class="n">authority</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">fragment</span><span class="p">)</span> <span class="o">=</span> <span class="n">parse_uri</span><span class="p">(</span><span class="n">request_uri</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">host</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">)</span> <span class="ow">and</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Modify the request headers to add the appropriate</span>
<span class="sd">        Authorization header. Over-rise this in sub-classes.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gives us a chance to update with new nonces</span>
<span class="sd">        or such returned from the last authorized response.</span>
<span class="sd">        Over-rise this in sub-classes if necessary.</span>

<span class="sd">        Return TRUE is the request is to be retried, for</span>
<span class="sd">        example Digest may return stale=true.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">False</span>



<span class="k">class</span> <span class="nc">BasicAuthentication</span><span class="p">(</span><span class="n">Authentication</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">credentials</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">http</span><span class="p">):</span>
        <span class="n">Authentication</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">credentials</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">http</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Modify the request headers to add the appropriate</span>
<span class="sd">        Authorization header.&quot;&quot;&quot;</span>
        <span class="n">headers</span><span class="p">[</span><span class="s">&#39;authorization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Basic &#39;</span> <span class="o">+</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">credentials</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">DigestAuthentication</span><span class="p">(</span><span class="n">Authentication</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Only do qop=&#39;auth&#39; and MD5, since that</span>
<span class="sd">    is all Apache currently implements&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">credentials</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">http</span><span class="p">):</span>
        <span class="n">Authentication</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">credentials</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">http</span><span class="p">)</span>
        <span class="n">challenge</span> <span class="o">=</span> <span class="n">_parse_www_authenticate</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s">&#39;www-authenticate&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span> <span class="o">=</span> <span class="n">challenge</span><span class="p">[</span><span class="s">&#39;digest&#39;</span><span class="p">]</span>
        <span class="n">qop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;qop&#39;</span><span class="p">,</span> <span class="s">&#39;auth&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;qop&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;auth&#39;</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">qop</span><span class="o">.</span><span class="n">split</span><span class="p">()])</span> <span class="ow">and</span> <span class="s">&#39;auth&#39;</span> <span class="ow">or</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;qop&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UnimplementedDigestAuthOptionError</span><span class="p">(</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;Unsupported value for qop: </span><span class="si">%s</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="n">qop</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;algorithm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;algorithm&#39;</span><span class="p">,</span> <span class="s">&#39;MD5&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;algorithm&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;MD5&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UnimplementedDigestAuthOptionError</span><span class="p">(</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;Unsupported value for algorithm: </span><span class="si">%s</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;algorithm&#39;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A1</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">credentials</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;realm&#39;</span><span class="p">],</span> <span class="s">&quot;:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">credentials</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;nc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">cnonce</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Modify the request headers&quot;&quot;&quot;</span>
        <span class="n">H</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">_md5</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="n">KD</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="n">H</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>
        <span class="n">A2</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">method</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;cnonce&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cnonce</span> <span class="ow">or</span> <span class="n">_cnonce</span><span class="p">()</span>
        <span class="n">request_digest</span>  <span class="o">=</span> <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">KD</span><span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A1</span><span class="p">),</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;nonce&#39;</span><span class="p">],</span>
                    <span class="s">&#39;</span><span class="si">%08x</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;nc&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;cnonce&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;qop&#39;</span><span class="p">],</span> <span class="n">H</span><span class="p">(</span><span class="n">A2</span><span class="p">)</span>
                    <span class="p">))</span>
        <span class="n">headers</span><span class="p">[</span><span class="s">&#39;authorization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Digest username=&quot;</span><span class="si">%s</span><span class="s">&quot;, realm=&quot;</span><span class="si">%s</span><span class="s">&quot;, nonce=&quot;</span><span class="si">%s</span><span class="s">&quot;, uri=&quot;</span><span class="si">%s</span><span class="s">&quot;, algorithm=</span><span class="si">%s</span><span class="s">, response=</span><span class="si">%s</span><span class="s">, qop=</span><span class="si">%s</span><span class="s">, nc=</span><span class="si">%08x</span><span class="s">, cnonce=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">credentials</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;realm&#39;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;nonce&#39;</span><span class="p">],</span>
                <span class="n">request_uri</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;algorithm&#39;</span><span class="p">],</span>
                <span class="n">request_digest</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;qop&#39;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;nc&#39;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;cnonce&#39;</span><span class="p">],</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;opaque&#39;</span><span class="p">):</span>
            <span class="n">headers</span><span class="p">[</span><span class="s">&#39;authorization&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s">&#39;, opaque=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;opaque&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;nc&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;authentication-info&#39;</span><span class="p">):</span>
            <span class="n">challenge</span> <span class="o">=</span> <span class="n">_parse_www_authenticate</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s">&#39;www-authenticate&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;digest&#39;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="s">&#39;true&#39;</span> <span class="o">==</span> <span class="n">challenge</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;stale&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;nonce&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">challenge</span><span class="p">[</span><span class="s">&#39;nonce&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;nc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">updated_challenge</span> <span class="o">=</span> <span class="n">_parse_www_authenticate</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s">&#39;authentication-info&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;digest&#39;</span><span class="p">,</span> <span class="p">{})</span>

            <span class="k">if</span> <span class="n">updated_challenge</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;nextnonce&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;nonce&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">updated_challenge</span><span class="p">[</span><span class="s">&#39;nextnonce&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;nc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">False</span>


<span class="k">class</span> <span class="nc">HmacDigestAuthentication</span><span class="p">(</span><span class="n">Authentication</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adapted from Robert Sayre&#39;s code and DigestAuthentication above.&quot;&quot;&quot;</span>
    <span class="n">__author__</span> <span class="o">=</span> <span class="s">&quot;Thomas Broyer (t.broyer@ltgt.net)&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">credentials</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">http</span><span class="p">):</span>
        <span class="n">Authentication</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">credentials</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">http</span><span class="p">)</span>
        <span class="n">challenge</span> <span class="o">=</span> <span class="n">_parse_www_authenticate</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s">&#39;www-authenticate&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span> <span class="o">=</span> <span class="n">challenge</span><span class="p">[</span><span class="s">&#39;hmacdigest&#39;</span><span class="p">]</span>
        <span class="c"># TODO: self.challenge[&#39;domain&#39;]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;reason&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;reason&#39;</span><span class="p">,</span> <span class="s">&#39;unauthorized&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;reason&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;unauthorized&#39;</span><span class="p">,</span> <span class="s">&#39;integrity&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;reason&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;unauthorized&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;salt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;salt&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;snonce&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">UnimplementedHmacDigestAuthOptionError</span><span class="p">(</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;The challenge doesn&#39;t contain a server nonce, or this one is empty.&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;algorithm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;algorithm&#39;</span><span class="p">,</span> <span class="s">&#39;HMAC-SHA-1&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;algorithm&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;HMAC-SHA-1&#39;</span><span class="p">,</span> <span class="s">&#39;HMAC-MD5&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">UnimplementedHmacDigestAuthOptionError</span><span class="p">(</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;Unsupported value for algorithm: </span><span class="si">%s</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;algorithm&#39;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;pw-algorithm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;pw-algorithm&#39;</span><span class="p">,</span> <span class="s">&#39;SHA-1&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;pw-algorithm&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;SHA-1&#39;</span><span class="p">,</span> <span class="s">&#39;MD5&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">UnimplementedHmacDigestAuthOptionError</span><span class="p">(</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;Unsupported value for pw-algorithm: </span><span class="si">%s</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;pw-algorithm&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;algorithm&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;HMAC-MD5&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hashmod</span> <span class="o">=</span> <span class="n">_md5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hashmod</span> <span class="o">=</span> <span class="n">_sha</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;pw-algorithm&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;MD5&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pwhashmod</span> <span class="o">=</span> <span class="n">_md5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pwhashmod</span> <span class="o">=</span> <span class="n">_sha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">credentials</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;:&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pwhashmod</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">credentials</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;salt&#39;</span><span class="p">]]))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                    <span class="s">&quot;:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;realm&#39;</span><span class="p">]</span>
                    <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pwhashmod</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Modify the request headers&quot;&quot;&quot;</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">_get_end2end_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">keylist</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> &quot;</span> <span class="o">%</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">])</span>
        <span class="n">headers_val</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">headers</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">])</span>
        <span class="n">created</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">T%H:%M:%SZ&#39;</span><span class="p">,</span><span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">())</span>
        <span class="n">cnonce</span> <span class="o">=</span> <span class="n">_cnonce</span><span class="p">()</span>
        <span class="n">request_digest</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">cnonce</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;snonce&#39;</span><span class="p">],</span> <span class="n">headers_val</span><span class="p">)</span>
        <span class="n">request_digest</span>  <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">request_digest</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hashmod</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">headers</span><span class="p">[</span><span class="s">&#39;authorization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;HMACDigest username=&quot;</span><span class="si">%s</span><span class="s">&quot;, realm=&quot;</span><span class="si">%s</span><span class="s">&quot;, snonce=&quot;</span><span class="si">%s</span><span class="s">&quot;, cnonce=&quot;</span><span class="si">%s</span><span class="s">&quot;, uri=&quot;</span><span class="si">%s</span><span class="s">&quot;, created=&quot;</span><span class="si">%s</span><span class="s">&quot;, response=&quot;</span><span class="si">%s</span><span class="s">&quot;, headers=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">credentials</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;realm&#39;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">challenge</span><span class="p">[</span><span class="s">&#39;snonce&#39;</span><span class="p">],</span>
                <span class="n">cnonce</span><span class="p">,</span>
                <span class="n">request_uri</span><span class="p">,</span>
                <span class="n">created</span><span class="p">,</span>
                <span class="n">request_digest</span><span class="p">,</span>
                <span class="n">keylist</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="n">challenge</span> <span class="o">=</span> <span class="n">_parse_www_authenticate</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s">&#39;www-authenticate&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;hmacdigest&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">challenge</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;reason&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;integrity&#39;</span><span class="p">,</span> <span class="s">&#39;stale&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>


<span class="k">class</span> <span class="nc">WsseAuthentication</span><span class="p">(</span><span class="n">Authentication</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This is thinly tested and should not be relied upon.</span>
<span class="sd">    At this time there isn&#39;t any third party server to test against.</span>
<span class="sd">    Blogger and TypePad implemented this algorithm at one point</span>
<span class="sd">    but Blogger has since switched to Basic over HTTPS and</span>
<span class="sd">    TypePad has implemented it wrong, by never issuing a 401</span>
<span class="sd">    challenge but instead requiring your client to telepathically know that</span>
<span class="sd">    their endpoint is expecting WSSE profile=&quot;UsernameToken&quot;.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">credentials</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">http</span><span class="p">):</span>
        <span class="n">Authentication</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">credentials</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">http</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Modify the request headers to add the appropriate</span>
<span class="sd">        Authorization header.&quot;&quot;&quot;</span>
        <span class="n">headers</span><span class="p">[</span><span class="s">&#39;authorization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;WSSE profile=&quot;UsernameToken&quot;&#39;</span>
        <span class="n">iso_now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s">T%H:%M:%SZ&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">())</span>
        <span class="n">cnonce</span> <span class="o">=</span> <span class="n">_cnonce</span><span class="p">()</span>
        <span class="n">password_digest</span> <span class="o">=</span> <span class="n">_wsse_username_token</span><span class="p">(</span><span class="n">cnonce</span><span class="p">,</span> <span class="n">iso_now</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">credentials</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">headers</span><span class="p">[</span><span class="s">&#39;X-WSSE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;UsernameToken Username=&quot;</span><span class="si">%s</span><span class="s">&quot;, PasswordDigest=&quot;</span><span class="si">%s</span><span class="s">&quot;, Nonce=&quot;</span><span class="si">%s</span><span class="s">&quot;, Created=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">credentials</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">password_digest</span><span class="p">,</span>
                <span class="n">cnonce</span><span class="p">,</span>
                <span class="n">iso_now</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">GoogleLoginAuthentication</span><span class="p">(</span><span class="n">Authentication</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">credentials</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">http</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">urlencode</span>
        <span class="n">Authentication</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">credentials</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">http</span><span class="p">)</span>
        <span class="n">challenge</span> <span class="o">=</span> <span class="n">_parse_www_authenticate</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s">&#39;www-authenticate&#39;</span><span class="p">)</span>
        <span class="n">service</span> <span class="o">=</span> <span class="n">challenge</span><span class="p">[</span><span class="s">&#39;googlelogin&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;service&#39;</span><span class="p">,</span> <span class="s">&#39;xapi&#39;</span><span class="p">)</span>
        <span class="c"># Bloggger actually returns the service in the challenge</span>
        <span class="c"># For the rest we guess based on the URI</span>
        <span class="k">if</span> <span class="n">service</span> <span class="o">==</span> <span class="s">&#39;xapi&#39;</span> <span class="ow">and</span>  <span class="n">request_uri</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;calendar&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">service</span> <span class="o">=</span> <span class="s">&quot;cl&quot;</span>
        <span class="c"># No point in guessing Base or Spreadsheet</span>
        <span class="c">#elif request_uri.find(&quot;spreadsheets&quot;) &gt; 0:</span>
        <span class="c">#    service = &quot;wise&quot;</span>

        <span class="n">auth</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">Email</span><span class="o">=</span><span class="n">credentials</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Passwd</span><span class="o">=</span><span class="n">credentials</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">service</span><span class="o">=</span><span class="n">service</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;user-agent&#39;</span><span class="p">])</span>
        <span class="n">resp</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s">&quot;https://www.google.com/accounts/ClientLogin&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">&quot;POST&quot;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">urlencode</span><span class="p">(</span><span class="n">auth</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s">&#39;application/x-www-form-urlencoded&#39;</span><span class="p">})</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([</span><span class="nb">tuple</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">line</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">403</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Auth</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Auth</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;Auth&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Modify the request headers to add the appropriate</span>
<span class="sd">        Authorization header.&quot;&quot;&quot;</span>
        <span class="n">headers</span><span class="p">[</span><span class="s">&#39;authorization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;GoogleLogin Auth=&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Auth</span>


<span class="n">AUTH_SCHEME_CLASSES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&quot;basic&quot;</span><span class="p">:</span> <span class="n">BasicAuthentication</span><span class="p">,</span>
    <span class="s">&quot;wsse&quot;</span><span class="p">:</span> <span class="n">WsseAuthentication</span><span class="p">,</span>
    <span class="s">&quot;digest&quot;</span><span class="p">:</span> <span class="n">DigestAuthentication</span><span class="p">,</span>
    <span class="s">&quot;hmacdigest&quot;</span><span class="p">:</span> <span class="n">HmacDigestAuthentication</span><span class="p">,</span>
    <span class="s">&quot;googlelogin&quot;</span><span class="p">:</span> <span class="n">GoogleLoginAuthentication</span>
<span class="p">}</span>

<span class="n">AUTH_SCHEME_ORDER</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;hmacdigest&quot;</span><span class="p">,</span> <span class="s">&quot;googlelogin&quot;</span><span class="p">,</span> <span class="s">&quot;digest&quot;</span><span class="p">,</span> <span class="s">&quot;wsse&quot;</span><span class="p">,</span> <span class="s">&quot;basic&quot;</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">FileCache</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Uses a local directory as a store for cached files.</span>
<span class="sd">    Not really safe to use if multiple threads or processes are going to</span>
<span class="sd">    be running on the same cache.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="n">safename</span><span class="p">):</span> <span class="c"># use safe=lambda x: md5.new(x).hexdigest() for the old behavior</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">safe</span> <span class="o">=</span> <span class="n">safe</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cache</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">cacheFullPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">safe</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">cacheFullPath</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">retval</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">cacheFullPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">safe</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">cacheFullPath</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">cacheFullPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">safe</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cacheFullPath</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">cacheFullPath</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Credentials</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">credentials</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">credentials</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">domain</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">name</span><span class="p">,</span> <span class="n">password</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">credentials</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">iter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">):</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">cdomain</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">credentials</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cdomain</span> <span class="o">==</span> <span class="s">&quot;&quot;</span> <span class="ow">or</span> <span class="n">domain</span> <span class="o">==</span> <span class="n">cdomain</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">KeyCerts</span><span class="p">(</span><span class="n">Credentials</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Identical to Credentials except that</span>
<span class="sd">    name/password are mapped to key/cert.&quot;&quot;&quot;</span>
    <span class="k">pass</span>


<div class="viewcode-block" id="ProxyInfo"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.http_client.httplib2.html#JumpScale.baselib.http_client.httplib2.ProxyInfo">[docs]</a><span class="k">class</span> <span class="nc">ProxyInfo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Collect information required to use a proxy.&quot;&quot;&quot;</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy_type</span><span class="p">,</span> <span class="n">proxy_host</span><span class="p">,</span> <span class="n">proxy_port</span><span class="p">,</span> <span class="n">proxy_rdns</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">proxy_user</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">proxy_pass</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;The parameter proxy_type must be set to one of socks.PROXY_TYPE_XXX</span>
<span class="sd">      constants. For example:</span>

<span class="sd">p = ProxyInfo(proxy_type=socks.PROXY_TYPE_HTTP, proxy_host=&#39;localhost&#39;, proxy_port=8000)</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">proxy_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_port</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_rdns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_pass</span> <span class="o">=</span> <span class="n">proxy_type</span><span class="p">,</span> <span class="n">proxy_host</span><span class="p">,</span> <span class="n">proxy_port</span><span class="p">,</span> <span class="n">proxy_rdns</span><span class="p">,</span> <span class="n">proxy_user</span><span class="p">,</span> <span class="n">proxy_pass</span>

<div class="viewcode-block" id="ProxyInfo.astuple"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.http_client.httplib2.html#JumpScale.baselib.http_client.httplib2.ProxyInfo.astuple">[docs]</a>  <span class="k">def</span> <span class="nf">astuple</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proxy_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_port</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_rdns</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proxy_user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_pass</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProxyInfo.isgood"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.http_client.httplib2.html#JumpScale.baselib.http_client.httplib2.ProxyInfo.isgood">[docs]</a>  <span class="k">def</span> <span class="nf">isgood</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proxy_host</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proxy_port</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">)</span>

</div></div>
<span class="k">class</span> <span class="nc">HTTPConnectionWithTimeout</span><span class="p">(</span><span class="n">httplib</span><span class="o">.</span><span class="n">HTTPConnection</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    HTTPConnection subclass that supports timeouts</span>

<span class="sd">    All timeouts are in seconds. If None is passed for timeout then</span>
<span class="sd">    Python&#39;s default timeout for sockets will be used. See for example</span>
<span class="sd">    the docs of socket.setdefaulttimeout():</span>
<span class="sd">    http://docs.python.org/library/socket.html#socket.setdefaulttimeout</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">proxy_info</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPConnection</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">strict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proxy_info</span> <span class="o">=</span> <span class="n">proxy_info</span>

    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Connect to the host and port specified in __init__.&quot;&quot;&quot;</span>
        <span class="c"># Mostly verbatim from httplib.py.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_info</span> <span class="ow">and</span> <span class="n">socks</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ProxiesUnavailableError</span><span class="p">(</span>
                <span class="s">&#39;Proxy support missing but proxy use was requested!&#39;</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;getaddrinfo returns an empty list&quot;</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">):</span>
            <span class="n">af</span><span class="p">,</span> <span class="n">socktype</span><span class="p">,</span> <span class="n">proto</span><span class="p">,</span> <span class="n">canonname</span><span class="p">,</span> <span class="n">sa</span> <span class="o">=</span> <span class="n">res</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_info</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_info</span><span class="o">.</span><span class="n">isgood</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">socks</span><span class="o">.</span><span class="n">socksocket</span><span class="p">(</span><span class="n">af</span><span class="p">,</span> <span class="n">socktype</span><span class="p">,</span> <span class="n">proto</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">setproxy</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">proxy_info</span><span class="o">.</span><span class="n">astuple</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">af</span><span class="p">,</span> <span class="n">socktype</span><span class="p">,</span> <span class="n">proto</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">TCP_NODELAY</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="c"># Different from httplib: support timeouts.</span>
                <span class="k">if</span> <span class="n">has_timeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
                    <span class="c"># End of difference from httplib.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debuglevel</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;connect: (</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">sa</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debuglevel</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&#39;connect fail:&#39;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">continue</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="n">msg</span>

<span class="k">class</span> <span class="nc">HTTPSConnectionWithTimeout</span><span class="p">(</span><span class="n">httplib</span><span class="o">.</span><span class="n">HTTPSConnection</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class allows communication via SSL.</span>

<span class="sd">    All timeouts are in seconds. If None is passed for timeout then</span>
<span class="sd">    Python&#39;s default timeout for sockets will be used. See for example</span>
<span class="sd">    the docs of socket.setdefaulttimeout():</span>
<span class="sd">    http://docs.python.org/library/socket.html#socket.setdefaulttimeout</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">key_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cert_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">strict</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">proxy_info</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">ca_certs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">disable_ssl_certificate_validation</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPSConnection</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> <span class="n">key_file</span><span class="o">=</span><span class="n">key_file</span><span class="p">,</span>
                <span class="n">cert_file</span><span class="o">=</span><span class="n">cert_file</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="n">strict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proxy_info</span> <span class="o">=</span> <span class="n">proxy_info</span>
        <span class="k">if</span> <span class="n">ca_certs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">ca_certs</span> <span class="o">=</span> <span class="n">CA_CERTS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ca_certs</span> <span class="o">=</span> <span class="n">ca_certs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disable_ssl_certificate_validation</span> <span class="o">=</span> \
                <span class="n">disable_ssl_certificate_validation</span>

    <span class="c"># The following two methods were adapted from https_wrapper.py, released</span>
    <span class="c"># with the Google Appengine SDK at</span>
    <span class="c"># http://googleappengine.googlecode.com/svn-history/r136/trunk/python/google/appengine/tools/https_wrapper.py</span>
    <span class="c"># under the following license:</span>
    <span class="c">#</span>
    <span class="c"># Copyright 2007 Google Inc.</span>
    <span class="c">#</span>
    <span class="c"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
    <span class="c"># you may not use this file except in compliance with the License.</span>
    <span class="c"># You may obtain a copy of the License at</span>
    <span class="c">#</span>
    <span class="c">#     http://www.apache.org/licenses/LICENSE-2.0</span>
    <span class="c">#</span>
    <span class="c"># Unless required by applicable law or agreed to in writing, software</span>
    <span class="c"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
    <span class="c"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
    <span class="c"># See the License for the specific language governing permissions and</span>
    <span class="c"># limitations under the License.</span>
    <span class="c">#</span>

    <span class="k">def</span> <span class="nf">_GetValidHostsForCert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cert</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of valid host globs for an SSL certificate.</span>

<span class="sd">        Args:</span>
<span class="sd">          cert: A dictionary representing an SSL certificate.</span>
<span class="sd">        Returns:</span>
<span class="sd">          list: A list of valid host globs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s">&#39;subjectAltName&#39;</span> <span class="ow">in</span> <span class="n">cert</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cert</span><span class="p">[</span><span class="s">&#39;subjectAltName&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;dns&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cert</span><span class="p">[</span><span class="s">&#39;subject&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;commonname&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_ValidateCertificateHostname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cert</span><span class="p">,</span> <span class="n">hostname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validates that a given hostname is valid for an SSL certificate.</span>

<span class="sd">        Args:</span>
<span class="sd">          cert: A dictionary representing an SSL certificate.</span>
<span class="sd">          hostname: The hostname to test.</span>
<span class="sd">        Returns:</span>
<span class="sd">          bool: Whether or not the hostname is valid for this certificate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hosts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetValidHostsForCert</span><span class="p">(</span><span class="n">cert</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="n">hosts</span><span class="p">:</span>
            <span class="n">host_re</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="s">&#39;\.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="p">,</span> <span class="s">&#39;[^.]*&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;^</span><span class="si">%s</span><span class="s">$&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">host_re</span><span class="p">,),</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Connect to a host on a given (SSL) port.&quot;</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;getaddrinfo returns an empty list&quot;</span>
        <span class="k">for</span> <span class="n">family</span><span class="p">,</span> <span class="n">socktype</span><span class="p">,</span> <span class="n">proto</span><span class="p">,</span> <span class="n">canonname</span><span class="p">,</span> <span class="n">sockaddr</span> <span class="ow">in</span> <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_info</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_info</span><span class="o">.</span><span class="n">isgood</span><span class="p">():</span>
                    <span class="n">sock</span> <span class="o">=</span> <span class="n">socks</span><span class="o">.</span><span class="n">socksocket</span><span class="p">(</span><span class="n">family</span><span class="p">,</span> <span class="n">socktype</span><span class="p">,</span> <span class="n">proto</span><span class="p">)</span>
                    <span class="n">sock</span><span class="o">.</span><span class="n">setproxy</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">proxy_info</span><span class="o">.</span><span class="n">astuple</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">family</span><span class="p">,</span> <span class="n">socktype</span><span class="p">,</span> <span class="n">proto</span><span class="p">)</span>
                    <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">TCP_NODELAY</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">has_timeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">):</span>
                    <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span><span class="n">_ssl_wrap_socket</span><span class="p">(</span>
                    <span class="n">sock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cert_file</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">disable_ssl_certificate_validation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ca_certs</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debuglevel</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;connect: (</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_ssl_certificate_validation</span><span class="p">:</span>
                    <span class="n">cert</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">getpeercert</span><span class="p">()</span>
                    <span class="n">hostname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ValidateCertificateHostname</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="n">hostname</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">CertificateHostnameMismatch</span><span class="p">(</span>
                            <span class="s">&#39;Server presented certificate that does not match &#39;</span>
                            <span class="s">&#39;host </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">cert</span><span class="p">),</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">cert</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ssl_SSLError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sock</span><span class="p">:</span>
                    <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="c"># Unfortunately the ssl module doesn&#39;t seem to provide any way</span>
                <span class="c"># to get at more detailed error information, in particular</span>
                <span class="c"># whether the error is due to certificate validation or</span>
                <span class="c"># something else (such as SSL protocol mismatch).</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSL_ERROR_SSL</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">SSLHandshakeError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">gaierror</span><span class="p">):</span>
              <span class="k">raise</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span>
              <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debuglevel</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                  <span class="k">print</span> <span class="s">&#39;connect fail:&#39;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
              <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="bp">None</span>
              <span class="k">continue</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="p">:</span>
          <span class="k">raise</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="n">msg</span>

<span class="n">SCHEME_TO_CONNECTION</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;http&#39;</span><span class="p">:</span> <span class="n">HTTPConnectionWithTimeout</span><span class="p">,</span>
    <span class="s">&#39;https&#39;</span><span class="p">:</span> <span class="n">HTTPSConnectionWithTimeout</span>
    <span class="p">}</span>

<span class="c"># Use a different connection object for Google App Engine</span>
<span class="k">try</span><span class="p">:</span>
  <span class="kn">from</span> <span class="nn">google.appengine.api</span> <span class="kn">import</span> <span class="n">apiproxy_stub_map</span>
  <span class="k">if</span> <span class="n">apiproxy_stub_map</span><span class="o">.</span><span class="n">apiproxy</span><span class="o">.</span><span class="n">GetStub</span><span class="p">(</span><span class="s">&#39;urlfetch&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ImportError</span>  <span class="c"># Bail out; we&#39;re not actually running on App Engine.</span>
  <span class="kn">from</span> <span class="nn">google.appengine.api.urlfetch</span> <span class="kn">import</span> <span class="n">fetch</span>
  <span class="kn">from</span> <span class="nn">google.appengine.api.urlfetch</span> <span class="kn">import</span> <span class="n">InvalidURLError</span>
  <span class="kn">from</span> <span class="nn">google.appengine.api.urlfetch</span> <span class="kn">import</span> <span class="n">DownloadError</span>
  <span class="kn">from</span> <span class="nn">google.appengine.api.urlfetch</span> <span class="kn">import</span> <span class="n">ResponseTooLargeError</span>
  <span class="kn">from</span> <span class="nn">google.appengine.api.urlfetch</span> <span class="kn">import</span> <span class="n">SSLCertificateError</span>


  <span class="k">class</span> <span class="nc">ResponseDict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Is a dictionary that also has a read() method, so</span>
<span class="sd">    that it can pass itself off as an httlib.HTTPResponse().&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">pass</span>


  <span class="k">class</span> <span class="nc">AppEngineHttpConnection</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Emulates an httplib.HTTPConnection object, but actually uses the Google</span>
<span class="sd">    App Engine urlfetch library. This allows the timeout to be properly used on</span>
<span class="sd">    Google App Engine, and avoids using httplib, which on Google App Engine is</span>
<span class="sd">    just another wrapper around urlfetch.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">key_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cert_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">strict</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">proxy_info</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ca_certs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">disable_certificate_validation</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
      <span class="k">if</span> <span class="n">key_file</span> <span class="ow">or</span> <span class="n">cert_file</span> <span class="ow">or</span> <span class="n">proxy_info</span> <span class="ow">or</span> <span class="n">ca_certs</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NotSupportedOnThisPlatform</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">scheme</span> <span class="o">=</span> <span class="s">&#39;http&#39;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">validate_certificate</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">disable_certificate_validation</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">headers</span><span class="p">):</span>
      <span class="c"># Calculate the absolute URI, which fetch requires</span>
      <span class="n">netloc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">:</span>
        <span class="n">netloc</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
      <span class="n">absolute_uri</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">://</span><span class="si">%s%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme</span><span class="p">,</span> <span class="n">netloc</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">fetch</span><span class="p">(</span><span class="n">absolute_uri</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">allow_truncated</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">follow_redirects</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">deadline</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
            <span class="n">validate_certificate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">validate_certificate</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">ResponseDict</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

      <span class="c"># Make sure the exceptions raised match the exceptions expected.</span>
      <span class="k">except</span> <span class="n">InvalidURLError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">socket</span><span class="o">.</span><span class="n">gaierror</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
      <span class="k">except</span> <span class="p">(</span><span class="n">DownloadError</span><span class="p">,</span> <span class="n">ResponseTooLargeError</span><span class="p">,</span> <span class="n">SSLCertificateError</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPException</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">getresponse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPException</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set_debuglevel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
      <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">pass</span>


  <span class="k">class</span> <span class="nc">AppEngineHttpsConnection</span><span class="p">(</span><span class="n">AppEngineHttpConnection</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Same as AppEngineHttpConnection, but for HTTPS URIs.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">key_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cert_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">strict</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">proxy_info</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
      <span class="n">AppEngineHttpConnection</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">key_file</span><span class="p">,</span> <span class="n">cert_file</span><span class="p">,</span>
          <span class="n">strict</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">proxy_info</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">scheme</span> <span class="o">=</span> <span class="s">&#39;https&#39;</span>

  <span class="c"># Update the connection classes to use the Googel App Engine specific ones.</span>
  <span class="n">SCHEME_TO_CONNECTION</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s">&#39;http&#39;</span><span class="p">:</span> <span class="n">AppEngineHttpConnection</span><span class="p">,</span>
      <span class="s">&#39;https&#39;</span><span class="p">:</span> <span class="n">AppEngineHttpsConnection</span>
      <span class="p">}</span>

<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
  <span class="k">pass</span>


<div class="viewcode-block" id="Http"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.http_client.httplib2.html#JumpScale.baselib.http_client.httplib2.Http">[docs]</a><span class="k">class</span> <span class="nc">Http</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An HTTP client that handles:</span>
<span class="sd">- all methods</span>
<span class="sd">- caching</span>
<span class="sd">- ETags</span>
<span class="sd">- compression,</span>
<span class="sd">- HTTPS</span>
<span class="sd">- Basic</span>
<span class="sd">- Digest</span>
<span class="sd">- WSSE</span>

<span class="sd">and more.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">proxy_info</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">ca_certs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">disable_ssl_certificate_validation</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The value of proxy_info is a ProxyInfo instance.</span>

<span class="sd">        If &#39;cache&#39; is a string then it is used as a directory name for</span>
<span class="sd">        a disk cache. Otherwise it must be an object that supports the</span>
<span class="sd">        same interface as FileCache.</span>

<span class="sd">        All timeouts are in seconds. If None is passed for timeout</span>
<span class="sd">        then Python&#39;s default timeout for sockets will be used. See</span>
<span class="sd">        for example the docs of socket.setdefaulttimeout():</span>
<span class="sd">        http://docs.python.org/library/socket.html#socket.setdefaulttimeout</span>

<span class="sd">        ca_certs is the path of a file containing root CA certificates for SSL</span>
<span class="sd">        server certificate validation.  By default, a CA cert file bundled with</span>
<span class="sd">        httplib2 is used.</span>

<span class="sd">        If disable_ssl_certificate_validation is true, SSL cert validation will</span>
<span class="sd">        not be performed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proxy_info</span> <span class="o">=</span> <span class="n">proxy_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ca_certs</span> <span class="o">=</span> <span class="n">ca_certs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disable_ssl_certificate_validation</span> <span class="o">=</span> \
                <span class="n">disable_ssl_certificate_validation</span>

        <span class="c"># Map domain name to an httplib connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connections</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c"># The location of the cache, for now a directory</span>
        <span class="c"># where cached responses are held.</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">FileCache</span><span class="p">(</span><span class="n">cache</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">cache</span>

        <span class="c"># Name/password</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">credentials</span> <span class="o">=</span> <span class="n">Credentials</span><span class="p">()</span>

        <span class="c"># Key/cert</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">certificates</span> <span class="o">=</span> <span class="n">KeyCerts</span><span class="p">()</span>

        <span class="c"># authorization objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authorizations</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># If set to False then no redirects are followed, even safe ones.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">follow_redirects</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c"># Which HTTP methods do we apply optimistic concurrency to, i.e.</span>
        <span class="c"># which methods get an &quot;if-match:&quot; etag header added to them.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimistic_concurrency_methods</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;PUT&quot;</span><span class="p">,</span> <span class="s">&quot;PATCH&quot;</span><span class="p">]</span>

        <span class="c"># If &#39;follow_redirects&#39; is True, and this is set to True then</span>
        <span class="c"># all redirecs are followed, including unsafe ones.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">follow_all_redirects</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_etag</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">force_exception_to_status_code</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>

    <span class="k">def</span> <span class="nf">_auth_from_challenge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A generator that creates Authorization objects</span>
<span class="sd">           that can be applied to requests.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">challenges</span> <span class="o">=</span> <span class="n">_parse_www_authenticate</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s">&#39;www-authenticate&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cred</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">credentials</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">host</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">scheme</span> <span class="ow">in</span> <span class="n">AUTH_SCHEME_ORDER</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">challenges</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">scheme</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">AUTH_SCHEME_CLASSES</span><span class="p">[</span><span class="n">scheme</span><span class="p">](</span><span class="n">cred</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="Http.add_credentials"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.http_client.httplib2.html#JumpScale.baselib.http_client.httplib2.Http.add_credentials">[docs]</a>    <span class="k">def</span> <span class="nf">add_credentials</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a name and password that will be used</span>
<span class="sd">        any time a request requires authentication.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">credentials</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">domain</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Http.add_certificate"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.http_client.httplib2.html#JumpScale.baselib.http_client.httplib2.Http.add_certificate">[docs]</a>    <span class="k">def</span> <span class="nf">add_certificate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">cert</span><span class="p">,</span> <span class="n">domain</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a key and cert that will be used</span>
<span class="sd">        any time a request requires authentication.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">certificates</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">cert</span><span class="p">,</span> <span class="n">domain</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Http.clear_credentials"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.http_client.httplib2.html#JumpScale.baselib.http_client.httplib2.Http.clear_credentials">[docs]</a>    <span class="k">def</span> <span class="nf">clear_credentials</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove all the names and passwords</span>
<span class="sd">        that are used for authentication&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">credentials</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authorizations</span> <span class="o">=</span> <span class="p">[]</span>
</div>
    <span class="k">def</span> <span class="nf">_conn_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">headers</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">conn</span><span class="o">.</span><span class="n">sock</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                  <span class="n">conn</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">gaierror</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">ServerNotFoundError</span><span class="p">(</span><span class="s">&quot;Unable to find the server at </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">conn</span><span class="o">.</span><span class="n">host</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ssl_SSLError</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s">&#39;args&#39;</span><span class="p">):</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s">&#39;args&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span>
                <span class="k">if</span> <span class="n">err</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ECONNREFUSED</span><span class="p">:</span> <span class="c"># Connection refused</span>
                    <span class="k">raise</span>
            <span class="k">except</span> <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPException</span><span class="p">:</span>
                <span class="c"># Just because the server closed the connection doesn&#39;t apparently mean</span>
                <span class="c"># that the server didn&#39;t send a response.</span>
                <span class="k">if</span> <span class="n">conn</span><span class="o">.</span><span class="n">sock</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="n">conn</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="k">raise</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                    <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">getresponse</span><span class="p">()</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPException</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
                <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&quot;HEAD&quot;</span><span class="p">:</span>
                    <span class="n">response</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">method</span> <span class="o">!=</span> <span class="s">&quot;HEAD&quot;</span><span class="p">:</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="n">_decompressContent</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">absolute_uri</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">redirections</span><span class="p">,</span> <span class="n">cachekey</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Do the actual request using the connection object</span>
<span class="sd">        and also follow one level of redirects if necessary&quot;&quot;&quot;</span>

        <span class="n">auths</span> <span class="o">=</span> <span class="p">[(</span><span class="n">auth</span><span class="o">.</span><span class="n">depth</span><span class="p">(</span><span class="n">request_uri</span><span class="p">),</span> <span class="n">auth</span><span class="p">)</span> <span class="k">for</span> <span class="n">auth</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">authorizations</span> <span class="k">if</span> <span class="n">auth</span><span class="o">.</span><span class="n">inscope</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">)]</span>
        <span class="n">auth</span> <span class="o">=</span> <span class="n">auths</span> <span class="ow">and</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">auths</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">auth</span><span class="p">:</span>
            <span class="n">auth</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>

        <span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn_request</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">auth</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">auth</span><span class="o">.</span><span class="n">response</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
                <span class="n">auth</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
                <span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn_request</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">headers</span> <span class="p">)</span>
                <span class="n">response</span><span class="o">.</span><span class="n">_stale_digest</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">401</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">authorization</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auth_from_challenge</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
                <span class="n">authorization</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
                <span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn_request</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="p">)</span>
                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">401</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">authorizations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">authorization</span><span class="p">)</span>
                    <span class="n">authorization</span><span class="o">.</span><span class="n">response</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
                    <span class="k">break</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">follow_all_redirects</span> <span class="ow">or</span> <span class="p">(</span><span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;HEAD&quot;</span><span class="p">])</span> <span class="ow">or</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">303</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">follow_redirects</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">300</span><span class="p">,</span> <span class="mi">301</span><span class="p">,</span> <span class="mi">302</span><span class="p">,</span> <span class="mi">303</span><span class="p">,</span> <span class="mi">307</span><span class="p">]:</span>
                <span class="c"># Pick out the location header and basically start from the beginning</span>
                <span class="c"># remembering first to strip the ETag header and decrement our &#39;depth&#39;</span>
                <span class="k">if</span> <span class="n">redirections</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;location&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">300</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">RedirectMissingLocation</span><span class="p">(</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;Redirected but the response is missing a Location: header.&quot;</span><span class="p">),</span> <span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
                    <span class="c"># Fix-up relative redirects (which violate an RFC 2616 MUST)</span>
                    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;location&#39;</span><span class="p">):</span>
                        <span class="n">location</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;location&#39;</span><span class="p">]</span>
                        <span class="p">(</span><span class="n">scheme</span><span class="p">,</span> <span class="n">authority</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">fragment</span><span class="p">)</span> <span class="o">=</span> <span class="n">parse_uri</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">authority</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">response</span><span class="p">[</span><span class="s">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">absolute_uri</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">301</span> <span class="ow">and</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;HEAD&quot;</span><span class="p">]:</span>
                        <span class="n">response</span><span class="p">[</span><span class="s">&#39;-x-permanent-redirect-url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;location&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;content-location&#39;</span><span class="p">):</span>
                            <span class="n">response</span><span class="p">[</span><span class="s">&#39;content-location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">absolute_uri</span>
                        <span class="n">_updateCache</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">,</span> <span class="n">cachekey</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">headers</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;if-none-match&#39;</span><span class="p">):</span>
                        <span class="k">del</span> <span class="n">headers</span><span class="p">[</span><span class="s">&#39;if-none-match&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">headers</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;if-modified-since&#39;</span><span class="p">):</span>
                        <span class="k">del</span> <span class="n">headers</span><span class="p">[</span><span class="s">&#39;if-modified-since&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;location&#39;</span><span class="p">):</span>
                        <span class="n">location</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;location&#39;</span><span class="p">]</span>
                        <span class="n">old_response</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">old_response</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;content-location&#39;</span><span class="p">):</span>
                            <span class="n">old_response</span><span class="p">[</span><span class="s">&#39;content-location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">absolute_uri</span>
                        <span class="n">redirect_method</span> <span class="o">=</span> <span class="n">method</span>
                        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">302</span><span class="p">,</span> <span class="mi">303</span><span class="p">]:</span>
                            <span class="n">redirect_method</span> <span class="o">=</span> <span class="s">&quot;GET&quot;</span>
                            <span class="n">body</span> <span class="o">=</span> <span class="bp">None</span>
                        <span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">redirect_method</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span><span class="p">,</span> <span class="n">redirections</span> <span class="o">=</span> <span class="n">redirections</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">response</span><span class="o">.</span><span class="n">previous</span> <span class="o">=</span> <span class="n">old_response</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">RedirectLimit</span><span class="p">(</span><span class="s">&quot;Redirected more times than rediection_limit allows.&quot;</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">203</span><span class="p">]</span> <span class="ow">and</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;HEAD&quot;</span><span class="p">]:</span>
                <span class="c"># Don&#39;t cache 206&#39;s since we aren&#39;t going to handle byte range requests</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;content-location&#39;</span><span class="p">):</span>
                    <span class="n">response</span><span class="p">[</span><span class="s">&#39;content-location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">absolute_uri</span>
                <span class="n">_updateCache</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">,</span> <span class="n">cachekey</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_normalize_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">headers</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_normalize_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>

<span class="c"># Need to catch and rebrand some exceptions</span>
<span class="c"># Then need to optionally turn all exceptions into status codes</span>
<span class="c"># including all socket.* and httplib.* exceptions.</span>


<div class="viewcode-block" id="Http.request"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.http_client.httplib2.html#JumpScale.baselib.http_client.httplib2.Http.request">[docs]</a>    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">redirections</span><span class="o">=</span><span class="n">DEFAULT_MAX_REDIRECTS</span><span class="p">,</span> <span class="n">connection_type</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Performs a single HTTP request.</span>
<span class="sd">The &#39;uri&#39; is the URI of the HTTP resource and can begin</span>
<span class="sd">with either &#39;http&#39; or &#39;https&#39;. The value of &#39;uri&#39; must be an absolute URI.</span>

<span class="sd">The &#39;method&#39; is the HTTP method to perform, such as GET, POST, DELETE, etc.</span>
<span class="sd">There is no restriction on the methods allowed.</span>

<span class="sd">The &#39;body&#39; is the entity body to be sent with the request. It is a string</span>
<span class="sd">object.</span>

<span class="sd">Any extra headers that are to be sent with the request should be provided in the</span>
<span class="sd">&#39;headers&#39; dictionary.</span>

<span class="sd">The maximum number of redirect to follow before raising an</span>
<span class="sd">exception is &#39;redirections. The default is 5.</span>

<span class="sd">The return value is a tuple of (response, content), the first</span>
<span class="sd">being and instance of the &#39;Response&#39; class, the second being</span>
<span class="sd">a string that contains the response entity body.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">headers</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">headers</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;user-agent&#39;</span><span class="p">):</span>
                <span class="n">headers</span><span class="p">[</span><span class="s">&#39;user-agent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Python-httplib2/</span><span class="si">%s</span><span class="s"> (gzip)&quot;</span> <span class="o">%</span> <span class="n">__version__</span>

            <span class="n">uri</span> <span class="o">=</span> <span class="n">iri2uri</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>

            <span class="p">(</span><span class="n">scheme</span><span class="p">,</span> <span class="n">authority</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">defrag_uri</span><span class="p">)</span> <span class="o">=</span> <span class="n">urlnorm</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
            <span class="n">domain_port</span> <span class="o">=</span> <span class="n">authority</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">domain_port</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">domain_port</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;443&#39;</span> <span class="ow">and</span> <span class="n">scheme</span> <span class="o">==</span> <span class="s">&#39;http&#39;</span><span class="p">:</span>
                <span class="n">scheme</span> <span class="o">=</span> <span class="s">&#39;https&#39;</span>
                <span class="n">authority</span> <span class="o">=</span> <span class="n">domain_port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">conn_key</span> <span class="o">=</span> <span class="n">scheme</span><span class="o">+</span><span class="s">&quot;:&quot;</span><span class="o">+</span><span class="n">authority</span>
            <span class="k">if</span> <span class="n">conn_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">:</span>
                <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">[</span><span class="n">conn_key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">connection_type</span><span class="p">:</span>
                  <span class="n">connection_type</span> <span class="o">=</span> <span class="n">SCHEME_TO_CONNECTION</span><span class="p">[</span><span class="n">scheme</span><span class="p">]</span>
                <span class="n">certs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">certificates</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">authority</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">connection_type</span><span class="p">,</span> <span class="n">HTTPSConnectionWithTimeout</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">certs</span><span class="p">:</span>
                        <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">[</span><span class="n">conn_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">connection_type</span><span class="p">(</span>
                                <span class="n">authority</span><span class="p">,</span> <span class="n">key_file</span><span class="o">=</span><span class="n">certs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                <span class="n">cert_file</span><span class="o">=</span><span class="n">certs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
                                <span class="n">proxy_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">proxy_info</span><span class="p">,</span>
                                <span class="n">ca_certs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ca_certs</span><span class="p">,</span>
                                <span class="n">disable_ssl_certificate_validation</span><span class="o">=</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">disable_ssl_certificate_validation</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">[</span><span class="n">conn_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">connection_type</span><span class="p">(</span>
                                <span class="n">authority</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
                                <span class="n">proxy_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">proxy_info</span><span class="p">,</span>
                                <span class="n">ca_certs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ca_certs</span><span class="p">,</span>
                                <span class="n">disable_ssl_certificate_validation</span><span class="o">=</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">disable_ssl_certificate_validation</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">[</span><span class="n">conn_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">connection_type</span><span class="p">(</span>
                            <span class="n">authority</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
                            <span class="n">proxy_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">proxy_info</span><span class="p">)</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">set_debuglevel</span><span class="p">(</span><span class="n">debuglevel</span><span class="p">)</span>

            <span class="k">if</span> <span class="s">&#39;range&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">headers</span> <span class="ow">and</span> <span class="s">&#39;accept-encoding&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
                <span class="n">headers</span><span class="p">[</span><span class="s">&#39;accept-encoding&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;gzip, deflate&#39;</span>

            <span class="n">info</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">Message</span><span class="o">.</span><span class="n">Message</span><span class="p">()</span>
            <span class="n">cached_value</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
                <span class="n">cachekey</span> <span class="o">=</span> <span class="n">defrag_uri</span>
                <span class="n">cached_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cachekey</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cached_value</span><span class="p">:</span>
                    <span class="c"># info = email.message_from_string(cached_value)</span>
                    <span class="c">#</span>
                    <span class="c"># Need to replace the line above with the kludge below</span>
                    <span class="c"># to fix the non-existent bug not fixed in this</span>
                    <span class="c"># bug report: http://mail.python.org/pipermail/python-bugs-list/2005-September/030289.html</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">info</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">cached_value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\r\n\r\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">feedparser</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">FeedParser</span><span class="o">.</span><span class="n">FeedParser</span><span class="p">()</span>
                        <span class="n">feedparser</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
                        <span class="n">info</span> <span class="o">=</span> <span class="n">feedparser</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="n">feedparser</span><span class="o">.</span><span class="n">_parse</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">cachekey</span><span class="p">)</span>
                        <span class="n">cachekey</span> <span class="o">=</span> <span class="bp">None</span>
                        <span class="n">cached_value</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cachekey</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">if</span> <span class="n">method</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimistic_concurrency_methods</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="ow">and</span> <span class="n">info</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;etag&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_etag</span> <span class="ow">and</span> <span class="s">&#39;if-match&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
                <span class="c"># http://www.w3.org/1999/04/Editing/</span>
                <span class="n">headers</span><span class="p">[</span><span class="s">&#39;if-match&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s">&#39;etag&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;HEAD&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="ow">and</span> <span class="n">cachekey</span><span class="p">:</span>
                <span class="c"># RFC 2616 Section 13.10</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">cachekey</span><span class="p">)</span>

            <span class="c"># Check the vary header in the cache to see if this request</span>
            <span class="c"># matches what varies in the cache.</span>
            <span class="k">if</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;HEAD&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s">&#39;vary&#39;</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
                <span class="n">vary</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s">&#39;vary&#39;</span><span class="p">]</span>
                <span class="n">vary_headers</span> <span class="o">=</span> <span class="n">vary</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">vary_headers</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;-varied-</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">header</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="o">!=</span> <span class="n">value</span><span class="p">:</span>
                            <span class="n">cached_value</span> <span class="o">=</span> <span class="bp">None</span>
                            <span class="k">break</span>

            <span class="k">if</span> <span class="n">cached_value</span> <span class="ow">and</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;HEAD&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="ow">and</span> <span class="s">&#39;range&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;-x-permanent-redirect-url&#39;</span><span class="p">):</span>
                    <span class="c"># Should cached permanent redirects be counted in our redirection count? For now, yes.</span>
                    <span class="k">if</span> <span class="n">redirections</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                      <span class="k">raise</span> <span class="n">RedirectLimit</span><span class="p">(</span><span class="s">&quot;Redirected more times than rediection_limit allows.&quot;</span><span class="p">,</span> <span class="p">{},</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
                    <span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">new_content</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s">&#39;-x-permanent-redirect-url&#39;</span><span class="p">],</span> <span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span><span class="p">,</span> <span class="n">redirections</span> <span class="o">=</span> <span class="n">redirections</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">response</span><span class="o">.</span><span class="n">previous</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
                    <span class="n">response</span><span class="o">.</span><span class="n">previous</span><span class="o">.</span><span class="n">fromcache</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># Determine our course of action:</span>
                    <span class="c">#   Is the cached entry fresh or stale?</span>
                    <span class="c">#   Has the client requested a non-cached response?</span>
                    <span class="c">#</span>
                    <span class="c"># There seems to be three possible answers:</span>
                    <span class="c"># 1. [FRESH] Return the cache entry w/o doing a GET</span>
                    <span class="c"># 2. [STALE] Do the GET (but add in cache validators if available)</span>
                    <span class="c"># 3. [TRANSPARENT] Do a GET w/o any cache validators (Cache-Control: no-cache) on the request</span>
                    <span class="n">entry_disposition</span> <span class="o">=</span> <span class="n">_entry_disposition</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">entry_disposition</span> <span class="o">==</span> <span class="s">&quot;FRESH&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">cached_value</span><span class="p">:</span>
                            <span class="n">info</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;504&#39;</span>
                            <span class="n">content</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
                        <span class="n">response</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">cached_value</span><span class="p">:</span>
                            <span class="n">response</span><span class="o">.</span><span class="n">fromcache</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="k">return</span> <span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">entry_disposition</span> <span class="o">==</span> <span class="s">&quot;STALE&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;etag&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_etag</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s">&#39;if-none-match&#39;</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
                            <span class="n">headers</span><span class="p">[</span><span class="s">&#39;if-none-match&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s">&#39;etag&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;last-modified&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s">&#39;last-modified&#39;</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
                            <span class="n">headers</span><span class="p">[</span><span class="s">&#39;if-modified-since&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s">&#39;last-modified&#39;</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">entry_disposition</span> <span class="o">==</span> <span class="s">&quot;TRANSPARENT&quot;</span><span class="p">:</span>
                        <span class="k">pass</span>

                    <span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">new_content</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">authority</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">redirections</span><span class="p">,</span> <span class="n">cachekey</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">304</span> <span class="ow">and</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&quot;GET&quot;</span><span class="p">:</span>
                    <span class="c"># Rewrite the cache entry with the new end-to-end headers</span>
                    <span class="c"># Take all headers that are in response</span>
                    <span class="c"># and overwrite their values in info.</span>
                    <span class="c"># unless they are hop-by-hop, or are listed in the connection header.</span>

                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">_get_end2end_headers</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
                        <span class="n">info</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="n">merged_response</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s">&quot;_stale_digest&quot;</span><span class="p">):</span>
                        <span class="n">merged_response</span><span class="o">.</span><span class="n">_stale_digest</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">_stale_digest</span>
                    <span class="n">_updateCache</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="n">merged_response</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">,</span> <span class="n">cachekey</span><span class="p">)</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">merged_response</span>
                    <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">200</span>
                    <span class="n">response</span><span class="o">.</span><span class="n">fromcache</span> <span class="o">=</span> <span class="bp">True</span>

                <span class="k">elif</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="n">new_content</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">cachekey</span><span class="p">)</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="n">new_content</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cc</span> <span class="o">=</span> <span class="n">_parse_cache_control</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cc</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;only-if-cached&#39;</span><span class="p">):</span>
                    <span class="n">info</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;504&#39;</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">authority</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">redirections</span><span class="p">,</span> <span class="n">cachekey</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_exception_to_status_code</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">HttpLib2ErrorWithResponse</span><span class="p">):</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">content</span>
                    <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">500</span>
                    <span class="n">response</span><span class="o">.</span><span class="n">reason</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">):</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="s">&quot;Request Timeout&quot;</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span> <span class="p">{</span>
                            <span class="s">&quot;content-type&quot;</span><span class="p">:</span> <span class="s">&quot;text/plain&quot;</span><span class="p">,</span>
                            <span class="s">&quot;status&quot;</span><span class="p">:</span> <span class="s">&quot;408&quot;</span><span class="p">,</span>
                            <span class="s">&quot;content-length&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                            <span class="p">})</span>
                    <span class="n">response</span><span class="o">.</span><span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;Request Timeout&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span> <span class="p">{</span>
                            <span class="s">&quot;content-type&quot;</span><span class="p">:</span> <span class="s">&quot;text/plain&quot;</span><span class="p">,</span>
                            <span class="s">&quot;status&quot;</span><span class="p">:</span> <span class="s">&quot;400&quot;</span><span class="p">,</span>
                            <span class="s">&quot;content-length&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                            <span class="p">})</span>
                    <span class="n">response</span><span class="o">.</span><span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;Bad Request&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>


        <span class="k">return</span> <span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>


</div></div>
<div class="viewcode-block" id="Response"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.http_client.httplib2.html#JumpScale.baselib.http_client.httplib2.Response">[docs]</a><span class="k">class</span> <span class="nc">Response</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An object more like email.Message than httplib.HTTPResponse.&quot;&quot;&quot;</span>

    <span class="sd">&quot;&quot;&quot;Is this response from our local cache&quot;&quot;&quot;</span>
    <span class="n">fromcache</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="sd">&quot;&quot;&quot;HTTP protocol version used by server. 10 for HTTP/1.0, 11 for HTTP/1.1. &quot;&quot;&quot;</span>
    <span class="n">version</span> <span class="o">=</span> <span class="mi">11</span>

    <span class="s">&quot;Status code returned by server. &quot;</span>
    <span class="n">status</span> <span class="o">=</span> <span class="mi">200</span>

    <span class="sd">&quot;&quot;&quot;Reason phrase returned by server.&quot;&quot;&quot;</span>
    <span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;Ok&quot;</span>

    <span class="n">previous</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="c"># info is either an email.Message or</span>
        <span class="c"># an httplib.HTTPResponse object.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPResponse</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">getheaders</span><span class="p">():</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">status</span>
            <span class="bp">self</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">reason</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">version</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">email</span><span class="o">.</span><span class="n">Message</span><span class="o">.</span><span class="n">Message</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;status&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;dict&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">,</span> <span class="n">name</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">Jumpscale Doc 7.0 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
    </div>
  </body>
</html>