<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>JumpScale.baselib.redis.Redis &mdash; Jumpscale Doc 7.0 documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '7.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="top" title="Jumpscale Doc 7.0 documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">Jumpscale Doc 7.0 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for JumpScale.baselib.redis.Redis</h1><div class="highlight"><pre>
<span class="kn">from</span> <span class="nn">JumpScale</span> <span class="kn">import</span> <span class="n">j</span>
<span class="kn">import</span> <span class="nn">redis</span>
<span class="kn">from</span> <span class="nn">JumpScale.baselib.credis.CRedis</span> <span class="kn">import</span> <span class="n">CRedis</span>
<span class="kn">from</span> <span class="nn">JumpScale.baselib.credis.CRedisQueue</span> <span class="kn">import</span> <span class="n">CRedisQueue</span>
<span class="kn">import</span> <span class="nn">itertools</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">ujson</span> <span class="kn">as</span> <span class="nn">json</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">json</span>


<div class="viewcode-block" id="RedisDict"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.redis.html#JumpScale.baselib.redis.Redis.RedisDict">[docs]</a><span class="k">class</span> <span class="nc">RedisDict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="n">key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="n">client</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">hexists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">))</span>

<div class="viewcode-block" id="RedisDict.copy"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.redis.html#JumpScale.baselib.redis.Redis.RedisDict.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">allkeys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">hgetalldict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">allkeys</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="RedisDict.pop"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.redis.html#JumpScale.baselib.redis.Redis.RedisDict.pop">[docs]</a>    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">hdel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RedisDict.keys"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.redis.html#JumpScale.baselib.redis.Redis.RedisDict.keys">[docs]</a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">hkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RedisDict.iteritems"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.redis.html#JumpScale.baselib.redis.Redis.RedisDict.iteritems">[docs]</a>    <span class="k">def</span> <span class="nf">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">allkeys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">hgetalldict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">allkeys</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">key</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="Redis"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.redis.html#JumpScale.baselib.redis.Redis.Redis">[docs]</a><span class="k">class</span> <span class="nc">Redis</span><span class="p">(</span><span class="n">redis</span><span class="o">.</span><span class="n">Redis</span><span class="p">):</span>
    <span class="n">hgetalldict</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">Redis</span><span class="o">.</span><span class="n">hgetall</span>
<div class="viewcode-block" id="Redis.getDict"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.redis.html#JumpScale.baselib.redis.Redis.Redis.getDict">[docs]</a>    <span class="k">def</span> <span class="nf">getDict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">RedisDict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="GeventRedis"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.redis.html#JumpScale.baselib.redis.Redis.GeventRedis">[docs]</a><span class="k">class</span> <span class="nc">GeventRedis</span><span class="p">(</span><span class="n">Redis</span><span class="p">):</span>
<div class="viewcode-block" id="GeventRedis.hgetall"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.redis.html#JumpScale.baselib.redis.Redis.GeventRedis.hgetall">[docs]</a>    <span class="k">def</span> <span class="nf">hgetall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="s">&quot;Return a Python dict of the hash&#39;s name/value pairs&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="s">&#39;HGETALL&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">d</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
</div></div>
<div class="viewcode-block" id="RedisFactory"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.redis.html#JumpScale.baselib.redis.Redis.RedisFactory">[docs]</a><span class="k">class</span> <span class="nc">RedisFactory</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gredis</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gredisq</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redisq</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="RedisFactory.getGeventRedisClient"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.redis.html#JumpScale.baselib.redis.Redis.RedisFactory.getGeventRedisClient">[docs]</a>    <span class="k">def</span> <span class="nf">getGeventRedisClient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ipaddr</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">fromcache</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">password</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="c">#from gevent.monkey import patch_socket</span>
        <span class="c">#patch_socket()        </span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fromcache</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">GeventRedis</span><span class="p">(</span><span class="n">ipaddr</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span><span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span> 
        <span class="n">key</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ipaddr</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gredis</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gredis</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">GeventRedis</span><span class="p">(</span><span class="n">ipaddr</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span><span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">gredis</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="RedisFactory.getRedisClient"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.redis.html#JumpScale.baselib.redis.Redis.RedisFactory.getRedisClient">[docs]</a>    <span class="k">def</span> <span class="nf">getRedisClient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ipaddr</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ipaddr</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">Redis</span><span class="p">(</span><span class="n">ipaddr</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="RedisFactory.getRedisQueue"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.redis.html#JumpScale.baselib.redis.Redis.RedisFactory.getRedisQueue">[docs]</a>    <span class="k">def</span> <span class="nf">getRedisQueue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ipaddr</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s">&quot;queues&quot;</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ipaddr</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">redisq</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redisq</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">CRedisQueue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getRedisClient</span><span class="p">(</span><span class="n">ipaddr</span><span class="p">,</span> <span class="n">port</span><span class="p">),</span> <span class="n">name</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">redisq</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="RedisFactory.getGeventRedisQueue"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.redis.html#JumpScale.baselib.redis.Redis.RedisFactory.getGeventRedisQueue">[docs]</a>    <span class="k">def</span> <span class="nf">getGeventRedisQueue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ipaddr</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s">&quot;queues&quot;</span><span class="p">,</span> <span class="n">fromcache</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">fromcache</span> <span class="o">=</span> <span class="bp">False</span>  <span class="c"># @todo remove</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fromcache</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CRedisQueue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getGeventRedisClient</span><span class="p">(</span><span class="n">ipaddr</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="bp">False</span><span class="p">),</span> <span class="n">name</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ipaddr</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">gredisq</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gredisq</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">CRedisQueue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getGeventRedisClient</span><span class="p">(</span><span class="n">ipaddr</span><span class="p">,</span> <span class="n">port</span><span class="p">),</span> <span class="n">name</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">gredisq</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="RedisFactory.checkAllInstances"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.redis.html#JumpScale.baselib.redis.Redis.RedisFactory.checkAllInstances">[docs]</a>    <span class="k">def</span> <span class="nf">checkAllInstances</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">pd</span> <span class="ow">in</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">j</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">startupmanager</span><span class="o">.</span><span class="n">getProcessDefs</span><span class="p">(</span><span class="s">&quot;jumpscale&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;redis&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="n">path</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">dirs</span><span class="o">.</span><span class="n">varDir</span><span class="p">,</span><span class="s">&quot;redis&quot;</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="s">&quot;db&quot;</span><span class="p">,</span><span class="s">&quot;appendonly.aof&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">stats</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">statPath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">stats</span><span class="o">.</span><span class="n">st_size</span><span class="o">&lt;&gt;</span><span class="mi">0</span><span class="p">:</span>                    
                    <span class="n">cmd</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">/apps/redis/redis-check-aof --fix </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">dirs</span><span class="o">.</span><span class="n">baseDir</span><span class="p">,</span><span class="n">path</span><span class="p">)</span>
                    <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">executeWithoutPipe</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="RedisFactory.emptyAllInstances"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.redis.html#JumpScale.baselib.redis.Redis.RedisFactory.emptyAllInstances">[docs]</a>    <span class="k">def</span> <span class="nf">emptyAllInstances</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">pd</span> <span class="ow">in</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">j</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">startupmanager</span><span class="o">.</span><span class="n">getProcessDefs</span><span class="p">(</span><span class="s">&quot;jumpscale&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;redis&quot;</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="s">&quot;redism&quot;</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="s">&quot;rediskvs&quot;</span><span class="p">:</span>
                <span class="k">continue</span> <span class="c">#nothing to do</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="n">path</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">dirs</span><span class="o">.</span><span class="n">varDir</span><span class="p">,</span><span class="s">&quot;redis&quot;</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="s">&quot;db&quot;</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;remove:</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">path</span>
            <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">removeDirTree</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">createDir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">path</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">dirs</span><span class="o">.</span><span class="n">varDir</span><span class="p">,</span><span class="s">&quot;redis&quot;</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="s">&quot;redis.log&quot;</span><span class="p">)</span>
            <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>            

    <span class="c"># def deleteAllInstances(self):</span>
    <span class="c">#     path = &quot;/opt/redis/&quot;</span>
    <span class="c">#     for name in j.system.fs.listDirsInDir(path, recursive=False, dirNameOnly=True, findDirectorySymlinks=True):</span>
    <span class="c">#         self.deleteInstance(name)</span>
</div>
<div class="viewcode-block" id="RedisFactory.getPort"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.redis.html#JumpScale.baselib.redis.Redis.RedisFactory.getPort">[docs]</a>    <span class="k">def</span> <span class="nf">getPort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getProcessPids</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">cpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getPaths</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">fileGetContents</span><span class="p">(</span><span class="n">cpath</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;port&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;port &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">port</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Could not find redis port in config file </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">cpath</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_getPaths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">dpath</span> <span class="o">=</span> <span class="s">&quot;/opt/redis/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">name</span>
        <span class="k">return</span> <span class="n">dpath</span><span class="p">,</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="s">&quot;redis.conf&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="RedisFactory.getProcessPids"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.redis.html#JumpScale.baselib.redis.Redis.RedisFactory.getProcessPids">[docs]</a>    <span class="k">def</span> <span class="nf">getProcessPids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;name cannot be empty to start redis&quot;</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">cpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getPaths</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">cpath</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Cannot find redis instance on </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">cpath</span><span class="p">)</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">getProcessPid</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pids</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pids</span>
        <span class="k">return</span> <span class="p">[]</span>
</div>
<div class="viewcode-block" id="RedisFactory.stopInstance"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.redis.html#JumpScale.baselib.redis.Redis.RedisFactory.stopInstance">[docs]</a>    <span class="k">def</span> <span class="nf">stopInstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">j</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;start redis:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="c"># from IPython import embed</span>
        <span class="c"># print &quot;DEBUG NOW id&quot;</span>
        <span class="c"># embed()</span>
        
</div>
<div class="viewcode-block" id="RedisFactory.startInstance"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.redis.html#JumpScale.baselib.redis.Redis.RedisFactory.startInstance">[docs]</a>    <span class="k">def</span> <span class="nf">startInstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">j</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;start redis:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RedisFactory.deleteInstance"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.redis.html#JumpScale.baselib.redis.Redis.RedisFactory.deleteInstance">[docs]</a>    <span class="k">def</span> <span class="nf">deleteInstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="c"># self.stopInstance(name)</span>
        <span class="n">dpath</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getPaths</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">removeDirTree</span><span class="p">(</span><span class="n">dpath</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RedisFactory.emptyInstance"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.redis.html#JumpScale.baselib.redis.Redis.RedisFactory.emptyInstance">[docs]</a>    <span class="k">def</span> <span class="nf">emptyInstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="c"># self.stopInstance(name)</span>
        <span class="n">dpath</span> <span class="o">=</span> <span class="s">&quot;/opt/redis/</span><span class="si">%s</span><span class="s">/db&quot;</span> <span class="o">%</span> <span class="n">name</span>
        <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">removeDirTree</span><span class="p">(</span><span class="n">dpath</span><span class="p">)</span>
        <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">createDir</span><span class="p">(</span><span class="n">dpath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startInstance</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RedisFactory.configureInstance"><a class="viewcode-back" href="../../../../API/JumpScale.baselib.redis.html#JumpScale.baselib.redis.Redis.RedisFactory.configureInstance">[docs]</a>    <span class="k">def</span> <span class="nf">configureInstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">maxram</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">appendonly</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">snapshot</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">slave</span><span class="o">=</span><span class="p">(),</span><span class="n">ismaster</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">passwd</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        @param maxram = MB of ram</span>
<span class="sd">        slave example: (192.168.10.10,8888,asecret)   (ip,port,secret)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span><span class="o">=</span><span class="s">&#39;sysctl vm.overcommit_memory=1&#39;</span>
        <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">dieOnNonZeroExitCode</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">outputToStdout</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">ignoreErrorOutput</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">C</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">daemonize no</span>
<span class="s">pidfile $vardir/redis/$name/redis.pid</span>
<span class="s">port $port</span>
<span class="s">bind 127.0.0.1</span>
<span class="s"># unixsocket $vardir/redis/$name/redis.sock</span>
<span class="s"># unixsocketperm 755</span>
<span class="s">timeout 0</span>

<span class="s"># TCP keepalive.</span>
<span class="s">#</span>
<span class="s"># If non-zero, use SO_KEEPALIVE to send TCP ACKs to clients in absence</span>
<span class="s"># of communication. This is useful for two reasons:</span>
<span class="s">#</span>
<span class="s"># 1) Detect dead peers.</span>
<span class="s"># 2) Take the connection alive from the point of view of network</span>
<span class="s">#    equipment in the middle.</span>
<span class="s">#</span>
<span class="s"># On Linux, the specified value (in seconds) is the period used to send ACKs.</span>
<span class="s"># Note that to close the connection the double of the time is needed.</span>
<span class="s"># On other kernels the period depends on the kernel configuration.</span>
<span class="s">#</span>
<span class="s"># A reasonable value for this option is 60 seconds.</span>
<span class="s">tcp-keepalive 0</span>

<span class="s"># Specify the server verbosity level.</span>
<span class="s"># This can be one of:</span>
<span class="s"># debug (a lot of information, useful for development/testing)</span>
<span class="s"># verbose (many rarely useful info, but not a mess like the debug level)</span>
<span class="s"># notice (moderately verbose, what you want in production probably)</span>
<span class="s"># warning (only very important / critical messages are logged)</span>
<span class="s">loglevel notice</span>

<span class="s">logfile $vardir/redis/$name/redis.log</span>
<span class="s">syslog-enabled no</span>

<span class="s">databases 1</span>

<span class="s">################################ SNAPSHOTTING  #################################</span>
<span class="s">#</span>
<span class="s"># Save the DB on disk:</span>
<span class="s">#</span>
<span class="s">#   save &lt;seconds&gt; &lt;changes&gt;</span>
<span class="s">#</span>
<span class="s">#   Will save the DB if both the given number of seconds and the given</span>
<span class="s">#   number of write operations against the DB occurred.</span>
<span class="s">#</span>
<span class="s">#   In the example below the behaviour will be to save:</span>
<span class="s">#   after 900 sec (15 min) if at least 1 key changed</span>
<span class="s">#   after 300 sec (5 min) if at least 10 keys changed</span>
<span class="s">#   after 60 sec if at least 10000 keys changed</span>
<span class="s">#</span>
<span class="s">#   Note: you can disable saving at all commenting all the &quot;save&quot; lines.</span>
<span class="s">#</span>
<span class="s">#   It is also possible to remove all the previously configured save</span>
<span class="s">#   points by adding a save directive with a single empty string argument</span>
<span class="s">#   like in the following example:</span>
<span class="s">#</span>
<span class="s">#   save &quot;&quot;</span>
<span class="s"># save 900 1</span>
<span class="s"># save 300 10</span>
<span class="s">$snapshot</span>

<span class="s"># By default Redis will stop accepting writes if RDB snapshots are enabled</span>
<span class="s"># (at least one save point) and the latest background save failed.</span>
<span class="s"># This will make the user aware (in an hard way) that data is not persisting</span>
<span class="s"># on disk properly, otherwise chances are that no one will notice and some</span>
<span class="s"># distater will happen.</span>
<span class="s">#</span>
<span class="s"># If the background saving process will start working again Redis will</span>
<span class="s"># automatically allow writes again.</span>
<span class="s">#</span>
<span class="s"># However if you have setup your proper monitoring of the Redis server</span>
<span class="s"># and persistence, you may want to disable this feature so that Redis will</span>
<span class="s"># continue to work as usually even if there are problems with disk,</span>
<span class="s"># permissions, and so forth.</span>
<span class="s">stop-writes-on-bgsave-error yes</span>

<span class="s"># Compress string objects using LZF when dump .rdb databases?</span>
<span class="s"># For default that&#39;s set to &#39;yes&#39; as it&#39;s almost always a win.</span>
<span class="s"># If you want to save some CPU in the saving child set it to &#39;no&#39; but</span>
<span class="s"># the dataset will likely be bigger if you have compressible values or keys.</span>
<span class="s">rdbcompression yes</span>

<span class="s"># Since version 5 of RDB a CRC64 checksum is placed at the end of the file.</span>
<span class="s"># This makes the format more resistant to corruption but there is a performance</span>
<span class="s"># hit to pay (around 10%) when saving and loading RDB files, so you can disable it</span>
<span class="s"># for maximum performances.</span>
<span class="s">#</span>
<span class="s"># RDB files created with checksum disabled have a checksum of zero that will</span>
<span class="s"># tell the loading code to skip the check.</span>
<span class="s">rdbchecksum yes</span>

<span class="s"># The filename where to dump the DB</span>
<span class="s">dbfilename dump.rdb</span>

<span class="s"># The working directory.</span>
<span class="s">#</span>
<span class="s"># The DB will be written inside this directory, with the filename specified</span>
<span class="s"># above using the &#39;dbfilename&#39; configuration directive.</span>
<span class="s">#</span>
<span class="s"># The Append Only File will also be created inside this directory.</span>
<span class="s">#</span>
<span class="s"># Note that you must specify a directory here, not a file name.</span>
<span class="s">dir $vardir/redis/$name/db/</span>

<span class="s">################################# REPLICATION #################################</span>

<span class="s"># Master-Slave replication. Use slaveof to make a Redis instance a copy of</span>
<span class="s"># another Redis server. Note that the configuration is local to the slave</span>
<span class="s"># so for example it is possible to configure the slave to save the DB with a</span>
<span class="s"># different interval, or to listen to another port, and so on.</span>
<span class="s">#</span>
<span class="s"># slaveof &lt;masterip&gt; &lt;masterport&gt;</span>
<span class="s">$slave</span>

<span class="s"># If the master is password protected (using the &quot;requirepass&quot; configuration</span>
<span class="s"># directive below) it is possible to tell the slave to authenticate before</span>
<span class="s"># starting the replication synchronization process, otherwise the master will</span>
<span class="s"># refuse the slave request.</span>
<span class="s">#</span>
<span class="s"># masterauth &lt;master-password&gt;</span>

<span class="s"># When a slave loses its connection with the master, or when the replication</span>
<span class="s"># is still in progress, the slave can act in two different ways:</span>
<span class="s">#</span>
<span class="s"># 1) if slave-serve-stale-data is set to &#39;yes&#39; (the default) the slave will</span>
<span class="s">#    still reply to client requests, possibly with out of date data, or the</span>
<span class="s">#    data set may just be empty if this is the first synchronization.</span>
<span class="s">#</span>
<span class="s"># 2) if slave-serve-stale-data is set to &#39;no&#39; the slave will reply with</span>
<span class="s">#    an error &quot;SYNC with master in progress&quot; to all the kind of commands</span>
<span class="s">#    but to INFO and SLAVEOF.</span>
<span class="s">#</span>
<span class="s">slave-serve-stale-data yes</span>

<span class="s"># You can configure a slave instance to accept writes or not. Writing against</span>
<span class="s"># a slave instance may be useful to store some ephemeral data (because data</span>
<span class="s"># written on a slave will be easily deleted after resync with the master) but</span>
<span class="s"># may also cause problems if clients are writing to it because of a</span>
<span class="s"># misconfiguration.</span>
<span class="s">#</span>
<span class="s"># Since Redis 2.6 by default slaves are read-only.</span>
<span class="s">#</span>
<span class="s"># Note: read only slaves are not designed to be exposed to untrusted clients</span>
<span class="s"># on the internet. It&#39;s just a protection layer against misuse of the instance.</span>
<span class="s"># Still a read only slave exports by default all the administrative commands</span>
<span class="s"># such as CONFIG, DEBUG, and so forth. To a limited extend you can improve</span>
<span class="s"># security of read only slaves using &#39;rename-command&#39; to shadow all the</span>
<span class="s"># administrative / dangerous commands.</span>
<span class="s">slave-read-only yes</span>

<span class="s"># Slaves send PINGs to server in a predefined interval. It&#39;s possible to change</span>
<span class="s"># this interval with the repl_ping_slave_period option. The default value is 10</span>
<span class="s"># seconds.</span>
<span class="s">#</span>
<span class="s">repl-ping-slave-period 10</span>

<span class="s"># The following option sets a timeout for both Bulk transfer I/O timeout and</span>
<span class="s"># master data or ping response timeout. The default value is 60 seconds.</span>
<span class="s">#</span>
<span class="s"># It is important to make sure that this value is greater than the value</span>
<span class="s"># specified for repl-ping-slave-period otherwise a timeout will be detected</span>
<span class="s"># every time there is low traffic between the master and the slave.</span>
<span class="s">#</span>
<span class="s"># repl-timeout 60</span>

<span class="s"># Disable TCP_NODELAY on the slave socket after SYNC?</span>
<span class="s">#</span>
<span class="s"># If you select &quot;yes&quot; Redis will use a smaller number of TCP packets and</span>
<span class="s"># less bandwidth to send data to slaves. But this can add a delay for</span>
<span class="s"># the data to appear on the slave side, up to 40 milliseconds with</span>
<span class="s"># Linux kernels using a default configuration.</span>
<span class="s">#</span>
<span class="s"># If you select &quot;no&quot; the delay for data to appear on the slave side will</span>
<span class="s"># be reduced but more bandwidth will be used for replication.</span>
<span class="s">#</span>
<span class="s"># By default we optimize for low latency, but in very high traffic conditions</span>
<span class="s"># or when the master and slaves are many hops away, turning this to &quot;yes&quot; may</span>
<span class="s"># be a good idea.</span>
<span class="s">repl-disable-tcp-nodelay no</span>

<span class="s"># The slave priority is an integer number published by Redis in the INFO output.</span>
<span class="s"># It is used by Redis Sentinel in order to select a slave to promote into a</span>
<span class="s"># master if the master is no longer working correctly.</span>
<span class="s">#</span>
<span class="s"># A slave with a low priority number is considered better for promotion, so</span>
<span class="s"># for instance if there are three slaves with priority 10, 100, 25 Sentinel will</span>
<span class="s"># pick the one wtih priority 10, that is the lowest.</span>
<span class="s">#</span>
<span class="s"># However a special priority of 0 marks the slave as not able to perform the</span>
<span class="s"># role of master, so a slave with priority of 0 will never be selected by</span>
<span class="s"># Redis Sentinel for promotion.</span>
<span class="s">#</span>
<span class="s"># By default the priority is 100.</span>
<span class="s">slave-priority 100</span>

<span class="s">################################## SECURITY ###################################</span>

<span class="s"># Require clients to issue AUTH &lt;PASSWORD&gt; before processing any other</span>
<span class="s"># commands.  This might be useful in environments in which you do not trust</span>
<span class="s"># others with access to the host running redis-server.</span>
<span class="s">#</span>
<span class="s"># This should stay commented out for backward compatibility and because most</span>
<span class="s"># people do not need auth (e.g. they run their own servers).</span>
<span class="s">#</span>
<span class="s"># Warning: since Redis is pretty fast an outside user can try up to</span>
<span class="s"># 150k passwords per second against a good box. This means that you should</span>
<span class="s"># use a very strong password otherwise it will be very easy to break.</span>
<span class="s">#</span>
<span class="s"># requirepass foobared</span>
<span class="s">$passwd</span>

<span class="s"># Command renaming.</span>
<span class="s">#</span>
<span class="s"># It is possible to change the name of dangerous commands in a shared</span>
<span class="s"># environment. For instance the CONFIG command may be renamed into something</span>
<span class="s"># hard to guess so that it will still be available for internal-use tools</span>
<span class="s"># but not available for general clients.</span>
<span class="s">#</span>
<span class="s"># Example:</span>
<span class="s">#</span>
<span class="s"># rename-command CONFIG b840fc02d524045429941cc15f59e41cb7be6c52</span>
<span class="s">#</span>
<span class="s"># It is also possible to completely kill a command by renaming it into</span>
<span class="s"># an empty string:</span>
<span class="s">#</span>
<span class="s"># rename-command CONFIG &quot;&quot;</span>
<span class="s">#</span>
<span class="s"># Please note that changing the name of commands that are logged into the</span>
<span class="s"># AOF file or transmitted to slaves may cause problems.</span>

<span class="s">################################### LIMITS ####################################</span>

<span class="s"># Set the max number of connected clients at the same time. By default</span>
<span class="s"># this limit is set to 10000 clients, however if the Redis server is not</span>
<span class="s"># able to configure the process file limit to allow for the specified limit</span>
<span class="s"># the max number of allowed clients is set to the current file limit</span>
<span class="s"># minus 32 (as Redis reserves a few file descriptors for internal uses).</span>
<span class="s">#</span>
<span class="s"># Once the limit is reached Redis will close all the new connections sending</span>
<span class="s"># an error &#39;max number of clients reached&#39;.</span>
<span class="s">#</span>
<span class="s"># maxclients 10000</span>

<span class="s"># Don&#39;t use more memory than the specified amount of bytes.</span>
<span class="s"># When the memory limit is reached Redis will try to remove keys</span>
<span class="s"># accordingly to the eviction policy selected (see maxmemmory-policy).</span>
<span class="s">#</span>
<span class="s"># If Redis can&#39;t remove keys according to the policy, or if the policy is</span>
<span class="s"># set to &#39;noeviction&#39;, Redis will start to reply with errors to commands</span>
<span class="s"># that would use more memory, like SET, LPUSH, and so on, and will continue</span>
<span class="s"># to reply to read-only commands like GET.</span>
<span class="s">#</span>
<span class="s"># This option is usually useful when using Redis as an LRU cache, or to set</span>
<span class="s"># an hard memory limit for an instance (using the &#39;noeviction&#39; policy).</span>
<span class="s">#</span>
<span class="s"># WARNING: If you have slaves attached to an instance with maxmemory on,</span>
<span class="s"># the size of the output buffers needed to feed the slaves are subtracted</span>
<span class="s"># from the used memory count, so that network problems / resyncs will</span>
<span class="s"># not trigger a loop where keys are evicted, and in turn the output</span>
<span class="s"># buffer of slaves is full with DELs of keys evicted triggering the deletion</span>
<span class="s"># of more keys, and so forth until the database is completely emptied.</span>
<span class="s">#</span>
<span class="s"># In short... if you have slaves attached it is suggested that you set a lower</span>
<span class="s"># limit for maxmemory so that there is some free RAM on the system for slave</span>
<span class="s"># output buffers (but this is not needed if the policy is &#39;noeviction&#39;).</span>
<span class="s">#</span>
<span class="s">maxmemory $maxrammb</span>

<span class="s"># MAXMEMORY POLICY: how Redis will select what to remove when maxmemory</span>
<span class="s"># is reached. You can select among five behaviors:</span>
<span class="s">#</span>
<span class="s"># volatile-lru -&gt; remove the key with an expire set using an LRU algorithm</span>
<span class="s"># allkeys-lru -&gt; remove any key accordingly to the LRU algorithm</span>
<span class="s"># volatile-random -&gt; remove a random key with an expire set</span>
<span class="s"># allkeys-random -&gt; remove a random key, any key</span>
<span class="s"># volatile-ttl -&gt; remove the key with the nearest expire time (minor TTL)</span>
<span class="s"># noeviction -&gt; don&#39;t expire at all, just return an error on write operations</span>
<span class="s">#</span>
<span class="s"># Note: with any of the above policies, Redis will return an error on write</span>
<span class="s">#       operations, when there are not suitable keys for eviction.</span>
<span class="s">#</span>
<span class="s">#       At the date of writing this commands are: set setnx setex append</span>
<span class="s">#       incr decr rpush lpush rpushx lpushx linsert lset rpoplpush sadd</span>
<span class="s">#       sinter sinterstore sunion sunionstore sdiff sdiffstore zadd zincrby</span>
<span class="s">#       zunionstore zinterstore hset hsetnx hmset hincrby incrby decrby</span>
<span class="s">#       getset mset msetnx exec sort</span>
<span class="s">#</span>
<span class="s"># The default is:</span>
<span class="s">#</span>
<span class="s">maxmemory-policy volatile-lru</span>
<span class="s">#maxmemory-policy allkeys-lru</span>

<span class="s"># LRU and minimal TTL algorithms are not precise algorithms but approximated</span>
<span class="s"># algorithms (in order to save memory), so you can select as well the sample</span>
<span class="s"># size to check. For instance for default Redis will check three keys and</span>
<span class="s"># pick the one that was used less recently, you can change the sample size</span>
<span class="s"># using the following configuration directive.</span>
<span class="s">#</span>
<span class="s"># maxmemory-samples 3</span>

<span class="s">############################## APPEND ONLY MODE ###############################</span>

<span class="s"># By default Redis asynchronously dumps the dataset on disk. This mode is</span>
<span class="s"># good enough in many applications, but an issue with the Redis process or</span>
<span class="s"># a power outage may result into a few minutes of writes lost (depending on</span>
<span class="s"># the configured save points).</span>
<span class="s">#</span>
<span class="s"># The Append Only File is an alternative persistence mode that provides</span>
<span class="s"># much better durability. For instance using the default data fsync policy</span>
<span class="s"># (see later in the config file) Redis can lose just one second of writes in a</span>
<span class="s"># dramatic event like a server power outage, or a single write if something</span>
<span class="s"># wrong with the Redis process itself happens, but the operating system is</span>
<span class="s"># still running correctly.</span>
<span class="s">#</span>
<span class="s"># AOF and RDB persistence can be enabled at the same time without problems.</span>
<span class="s"># If the AOF is enabled on startup Redis will load the AOF, that is the file</span>
<span class="s"># with the better durability guarantees.</span>
<span class="s">#</span>
<span class="s"># Please check http://redis.io/topics/persistence for more information.</span>

<span class="s">appendonly $appendonly</span>

<span class="s"># The name of the append only file (default: &quot;appendonly.aof&quot;)</span>
<span class="s">appendfilename appendonly.aof</span>

<span class="s"># The fsync() call tells the Operating System to actually write data on disk</span>
<span class="s"># instead to wait for more data in the output buffer. Some OS will really flush</span>
<span class="s"># data on disk, some other OS will just try to do it ASAP.</span>
<span class="s">#</span>
<span class="s"># Redis supports three different modes:</span>
<span class="s">#</span>
<span class="s"># no: don&#39;t fsync, just let the OS flush the data when it wants. Faster.</span>
<span class="s"># always: fsync after every write to the append only log . Slow, Safest.</span>
<span class="s"># everysec: fsync only one time every second. Compromise.</span>
<span class="s">#</span>
<span class="s"># The default is &quot;everysec&quot;, as that&#39;s usually the right compromise between</span>
<span class="s"># speed and data safety. It&#39;s up to you to understand if you can relax this to</span>
<span class="s"># &quot;no&quot; that will let the operating system flush the output buffer when</span>
<span class="s"># it wants, for better performances (but if you can live with the idea of</span>
<span class="s"># some data loss consider the default persistence mode that&#39;s snapshotting),</span>
<span class="s"># or on the contrary, use &quot;always&quot; that&#39;s very slow but a bit safer than</span>
<span class="s"># everysec.</span>
<span class="s">#</span>
<span class="s"># More details please check the following article:</span>
<span class="s"># http://antirez.com/post/redis-persistence-demystified.html</span>
<span class="s">#</span>
<span class="s"># If unsure, use &quot;everysec&quot;.</span>

<span class="s">#appendfsync always</span>
<span class="s">#appendfsync everysec</span>
<span class="s"># appendfsync no</span>

<span class="s"># When the AOF fsync policy is set to always or everysec, and a background</span>
<span class="s"># saving process (a background save or AOF log background rewriting) is</span>
<span class="s"># performing a lot of I/O against the disk, in some Linux configurations</span>
<span class="s"># Redis may block too long on the fsync() call. Note that there is no fix for</span>
<span class="s"># this currently, as even performing fsync in a different thread will block</span>
<span class="s"># our synchronous write(2) call.</span>
<span class="s">#</span>
<span class="s"># In order to mitigate this problem it&#39;s possible to use the following option</span>
<span class="s"># that will prevent fsync() from being called in the main process while a</span>
<span class="s"># BGSAVE or BGREWRITEAOF is in progress.</span>
<span class="s">#</span>
<span class="s"># This means that while another child is saving, the durability of Redis is</span>
<span class="s"># the same as &quot;appendfsync none&quot;. In practical terms, this means that it is</span>
<span class="s"># possible to lose up to 30 seconds of log in the worst scenario (with the</span>
<span class="s"># default Linux settings).</span>
<span class="s">#</span>
<span class="s"># If you have latency problems turn this to &quot;yes&quot;. Otherwise leave it as</span>
<span class="s"># &quot;no&quot; that is the safest pick from the point of view of durability.</span>
<span class="s">no-appendfsync-on-rewrite no</span>

<span class="s"># Automatic rewrite of the append only file.</span>
<span class="s"># Redis is able to automatically rewrite the log file implicitly calling</span>
<span class="s"># BGREWRITEAOF when the AOF log size grows by the specified percentage.</span>
<span class="s">#</span>
<span class="s"># This is how it works: Redis remembers the size of the AOF file after the</span>
<span class="s"># latest rewrite (if no rewrite has happened since the restart, the size of</span>
<span class="s"># the AOF at startup is used).</span>
<span class="s">#</span>
<span class="s"># This base size is compared to the current size. If the current size is</span>
<span class="s"># bigger than the specified percentage, the rewrite is triggered. Also</span>
<span class="s"># you need to specify a minimal size for the AOF file to be rewritten, this</span>
<span class="s"># is useful to avoid rewriting the AOF file even if the percentage increase</span>
<span class="s"># is reached but it is still pretty small.</span>
<span class="s">#</span>
<span class="s"># Specify a percentage of zero in order to disable the automatic AOF</span>
<span class="s"># rewrite feature.</span>

<span class="s">auto-aof-rewrite-percentage 150</span>
<span class="s">auto-aof-rewrite-min-size 64mb</span>

<span class="s">################################ LUA SCRIPTING  ###############################</span>

<span class="s"># Max execution time of a Lua script in milliseconds.</span>
<span class="s">#</span>
<span class="s"># If the maximum execution time is reached Redis will log that a script is</span>
<span class="s"># still in execution after the maximum allowed time and will start to</span>
<span class="s"># reply to queries with an error.</span>
<span class="s">#</span>
<span class="s"># When a long running script exceed the maximum execution time only the</span>
<span class="s"># SCRIPT KILL and SHUTDOWN NOSAVE commands are available. The first can be</span>
<span class="s"># used to stop a script that did not yet called write commands. The second</span>
<span class="s"># is the only way to shut down the server in the case a write commands was</span>
<span class="s"># already issue by the script but the user don&#39;t want to wait for the natural</span>
<span class="s"># termination of the script.</span>
<span class="s">#</span>
<span class="s"># Set it to 0 or a negative value for unlimited execution without warnings.</span>
<span class="s">lua-time-limit 5000</span>

<span class="s">################################## SLOW LOG ###################################</span>

<span class="s"># The Redis Slow Log is a system to log queries that exceeded a specified</span>
<span class="s"># execution time. The execution time does not include the I/O operations</span>
<span class="s"># like talking with the client, sending the reply and so forth,</span>
<span class="s"># but just the time needed to actually execute the command (this is the only</span>
<span class="s"># stage of command execution where the thread is blocked and can not serve</span>
<span class="s"># other requests in the meantime).</span>
<span class="s">#</span>
<span class="s"># You can configure the slow log with two parameters: one tells Redis</span>
<span class="s"># what is the execution time, in microseconds, to exceed in order for the</span>
<span class="s"># command to get logged, and the other parameter is the length of the</span>
<span class="s"># slow log. When a new command is logged the oldest one is removed from the</span>
<span class="s"># queue of logged commands.</span>

<span class="s"># The following time is expressed in microseconds, so 1000000 is equivalent</span>
<span class="s"># to one second. Note that a negative number disables the slow log, while</span>
<span class="s"># a value of zero forces the logging of every command.</span>
<span class="s">slowlog-log-slower-than 10000</span>

<span class="s"># There is no limit to this length. Just be aware that it will consume memory.</span>
<span class="s"># You can reclaim memory used by the slow log with SLOWLOG RESET.</span>
<span class="s">slowlog-max-len 128</span>

<span class="s">############################### ADVANCED CONFIG ###############################</span>

<span class="s"># Hashes are encoded using a memory efficient data structure when they have a</span>
<span class="s"># small number of entries, and the biggest entry does not exceed a given</span>
<span class="s"># threshold. These thresholds can be configured using the following directives.</span>
<span class="s">hash-max-ziplist-entries 512</span>
<span class="s">hash-max-ziplist-value 64</span>

<span class="s"># Similarly to hashes, small lists are also encoded in a special way in order</span>
<span class="s"># to save a lot of space. The special representation is only used when</span>
<span class="s"># you are under the following limits:</span>
<span class="s">list-max-ziplist-entries 512</span>
<span class="s">list-max-ziplist-value 64</span>

<span class="s"># Sets have a special encoding in just one case: when a set is composed</span>
<span class="s"># of just strings that happens to be integers in radix 10 in the range</span>
<span class="s"># of 64 bit signed integers.</span>
<span class="s"># The following configuration setting sets the limit in the size of the</span>
<span class="s"># set in order to use this special memory saving encoding.</span>
<span class="s">set-max-intset-entries 512</span>

<span class="s"># Similarly to hashes and lists, sorted sets are also specially encoded in</span>
<span class="s"># order to save a lot of space. This encoding is only used when the length and</span>
<span class="s"># elements of a sorted set are below the following limits:</span>
<span class="s">zset-max-ziplist-entries 128</span>
<span class="s">zset-max-ziplist-value 64</span>

<span class="s"># Active rehashing uses 1 millisecond every 100 milliseconds of CPU time in</span>
<span class="s"># order to help rehashing the main Redis hash table (the one mapping top-level</span>
<span class="s"># keys to values). The hash table implementation Redis uses (see dict.c)</span>
<span class="s"># performs a lazy rehashing: the more operation you run into an hash table</span>
<span class="s"># that is rehashing, the more rehashing &quot;steps&quot; are performed, so if the</span>
<span class="s"># server is idle the rehashing is never complete and some more memory is used</span>
<span class="s"># by the hash table.</span>
<span class="s">#</span>
<span class="s"># The default is to use this millisecond 10 times every second in order to</span>
<span class="s"># active rehashing the main dictionaries, freeing memory when possible.</span>
<span class="s">#</span>
<span class="s"># If unsure:</span>
<span class="s"># use &quot;activerehashing no&quot; if you have hard latency requirements and it is</span>
<span class="s"># not a good thing in your environment that Redis can reply form time to time</span>
<span class="s"># to queries with 2 milliseconds delay.</span>
<span class="s">#</span>
<span class="s"># use &quot;activerehashing yes&quot; if you don&#39;t have such hard requirements but</span>
<span class="s"># want to free memory asap when possible.</span>
<span class="s">activerehashing yes</span>

<span class="s"># The client output buffer limits can be used to force disconnection of clients</span>
<span class="s"># that are not reading data from the server fast enough for some reason (a</span>
<span class="s"># common reason is that a Pub/Sub client can&#39;t consume messages as fast as the</span>
<span class="s"># publisher can produce them).</span>
<span class="s">#</span>
<span class="s"># The limit can be set differently for the three different classes of clients:</span>
<span class="s">#</span>
<span class="s"># normal -&gt; normal clients</span>
<span class="s"># slave  -&gt; slave clients and MONITOR clients</span>
<span class="s"># pubsub -&gt; clients subcribed to at least one pubsub channel or pattern</span>
<span class="s">#</span>
<span class="s"># The syntax of every client-output-buffer-limit directive is the following:</span>
<span class="s">#</span>
<span class="s"># client-output-buffer-limit &lt;class&gt; &lt;hard limit&gt; &lt;soft limit&gt; &lt;soft seconds&gt;</span>
<span class="s">#</span>
<span class="s"># A client is immediately disconnected once the hard limit is reached, or if</span>
<span class="s"># the soft limit is reached and remains reached for the specified number of</span>
<span class="s"># seconds (continuously).</span>
<span class="s"># So for instance if the hard limit is 32 megabytes and the soft limit is</span>
<span class="s"># 16 megabytes / 10 seconds, the client will get disconnected immediately</span>
<span class="s"># if the size of the output buffers reach 32 megabytes, but will also get</span>
<span class="s"># disconnected if the client reaches 16 megabytes and continuously overcomes</span>
<span class="s"># the limit for 10 seconds.</span>
<span class="s">#</span>
<span class="s"># By default normal clients are not limited because they don&#39;t receive data</span>
<span class="s"># without asking (in a push way), but just after a request, so only</span>
<span class="s"># asynchronous clients may create a scenario where data is requested faster</span>
<span class="s"># than it can read.</span>
<span class="s">#</span>
<span class="s"># Instead there is a default limit for pubsub and slave clients, since</span>
<span class="s"># subscribers and slaves receive data in a push fashion.</span>
<span class="s">#</span>
<span class="s"># Both the hard or the soft limit can be disabled by setting them to zero.</span>
<span class="s">client-output-buffer-limit normal 0 0 0</span>
<span class="s">client-output-buffer-limit slave 256mb 64mb 60</span>
<span class="s">client-output-buffer-limit pubsub 32mb 8mb 60</span>

<span class="s"># Redis calls an internal function to perform many background tasks, like</span>
<span class="s"># closing connections of clients in timeot, purging expired keys that are</span>
<span class="s"># never requested, and so forth.</span>
<span class="s">#</span>
<span class="s"># Not all tasks are perforemd with the same frequency, but Redis checks for</span>
<span class="s"># tasks to perform accordingly to the specified &quot;hz&quot; value.</span>
<span class="s">#</span>
<span class="s"># By default &quot;hz&quot; is set to 10. Raising the value will use more CPU when</span>
<span class="s"># Redis is idle, but at the same time will make Redis more responsive when</span>
<span class="s"># there are many keys expiring at the same time, and timeouts may be</span>
<span class="s"># handled with more precision.</span>
<span class="s">#</span>
<span class="s"># The range is between 1 and 500, however a value over 100 is usually not</span>
<span class="s"># a good idea. Most users should use the default of 10 and raise this up to</span>
<span class="s"># 100 only in environments where very low latency is required.</span>
<span class="s">hz 10</span>

<span class="s"># When a child rewrites the AOF file, if the following option is enabled</span>
<span class="s"># the file will be fsync-ed every 32 MB of data generated. This is useful</span>
<span class="s"># in order to commit the file to the disk more incrementally and avoid</span>
<span class="s"># big latency spikes.</span>
<span class="s">aof-rewrite-incremental-fsync yes</span>

<span class="s">################################## INCLUDES ###################################</span>

<span class="s"># Include one or more other config files here.  This is useful if you</span>
<span class="s"># have a standard template that goes to all Redis server but also need</span>
<span class="s"># to customize a few per-server settings.  Include files can include</span>
<span class="s"># other files, so use this wisely.</span>
<span class="s">#</span>
<span class="s"># include /path/to/local.conf</span>
<span class="s"># include /path/to/other.conf</span>
<span class="s">&quot;&quot;&quot;</span>

        <span class="n">C</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;$name&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;$maxram&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">maxram</span><span class="p">))</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;$port&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;$vardir&quot;</span><span class="p">,</span> <span class="n">j</span><span class="o">.</span><span class="n">dirs</span><span class="o">.</span><span class="n">varDir</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ismaster</span><span class="p">:</span>
            <span class="n">slave</span><span class="o">=</span><span class="bp">False</span>

        <span class="k">if</span> <span class="n">appendonly</span> <span class="ow">or</span> <span class="n">ismaster</span><span class="p">:</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;$appendonly&quot;</span><span class="p">,</span> <span class="s">&quot;yes&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;$appendonly&quot;</span><span class="p">,</span> <span class="s">&quot;no&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">slave</span><span class="p">:</span>
            <span class="n">CONTENT</span><span class="o">=</span><span class="s">&quot;slaveof </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">slave</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">slave</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">slave</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;&gt;</span><span class="s">&quot;&quot;</span><span class="p">:</span>
                <span class="n">CONTENT</span><span class="o">+=</span><span class="s">&quot;masterauth </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">%</span><span class="n">slave</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;$slave&quot;</span><span class="p">,</span><span class="n">CONTENT</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;$slave&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>

        
        
        <span class="k">if</span> <span class="n">snapshot</span><span class="p">:</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;$snapshot&quot;</span><span class="p">,</span> <span class="s">&quot;save 30 1&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;$snapshot&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">passwd</span><span class="o">&lt;&gt;</span><span class="bp">None</span><span class="p">:</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;$passwd&quot;</span><span class="p">,</span> <span class="s">&quot;requirepass </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">passwd</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;$passwd&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">ismaster</span><span class="p">:</span>
            <span class="n">C</span><span class="o">=</span><span class="n">C</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;#appendfsync always&quot;</span><span class="p">,</span><span class="s">&quot;appendfsync always&quot;</span><span class="p">)</span>

        <span class="n">dpath</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/redis/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">dirs</span><span class="o">.</span><span class="n">varDir</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
        <span class="n">dbpath</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="s">&quot;db&quot;</span><span class="p">)</span>
        <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">createDir</span><span class="p">(</span><span class="n">dbpath</span><span class="p">)</span>
        <span class="n">cpath</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">joinPaths</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="s">&quot;redis.conf&quot;</span><span class="p">)</span>
        <span class="n">j</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">writeFile</span><span class="p">(</span><span class="n">cpath</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
</pre></div></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">Jumpscale Doc 7.0 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
    </div>
  </body>
</html>